<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Couleurs du comportement - Suivi annuel</title>
<style>
        :root {
            --v: #2ecc71; --j: #f1c40f; --o: #e67e22; --r: #e74c3c;
            --dark: #2c3e50; --light: #f4f7f6;
            --win: #111111;
            --gold: #f1c40f;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); font-size: 11px; margin: 10px; }
        .container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 98vw; margin: auto; overflow-x: auto; }
        .top-bar { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; background: #eee; padding: 8px; border-radius: 5px; position: sticky; left: 0; }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 1px; text-align: center; overflow: hidden; white-space: nowrap; transition: background 0.2s; background: white; }
        
        /* FIXE L'EN-TETE (Vertical) */
        #headerRow th { 
            position: sticky; 
            top: 0; 
            z-index: 110; 
            background: #ddd !important;
            border-bottom: 2px solid #bbb;
        }

        /* FIXE LES COLONNES DE GAUCHE (Horizontal) */
        .col-del { width: 30px; position: sticky; left: 0; z-index: 20; background: #f9f9f9 !important; }
        .col-name { width: 150px; text-align: left; padding-left: 5px; cursor: move; font-size: 13px; color: #2980b9; font-weight: bold; position: sticky; left: 30px; z-index: 20; background: white !important; }
        .col-pts { width: 50px; font-weight: bold; background: #f0f0f0 !important; cursor: pointer; position: sticky; left: 180px; z-index: 20; }
        
        /* Ajustement des z-index pour les coins (en-haut √† gauche) */
        #headerRow th.col-del { z-index: 120; left: 0; }
        #headerRow th.col-name { z-index: 120; left: 30px; }
        #headerRow th.col-pts { z-index: 120; left: 180px; }

        .col-pts:hover { background: var(--win) !important; color: white; }
        .student-row:hover td { background-color: #f1f7ff !important; }

        /* Verrouillage */
        .is-locked .btn-cycle, 
        .is-locked .btn-del, 
        .is-locked .col-pts,
        .is-locked .reward-item { pointer-events: none; opacity: 0.8; }
        .is-locked .col-name { cursor: default; }

        /* Drag & Drop Visual */
        tr.dragging { opacity: 0.5; background: #e0e0e0; }
        tr.drag-over { border-top: 3px solid var(--win); }

        .handle { color: #bdc3c7; font-weight: normal; margin-right: 5px; font-size: 10px; user-select: none; }

        .winner-name { background-color: #fdf2ab !important; color: #d35400 !important; border: 2px solid var(--gold) !important; }
        .winner-score { background-color: var(--gold) !important; color: black !important; font-size: 13px; }

        .col-week { width: 35px; min-width: 35px; position: relative; padding: 0 !important; height: 26px; }
        .btn-cycle { width: 100%; height: 100%; border: none; cursor: pointer; font-weight: bold; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        .win-cell { border-radius: 50%; outline: 2px solid var(--win) !important; outline-offset: -2px; z-index: 1; }

        th.week-col { font-size: 9px; }
        
        .c-5 { background-color: var(--v) !important; color: white !important; }
        .c-3 { background-color: var(--j) !important; color: black !important; }
        .c-2 { background-color: var(--o) !important; color: white !important; }
        .c-1 { background-color: var(--r) !important; color: white !important; }
        .c-none { background-color: #fff; color: transparent; }

        .reward-panel { display: none; background: #fff; padding: 10px; border: 2px solid #2980b9; border-top: none; position: sticky; left: 0; width: 95vw; }
        .reward-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 5px; margin-bottom: 10px; }
        .row-title { font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 5px; grid-column: 1 / -1; font-size: 12px; }

        .reward-item { border: 1px solid #bdc3c7; padding: 4px; border-radius: 3px; cursor: pointer; background: #f9f9f9; font-size: 9px; display: flex; flex-direction: column; min-height: 45px; }
        .reward-item.target { background: #72cfdb; border-color: #3498db; }
        .reward-item.done { background: #2ecc71; color: white; border-color: #27ae60; }

        .btn-del { background: none; color: #e74c3c; font-size: 14px; border: none; cursor: pointer; }
        .btn-main { background: var(--dark); color: white; border: none; border-radius: 3px; padding: 5px 8px; cursor: pointer; }
        .btn-lock { background: #f39c12; color: white; }
        .btn-lock.active { background: #7f8c8d; }

        #resetModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <input type="text" id="newName" placeholder="Nom de l'√©l√®ve" style="padding: 5px; width: 130px;" onkeypress="if(event.key === 'Enter') addStudent()">
        <button class="btn-main" onclick="addStudent()">+ Ajouter</button>
        
        <button class="btn-main" style="background:#3498db;" onclick="toggleAllAccordions(true)">üìÇ Tout ouvrir</button>
        <button class="btn-main" style="background:#3498db;" onclick="toggleAllAccordions(false)">üìÅ Tout fermer</button>

        <button id="lockBtn" class="btn-main btn-lock" onclick="toggleLock()">üîì Mode √âdition</button>
        <div style="flex-grow: 1;"></div>
        <button style="background:#27ae60; color:white;" class="btn-main" onclick="exportData()">üíæ Export JSON</button>
        <button style="background:#8e44ad; color:white;" class="btn-main" onclick="document.getElementById('importFile').click()">üìÅ Import JSON</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

    <table id="mainTable">
        <thead>
            <tr id="headerRow">
                <th class="col-del"></th>
                <th class="col-name">√âl√®ve</th>
                <th class="col-pts">Score</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="resetModal">
    <div class="modal-content">
        <div style="font-size:40px; margin-bottom:10px;">üèÜ</div>
        <h2 style="margin:0 0 10px 0;">Reset Score</h2>
        <p id="modalText" style="color:#666; font-size:13px; margin-bottom:20px;"></p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="closeModal()" style="background:#eee; padding:8px 15px; border:none; border-radius:6px; cursor:pointer;">Annuler</button>
            <button id="confirmBtn" style="background:var(--win); color:white; padding:8px 15px; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">Confirmer (Entr√©e)</button>
        </div>
    </div>
</div>

<script>
    // URL de votre application web Google Apps Script
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw-qXbfVkaX9_ns-9C1gxoKTJvBmocj4l4RVlh0jAYFHbfBPCw-qYc-mSWOGyczbvce/exec";
    // Nom exact du fichier sur le Drive
    const DRIVE_FILE_NAME = "suivi_couleurs_data.json";

    const descP = ["Casquette", "1er rang", "Tablette", "Moins contrat", "Foot A/B", "Chaise confort", "Bureau ma√Ætre", "A c√¥t√© ami", "Pyjama", "Stylo couleur", "Craie r√©cr√©", "Chanson", "Dessin table", "Dessin porte"];
    const descT = ["Crayon flex", "Crayon ArcEnCiel", "Feuilles √† gratter", "Gomme animal", "Capsule Kawaii", "Squishy", "D√©co crayon", "Scotch d√©co", "3 Stickers", "3 Billes"];

    let classData = JSON.parse(localStorage.getItem('classData36_vFinal')) || [];
    let isLocked = false;
    
    const pointsMap = { '5': 5, '3': 3, '2': 2, '1': 1, '': 0 };
    const cycle = ['', '5', '3', '2', '1'];
    let draggedIndex = null;

    // --- CHARGEMENT DEPUIS DRIVE ---
    async function loadFromDrive() {
        try {
            const response = await fetch(GAS_URL + "?filename=" + DRIVE_FILE_NAME, { method: 'GET', redirect: 'follow' });
            const data = await response.json();
            if (data && Array.isArray(data) && data.length > 0) {
                classData = data;
                saveData(false); 
                fullRender();
            }
        } catch (e) { console.log("Fichier " + DRIVE_FILE_NAME + " non trouv√© ou Drive vide."); }
    }

    const headerRow = document.getElementById('headerRow');
    for (let i = 1; i <= 36; i++) {
        let th = document.createElement('th');
        th.className = 'col-week week-col';
        th.innerText = i;
        headerRow.appendChild(th);
    }

    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        const container = document.querySelector('.container');
        if (isLocked) {
            btn.innerText = "üîí Tableau Verrouill√©";
            btn.classList.add('active');
            container.classList.add('is-locked');
        } else {
            btn.innerText = "üîì Mode √âdition";
            btn.classList.remove('active');
            container.classList.remove('is-locked');
        }
        fullRender();
    }

    function getNetScore(student) {
        const total = student.weeks.reduce((sum, v) => sum + (pointsMap[v] || 0), 0);
        return total - (student.pointsUsed || 0);
    }

    // --- SAUVEGARDE DRIVE ---
    async function saveData(syncToDrive = true) { 
        localStorage.setItem('classData36_vFinal', JSON.stringify(classData)); 
        if (syncToDrive) {
            try {
                // On envoie les donn√©es ET le nom du fichier souhait√©
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        filename: DRIVE_FILE_NAME,
                        data: classData
                    })
                });
            } catch (e) { console.error("Erreur de synchronisation Drive"); }
        }
    }

    function addStudent() {
        if(isLocked) return;
        const input = document.getElementById('newName');
        const name = input.value.trim();
        if (!name) return;
        classData.push({ name: name, weeks: Array(36).fill(''), rewards: {}, pointsUsed: 0, winWeeks: [] });
        input.value = ''; input.focus();
        saveData(); fullRender();
    }

    function deleteStudent(index) {
        if(isLocked) return;
        if(confirm(`Supprimer ${classData[index].name} ?`)) {
            classData.splice(index, 1);
            saveData(); fullRender();
        }
    }

    function manualReset(index) {
        if(isLocked) return;
        const student = classData[index];
        const modal = document.getElementById('resetModal');
        const confirmBtn = document.getElementById('confirmBtn');
        document.getElementById('modalText').innerText = `Remettre le score de ${student.name} √† 0 ?`;
        modal.style.display = 'flex';
        confirmBtn.focus();
        confirmBtn.onclick = function() {
            const totalAccumule = student.weeks.reduce((sum, v) => sum + (pointsMap[v] || 0), 0);
            student.pointsUsed = totalAccumule;
            saveData(); closeModal(); fullRender();
        };
    }

    function closeModal() { document.getElementById('resetModal').style.display = 'none'; }

    function handleDragStart(e, index) {
        if(isLocked) { e.preventDefault(); return; }
        draggedIndex = index;
        e.currentTarget.classList.add('dragging');
    }

    function handleDragOver(e) {
        if(isLocked) return;
        e.preventDefault();
        const tr = e.currentTarget;
        if (tr.classList.contains('student-row')) {
            tr.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

    function handleDrop(e, targetIndex) {
        if(isLocked) return;
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === targetIndex) {
            fullRender();
            return;
        }
        const movedItem = classData.splice(draggedIndex, 1)[0];
        classData.splice(targetIndex, 0, movedItem);
        saveData();
        fullRender();
    }

    function cycleWeek(sIdx, wIdx) {
        if(isLocked) return;
        const student = classData[sIdx];
        const oldScore = getNetScore(student);
        let currentVal = student.weeks[wIdx];
        
        if(currentVal === 'V') currentVal = '5';
        if(currentVal === 'J') currentVal = '3';
        if(currentVal === 'O') currentVal = '2';
        if(currentVal === 'R') currentVal = '1';

        let currentIdx = cycle.indexOf(currentVal);
        student.weeks[wIdx] = cycle[(currentIdx + 1) % cycle.length];
        const newScore = getNetScore(student);

        if (!student.winWeeks) student.winWeeks = [];
        if (oldScore < 12 && newScore >= 12) {
            if (!student.winWeeks.includes(wIdx)) student.winWeeks.push(wIdx);
        } else if (newScore < 12) {
            student.winWeeks = student.winWeeks.filter(w => w !== wIdx);
        }
        saveData();
        fullRender();
    }

    function toggleReward(sIdx, rCode, element) {
        if(isLocked) return;
        let current = classData[sIdx].rewards[rCode] || 0;
        let next = (current + 1) % 3;
        classData[sIdx].rewards[rCode] = next;
        
        element.classList.remove('target', 'done');
        let icon = "";
        if (next === 1) { element.classList.add('target'); icon = "‚è≥"; }
        else if (next === 2) { element.classList.add('done'); icon = "‚úÖ"; }
        element.querySelector('span').innerText = icon;
        saveData();
    }

    function toggleAccordion(id) {
        let el = document.getElementById('acc-' + id);
        let current = el.style.display;
        document.querySelectorAll('.reward-panel').forEach(p => p.style.display = 'none');
        el.style.display = (current === 'block') ? 'none' : 'block';
    }

    function toggleAllAccordions(open) {
        const panels = document.querySelectorAll('.reward-panel');
        panels.forEach(panel => {
            panel.style.display = open ? 'block' : 'none';
        });
    }

    function fullRender() {
        const openPanels = Array.from(document.querySelectorAll('.reward-panel'))
                                .filter(p => p.style.display === 'block')
                                .map(p => p.id);
                                
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        classData.forEach((student, sIdx) => {
            const netScore = getNetScore(student);
            const isWinner = netScore >= 12;
            
            let tr = document.createElement('tr');
            tr.className = 'student-row';
            tr.draggable = !isLocked;
            
            tr.addEventListener('dragstart', (e) => handleDragStart(e, sIdx));
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('dragleave', handleDragLeave);
            tr.addEventListener('drop', (e) => handleDrop(e, sIdx));
            tr.addEventListener('dragend', () => fullRender());

            let html = `<td class="col-del"><button class="btn-del" onclick="deleteStudent(${sIdx})">√ó</button></td>`;
            html += `<td class="col-name ${isWinner ? 'winner-name' : ''}" onclick="toggleAccordion(${sIdx})">${isLocked ? '' : '<span class="handle"> &nbsp; ‚ò∞ &nbsp;&nbsp;&nbsp;</span>'}${student.name}</td>`;
            html += `<td class="col-pts ${isWinner ? 'winner-score' : ''}" onclick="manualReset(${sIdx})">${netScore}</td>`;
            
            student.weeks.forEach((wVal, wIdx) => {
				const isWinMarker = student.winWeeks && student.winWeeks.includes(wIdx);
				// Optionnel : surligner la colonne de la semaine si on veut (ex: semaine 5)
				// const isCurrentWeek = (wIdx + 1) === currentWeekNumber; 

				let displayVal = wVal;
				if(wVal === 'V') displayVal = '5';
				if(wVal === 'J') displayVal = '3';
				if(wVal === 'O') displayVal = '2';
				if(wVal === 'R') displayVal = '1';

				html += `<td class="col-week ${isWinMarker ? 'win-cell' : ''}">
					<button onclick="cycleWeek(${sIdx}, ${wIdx})" 
							class="btn-cycle ${displayVal ? 'c-' + displayVal : 'c-none'}"
							title="Semaine ${wIdx + 1}">
						${displayVal || ''}
					</button>
				</td>`;
			});
            tr.innerHTML = html;
            tbody.appendChild(tr);

            let trAcc = document.createElement('tr');
            let pItems = "", tItems = "";
            for(let i=1; i<=14; i++) {
                let code = 'P'+i; let state = student.rewards[code] || 0;
                pItems += `<div class="reward-item ${state==1?'target':(state==2?'done':'')}" onclick="toggleReward(${sIdx},'${code}',this)">
                    <strong>${code}</strong> ${descP[i-1]} <span>${state==1?'‚è≥':(state==2?'‚úÖ':'')}</span>
                </div>`;
            }
            for(let i=1; i<=10; i++) {
                let code = 'T'+i; let state = student.rewards[code] || 0;
                tItems += `<div class="reward-item ${state==1?'target':(state==2?'done':'')}" onclick="toggleReward(${sIdx},'${code}',this)">
                    <strong>${code}</strong> ${descT[i-1]} <span>${state==1?'‚è≥':(state==2?'‚úÖ':'')}</span>
                </div>`;
            }
            
            const currentAccId = `acc-${sIdx}`;
            trAcc.innerHTML = `<td colspan="39" style="padding:0; border:none;">
                <div id="${currentAccId}" class="reward-panel" style="display: ${openPanels.includes(currentAccId) ? 'block' : 'none'}">
                    <div class="reward-row"><div class="row-title">Privil√®ges (P)</div>${pItems}</div>
                    <div class="reward-row"><div class="row-title">Tr√©sors (T)</div>${tItems}</div>
                </div>
            </td>`;
            tbody.appendChild(trAcc);
        });
    }

    function exportData() {
        const now = new Date();
        const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(classData)], {type: 'application/json'}));
        a.download = `couleurs_comportement_${dateStr}.json`;
        a.click();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => { classData = JSON.parse(e.target.result); saveData(); fullRender(); };
        reader.readAsText(event.target.files[0]);
    }
    
    // Initialisation
    fullRender();
    loadFromDrive();
</script>
</body>
</html>