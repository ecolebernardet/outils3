<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G√©n√©rateur de Fractions - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ===== VARIABLES CSS ===== */
        :root {
            --bg-page: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --accent-color: #06b6d4;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee;
            --card-bg: #ffffff;
            --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* ===== STYLES G√âN√âRAUX ===== */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
        }
        
        /* ===== HEADER ===== */
        header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ===== BOUTONS ===== */
        .ui-btn-round {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        .btn-game-action {
            height: 40px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 900;
            color: white;
            transition: all 0.2s ease;
            text-transform: uppercase;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* ===== LAYOUT ===== */
        .main-wrapper {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 10px 15px 40px;
        }

        .light-card {
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 20px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
            margin-bottom: 20px;
        }

        /* ===== FORMULAIRES ===== */
        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.75rem;
            padding: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            width: 100%;
            color: var(--text-main);
            outline: none;
        }

        /* ===== CARTES DE QUESTIONS ===== */
        .q-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 15px;
            border: 1px solid var(--column-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* ===== FRACTIONS ===== */
        .math-fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            font-weight: 900;
            font-size: 1.3rem;
            line-height: 1;
            color: var(--accent-color);
        }

        .fraction-bar {
            width: 110%;
            height: 2px;
            background-color: currentColor;
            margin: 2px 0;
        }

        .fraction-svg {
            max-width: 140px;
            height: auto;
            display: block;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
            position: relative;
        }

        /* ===== RESPONSIVE ===== */
        @media (min-width: 768px) {
            .main-wrapper {
                max-width: 950px;
            }
            #questions-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }
    </style>
</head>
<body class="dark-mode">

<!-- Application du th√®me au chargement -->
<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<!-- ===== HEADER ===== -->
<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>G√©n√©rateur de fractions</h1>
    <button id="btn-aide" onclick="toggleModal('modal-aide', true)" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<!-- ===== CONTENU PRINCIPAL ===== -->
<div class="main-wrapper">
    <!-- Bouton retour aux g√©n√©rateurs -->
    <div id="container-retour-liste" class="mb-4 text-left">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <!-- ===== ZONE DE CONFIGURATION ===== -->
    <div id="setup-zone" class="light-card space-y-4">
        <!-- Titre de la fiche -->
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Titre de la fiche</label>
            <input type="text" id="quiz-title" class="input-field mb-4" placeholder="Ex: Fractions CM1 - √âvaluation">
            
            <!-- Donn√©es -->
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Donn√©es (Fraction ; Forme)</label>
            <textarea id="quiz-data" class="input-field h-40 font-normal" placeholder="1/2 ; disque&#10;3/4 ; bande"></textarea>
            
            <!-- Bouton exemple -->
            <div class="flex justify-start mt-2">
                <button onclick="addExample()" class="px-3 py-1.5 rounded-lg border border-cyan-500/30 text-[8px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/10 transition-colors">
                    Charger un exemple
                </button>
            </div>
        </div>

        <!-- Options -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Mode de rendu -->
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 text-center">Mode de rendu</label>
                <div class="grid grid-cols-2 gap-1 bg-black/10 p-1 rounded-xl">
                    <button onclick="setMode('prof')" id="mode-prof" class="p-2 text-[9px] font-bold uppercase transition-all">Prof</button>
                    <button onclick="setMode('eleve')" id="mode-eleve" class="p-2 text-[9px] font-bold uppercase transition-all">√âl√®ve</button>
                </div>
            </div>
            
            <!-- Chronom√®tre -->
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 text-center">Chrono (min : sec)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="t-min" value="1" class="input-field text-center">
                    <span class="font-bold">:</span>
                    <input type="number" id="t-sec" value="0" class="input-field text-center">
                </div>
            </div>
        </div>

        <!-- Bouton de g√©n√©ration -->
        <button id="mainAddBtn" onclick="generateQuiz()" class="btn-add">Lancer le G√©n√©rateur</button>
    </div>

    <!-- ===== ZONE DE JEU ===== -->
    <div id="game-zone" class="hidden space-y-6">
        <!-- Timer -->
        <div id="timer-display" class="text-center p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <div id="seconds-left" class="text-2xl font-black text-amber-500">0:00</div>
        </div>

        <!-- Grille de questions -->
        <div id="questions-grid" class="grid grid-cols-1 gap-3"></div>

        <!-- Boutons d'action -->
        <div class="flex flex-wrap justify-center gap-3 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500">üìÑ PDF</button>
        </div>
    </div>
</div>

<!-- ===== MODAL D'AIDE ===== -->
<div id="modal-aide" class="modal-overlay" onclick="toggleModal('modal-aide', false)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide Fractions</h2>
        <div class="text-[11px] leading-relaxed space-y-4">
            <p>1. <b>Saisie :</b> √âcrivez une fraction par ligne au format :<br><code class="bg-black/20 p-1 rounded">Num√©rateur/D√©nominateur ; Forme</code></p>
            <p>2. <b>Formes :</b> Vous pouvez choisir entre <b class="text-cyan-500">disque</b> ou <b class="text-cyan-500">bande</b>.</p>
            <p>3. <b>Modes :</b><br>‚Ä¢ <b>Prof :</b> Les formes sont d√©j√† colori√©es.<br>‚Ä¢ <b>√âl√®ve :</b> Les formes sont vides et cliquables.</p>
            <p>4. <b>PDF :</b> G√©n√®re une fiche propre pr√™te √† imprimer.</p>
        </div>
        <button onclick="toggleModal('modal-aide', false)" id="btn-fermer-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">
            J'ai compris
        </button>
    </div>
</div>

<script>
    // ===== CONSTANTES ET CONFIGURATION =====
    const COLOR_MAP = {
        'red': '#ef4444',
        'orange': '#f97316',
        'amber': '#f97316',
        'yellow': '#eab308',
        'lime': '#84cc16',
        'green': '#22c55e',
        'emerald': '#10b981',
        'teal': '#14b8a6',
        'cyan': '#06b6d4',
        'sky': '#0ea5e9',
        'blue': '#3b82f6',
        'indigo': '#6366f1',
        'violet': '#8b5cf6',
        'purple': '#a855f7',
        'fuchsia': '#d946ef',
        'pink': '#ec4899',
        'rose': '#f43f5e',
        'gray': '#6b7280'
    };

    const LIGHT_COLORS = ['yellow', 'lime', 'amber', 'cyan'];
    const MAX_QUESTIONS = 50;

    // ===== VARIABLES D'√âTAT =====
    let currentQuestions = [];
    let currentMode = 'prof';
    let userAnswers = {};
    let isCorr = false;
    let countdown;

    // ===== UTILITAIRES =====
    
    /**
     * Obtient la couleur hexad√©cimale √† partir du nom de couleur
     */
    function getColorHex(colorName) {
        return COLOR_MAP[colorName] || COLOR_MAP.cyan;
    }

    /**
     * D√©termine si une couleur n√©cessite du texte fonc√© (contraste)
     */
    function needsDarkText(colorName) {
        return LIGHT_COLORS.includes(colorName);
    }

    /**
     * Obtient la couleur d'accent actuelle
     */
    function getAccentColor() {
        return getComputedStyle(document.documentElement)
            .getPropertyValue('--accent-color')
            .trim();
    }

    /**
     * G√®re l'affichage/masquage des modales
     */
    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = show ? 'flex' : 'none';
        }
    }

    /**
     * Applique les styles √† un bouton
     */
    function applyButtonStyle(button, bgColor, textColor) {
        if (button) {
            button.style.backgroundColor = bgColor;
            button.style.color = textColor;
        }
    }

    // ===== GESTION DU TH√àME =====
    
    /**
     * Applique le th√®me personnalis√© de l'utilisateur
     */
    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles') || '{}');
        const colorPref = themePrefs.gen || 'cyan';
        const hexColor = getColorHex(colorPref);
        const contrastColor = needsDarkText(colorPref) ? '#000' : '#fff';
        
        // Applique la couleur d'accent
        document.documentElement.style.setProperty('--accent-color', hexColor);
        
        // Liste des boutons √† styliser
        const buttonIds = [
            'btn-retour-header',
            'btn-retour-liste',
            'btn-aide',
            'mainAddBtn',
            'btn-fermer-aide'
        ];
        
        // Applique les styles aux boutons
        buttonIds.forEach(id => {
            applyButtonStyle(document.getElementById(id), hexColor, contrastColor);
        });
        
        // Applique la couleur au titre de la modale
        const titreAide = document.getElementById('titre-aide');
        if (titreAide) {
            titreAide.style.color = hexColor;
        }
        
        // Initialise le mode par d√©faut
        setMode(currentMode);
    }

    /**
     * D√©finit le mode de rendu (prof ou √©l√®ve)
     */
    function setMode(mode) {
        currentMode = mode;
        const accentColor = getAccentColor();
        const btnProf = document.getElementById('mode-prof');
        const btnEleve = document.getElementById('mode-eleve');
        
        if (!btnProf || !btnEleve) return;

        // R√©initialise les styles
        const resetStyle = "background-color: transparent !important; color: inherit; border-radius: 9999px;";
        btnProf.style.cssText = resetStyle;
        btnEleve.style.cssText = resetStyle;

        // Active le bouton s√©lectionn√©
        const activeBtn = document.getElementById('mode-' + mode);
        const isLightColor = LIGHT_COLORS.some(c => accentColor.toLowerCase().includes(c));
        const textColor = isLightColor ? '#000' : '#fff';
        activeBtn.style.cssText = `background-color: ${accentColor} !important; color: ${textColor} !important; border-radius: 9999px;`;
    }

    // ===== GESTION DES EXEMPLES =====
    
    /**
     * Charge un exemple de donn√©es dans le formulaire
     */
    function addExample() {
        document.getElementById('quiz-title').value = "R√©visions : les fractions";
        
        const exemples = [];
        for (let i = 1; i <= 5; i++) {
            const forme = i % 2 === 0 ? 'disque' : 'bande';
            exemples.push(`${i}/${i + 1} ; ${forme}`);
        }
        
        document.getElementById('quiz-data').value = exemples.join('\n');
    }

    // ===== CR√âATION DES FRACTIONS SVG =====
    
    /**
     * Cr√©e le SVG d'une fraction (disque ou bande)
     */
    function createFractionSVG(item, qIdx) {
        const accent = getAccentColor();
        let svg = `<svg viewBox="0 0 100 100" class="fraction-svg" xmlns="http://www.w3.org/2000/svg">`;
        
        if (item.type === 'disque') {
            svg += createDiskSVG(item, qIdx, accent);
        } else {
            svg += createBandSVG(item, qIdx, accent);
        }
        
        return svg + `</svg>`;
    }

    /**
     * Cr√©e un disque SVG divis√© en parts
     */
    function createDiskSVG(item, qIdx, accentColor) {
        const cx = 50, cy = 50, r = 44;
        let svgParts = '';
        
        for (let i = 0; i < item.den; i++) {
            const angle1 = (i * 360) / item.den - 90;
            const angle2 = ((i + 1) * 360) / item.den - 90;
            
            const x1 = cx + r * Math.cos(angle1 * Math.PI / 180);
            const y1 = cy + r * Math.sin(angle1 * Math.PI / 180);
            const x2 = cx + r * Math.cos(angle2 * Math.PI / 180);
            const y2 = cy + r * Math.sin(angle2 * Math.PI / 180);
            
            const filled = isPartFilled(item, qIdx, i);
            const fillColor = filled ? accentColor : 'transparent';
            
            svgParts += `<path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} Z" 
                fill="${fillColor}" 
                stroke="currentColor" 
                stroke-width="1" 
                onclick="togglePart(${qIdx}, ${i})" 
                style="cursor:pointer" />`;
        }
        
        return svgParts;
    }

    /**
     * Cr√©e une bande SVG divis√©e en parts
     */
    function createBandSVG(item, qIdx, accentColor) {
        const w = 90, h = 40, x = 5, y = 30;
        const step = w / item.den;
        let svgParts = '';
        
        for (let i = 0; i < item.den; i++) {
            const filled = isPartFilled(item, qIdx, i);
            const fillColor = filled ? accentColor : 'transparent';
            
            svgParts += `<rect 
                x="${x + i * step}" 
                y="${y}" 
                width="${step}" 
                height="${h}" 
                fill="${fillColor}" 
                stroke="currentColor" 
                stroke-width="1" 
                onclick="togglePart(${qIdx}, ${i})" 
                style="cursor:pointer" />`;
        }
        
        return svgParts;
    }

    /**
     * D√©termine si une part doit √™tre remplie
     */
    function isPartFilled(item, qIdx, partIdx) {
        if (currentMode === 'prof') {
            return partIdx < item.num;
        }
        return userAnswers[qIdx]?.includes(partIdx) || false;
    }

    /**
     * Bascule l'√©tat d'une part (mode √©l√®ve uniquement)
     */
    function togglePart(qIdx, pIdx) {
        if (currentMode === 'prof') return;
        
        if (!userAnswers[qIdx]) {
            userAnswers[qIdx] = [];
        }
        
        const pos = userAnswers[qIdx].indexOf(pIdx);
        if (pos > -1) {
            userAnswers[qIdx].splice(pos, 1);
        } else {
            userAnswers[qIdx].push(pIdx);
        }
        
        // Rafra√Æchit le SVG
        const container = document.getElementById(`svg-cont-${qIdx}`);
        if (container) {
            container.innerHTML = createFractionSVG(currentQuestions[qIdx], qIdx);
        }
    }

    // ===== G√âN√âRATION DU QUIZ =====
    
    /**
     * Parse une ligne de donn√©es et retourne un objet question
     */
    function parseQuestionLine(line) {
        const parts = line.split(';');
        const fraction = parts[0].trim();
        const fractionParts = fraction.split('/');
        
        return {
            frac: fraction,
            num: parseInt(fractionParts[0]),
            den: parseInt(fractionParts[1]),
            type: parts[1]?.toLowerCase().includes('bande') ? 'bande' : 'disque'
        };
    }

    /**
     * G√©n√®re le quiz √† partir des donn√©es saisies
     */
    function generateQuiz() {
        const text = document.getElementById('quiz-data').value.trim();
        if (!text) return;
        
        // Parse les lignes
        let lines = text.split('\n')
            .filter(l => l.trim() !== '')
            .slice(0, MAX_QUESTIONS);
        
        // R√©initialise l'√©tat
        userAnswers = {};
        isCorr = false;
        
        // Parse les questions
        currentQuestions = lines
            .map(parseQuestionLine)
            .filter(q => !isNaN(q.num) && !isNaN(q.den));

        // Affiche les questions
        render();

        // G√®re le chronom√®tre
        if (currentMode === 'prof') {
            clearInterval(countdown);
            document.getElementById('timer-display').classList.add('hidden');
        } else {
            startTimer();
        }

        // G√®re l'affichage du bouton de validation
        const validateBtn = document.getElementById('validate-btn');
        validateBtn.style.display = currentMode === 'prof' ? 'none' : 'flex';

        // Bascule les zones d'affichage
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('container-retour-liste').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    /**
     * Affiche les questions dans la grille
     */
    function render() {
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = '';
        
        // Application de 2 colonnes sur mobile uniquement en mode Prof
        grid.className = currentMode === 'prof' 
            ? "grid grid-cols-2 md:grid-cols-3 gap-3"
            : "grid grid-cols-1 md:grid-cols-3 gap-3";

        currentQuestions.forEach((q, i) => {
            const [n, d] = q.frac.split('/');
            const card = `
                <div class="q-card">
                    <div class="math-fraction">
                        <span>${n}</span>
                        <span class="fraction-bar"></span>
                        <span>${d}</span>
                    </div>
                    <div id="svg-cont-${i}" class="w-full flex justify-center">
                        ${createFractionSVG(q, i)}
                    </div>
                    <div id="res-${i}" class="hidden text-[10px] font-black uppercase mt-2"></div>
                </div>
            `;
            grid.innerHTML += card;
        });
    }

    // ===== GESTION DU CHRONOM√àTRE =====
    
    /**
     * D√©marre le chronom√®tre
     */
    function startTimer() {
        clearInterval(countdown);
        
        const mins = parseInt(document.getElementById('t-min').value) || 0;
        const secs = parseInt(document.getElementById('t-sec').value) || 0;
        let timeLeft = (mins * 60) + secs;

        if (timeLeft <= 0) {
            document.getElementById('timer-display').classList.add('hidden');
            return;
        }
        
        document.getElementById('timer-display').classList.remove('hidden');
        const display = document.getElementById('seconds-left');
        
        countdown = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            display.innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft-- <= 0) {
                clearInterval(countdown);
                showCorrection();
            }
        }, 1000);
    }

    // ===== GESTION DE LA CORRECTION =====
    
    /**
     * Affiche ou masque la correction
     */
    function showCorrection() {
        isCorr = !isCorr;
        
        currentQuestions.forEach((q, i) => {
            const resElement = document.getElementById(`res-${i}`);
            const isCorrect = userAnswers[i]?.length === q.num;
            
            resElement.innerHTML = isCorrect 
                ? '<span class="text-green-500">‚úÖ Juste</span>' 
                : '<span class="text-red-500">‚ùå Faux</span>';
            
            resElement.classList.toggle('hidden', !isCorr);
        });
        
        const validateBtn = document.getElementById('validate-btn');
        validateBtn.innerHTML = isCorr ? "üôà masquer" : "üëÅÔ∏è correction";
    }

    // ===== EXPORT PDF =====
    
    /**
     * Exporte le quiz en PDF
     */
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // G√©n√©ration du nom de fichier avec date
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const filename = `outilsprofs_fractions_${dateStr}.pdf`;
        
        const titre = document.getElementById('quiz-title').value || "Fractions";
        const accent = getAccentColor();
        
        // G√©n√®re les deux pages (√©nonc√© + correction)
        drawQuestions(doc, titre, accent, false);
        doc.addPage();
        drawQuestions(doc, titre, accent, true);

        // Sauvegarde
        if (window.Android && window.Android.savePdfFromBase64) {
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            window.Android.savePdfFromBase64(pdfBase64, filename);
        } else {
            doc.save(filename);
        }
    }

    /**
     * Dessine les questions dans le PDF
     */
    function drawQuestions(doc, titre, accentColor, isCorrection) {
        // Titre
        doc.setFontSize(18);
        doc.text(titre + (isCorrection ? " - Correction" : ""), 105, 20, { align: "center" });
        
        let x = 20, y = 45;

        currentQuestions.forEach((q, i) => {
            // Nouvelle page si n√©cessaire
            if (y > 250) {
                doc.addPage();
                y = 30;
            }
            
            // Affiche la fraction
            const [n, d] = q.frac.split('/');
            doc.setFontSize(14);
            doc.text(n, x + 25, y - 8, { align: "center" });
            doc.line(x + 21, y - 6.5, x + 29, y - 6.5);
            doc.text(d, x + 25, y - 2, { align: "center" });
            
            // Dessine la forme
            if (q.type === 'disque') {
                drawPDFDisk(doc, x, y, q, accentColor, isCorrection);
            } else {
                drawPDFBand(doc, x, y, q, accentColor, isCorrection);
            }
            
            // Positionnement suivant
            x += 65;
            if (x > 160) {
                x = 20;
                y += 70;
            }
        });
    }

    /**
     * Dessine un disque dans le PDF
     */
    function drawPDFDisk(doc, x, y, item, accentColor, showFilled) {
        const cx = x + 25, cy = y + 20, r = 18;
        
        // Remplit les parts si n√©cessaire
        if (showFilled || currentMode === 'prof') {
            doc.setFillColor(accentColor);
            for (let j = 0; j < item.num; j++) {
                const startAngle = (j * 360 / item.den - 90);
                const endAngle = ((j + 1) * 360 / item.den - 90);
                
                for (let a = startAngle; a < endAngle; a += 2) {
                    const a1 = a * Math.PI / 180;
                    const a2 = (a + 2.1) * Math.PI / 180;
                    doc.triangle(
                        cx, cy,
                        cx + r * Math.cos(a1), cy + r * Math.sin(a1),
                        cx + r * Math.cos(a2), cy + r * Math.sin(a2),
                        'F'
                    );
                }
            }
        }
        
        // Dessine le cercle et les divisions
        doc.circle(cx, cy, r, 'S');
        for (let j = 0; j < item.den; j++) {
            const ang = (j * 360 / item.den - 90) * Math.PI / 180;
            doc.line(cx, cy, cx + r * Math.cos(ang), cy + r * Math.sin(ang));
        }
    }

    /**
     * Dessine une bande dans le PDF
     */
    function drawPDFBand(doc, x, y, item, accentColor, showFilled) {
        const bx = x, by = y + 10, w = 50, h = 15;
        const step = w / item.den;
        
        // Remplit les parts si n√©cessaire
        if (showFilled || currentMode === 'prof') {
            doc.setFillColor(accentColor);
            doc.rect(bx, by, step * item.num, h, 'F');
        }
        
        // Dessine le rectangle et les divisions
        doc.rect(bx, by, w, h, 'S');
        for (let j = 0; j <= item.den; j++) {
            doc.line(bx + j * step, by, bx + j * step, by + h);
        }
    }

    // ===== NAVIGATION =====
    
    /**
     * Retourne √† l'√©cran de configuration
     */
    function retourReglages() {
        clearInterval(countdown);
        document.getElementById('game-zone').classList.add('hidden');
        document.getElementById('setup-zone').classList.remove('hidden');
        document.getElementById('container-retour-liste').classList.remove('hidden');
    }

    // ===== INITIALISATION =====
    
    window.onload = () => {
        appliquerTheme();
    };
</script>
</body>
</html>
