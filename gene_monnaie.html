<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G√©n√©rateur de Monnaie - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --accent-color: #06b6d4;
        }
        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }
        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }
        .main-wrapper { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .money-item { display: inline-flex; align-items: center; justify-content: center; margin: 4px; font-weight: 900; color: #111827; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .billet { width: 65px; height: 35px; border-radius: 4px; font-size: 11px; }
        .piece { width: 35px; height: 35px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); font-size: 10px; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white; transition: all 0.2s ease; text-transform: uppercase; }
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1>La Monnaie</h1>
    <button id="btn-aide" onclick="ouvrirModal('modal-aide')" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4 text-left">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest">Nombre de d√©fis (1-10)</label>
            <input type="number" id="nb-questions" class="input-field" value="5" min="1" max="10">
        </div>
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest">Difficult√©</label>
            <select id="difficulte" class="input-field">
                <option value="easy">Facile (Entiers seulement)</option>
                <option value="medium">Moyen (Avec centimes)</option>
                <option value="expert">Expert (Centimes cumul√©s > 1‚Ç¨)</option>
            </select>
        </div>
        <button id="mainAddBtn" onclick="generateExercise()" class="btn-add">G√©n√©rer les d√©fis</button>
    </div>

    <div id="game-zone" class="hidden space-y-6">
        <div id="exercise-content" class="space-y-4"></div>
        <div class="grid grid-cols-2 gap-4 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500 col-span-2">üìÑ √©dition PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4 text-center">üìñ Guide d'utilisation</h2>
        <div class="text-[12px] leading-relaxed space-y-4 opacity-90 overflow-y-auto max-h-[60vh] pr-2">
            <div>
                <p class="font-bold text-[10px] uppercase text-cyan-500 mb-1">üéØ Objectif</p>
                <p>Calculer la somme totale des pi√®ces et billets pour travailler le calcul mental et la monnaie.</p>
            </div>
            <div>
                <p class="font-bold text-[10px] uppercase text-cyan-500 mb-1">‚öôÔ∏è Difficult√©s</p>
                <ul class="list-disc ml-4 space-y-1">
                    <li><strong>Facile :</strong> Nombres entiers (1‚Ç¨ √† 50‚Ç¨).</li>
                    <li><strong>Moyen :</strong> Pi√®ces de centimes classiques.</li>
                    <li><strong>Expert :</strong> Grosses sommes et beaucoup de petites pi√®ces (> 100c).</li>
                </ul>
            </div>
            <div>
                <p class="font-bold text-[10px] uppercase text-cyan-500 mb-1">üñ®Ô∏è PDF</p>
                <p>G√©n√®re une fiche propre avec les exercices et une page de correction.</p>
            </div>
        </div>
        <button onclick="fermerModal('modal-aide')" id="btn-fermer-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Fermer</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    
    // NOUVELLES COULEURS R√âALISTES
    const COULEURS_MONNAIE = { 
        200: '#fde68a', 100: '#dcfce7', 50: '#f9a8d4', 20: '#93c5fd', 10: '#fca5a5', 5: '#86efac', 
        2: '#e5e7eb', 1: '#fef08a',
        0.50: '#fbbf94', 0.20: '#fbbf54', 0.10: '#fbbf34',
        0.05: '#f97316', 0.02: '#f97336', 0.01: '#f97356'
    };

    let currentQuestions = [];
    let isShowingCorrection = false;

    function generateExercise() {
    const nb = document.getElementById('nb-questions').value;
    const mode = document.getElementById('difficulte').value;
    const container = document.getElementById('exercise-content');
    container.innerHTML = "";
    currentQuestions = [];

    // √âchelle de taille pour l'√©cran (ratio bas√© sur 35px)
    const taillesEcran = { 
        2: 1.15, 1: 1.05, 0.50: 1.0, 0.20: 0.95, 
        0.10: 0.85, 0.05: 0.90, 0.02: 0.80, 0.01: 0.75 
    };

    for (let i = 0; i < nb; i++) {
        let total = 0;
        let items = [];
        let pool, nbItems;

        if (mode === 'easy') {
            nbItems = Math.floor(Math.random() * 3) + 3;
            pool = [50, 20, 10, 5, 2, 1];
        } else if (mode === 'medium') {
            nbItems = Math.floor(Math.random() * 4) + 4;
            pool = [50, 20, 10, 5, 2, 1, 0.50, 0.20, 0.10, 0.05];
        } else {
            nbItems = Math.floor(Math.random() * 6) + 8;
            pool = [200, 100, 50, 20, 10, 5, 2, 1, 0.50, 0.50, 0.20, 0.20, 0.10, 0.05, 0.02, 0.01];
        }

        for (let j = 0; j < nbItems; j++) {
            let val = pool[Math.floor(Math.random() * pool.length)];
            items.push(val);
            total += val;
        }

        currentQuestions.push({ items, total: total.toFixed(2) });

        const card = document.createElement('div');
        card.className = "light-card flex flex-col items-center gap-4";
        const moneyContainer = document.createElement('div');
        moneyContainer.className = "flex flex-wrap justify-center items-center gap-2"; // gap ajout√© pour les tailles vari√©es
        
        items.sort((a,b) => b-a).forEach(val => {
            const el = document.createElement('div');
            const color = COULEURS_MONNAIE[val] || '#ccc';
            
            if (val >= 5) {
                el.className = "money-item billet";
                el.style.backgroundColor = color;
                el.textContent = val + " ‚Ç¨";
            } else {
                el.className = "money-item piece";
                // Application de la taille d√©gressive
                const ratio = taillesEcran[val] || 1;
                el.style.width = (35 * ratio) + "px";
                el.style.height = (35 * ratio) + "px";
                el.style.fontSize = (10 * ratio) + "px";
                el.style.backgroundColor = color;

                // Application du liser√© bicolore
                if (val === 2) {
                    el.style.border = "3px solid #fbbf24"; // Or autour
                    el.style.backgroundColor = "#e5e7eb"; // Argent dedans
                } else if (val === 1) {
                    el.style.border = "3px solid #e5e7eb"; // Argent autour
                    el.style.backgroundColor = "#fef08a"; // Or dedans
                }
                
                el.textContent = val >= 1 ? val + "‚Ç¨" : (val*100).toFixed(0) + "c";
            }
            moneyContainer.appendChild(el);
        });

        card.appendChild(moneyContainer);
        card.innerHTML += `<input type="text" placeholder="Total ?" class="input-field text-center money-input" data-answer="${total.toFixed(2)}">`;
        container.appendChild(card);
    }

    document.getElementById('setup-zone').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
}

    function showCorrection() {
        const inputs = document.querySelectorAll('.money-input');
        const btn = document.getElementById('validate-btn');
        if (!isShowingCorrection) {
            inputs.forEach(i => {
                const userVal = parseFloat(i.value.replace(',', '.')).toFixed(2);
                i.value = i.dataset.answer + " ‚Ç¨";
                i.style.color = (userVal === i.dataset.answer) ? '#10b981' : '#ef4444';
                i.disabled = true;
            });
            btn.innerHTML = "üôà masquer";
            btn.classList.replace('bg-green-500', 'bg-orange-500');
            isShowingCorrection = true;
        } else {
            inputs.forEach(i => { i.value = ""; i.style.color = ""; i.disabled = false; });
            btn.innerHTML = "üëÅÔ∏è correction";
            btn.classList.replace('bg-orange-500', 'bg-green-500');
            isShowingCorrection = false;
        }
    }

    function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    
    const date = new Date();
    const dateStr = date.getFullYear() + String(date.getMonth() + 1).padStart(2, '0') + String(date.getDate()).padStart(2, '0');
    const fileName = `outilsprofs_monnaie_${dateStr}.pdf`;

    // √âchelle des rayons r√©els en mm pour le PDF
    const rayonsPDF = { 
        2: 5.8, 1: 5.2, 0.50: 5, 0.20: 4.5, 
        0.10: 4, 0.05: 4.3, 0.02: 3.8, 0.01: 3.4 
    };

    const drawPage = (isCorr) => {
        let y = 20;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(accent);
        doc.text(isCorr ? "Correction : La Monnaie" : "Exercice : La Monnaie", 105, y, { align: "center" });
        
        y += 15;
        doc.setFontSize(12);
        doc.setTextColor(60);
        doc.text("Consigne : Calcule la somme totale pour chaque s√©rie.", 20, y);
        y += 15;

        currentQuestions.forEach((q, idx) => {
            const nbLignes = Math.ceil(q.items.length / 5); 
            const hauteurBloc = Math.max(25, nbLignes * 14);

            if (y + hauteurBloc > 275) { doc.addPage(); y = 20; }

            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(`${idx + 1}.`, 15, y + 5);

            let xMonnaie = 25;
            let yMonnaie = y;
            const xLimite = 130; 

            q.items.sort((a, b) => b - a).forEach(val => {
                const r = rayonsPDF[val] || 4.5;
                
                // Retour √† la ligne si on d√©passe la colonne de gauche
                if (xMonnaie + (r * 2) > xLimite) { xMonnaie = 25; yMonnaie += 14; }
                
                const color = COULEURS_MONNAIE[val] || '#cccccc';

                if (val >= 5) {
                    // Dessin Billet
                    doc.setDrawColor(180);
                    doc.setFillColor(color);
                    doc.roundedRect(xMonnaie, yMonnaie, 18, 10, 1, 1, 'FD');
                    doc.setFontSize(7);
                    doc.setTextColor(0);
                    doc.text(`${val}‚Ç¨`, xMonnaie + 9, yMonnaie + 6.5, { align: 'center' });
                    xMonnaie += 22;
                } else {
                    // Dessin Pi√®ce
                    doc.setDrawColor(150);
                    doc.setFillColor(color);
                    doc.circle(xMonnaie + 5, yMonnaie + 5, r, 'FD');

                    // Liser√© bicolore pour 1‚Ç¨ et 2‚Ç¨
                    if (val === 2 || val === 1) {
                        const centreColor = (val === 2) ? '#f3f4f6' : '#fef08a';
                        doc.setDrawColor(180);
                        doc.setFillColor(centreColor);
                        doc.circle(xMonnaie + 5, yMonnaie + 5, r * 0.7, 'FD');
                    }

                    doc.setFontSize(r > 4.5 ? 6 : 5);
                    doc.setTextColor(0);
                    const label = val >= 1 ? `${val}‚Ç¨` : `${(val * 100).toFixed(0)}c`;
                    doc.text(label, xMonnaie + 5, yMonnaie + 6, { align: 'center' });
                    xMonnaie += (r * 2) + 2;
                }
            });

            // Colonne de droite pour la r√©ponse
            doc.setFontSize(11);
            doc.setTextColor(0);
            const reponseLabel = isCorr ? `Total : ${q.total} ‚Ç¨` : "Total : ............... ‚Ç¨";
            doc.text(reponseLabel, 145, y + 7);

            y = Math.max(yMonnaie + 15, y + 15);
            doc.setDrawColor(240);
            doc.line(20, y - 2, 190, y - 2);
            y += 5;
        });
    };

    drawPage(false); 
    doc.addPage(); 
    drawPage(true);

    const pdfBase64 = doc.output('datauristring');
    const link = document.createElement('a');
    link.href = pdfBase64;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        document.documentElement.style.setProperty('--accent-color', hexa);
        [document.getElementById('btn-retour-header'), document.getElementById('btn-retour-liste'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-fermer-aide')].forEach(el => { if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; } });
        if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
    }

    function ouvrirModal(id) { document.getElementById(id).style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    function retourReglages() { document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    window.onload = appliquerTheme;
</script>
</body>
</html>