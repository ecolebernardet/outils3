<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mots M√™l√©s - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 450px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 600; font-size: 12px; 
            border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .grid-container { position: relative; margin: 10px auto; width: fit-content; border-radius: 8px; overflow: hidden; }
        #word-grid { display: grid; gap: 2px; background: var(--column-border); border: 2px solid var(--column-border); position: relative; z-index: 2; }
        .grid-cell { width: 100%; height: 100%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-weight: 800; text-transform: uppercase; position: relative; z-index: 3; }
        
        /* Le canvas est maintenant plac√© au m√™me niveau que les cellules mais avec un z-index inf√©rieur */
        #correction-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }

        .bottom-nav { width: 100%; max-width: 450px; margin: 20px auto 0; display: flex; flex-direction: column; gap: 8px; }
        .nav-group { display: flex; gap: 8px; width: 100%; }
        .nav-btn { font-weight: 900; border-radius: 50px; font-size: 9px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Mots M√™l√©s</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>
    
    <div id="setup-zone" class="light-card space-y-6">
        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">Th√©matiques rapides</label>
            <select id="theme-selector" onchange="appliquerThematique()" class="input-field">
                <option value="">-- Choisir un th√®me --</option>
                <option value="animaux">üêæ Animaux</option>
                <option value="ecole">üè´ √âcole</option>
                <option value="corps">üë§ Corps Humain</option>
                <option value="noel">üéÑ No√´l</option>
                <option value="fruits">üçé Fruits & L√©gumes</option>
                <option value="pays">üåç Pays</option>
                <option value="sports">‚öΩ Sports</option>
                <option value="musique">üé∏ Instruments</option>
                <option value="espace">üöÄ Espace</option>
                <option value="couleurs">üé® Couleurs</option>
            </select>
        </div>

        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">Titre de la grille</label>
            <input type="text" id="grid-title" placeholder="Ex: Les Animaux" class="input-field text-left">
        </div>

        <div>
            <div class="flex justify-between items-end mb-2">
                <label class="text-[10px] font-black uppercase opacity-50 tracking-widest">Liste des mots</label>
                <span id="word-count" class="text-[10px] font-black opacity-50">0 MOTS</span>
            </div>
            <textarea id="word-list" rows="4" class="input-field text-left" placeholder="Lion, Tigre, Elephant..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Taille (Max 20)</label>
                <input type="number" id="grid-size" value="10" min="5" max="20" class="input-field text-center">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Difficult√©</label>
                <select id="difficulty" class="input-field">
                    <option value="easy">Facile (H/V √† l'endroit)</option>
                    <option value="hard">Difficile (+ Diagonales)</option>
                    <option value="expert">Expert (Toutes directions + Envers)</option>
                </select>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <button onclick="viderSiRempli()" class="text-[10px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity py-2">
                üóëÔ∏è Vider le formulaire
            </button>
            <button id="mainAddBtn" onclick="generateWordSearch()" class="btn-add">G√©n√©rer la grille</button>
            <label class="btn-add bg-black text-white cursor-pointer flex items-center justify-center gap-2 mt-2">
                üëá charger un fichier .txt üëá
                <input type="file" class="hidden" accept=".txt" onchange="importData(event)">
            </label>
        </div>
    </div>
    
    <div id="game-zone" class="hidden space-y-6">
        <h2 id="display-title" class="text-center font-black uppercase tracking-widest"></h2>
        
        <div class="grid-container">
            <canvas id="correction-canvas"></canvas>
            <div id="word-grid"></div>
        </div>

        <div id="words-to-find" class="grid grid-cols-3 gap-x-4 gap-y-1 text-[10px] font-bold opacity-70 max-w-[300px] mx-auto"></div>
        
        <div class="flex flex-col items-center gap-3 mt-10">
            <button id="btn-reveal" onclick="toggleCorrection()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md">
                üëÅÔ∏è Afficher la correction
            </button>
            <button id="btn-shuffle" onclick="generateWordSearch()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md opacity-50">
                üîÑ M√©langer la grille
            </button>
        </div>

        <footer class="bottom-nav">
            <div class="nav-group">
                <button onclick="exportToTXT()" class="nav-btn bg-black text-white flex-1">üëÜ exporter .txt üëÜ</button>
                <button onclick="exportToPDF()" class="nav-btn bg-black text-white flex-1">üìÑ exporter .pdf</button>
            </div>
            <button onclick="retourReglages()" class="nav-btn bg-gray-500 text-white shadow-lg text-xs">‚¨ÖÔ∏è retour aux r√©glages</button>
        </footer>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content !max-w-[450px] max-h-[90vh] overflow-y-auto !p-0 flex flex-col" onclick="event.stopPropagation()">
        
        <div class="p-6 border-b border-black border-opacity-5 sticky top-0 bg-inherit z-10">
            <h2 class="text-xl font-black uppercase tracking-tighter flex items-center gap-3">
                <span id="aide-emoji">üí°</span> <span id="aide-titre-dynamique">G√©n√©rateur de mots m√™l√©s</span>
            </h2>
        </div>

        <div class="p-6 space-y-6">
            
            <div class="flex gap-4">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-black bg-opacity-5 flex items-center justify-center font-black text-xs">1</div>
                <div>
                    <h3 class="font-black uppercase text-xs mb-1">Configuration</h3>
                    <p class="text-[11px] leading-relaxed opacity-70">Saisissez vos mots s√©par√©s par une <b>virgule</b> (ex: Chat, Chien, Lapin). R√©glez la taille de la grille (max 20) et le niveau de difficult√©.</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-black bg-opacity-5 flex items-center justify-center font-black text-xs">2</div>
                <div>
                    <h3 class="font-black uppercase text-xs mb-1">G√©n√©ration & Jeu</h3>
                    <p class="text-[11px] leading-relaxed opacity-70">Cliquez sur <b>G√©n√©rer</b>. Le bouton üí° dans la barre de titre permet de revenir √† ce guide √† tout moment, m√™me pendant que vous jouez.</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-black bg-opacity-5 flex items-center justify-center font-black text-xs">3</div>
                <div>
                    <h3 class="font-black uppercase text-xs mb-1">Correction Dynamique</h3>
                    <p class="text-[11px] leading-relaxed opacity-70">Utilisez le bouton <b>"Afficher la correction"</b> pour r√©v√©ler les mots avec un trac√© color√©. Cliquez sur <b>"Cacher"</b> pour reprendre votre recherche.</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-black bg-opacity-5 flex items-center justify-center font-black text-xs">4</div>
                <div>
                    <h3 class="font-black uppercase text-xs mb-1">Export PDF & TXT</h3>
                    <p class="text-[11px] leading-relaxed opacity-70">L'export <b>PDF</b> g√©n√®re la grille et sa correction sur deux pages distinctes. L'export <b>TXT</b> permet de sauvegarder vos mots pour plus tard.</p>
                </div>
            </div>
        </div>

        <div class="p-6 pt-0">
            <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg transition-transform active:scale-95">
                C'est compris !
            </button>
        </div>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    const themes = {
        animaux: "Lion, Tigre, Elephant, Girafe, Zebre, Singe, Kangourou, Panda, Renard, Loup, Ours, Lapin",
        ecole: "Crayon, Cahier, Gomme, Stylo, Maitre, Classe, Bureau, Ardoise, Ecole, Livre, Cartable, Regle",
        corps: "Tete, Epaule, Genou, Pied, Main, Bras, Jambe, Doigt, Ventre, Dos, Bouche, Nez, Oreille, Yeux",
        noel: "Sapin, Cadeau, Lutin, Traineau, Etoile, Boule, Guirlande, Flocon, Neige, Hotte, Renne, Noel",
        fruits: "Pomme, Banane, Fraise, Orange, Poire, Cerise, Raisin, Ananas, Melon, Peche, Kiwi, Citron",
        pays: "France, Italie, Espagne, Belgique, Suisse, Canada, Japon, Bresil, Maroc, Algerie, Chine, Inde",
        sports: "Football, Basket, Tennis, Judo, Natation, Rugby, Karate, Escrime, Boxe, Danse, Yoga, Ski",
        musique: "Piano, Guitare, Violon, Flute, Trompette, Batterie, Harpe, Saxophone, Orgue, Violoncelle, Tambour",
        espace: "Soleil, Lune, Terre, Mars, Jupiter, Saturne, Planete, Etoile, Galaxie, Comete, Fusee, Astronaute",
        couleurs: "Rouge, Bleu, Vert, Jaune, Orange, Violet, Marron, Rose, Blanc, Noir, Gris, Beige"
    };

    let finalGrid = [];
    let gridSize = 10;
    let isRevealed = false;
    window.placedWords = [];

    document.getElementById('word-list').addEventListener('input', function(e) {
        const count = e.target.value.split(',').map(w => w.trim()).filter(w => w.length > 0).length;
        document.getElementById('word-count').innerText = `${count} MOTS`;
    });

    function appliquerThematique() {
        const select = document.getElementById('theme-selector');
        const themeKey = select.value;
        if (themeKey && themes[themeKey]) {
            document.getElementById('word-list').value = themes[themeKey];
            document.getElementById('grid-title').value = select.options[select.selectedIndex].text.replace(/^[^\s]+\s/, '');
            const count = themes[themeKey].split(',').length;
            document.getElementById('word-count').innerText = `${count} MOTS`;
        }
    }

    function viderSiRempli() {
        const titre = document.getElementById('grid-title').value.trim();
        const mots = document.getElementById('word-list').value.trim();
        if (titre !== "" || mots !== "") document.getElementById('modal-confirm-vider').style.display = 'flex';
    }

    function executerVidage() {
        document.getElementById('grid-title').value = "";
        document.getElementById('word-list').value = "";
        document.getElementById('grid-size').value = 10;
        document.getElementById('word-count').innerText = "0 MOTS";
        fermerModal('modal-confirm-vider');
    }

    function cleanStringForFilename(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '');
    }

    function canPlace(word, r, c, dr, dc) {
        const lastR = r + (word.length - 1) * dr;
        const lastC = c + (word.length - 1) * dc;
        if (lastR >= gridSize || lastR < 0 || lastC >= gridSize || lastC < 0) return false;
        for (let i = 0; i < word.length; i++) {
            const char = finalGrid[r + i * dr][c + i * dc];
            if (char !== '' && char !== word[i]) return false;
        }
        return true;
    }

    function generateWordSearch() {
        const title = document.getElementById('grid-title').value || "Mots M√™l√©s";
        const rawWords = document.getElementById('word-list').value;
        gridSize = parseInt(document.getElementById('grid-size').value) || 10;
        if (!rawWords || rawWords.trim() === "") { return; }

        const words = rawWords.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0);
        finalGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
        window.placedWords = [];
        isRevealed = false;

        words.forEach(word => {
            let placed = false, attempts = 0;
            const diff = document.getElementById('difficulty').value;
            while (!placed && attempts < 150) {
                let dr = 0, dc = 0;
                if (diff === 'easy') {
                    const dir = Math.floor(Math.random() * 2);
                    if (dir === 0) dc = 1; else dr = 1;
                } else if (diff === 'hard') {
                    const dir = Math.floor(Math.random() * 3);
                    if (dir === 0) dc = 1; else if (dir === 1) dr = 1; else { dr = 1; dc = 1; }
                } else if (diff === 'expert') {
                    const directions = [[0,1],[0,-1],[1,0],[-1,0],[1,1],[-1,-1],[1,-1],[-1,1]];
                    const chosen = directions[Math.floor(Math.random() * directions.length)];
                    dr = chosen[0]; dc = chosen[1];
                }
                let r = Math.floor(Math.random() * gridSize), c = Math.floor(Math.random() * gridSize);
                if (canPlace(word, r, c, dr, dc)) {
                    for (let i = 0; i < word.length; i++) finalGrid[r + i * dr][c + i * dc] = word[i];
                    window.placedWords.push({ r1: r, c1: c, r2: r + (word.length - 1) * dr, c2: c + (word.length - 1) * dc });
                    placed = true;
                }
                attempts++;
            }
        });

        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) {
                if (finalGrid[r][c] === '') finalGrid[r][c] = String.fromCharCode(65 + Math.floor(Math.random() * 26));
            }
        }
        renderGrid(title, words);
    }

    function renderGrid(title, words) {
        const gridEl = document.getElementById('word-grid');
        const canvas = document.getElementById('correction-canvas');
        const cellSize = Math.max(18, 40 - (gridSize * 1.1)); 
        const fontSize = Math.max(9, cellSize * 0.6);
        const gap = 2;
        
        gridEl.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
        gridEl.innerHTML = finalGrid.flat().map(l => `<div class="grid-cell" style="font-size: ${fontSize}px; width:${cellSize}px; height:${cellSize}px;">${l}</div>`).join('');
        
        // Taille pr√©cise du canvas (cellules + gaps + bordures)
        const totalSize = (gridSize * cellSize) + ((gridSize + 1) * gap);
        canvas.width = totalSize;
        canvas.height = totalSize;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        document.getElementById('display-title').innerText = title;
        const container = document.getElementById('words-to-find');
        container.innerHTML = words.sort((a,b)=>a.localeCompare(b,'fr')).map(w => `<span class="truncate">‚Ä¢ ${w}</span>`).join('');
        
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
        
        document.getElementById('btn-reveal').innerHTML = "üëÅÔ∏è Afficher la correction";
        appliquerTheme();
    }

    function toggleCorrection() {
        const canvas = document.getElementById('correction-canvas');
        const ctx = canvas.getContext('2d');
        const btnReveal = document.getElementById('btn-reveal');
        const cells = document.querySelectorAll('.grid-cell');
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        
        const cellSize = parseFloat(cells[0].style.width);
        const gap = 2;

        isRevealed = !isRevealed;

        if (isRevealed) {
            btnReveal.innerHTML = "üôà Cacher la correction";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = hexa;
            ctx.lineWidth = cellSize * 0.8;
            ctx.lineCap = "round";
            ctx.globalAlpha = 0.5;

            window.placedWords.forEach(word => {
                // Calcul du centre de la cellule en tenant compte de la bordure initiale et des gaps
                const x1 = gap + word.c1 * (cellSize + gap) + cellSize/2;
                const y1 = gap + word.r1 * (cellSize + gap) + cellSize/2;
                const x2 = gap + word.c2 * (cellSize + gap) + cellSize/2;
                const y2 = gap + word.r2 * (cellSize + gap) + cellSize/2;
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            });
            
            // Facultatif : on peut l√©g√®rement baisser l'opacit√© des cellules pour que le trait soit plus "fusionn√©"
            cells.forEach(c => c.style.background = "transparent");
        } else {
            btnReveal.innerHTML = "üëÅÔ∏è Afficher la correction";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            cells.forEach(c => c.style.background = "");
        }
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const rawTitle = document.getElementById('grid-title').value || "Mots M√™l√©s";
        const cleanTitle = cleanStringForFilename(rawTitle);
        const mots = document.getElementById('word-list').value.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0).sort((a, b) => a.localeCompare(b, 'fr'));
        const cellSize = 8, startX = (210 - (gridSize * cellSize)) / 2, startY = 40;

        doc.setFont("helvetica", "bold").setFontSize(18);
        doc.text(rawTitle, 105, 20, { align: "center" });
        finalGrid.forEach((row, r) => {
            row.forEach((letter, c) => {
                const x = startX + (c * cellSize), y = startY + (r * cellSize);
                doc.setDrawColor(180).setLineWidth(0.1).rect(x, y, cellSize, cellSize);
                doc.setTextColor(0).setFont("helvetica", "normal").setFontSize(11).text(letter, x + 4, y + 5.5, { align: "center" });
            });
        });
        let listY = startY + (gridSize * cellSize) + 15;
        doc.setFont("helvetica", "bold").setFontSize(11).text("MOTS √Ä TROUVER :", 20, listY);
        const nbLignes = Math.ceil(mots.length / 3);
        mots.forEach((m, i) => {
            const col = Math.floor(i / nbLignes), row = i % nbLignes;
            doc.setFont("helvetica", "normal").setFontSize(10).text("‚Ä¢ " + m, 20 + (col * 63), listY + 8 + (row * 7));
        });

        doc.addPage();
        doc.setFont("helvetica", "bold").setFontSize(18).text(rawTitle + " (CORRECTION)", 105, 20, { align: "center" });
        finalGrid.forEach((row, r) => {
            row.forEach((letter, c) => {
                const x = startX + (c * cellSize), y = startY + (r * cellSize);
                doc.setDrawColor(220).setLineWidth(0.1).rect(x, y, cellSize, cellSize);
            });
        });

        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        
        doc.setDrawColor(hexa); doc.setLineWidth(cellSize - 2.5); doc.setLineCap(2); 
        window.placedWords.forEach(word => {
            const dr = Math.sign(word.r2 - word.r1) || 0;
            const dc = Math.sign(word.c2 - word.c1) || 0;
            const x1 = startX + (word.c1 * cellSize) + 4;
            const y1 = startY + (word.r1 * cellSize) + 4;
            const x2 = startX + (word.c2 * cellSize) + 4;
            const y2 = startY + (word.r2 * cellSize) + 4;
            doc.setGState(new doc.GState({ opacity: 0.4 }));
            doc.line(x1, y1, x2, y2);
            doc.setGState(new doc.GState({ opacity: 1 }));
        });

        finalGrid.forEach((row, r) => {
            row.forEach((letter, c) => {
                const x = startX + (c * cellSize), y = startY + (r * cellSize);
                doc.setTextColor(0).setFont("helvetica", "bold").setFontSize(11).text(letter, x + 4, y + 5.5, { align: "center" });
            });
        });
        doc.save(`outilsprofs_mots_meles_${cleanTitle}.pdf`);
    }

    function exportToTXT() {
        const rawTitle = document.getElementById('grid-title').value || "grille";
        const data = { title: rawTitle, words: document.getElementById('word-list').value, size: gridSize, diff: document.getElementById('difficulty').value };
        const blob = new Blob([JSON.stringify(data)], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `outilsprofs_mots_meles_${cleanStringForFilename(rawTitle)}.txt`; a.click();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                document.getElementById('grid-title').value = d.title || "";
                document.getElementById('word-list').value = d.words || "";
                document.getElementById('grid-size').value = d.size || 10;
                document.getElementById('difficulty').value = d.diff || "easy";
                retourReglages();
            } catch(err) { alert("Fichier invalide"); }
        };
        reader.readAsText(event.target.files[0]);
    }

    function appliquerTheme() {
        if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.gen || 'cyan') ? '#000' : '#fff';
		// Application au titre et au bouton de la modale
		const titreAide = document.getElementById('aide-titre-dynamique');
		const btnFermerAide = document.getElementById('btn-fermer-aide');
		if (titreAide) titreAide.style.color = hexa;
if (btnFermerAide) {
    btnFermerAide.style.backgroundColor = hexa;
    btnFermerAide.style.color = contrast;
}
        [document.getElementById('btn-retour-header'), document.getElementById('btn-retour-liste'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-shuffle'), document.getElementById('btn-reveal')].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
    }

    function retourReglages() { 
        document.getElementById('setup-zone').classList.remove('hidden'); 
        document.getElementById('game-zone').classList.add('hidden'); 
    }
    
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onload = appliquerTheme;
</script>
</body>
</html>