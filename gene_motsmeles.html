<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mots M√™l√©s - OutilsProfs</title>
    
    <!-- Biblioth√®ques externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ===== POLICES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ===== VARIABLES CSS ===== */
        :root {
            --bg-page: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        /* Mode clair */
        body.light-mode {
            --bg-page: #eeeeee;
            --card-bg: #ffffff;
            --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* ===== STYLES GLOBAUX ===== */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
        }
        
        /* ===== HEADER ===== */
        header { 
            background: var(--card-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%;
            margin-bottom: 12px;
        }

        .ui-btn-round {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ===== CONTENEUR PRINCIPAL ===== */
        .main-wrapper { 
            width: 100%; 
            max-width: 1000px;
            margin: 0 auto; 
            padding: 10px 15px 40px; 
        }
        
        .light-card {
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 20px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
            margin-bottom: 20px;
        }
        
        /* ===== FORMULAIRES ===== */
        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.75rem;
            padding: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            width: 100%;
            color: var(--text-main);
            outline: none;
        }

        .section-label {
            display: block;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            opacity: 0.5;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        
        /* ===== BOUTONS ===== */
        .btn-add {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        /* ===== GRILLE DE JEU ===== */
        .grid-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            width: 100%;
            min-height: 300px;
            overflow: hidden;
        }
        
        #word-grid {
            display: grid;
            gap: 2px;
            z-index: 10;
            pointer-events: auto;
        }

        .grid-cell {
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            text-transform: uppercase;
            position: relative;
            z-index: 3;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .grid-cell.selected {
            color: white;
            border-radius: 4px;
        }

        .word-found {
            text-decoration: line-through;
            opacity: 0.3;
            transition: all 0.3s ease;
            color: gray !important;
        }

        #correction-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            pointer-events: none;
        }

        /* ===== NAVIGATION ===== */
        .bottom-nav {
            width: 100%;
            max-width: 600px;
            margin: 20px auto 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .nav-btn {
            font-weight: 900;
            border-radius: 50px;
            font-size: 9px;
            padding: 12px;
            border: none;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
        }

        /* ===== MODALES ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
            position: relative;
        }
    </style>
</head>
<body>

<!-- Initialisation du th√®me -->
<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<!-- ===== HEADER ===== -->
<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Mots M√™l√©s</h1>
    <button id="btn-aide" onclick="openModal('modal-aide')" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<!-- ===== CONTENEUR PRINCIPAL ===== -->
<div class="main-wrapper">
    <!-- Bouton retour g√©n√©rateurs -->
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>
    
    <!-- ===== ZONE DE CONFIGURATION ===== -->
    <div id="setup-zone" class="light-card space-y-6">
        <!-- S√©lecteur de th√®me -->
        <div>
            <label class="section-label">Th√©matiques rapides</label>
            <select id="theme-selector" onchange="applyTheme()" class="input-field">
                <option value="">-- Choisir un th√®me --</option>
                <option value="animaux">üêæ Animaux</option>
                <option value="ecole">üè´ √âcole</option>
                <option value="corps">üë§ Corps Humain</option>
                <option value="noel">üéÑ No√´l</option>
                <option value="fruits">üçé Fruits & L√©gumes</option>
                <option value="pays">üåç Pays</option>
                <option value="sports">‚öΩ Sports</option>
                <option value="musique">üé∏ Instruments</option>
                <option value="espace">üöÄ Espace</option>
                <option value="couleurs">üé® Couleurs</option>
                <option value="voiture">üöó Voiture</option>
                <option value="cuisine">üç≥ Cuisine</option>
                <option value="metiers">üë∑ M√©tiers</option>
                <option value="vetements">üëï V√™tements</option>
                <option value="maison">üè† Maison</option>
                <option value="meteo">‚òÅÔ∏è M√©t√©o</option>
                <option value="insectes">üêù Insectes</option>
                <option value="ocean">üåä Oc√©an</option>
                <option value="geometrie">üìê G√©om√©trie</option>
            </select>
        </div>

        <!-- Titre -->
        <div>
            <label class="section-label">Titre de la grille</label>
            <input type="text" id="grid-title" placeholder="Ex: Les Animaux" class="input-field text-left">
        </div>

        <!-- Liste des mots -->
        <div>
            <div class="flex justify-between items-end mb-2">
                <label class="section-label !mb-0">Liste des mots</label>
                <span id="word-count" class="text-[10px] font-black opacity-50">0 MOTS</span>
            </div>
            <textarea id="word-list" rows="4" class="input-field text-left" placeholder="Lion, Tigre, Elephant..."></textarea>
        </div>

        <!-- Param√®tres -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="section-label text-center">Taille (Max 20)</label>
                <input type="number" id="grid-size" value="10" min="5" max="20" class="input-field text-center">
            </div>
            <div>
                <label class="section-label text-center">Difficult√©</label>
                <select id="difficulty" class="input-field">
                    <option value="easy">Facile (H/V √† l'endroit)</option>
                    <option value="hard">Difficile (+ Diagonales)</option>
                    <option value="expert">Expert (Toutes directions + Envers)</option>
                </select>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-2">
            <button onclick="clearForm()" class="text-[10px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity py-2">
                üóëÔ∏è Vider le formulaire
            </button>
            <button id="mainAddBtn" onclick="generateWordSearch()" class="btn-add">G√©n√©rer la grille</button>
            <label class="btn-add bg-black text-white cursor-pointer flex items-center justify-center gap-2 mt-2">
                üëá charger un fichier .txt üëá
                <input type="file" class="hidden" accept=".txt" onchange="importData(event)">
            </label>
        </div>
    </div>
    
    <!-- ===== ZONE DE JEU ===== -->
    <div id="game-zone" class="hidden space-y-6">
        <h2 id="display-title" class="text-center font-black uppercase tracking-widest text-xl"></h2>
        
        <div id="game-layout" class="flex flex-col md:flex-row md:items-start md:justify-center gap-8">
            <div class="grid-container !m-0">
                <canvas id="correction-canvas"></canvas>
                <div id="word-grid"></div>
            </div>

            <div id="words-to-find" class="grid grid-cols-3 md:grid-cols-2 gap-x-4 gap-y-1 text-[15px] font-bold opacity-70 w-full md:max-w-[250px]"></div>
        </div>

        <div class="flex flex-col items-center gap-3 mt-10">
            <button id="btn-reveal" onclick="toggleCorrection()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md">
                üëÅÔ∏è Afficher la correction
            </button>
            <button id="btn-shuffle" onclick="generateWordSearch()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md opacity-50">
                üîÑ M√©langer la grille
            </button>
        </div>

        <footer class="bottom-nav">
            <div class="nav-group">
                <button onclick="exportToTXT()" class="nav-btn bg-black text-white flex-1">üëÜ sauvegarder .txt üëÜ</button>
                <button onclick="exportToPDF()" class="nav-btn bg-black text-white flex-1">üìÑ √©diter .pdf</button>
            </div>
            <button onclick="returnToSettings()" class="nav-btn bg-gray-500 text-white shadow-lg text-xs">‚¨ÖÔ∏è retour aux r√©glages</button>
        </footer>
    </div>
</div>

<!-- ===== MODALE D'AIDE ===== -->
<div id="modal-aide" class="modal-overlay" onclick="closeModal('modal-aide')">
    <div class="modal-content !max-w-[450px] max-h-[90vh] overflow-y-auto !p-0 flex flex-col" onclick="event.stopPropagation()">
        <div class="p-6 border-b border-black border-opacity-5 sticky top-0 bg-inherit z-10">
            <h2 class="text-xl font-black uppercase tracking-tighter flex items-center gap-3">
                <span id="aide-emoji">üí°</span> <span id="aide-titre-dynamique">Les mots m√™l√©s</span>
            </h2>
        </div>
        <div class="p-6 space-y-6 text-[11px] leading-relaxed opacity-100">
            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>üìù</span> 1. Cr√©ation
                </p>
                <p>Saisissez vos mots s√©par√©s par une <b>virgule</b>, choisissez la taille de la grille et la difficult√©, puis cliquez sur <b>G√©n√©rer</b>.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>üîç</span> 2. Recherche
                </p>
                <p>Cliquez sur une lettre pour la <b>surligner</b>. Si vous faites une erreur, cliquez √† nouveau sur la lettre pour la <b>d√©s√©lectionner</b>.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>‚úÖ</span> 3. Progression
                </p>
                <p>Lorsqu'un mot est enti√®rement trouv√©, il se <b>barre automatiquement</b> dans la liste situ√©e sous la grille.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>üèÜ</span> 4. Victoire & Export
                </p>
                <p>Trouvez tous les mots pour gagner ! Vous pouvez aussi <b>exporter votre grille en PDF</b> pour l'imprimer ou en <b>TXT</b> pour la sauvegarder.</p>
            </div>
        </div>
        <div class="p-6 pt-0">
            <button onclick="closeModal('modal-aide')" id="btn-fermer-aide" class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg transition-transform active:scale-95">
                C'est compris !
            </button>
        </div>
    </div>
</div>

<!-- ===== MODALE DE VICTOIRE ===== -->
<div id="modal-bravo" class="modal-overlay" onclick="closeModal('modal-bravo')">
    <div class="modal-content text-center">
        <div class="text-6xl mb-4">üèÜ</div>
        <h2 class="text-2xl font-black uppercase mb-2" id="bravo-titre">Bravo !</h2>
        <p class="opacity-70 text-sm mb-6">Vous avez trouv√© tous les mots de la grille.</p>
        <button onclick="closeModal('modal-bravo')" class="btn-add bg-black text-white">Continuer</button>
    </div>
</div>

<script>
    // ==================== CONSTANTES ====================
    
    const COLOR_MAP = {
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
        'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
        'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
        'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
        'rose': '#f43f5e', 'gray': '#6b7280'
    };

    const THEMES = {
        animaux: "Lion, Tigre, Elephant, Girafe, Zebre, Singe, Kangourou, Panda, Renard, Loup, Ours, Lapin, tortue, vipere, aigle, moineau, grenouille, sardine",
        ecole: "Crayon, Cahier, Gomme, Stylo, Maitre, Classe, Bureau, Ardoise, Ecole, Livre, Cartable, Regle, cour, recreation, francais, mathematiques, histoire, geographie, sciences",
        corps: "Tete, Epaule, Genou, Pied, Main, Bras, Jambe, Doigt, Ventre, Dos, Bouche, Nez, Oreille, Yeux, cheville, coude, cou",
        noel: "Sapin, Cadeau, Lutin, Traineau, Etoile, Boule, Guirlande, Flocon, Neige, Hotte, Renne, Noel, lumiere, cheminee",
        fruits: "Pomme, Banane, Fraise, Orange, Poire, Cerise, Raisin, Ananas, Melon, Peche, Kiwi, Citron, abricot, framboise, myrtille, groseille",
        pays: "France, Italie, Espagne, Belgique, Suisse, Monaco, Andorre, Allemagne, Canada, Japon, Bresil, Maroc, Algerie, Tunisie, Turquie, Chine, Inde, Pakistan, Suede, Norvege, Mexique",
        sports: "Football, Basket, Tennis, Judo, Natation, Rugby, Karate, Escrime, Boxe, Danse, Yoga, Ski, handball, gymnastique, surf",
        musique: "Piano, Guitare, Violon, Flute, Trompette, Batterie, Harpe, Saxophone, Orgue, Violoncelle, Tambour",
        espace: "Soleil, Lune, Terre, Mars, Jupiter, Saturne, Planete, Etoile, Galaxie, Comete, Fusee, Astronaute",
        couleurs: "Rouge, Bleu, Vert, Jaune, Orange, Violet, Marron, Rose, Blanc, Noir, Gris, Beige",
        voiture: "Volant, Roue, Vitesse, Pedale, Frein, Porte, Siege, Coffre, Moteur, Embrayage",
        cuisine: "Po√™le, Casserole, Couteau, Four, Mixeur, Tablier, Recette, Assiette, Cuillere, Fourchette",
        metiers: "Docteur, Pompier, Policier, Boulanger, Avocat, Pilote, Facteur, Artiste, Juge, Marin",
        vetements: "Pantalon, Chemise, Robe, Jupe, Veste, Bonnet, Echarpe, Gants, Chaussette, Chaussure",
        maison: "Cuisine, Salon, Chambre, Jardin, Fenetre, Escalier, Toiture, Garage, Balcon, Entree",
        meteo: "Soleil, Nuage, Pluie, Orage, Eclair, Tempete, Brouillard, Neige, Ouragan, Arcenciel",
        insectes: "Abeille, Fourmi, Mouche, Papillon, Grillon, Cafard, Cigale, Gu√™pe, Libellule, Luciole",
        ocean: "Baleine, Requin, Dauphin, Tortue, Pieuvre, Corail, Algue, Meduse, Crevette, Etoile",
        geometrie: "Carre, Cercle, Triangle, Losange, Ovale, Cube, Sphere, Pyramide, Angle, Droite"
    };

    const STORAGE_KEYS = {
        theme: 'theme_tuiles',
        themeMode: 'theme_mode'
    };

    const DIFFICULTY_DIRECTIONS = {
        easy: () => Math.random() < 0.5 ? [0, 1] : [1, 0],
        hard: () => {
            const rand = Math.random();
            if (rand < 0.33) return [0, 1];
            if (rand < 0.66) return [1, 0];
            return [1, 1];
        },
        expert: () => {
            const dirs = [[0,1], [0,-1], [1,0], [-1,0], [1,1], [-1,-1], [1,-1], [-1,1]];
            return dirs[Math.floor(Math.random() * dirs.length)];
        }
    };

    // ==================== √âTAT DE L'APPLICATION ====================
    
    let finalGrid = [];
    let gridSize = 10;
    let isRevealed = false;
    window.placedWords = [];

    // ==================== UTILITAIRES ====================
    
    /**
     * Nettoie une cha√Æne pour cr√©er un nom de fichier valide
     */
    function cleanStringForFilename(str) {
        return str.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/gi, '');
    }

    /**
     * G√©n√®re un nom de fichier avec date
     */
    function generateFilename(prefix, title, extension) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const cleanTitle = cleanStringForFilename(title || "grille");
        return `outilsprofs_${prefix}_${cleanTitle}_${dateStr}.${extension}`;
    }

    /**
     * Retourne la couleur d'accent actuelle
     */
    function getAccentColor() {
        const themePrefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
        return COLOR_MAP[themePrefs.gen || 'cyan'];
    }

    /**
     * D√©termine si une couleur n√©cessite un texte sombre
     */
    function needsDarkText(colorKey) {
        const lightColors = ['yellow', 'lime', 'amber', 'cyan'];
        return lightColors.includes(colorKey);
    }

    // ==================== GESTION DES MODALES ====================
    
    /**
     * Ouvre une modale
     */
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    /**
     * Ferme une modale
     */
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // ==================== GESTION DU FORMULAIRE ====================
    
    /**
     * Met √† jour le compteur de mots
     */
    function updateWordCount() {
        const input = document.getElementById('word-list').value;
        const count = input.split(',')
            .map(w => w.trim())
            .filter(w => w.length > 0)
            .length;
        document.getElementById('word-count').innerText = `${count} MOTS`;
    }

    /**
     * Applique un th√®me pr√©d√©fini
     */
    function applyTheme() {
        const select = document.getElementById('theme-selector');
        const themeKey = select.value;
        
        if (themeKey && THEMES[themeKey]) {
            document.getElementById('word-list').value = THEMES[themeKey];
            document.getElementById('grid-title').value = select.options[select.selectedIndex].text.replace(/^[^\s]+\s/, '');
            updateWordCount();
        }
    }

    /**
     * Vide le formulaire apr√®s confirmation
     */
    function clearForm() {
        if (confirm("Voulez-vous vider le formulaire ?")) {
            document.getElementById('grid-title').value = "";
            document.getElementById('word-list').value = "";
            document.getElementById('grid-size').value = 10;
            document.getElementById('word-count').innerText = "0 MOTS";
        }
    }

    // ==================== G√âN√âRATION DE LA GRILLE ====================
    
    /**
     * V√©rifie si un mot peut √™tre plac√© √† une position donn√©e
     */
    function canPlaceWord(word, row, col, dirRow, dirCol) {
        const lastRow = row + (word.length - 1) * dirRow;
        const lastCol = col + (word.length - 1) * dirCol;
        
        // V√©rification des limites
        if (lastRow >= gridSize || lastRow < 0 || lastCol >= gridSize || lastCol < 0) {
            return false;
        }
        
        // V√©rification des conflits
        for (let i = 0; i < word.length; i++) {
            const current = finalGrid[row + i * dirRow][col + i * dirCol];
            if (current !== '' && current.char !== word[i]) {
                return false;
            }
        }
        
        return true;
    }

    /**
     * Place un mot dans la grille
     */
    function placeWord(word, row, col, dirRow, dirCol) {
        for (let i = 0; i < word.length; i++) {
            finalGrid[row + i * dirRow][col + i * dirCol] = {
                char: word[i],
                isSolution: true
            };
        }
        
        window.placedWords.push({
            r1: row,
            c1: col,
            r2: row + (word.length - 1) * dirRow,
            c2: col + (word.length - 1) * dirCol
        });
    }

    /**
     * Remplit les cases vides avec des lettres al√©atoires
     */
    function fillEmptyCells() {
        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) {
                if (finalGrid[r][c] === '') {
                    finalGrid[r][c] = {
                        char: String.fromCharCode(65 + Math.floor(Math.random() * 26)),
                        isSolution: false
                    };
                }
            }
        }
    }

    /**
     * G√©n√®re la grille de mots m√™l√©s
     */
    function generateWordSearch() {
        const title = document.getElementById('grid-title').value || "Mots M√™l√©s";
        const rawWords = document.getElementById('word-list').value;
        gridSize = parseInt(document.getElementById('grid-size').value) || 10;
        
        if (!rawWords.trim()) return;

        const words = rawWords.split(',')
            .map(w => w.trim().toUpperCase())
            .filter(w => w.length > 0 && w.length <= gridSize)
            .sort(() => Math.random() - 0.5);
        
        // Initialisation de la grille
        finalGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
        window.placedWords = [];
        isRevealed = false;
        
        const wordsActuallyPlaced = [];
        const difficulty = document.getElementById('difficulty').value;
        const getDirection = DIFFICULTY_DIRECTIONS[difficulty];

        // Placement des mots
        words.forEach(word => {
            let placed = false;
            let attempts = 0;
            
            while (!placed && attempts < 150) {
                const [dirRow, dirCol] = getDirection();
                const row = Math.floor(Math.random() * gridSize);
                const col = Math.floor(Math.random() * gridSize);
                
                if (canPlaceWord(word, row, col, dirRow, dirCol)) {
                    placeWord(word, row, col, dirRow, dirCol);
                    wordsActuallyPlaced.push(word);
                    placed = true;
                }
                
                attempts++;
            }
        });

        fillEmptyCells();
        renderGrid(title, wordsActuallyPlaced);
    }

    // ==================== RENDU DE LA GRILLE ====================
    
    /**
     * Calcule la taille optimale des cellules
     */
    function calculateCellSize() {
        const isDesktop = window.innerWidth > 768;
        const gap = 2;
        const containerWidth = document.querySelector('.main-wrapper').clientWidth - 40;
        const maxCellSize = Math.floor((containerWidth - (gridSize - 1) * gap) / gridSize);
        
        return isDesktop ? Math.min(42, maxCellSize) : maxCellSize;
    }

    /**
     * Affiche la grille g√©n√©r√©e
     */
    function renderGrid(title, words) {
        const gridEl = document.getElementById('word-grid');
        const canvas = document.getElementById('correction-canvas');
        
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');

        const isDesktop = window.innerWidth > 768;
        const gap = 2;
        const cellSize = calculateCellSize();
        const fontSize = Math.max(10, cellSize * 0.55);
        
        // Configuration de la grille
        gridEl.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
        gridEl.style.gap = `${gap}px`;
        
        // G√©n√©ration des cellules
        gridEl.innerHTML = finalGrid.flat()
            .map(obj => `<div class="grid-cell" onclick="toggleCell(this)" data-sol="${obj.isSolution}" style="font-size: ${fontSize}px; width:${cellSize}px; height:${cellSize}px;">${obj.char}</div>`)
            .join('');
        
        // Configuration du canvas
        const totalSize = (gridSize * cellSize) + ((gridSize - 1) * gap);
        canvas.width = totalSize;
        canvas.height = totalSize;
        
        // Affichage du titre
        document.getElementById('display-title').innerText = title;

        // Affichage de la liste des mots
        renderWordList(words, isDesktop);
        
        // R√©initialisation du bouton de r√©v√©lation
        document.getElementById('btn-reveal').innerHTML = "üëÅÔ∏è Afficher la correction";
        
        applyColorTheme();
    }

    /**
     * Affiche la liste des mots √† trouver
     */
    function renderWordList(words, isDesktop) {
        const sortedWords = words.sort((a, b) => a.localeCompare(b, 'fr'));
        const nbCols = isDesktop ? 2 : 3;
        const nbPerCol = Math.ceil(sortedWords.length / nbCols);
        
        let htmlWords = '';
        for (let i = 0; i < nbPerCol; i++) {
            for (let j = 0; j < nbCols; j++) {
                const index = i + (j * nbPerCol);
                if (index < sortedWords.length) {
                    htmlWords += `<span class="truncate">‚Ä¢ ${sortedWords[index]}</span>`;
                } else {
                    htmlWords += `<span></span>`;
                }
            }
        }
        
        document.getElementById('words-to-find').innerHTML = htmlWords;
    }

    // ==================== INTERACTION AVEC LA GRILLE ====================
    
    /**
     * Active/d√©sactive une cellule
     */
    function toggleCell(cell) {
        if (isRevealed) return;
        
        cell.classList.toggle('selected');
        const accentColor = getAccentColor();
        cell.style.backgroundColor = cell.classList.contains('selected') ? accentColor : "";
        
        checkVictory();
    }

    /**
     * V√©rifie si tous les mots ont √©t√© trouv√©s
     */
    function checkVictory() {
        const wordSpans = document.querySelectorAll('#words-to-find span');
        const selectedCells = Array.from(document.querySelectorAll('.grid-cell.selected'));
        const selectedCoords = selectedCells.map(cell => {
            const index = Array.from(cell.parentNode.children).indexOf(cell);
            return {
                r: Math.floor(index / gridSize),
                c: index % gridSize
            };
        });

        // V√©rification de chaque mot plac√©
        window.placedWords.forEach((wordObj) => {
            const dirRow = wordObj.r2 === wordObj.r1 ? 0 : (wordObj.r2 > wordObj.r1 ? 1 : -1);
            const dirCol = wordObj.c2 === wordObj.c1 ? 0 : (wordObj.c2 > wordObj.c1 ? 1 : -1);
            const length = Math.max(Math.abs(wordObj.r2 - wordObj.r1), Math.abs(wordObj.c2 - wordObj.c1)) + 1;
            
            let allLettersSelected = true;
            let wordString = "";
            
            for (let i = 0; i < length; i++) {
                const currR = wordObj.r1 + (i * dirRow);
                const currC = wordObj.c1 + (i * dirCol);
                wordString += finalGrid[currR][currC].char;
                
                if (!selectedCoords.some(coord => coord.r === currR && coord.c === currC)) {
                    allLettersSelected = false;
                }
            }
            
            // Mise √† jour de l'affichage du mot
            wordSpans.forEach(span => {
                const cleanText = span.innerText.replace('‚Ä¢ ', '').trim();
                if (cleanText === wordString) {
                    span.classList.toggle('word-found', allLettersSelected);
                }
            });
        });

        // V√©rification de la victoire
        const solutionCells = document.querySelectorAll('.grid-cell[data-sol="true"]');
        const selectedSolutionCells = document.querySelectorAll('.grid-cell.selected[data-sol="true"]');
        const wrongCells = document.querySelectorAll('.grid-cell.selected[data-sol="false"]');
        
        if (solutionCells.length > 0 && 
            solutionCells.length === selectedSolutionCells.length && 
            wrongCells.length === 0) {
            showVictoryModal();
        }
    }

    /**
     * Affiche la modale de victoire
     */
    function showVictoryModal() {
        const accentColor = getAccentColor();
        document.getElementById('bravo-titre').style.color = accentColor;
        openModal('modal-bravo');
    }

    // ==================== CORRECTION ====================
    
    /**
     * Affiche ou cache la correction
     */
    function toggleCorrection() {
        const canvas = document.getElementById('correction-canvas');
        const ctx = canvas.getContext('2d');
        const btn = document.getElementById('btn-reveal');
        const cells = document.querySelectorAll('.grid-cell');
        const accentColor = getAccentColor();
        const cellSize = parseFloat(cells[0].style.width);
        const gap = 2;
        
        isRevealed = !isRevealed;

        if (isRevealed) {
            showCorrection(ctx, canvas, accentColor, cellSize, gap, cells);
            btn.innerHTML = "üôà Cacher la correction";
        } else {
            hideCorrection(ctx, canvas, accentColor, cells);
            btn.innerHTML = "üëÅÔ∏è Afficher la correction";
        }
    }

    /**
     * Affiche la correction sur le canvas
     */
    function showCorrection(ctx, canvas, color, cellSize, gap, cells) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = color;
        ctx.lineWidth = cellSize * 0.8;
        ctx.lineCap = "round";
        ctx.globalAlpha = 0.5;
        
        window.placedWords.forEach(word => {
            const x1 = gap + word.c1 * (cellSize + gap) + cellSize / 2;
            const y1 = gap + word.r1 * (cellSize + gap) + cellSize / 2;
            const x2 = gap + word.c2 * (cellSize + gap) + cellSize / 2;
            const y2 = gap + word.r2 * (cellSize + gap) + cellSize / 2;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        });
        
        cells.forEach(cell => cell.style.background = "transparent");
    }

    /**
     * Cache la correction
     */
    function hideCorrection(ctx, canvas, color, cells) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        cells.forEach(cell => {
            cell.style.backgroundColor = cell.classList.contains('selected') ? color : "";
        });
    }

    // ==================== EXPORT ====================
    
    /**
     * Exporte la grille en PDF
     */
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const title = document.getElementById('grid-title').value || "Mots M√™l√©s";
        const filename = generateFilename('motsmeles', title, 'pdf');
        
        const words = document.getElementById('word-list').value
            .split(',')
            .map(w => w.trim().toUpperCase())
            .filter(w => w.length > 0)
            .sort((a, b) => a.localeCompare(b, 'fr'));
        
        const cellSize = 8;
        const startX = (210 - (gridSize * cellSize)) / 2;
        const startY = 40;

        // Page 1: Grille vierge
        renderPDFPage(doc, title, startX, startY, cellSize, words, false);
        
        // Page 2: Correction
        doc.addPage();
        renderPDFPage(doc, title + " (CORRECTION)", startX, startY, cellSize, words, true);

        // Sauvegarde
        savePDF(doc, filename);
    }

    /**
     * G√©n√®re une page du PDF
     */
    function renderPDFPage(doc, title, startX, startY, cellSize, words, showSolution) {
        // Titre
        doc.setFont("helvetica", "bold")
            .setFontSize(18)
            .text(title, 105, 20, { align: "center" });
        
        // Grille
        if (showSolution) {
            drawPDFSolution(doc, startX, startY, cellSize);
        }
        
        drawPDFGrid(doc, startX, startY, cellSize);
        
        // Liste des mots
        drawPDFWordList(doc, words, startX, startY + (gridSize * cellSize));
    }

    /**
     * Dessine la grille sur le PDF
     */
    function drawPDFGrid(doc, startX, startY, cellSize) {
        finalGrid.forEach((row, r) => {
            row.forEach((obj, c) => {
                const x = startX + (c * cellSize);
                const y = startY + (r * cellSize);
                
                doc.setDrawColor(200)
                    .setLineWidth(0.1)
                    .rect(x, y, cellSize, cellSize);
                
                doc.setTextColor(0)
                    .setFont("helvetica", "bold")
                    .setFontSize(11)
                    .text(obj.char, x + (cellSize / 2), y + (cellSize / 2) + 1.5, { align: "center" });
            });
        });
    }

    /**
     * Dessine la solution sur le PDF
     */
    function drawPDFSolution(doc, startX, startY, cellSize) {
        doc.setGState(new doc.GState({ opacity: 0.3 }));
        doc.setDrawColor(150, 150, 150);
        doc.setLineCap("round");
        doc.setLineWidth(cellSize - 4);

        window.placedWords.forEach((word) => {
            const x1 = startX + (word.c1 * cellSize) + (cellSize / 2);
            const y1 = startY + (word.r1 * cellSize) + (cellSize / 2);
            const x2 = startX + (word.c2 * cellSize) + (cellSize / 2);
            const y2 = startY + (word.r2 * cellSize) + (cellSize / 2);
            doc.line(x1, y1, x2, y2);
        });

        doc.setGState(new doc.GState({ opacity: 1 }));
    }

    /**
     * Dessine la liste des mots sur le PDF
     */
    function drawPDFWordList(doc, words, startX, yStart) {
        doc.setTextColor(0)
            .setFont("helvetica", "bold")
            .setFontSize(12)
            .text("Mots √† trouver :", startX, yStart + 15);
        
        doc.setFont("helvetica", "normal")
            .setFontSize(10);
        
        const nbPerCol = Math.ceil(words.length / 3);
        words.forEach((word, i) => {
            const col = Math.floor(i / nbPerCol);
            const row = i % nbPerCol;
            doc.text("‚Ä¢ " + word, startX + (col * 50), yStart + 22 + (row * 5));
        });
    }

    /**
     * Sauvegarde le PDF (compatible Android)
     */
    function savePDF(doc, filename) {
        if (window.Android && window.Android.savePdfFromBase64) {
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            window.Android.savePdfFromBase64(pdfBase64, filename);
        } else {
            doc.save(filename);
        }
    }

    /**
     * Exporte les donn√©es en TXT
     */
    function exportToTXT() {
        const title = document.getElementById('grid-title').value || "grille";
        const filename = generateFilename('motsmeles', title, 'txt');
        
        const data = {
            title: title,
            words: document.getElementById('word-list').value,
            size: gridSize,
            diff: document.getElementById('difficulty').value
        };
        
        const jsonString = JSON.stringify(data);

        if (window.Android && window.Android.savePdfFromBase64) {
            const base64String = btoa(unescape(encodeURIComponent(jsonString)));
            window.Android.savePdfFromBase64(base64String, filename);
        } else {
            const blob = new Blob([jsonString], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
    }

    /**
     * Importe des donn√©es depuis un fichier TXT
     */
    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                document.getElementById('grid-title').value = data.title || "";
                document.getElementById('word-list').value = data.words || "";
                document.getElementById('grid-size').value = data.size || 10;
                document.getElementById('difficulty').value = data.diff || "easy";
                updateWordCount();
                returnToSettings();
            } catch(err) {
                alert("Fichier invalide");
            }
        };
        reader.readAsText(event.target.files[0]);
    }

    // ==================== TH√àME ====================
    
    /**
     * Applique le th√®me de couleur
     */
    function applyColorTheme() {
        // Mode clair/sombre
        if (localStorage.getItem(STORAGE_KEYS.themeMode) === 'light') {
            document.body.classList.add('light-mode');
        } else {
            document.body.classList.remove('light-mode');
        }
        
        const themePrefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
        const colorKey = themePrefs.gen || 'cyan';
        const hexColor = COLOR_MAP[colorKey];
        const contrastColor = needsDarkText(colorKey) ? '#000' : '#fff';
        
        // Application sur les √©l√©ments dynamiques
        const elements = [
            'aide-titre-dynamique',
            'btn-fermer-aide',
            'btn-retour-header',
            'btn-retour-liste',
            'btn-aide',
            'mainAddBtn',
            'btn-shuffle',
            'btn-reveal'
        ];
        
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id === 'aide-titre-dynamique') {
                    el.style.color = hexColor;
                } else {
                    el.style.backgroundColor = hexColor;
                    el.style.color = contrastColor;
                }
            }
        });
        
        // Application sur les cellules s√©lectionn√©es
        document.querySelectorAll('.grid-cell.selected').forEach(el => {
            el.style.backgroundColor = hexColor;
        });
    }

    /**
     * Retourne aux r√©glages
     */
    function returnToSettings() {
        document.getElementById('setup-zone').classList.remove('hidden');
        document.getElementById('game-zone').classList.add('hidden');
    }

    // ==================== INITIALISATION ====================
    
    // √âcouteur pour le compteur de mots
    document.getElementById('word-list').addEventListener('input', updateWordCount);
    
    // Application du th√®me au chargement
    window.onload = applyColorTheme;
</script>
</body>
</html>
