<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rituel Op√©rations - Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --accent-color: #f59e0b; --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; background: var(--accent-color); color: #000; }

        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 450px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border);
            border-radius: 0.75rem; padding: 10px; font-size: 0.85rem; font-weight: 700;
            width: 100%; color: var(--text-main); outline: none; text-align: center; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px;
            text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; background: var(--accent-color); color: #000; }

        .day-box { background: rgba(255,255,255,0.03); border-radius: 1rem; padding: 12px; border: 1px solid var(--column-border); }
        
        .counter-group button { transition: all 0.1s ease; border: 1px solid var(--column-border); color: var(--text-main); }
        .counter-group button:active { background: var(--accent-color); color: #000; transform: scale(0.9); }
		.counter-group svg {
        filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
    }
    
    /* Animation pour montrer que le changement a eu lieu */
    [id^="cnt-"] {
        transition: transform 0.1s ease;
    }
    .active-scale { transform: scale(1.3); }
	
        .q-card { background: var(--card-bg); border-radius: 0.75rem; padding: 12px; border: 1px solid var(--column-border); display: flex; justify-content: space-between; align-items: center; }
        .res-text { color: #10b981; font-weight: 800; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px;
            border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        
        @media print { .btn-add, header, #setup-zone, .mb-4 { display: none !important; } .main-wrapper { max-width: 100%; } }
    </style>
</head>
<body class="dark-mode">

<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
    }
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Rituel Op√©rations</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="space-y-4">
        <div class="light-card">
            <label class="block text-[10px] font-black uppercase opacity-40 mb-3 tracking-widest text-center">1. Niveau Scolaire</label>
            <select id="niveau-select" class="input-field" onchange="appliquerPresetsNiveau()">
                <option value="cp">CP</option>
                <option value="ce1">CE1</option>
                <option value="ce2">CE2</option>
                <option value="cm1">CM1</option>
                <option value="cm2" selected>CM2</option>
            </select>
        </div>

        <div class="light-card">
            <label class="block text-[10px] font-black uppercase opacity-40 mb-4 tracking-widest text-center">2. Quantit√© par jour (Total 4)</label>
            <div id="days-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div class="light-card space-y-5">
            <label class="block text-[10px] font-black uppercase opacity-40 mb-2 tracking-widest text-center">3. R√©glages des termes</label>
            
            <div id="group-settings-as" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5">
                <span class="block text-[9px] font-black opacity-30 uppercase text-center">Additions & Soustractions</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Mini</label><input type="number" id="as-min" class="input-field" value="100000"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Maxi</label><input type="number" id="as-max" class="input-field" value="999999"></div>
                </div>
            </div>

            <div id="group-settings-mult" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5">
                <span class="block text-[9px] font-black opacity-30 uppercase text-center">Multiplications</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Chiffres T1</label><input type="number" id="mult-t1" class="input-field" value="4"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Chiffres T2</label><input type="number" id="mult-t2" class="input-field" value="3"></div>
                </div>
            </div>

            <div id="group-settings-div" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5">
                <span class="block text-[9px] font-black opacity-30 uppercase text-center">Divisions</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Chiffres Dividende</label><input type="number" id="div-t1" class="input-field" value="4"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1 ml-1">Diviseur Max</label><input type="number" id="div-t2" class="input-field" value="20"></div>
                </div>
            </div>
        </div>

        <button onclick="genererRituel()" class="btn-add">G√©n√©rer la semaine</button>
    </div>

    <div id="result-zone" class="hidden space-y-4">
        <div id="questions-grid" class="grid grid-cols-1 gap-2"></div>
        <div class="grid grid-cols-2 gap-3 pt-4">
            <button onclick="location.reload()" class="btn-add bg-gray-600 text-white">‚¨ÖÔ∏è R√©glages</button>
            <button onclick="window.print()" class="btn-add bg-blue-600 text-white">üìÑ Imprimer</button>
            <button onclick="toggleCorrection()" class="btn-add bg-green-600 text-white col-span-2">üëÅÔ∏è Voir Correction</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide : Rituel Op√©rations</h2>
        <div class="text-[11px] leading-relaxed space-y-4">
            <div class="flex items-start gap-3">
                <div class="w-7 h-7 rounded-lg bg-white/5 flex items-center justify-center flex-shrink-0 border border-white/10 text-xs">üè´</div>
                <div>
                    <h3 class="font-black uppercase tracking-wider mb-0.5" style="color: var(--accent-color)">Niveaux & Presets</h3>
                    <p class="opacity-70 text-[10px]">L'interface s'adapte selon le niveau. CP : +/- uniquement. CE1 : +/-/x. Autres : toutes op√©rations.</p>
                </div>
            </div>
        </div>
        <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Fermer</button>
    </div>
</div>

<script>
    const jours = ["Lundi", "Mardi", "Jeudi", "Vendredi"];
    const ops = [
        {id: 'add', label: '+', color: '#60a5fa'},
        {id: 'sub', label: '-', color: '#f87171'},
        {id: 'mul', label: 'x', color: '#fbbf24'},
        {id: 'div', label: '√∑', color: '#a78bfa'}
    ];

    function init() {
        const container = document.getElementById('days-container');
        const niv = document.getElementById('niveau-select').value;
        container.innerHTML = ''; 

        jours.forEach((j, dayIdx) => {
            let html = `<div class="day-box">
                <div class="text-[10px] font-black mb-3 opacity-60 uppercase text-center">${j}</div>
                <div class="flex justify-around items-center">`;
            
            ops.forEach((op, opIdx) => {
                if (niv === 'cp' && (op.id === 'mul' || op.id === 'div')) return;
                if (niv === 'ce1' && op.id === 'div') return;

                const val = (opIdx === 0) ? 4 : 0; 
                html += `<div class="counter-group flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 shadow-inner" 
                         style="background: ${op.color}20; border: 1.5px solid ${op.color}">
                        <span class="text-lg font-black" style="color:${op.color}">${op.label}</span>
                    </div>
                    
                    <div class="flex flex-col items-center bg-black/10 rounded-xl p-1 border border-white/5">
                        <button onclick="changeVal(${dayIdx}, '${op.id}', 1)" 
                                class="w-9 h-7 flex items-center justify-center text-white/40 hover:text-white active:scale-75">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 15l7-7 7 7" />
                            </svg>
                        </button>
                        
                        <div id="cnt-${dayIdx}-${op.id}" class="w-9 h-6 flex items-center justify-center font-black text-sm text-[var(--accent-color)]">
                            ${val}
                        </div>
                        
                        <button onclick="changeVal(${dayIdx}, '${op.id}', -1)" 
                                class="w-9 h-7 flex items-center justify-center text-white/40 hover:text-white active:scale-75">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <input type="hidden" data-day="${dayIdx}" data-op="${op.id}" value="${val}">
                    </div>
                </div>`;
            });
            html += `</div></div>`;
            container.innerHTML += html;
        });
        appliquerTheme();
    }

    function changeVal(dayIdx, opId, delta) {
        const hiddenInput = document.querySelector(`input[data-day="${dayIdx}"][data-op="${opId}"]`);
        const displayDiv = document.getElementById(`cnt-${dayIdx}-${opId}`);
        const allDayInputs = document.querySelectorAll(`input[data-day="${dayIdx}"]`);
        
        let currentTotal = 0;
        allDayInputs.forEach(i => currentTotal += parseInt(i.value) || 0);
        
        let newVal = (parseInt(hiddenInput.value) || 0) + delta;
        if (newVal < 0) return;
        if (delta > 0 && currentTotal >= 4) return;

        hiddenInput.value = newVal;
        displayDiv.innerText = newVal;
		// Petit effet de "pop" sur le chiffre
		displayDiv.classList.add('active-scale');
		setTimeout(() => displayDiv.classList.remove('active-scale'), 100);
    }

    function appliquerPresetsNiveau() {
        const niv = document.getElementById('niveau-select').value;
        const config = {
            'cp': [1, 50, 1, 1, 1, 2],
            'ce1': [10, 99, 1, 1, 1, 5],
            'ce2': [100, 9999, 2, 1, 2, 9],
            'cm1': [1000, 99999, 3, 2, 3, 9],
            'cm2': [100000, 999999, 4, 3, 4, 20]
        };
        const p = config[niv];
        document.getElementById('as-min').value = p[0];
        document.getElementById('as-max').value = p[1];
        document.getElementById('mult-t1').value = p[2];
        document.getElementById('mult-t2').value = p[3];
        document.getElementById('div-t1').value = p[4];
        document.getElementById('div-t2').value = p[5];

        const multBlock = document.getElementById('group-settings-mult');
        const divBlock = document.getElementById('group-settings-div');
        
        // Affichage des r√©glages termes selon niveau
        multBlock.style.display = (niv === 'cp') ? 'none' : 'block';
        divBlock.style.display = (niv === 'cp' || niv === 'ce1') ? 'none' : 'block';

        init(); 
    }

    function getRandomNDigits(n) {
        if (n <= 0) return 0;
        const min = Math.pow(10, n-1);
        const max = Math.pow(10, n) - 1;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function genererRituel() {
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = '';
        jours.forEach((j, dayIdx) => {
            grid.innerHTML += `<div class="col-span-full font-black text-center py-1 mt-4 opacity-30 text-[10px] tracking-widest uppercase border-b border-white/10">‚Ä¢ ${j} ‚Ä¢</div>`;
            const inputs = document.querySelectorAll(`input[data-day="${dayIdx}"]`);
            inputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                const type = input.dataset.op;
                for(let i=0; i<count; i++) {
                    let a, b, opSign, res;
                    if (type === 'add' || type === 'sub') {
                        const min = parseInt(document.getElementById('as-min').value);
                        const max = parseInt(document.getElementById('as-max').value);
                        a = Math.floor(Math.random() * (max - min + 1)) + min;
                        b = Math.floor(Math.random() * (max - min + 1)) + min;
                        if (type === 'add') { opSign = '+'; res = a + b; }
                        else { if (a < b) [a, b] = [b, a]; opSign = '-'; res = a - b; }
                    } else if (type === 'mul') {
                        a = getRandomNDigits(parseInt(document.getElementById('mult-t1').value));
                        b = getRandomNDigits(parseInt(document.getElementById('mult-t2').value));
                        opSign = 'x'; res = a * b;
                    } else if (type === 'div') {
                        b = Math.floor(Math.random() * (parseInt(document.getElementById('div-t2').value) - 2 + 1)) + 2;
                        a = Math.floor(getRandomNDigits(parseInt(document.getElementById('div-t1').value)) / b) * b;
                        opSign = '√∑'; res = a / b;
                    }
                    grid.innerHTML += `<div class="q-card">
                        <span class="text-[13px] font-black">${a.toLocaleString('fr-FR')} ${opSign} ${b.toLocaleString('fr-FR')} =</span>
                        <span class="res-text hidden">${res.toLocaleString('fr-FR')}</span>
                    </div>`;
                }
            });
        });
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('result-zone').classList.remove('hidden');
    }

    function toggleCorrection() { document.querySelectorAll('.res-text').forEach(e => e.classList.toggle('hidden')); }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'amber';
        const map = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
        const hexa = map[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        document.documentElement.style.setProperty('--accent-color', hexa);
        [document.getElementById('btn-retour-header'), document.getElementById('btn-retour-liste'), document.getElementById('btn-aide'), document.querySelector('.btn-add'), document.getElementById('btn-fermer-aide')].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }

    window.onload = init;
</script>
</body>
</html>