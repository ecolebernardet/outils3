<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reproduction g√©om√©trique - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root { --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.1); --header-bg: #1e1e1e; --card-bg: #1e1e1e; }
        body.light-mode { --bg-page: #eeeeee; --text-page: #111827; --column-border: #ddd; --header-bg: #ffffff; --card-bg: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; }
        header { background: var(--header-bg); border-bottom: 1px solid var(--column-border); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; width: 100%; margin-bottom: 20px; }
        #btn-retour-liste { text-decoration: none !important; display: inline-flex; align-items: center; }
		#btn-retour-header, #btn-aide { display: flex !important; align-items: center; justify-content: center; width: 38px !important; height: 38px !important; border-radius: 50% !important; flex-shrink: 0; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; letter-spacing: 0.1em; }
        .main-wrapper { width: 100%; max-width: 900px; margin: 0 auto; padding: 0 15px 20px 15px; }
        .controls { background: var(--card-bg); padding: 20px; border-radius: 1.5rem; border: 1px solid var(--column-border); margin-bottom: 20px; }
        #preview-container { background: white; padding: 30px; border-radius: 1.5rem; display: flex; justify-content: center; gap: 40px; overflow-x: auto; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2); }
        #svg-model, #svg-empty { background: white; cursor: crosshair; touch-action: none; display: block; }

		/* On force le curseur "main" (pointer) sur les boutons et leurs contenus */
		#btn-retour-header, #btn-retour-header svg, #btn-aide { cursor: pointer !important; }
        .grid-line { stroke: #e5e7eb; stroke-width: 1; }
        .grid-main { stroke: #9ca3af; stroke-width: 2; }
        .draw-line { stroke: black; stroke-width: 3; stroke-linecap: round; pointer-events: none; }
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        .btn-modal-close { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; margin-top: 20px; cursor: pointer; border: none; }
        @media print { .no-print { display: none !important; } body { background: white; } #preview-container { box-shadow: none; padding: 0; } }
    </style>
</head>
<body>

<script>if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');</script>

<header style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: var(--header-bg); border-bottom: 1px solid var(--column-border);">
    <a href="index.html" id="btn-retour-header" style="display: flex !important; align-items: center; justify-content: center; width: 38px !important; height: 38px !important; border-radius: 50% !important; text-decoration: none; flex-shrink: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="display: block; min-width: 20px; min-height: 20px;">
            <path d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 style="margin: 0; font-size: 1.125rem; font-weight: 900; text-transform: uppercase; flex-grow: 1; text-align: center;">Reproduction G√©om√©trie</h1>
    <button id="btn-aide" onclick="ouvrirAide()" style="display: flex !important; align-items: center; justify-content: center; width: 38px !important; height: 38px !important; border-radius: 50% !important; border: none; cursor: pointer; flex-shrink: 0; font-size: 1.2rem;">üí°</button>
</header>

<div class="main-wrapper">
	<div id="container-retour-liste" class="mb-6 text-left no-print">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-[10px] font-black uppercase transition-all active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" style="width:12px; height:12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>
    <div class="controls no-print">
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest mb-2">Taille (Carreaux)</label>
                <input type="number" id="gridSize" value="10" min="5" max="25" class="w-full bg-transparent border-b-2 border-gray-500 py-1 outline-none font-bold">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 tracking-widest mb-2">Zoom (Pixels)</label>
                <input type="number" id="cellSize" value="30" step="5" class="w-full bg-transparent border-b-2 border-gray-500 py-1 outline-none font-bold">
            </div>
        </div>
        <button onclick="initGrids()" class="w-full py-3 rounded-xl font-black text-[11px] uppercase tracking-widest bg-gray-500/20 transition active:scale-95">Tout effacer</button>
        <p class="text-[9px] mt-4 opacity-50 text-center uppercase font-bold tracking-tighter">Cliquez deux fois pour tracer un segment. Export PDF optimis√© (x3).</p>
    </div>

    <div id="preview-container">
        <div class="flex flex-col items-center">
            <span class="text-black text-[10px] font-bold uppercase mb-2">Mod√®le</span>
            <svg id="svg-model"></svg>
            <div id="draw-actions" class="flex gap-2 mt-3 no-print">
				<button id="btn-undo" onclick="undoLastAction()" class="bg-gray-200 hover:bg-gray-300 text-black text-[10px] font-black uppercase py-2 px-3 rounded-lg transition active:scale-95">‚Ü© Annuler</button>
				<button id="btn-redo" onclick="redoLastAction()" class="bg-gray-200 hover:bg-gray-300 text-black text-[10px] font-black uppercase py-2 px-3 rounded-lg transition active:scale-95">‚Ü™ Refaire</button>
				<button id="btn-gomme" onclick="toggleGomme()" class="bg-gray-200 hover:bg-gray-300 text-black text-[10px] font-black uppercase py-2 px-3 rounded-lg transition active:scale-95">
					<span id="gomme-status">‚ùå Gomme OFF</span>
				</button>
				<button id="btn-vider" onclick="viderGrille()" class="bg-gray-200 hover:bg-gray-300 text-black text-[10px] font-black uppercase py-2 px-3 rounded-lg transition active:scale-95">
					üóëÔ∏è Vider
				</button>
			</div>
        </div>
        <div class="flex flex-col items-center">
            <span class="text-black text-[10px] font-bold uppercase mb-2">√Ä reproduire</span>
            <svg id="svg-empty"></svg>
        </div>
    </div>

    <div class="mt-8 no-print">
        <button onclick="exportToPDF()" id="btn-export-pdf" class="w-full py-4 rounded-xl font-black text-[11px] uppercase tracking-widest transition active:scale-95 shadow-lg">üìÑ G√©n√©rer le PDF (Portrait x3)</button>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerAide()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide</h2>
        <div class="text-[11px] leading-relaxed space-y-3 opacity-80 font-semibold">
            <p><strong>Aide au trac√© :</strong> Un point gris suit votre curseur pour viser les intersections. Cliquez une fois pour d√©buter un trait, une seconde fois pour le terminer.</p>
        </div>
        <button id="btn-fermer-aide" onclick="fermerAide()" class="btn-modal-close active:scale-95">Fermer</button>
    </div>
</div>

<div id="modal-confirm" class="modal-overlay" onclick="fermerConfirm()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-confirm" class="text-lg font-black uppercase mb-4 text-red-500">üóëÔ∏è Tout effacer ?</h2>
        <p class="text-[11px] leading-relaxed opacity-80 font-semibold mb-6">
            Cette action supprimera d√©finitivement tous les traits trac√©s sur le mod√®le.
        </p>
        <div class="flex gap-3">
            <button onclick="fermerConfirm()" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-gray-500/20 active:scale-95">Annuler</button>
            <button id="btn-valider-vider" onclick="validerVider()" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase text-white bg-red-500 active:scale-95">Confirmer</button>
        </div>
    </div>
</div>

<script>
    const svgModel = document.getElementById('svg-model');
    const svgEmpty = document.getElementById('svg-empty');
    let lastPoint = null;
    let redoStack = [];
    let ghostLine, hoverDot, anchorDot;
    let isGommeActive = false;

    function initGrids() {
        const size = parseInt(document.getElementById('gridSize').value) || 10;
        const cell = parseInt(document.getElementById('cellSize').value) || 30;
        const total = size * cell;
        lastPoint = null; redoStack = [];
        
        [svgModel, svgEmpty].forEach(svg => {
            svg.innerHTML = '';
            svg.setAttribute('width', total);
            svg.setAttribute('height', total);
            let lines = '';
            for (let i = 0; i <= size; i++) {
                const pos = i * cell;
                const color = (i === 0 || i === size) ? 'grid-main' : 'grid-line';
                lines += `<line x1="0" y1="${pos}" x2="${total}" y2="${pos}" class="${color}" />`;
                lines += `<line x1="${pos}" y1="0" x2="${pos}" y2="${total}" class="${color}" />`;
            }
            svg.insertAdjacentHTML('beforeend', lines);
        });

        const helpGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        helpGroup.id = "help-layer";
        
        ghostLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
        ghostLine.setAttribute("stroke", "rgba(0,0,0,0.3)");
        ghostLine.setAttribute("stroke-width", "2");
        ghostLine.setAttribute("stroke-dasharray", "4");
        ghostLine.setAttribute("visibility", "hidden");
        ghostLine.style.pointerEvents = "none";

        hoverDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        hoverDot.setAttribute("r", "4");
        hoverDot.setAttribute("fill", "rgba(0,0,0,0.2)");
        hoverDot.style.pointerEvents = "none";

        anchorDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        anchorDot.setAttribute("r", "4");
        anchorDot.setAttribute("fill", "black");
        anchorDot.setAttribute("visibility", "hidden");
        anchorDot.style.pointerEvents = "none";

        helpGroup.appendChild(ghostLine);
        helpGroup.appendChild(hoverDot);
        helpGroup.appendChild(anchorDot);
        svgModel.appendChild(helpGroup);
    }

    function toggleGomme() {
        isGommeActive = !isGommeActive;
        const status = document.getElementById('gomme-status');
        if (isGommeActive) {
            status.innerText = "‚úÖ Gomme ON";
            svgModel.style.cursor = `url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' style='font-size:24px'><text y='20'>üßΩ</text></svg>") 10 10, not-allowed`;
        } else {
            status.innerText = "‚ùå Gomme OFF";
            svgModel.style.cursor = "crosshair";
        }
        appliquerTheme(); 
        lastPoint = null;
        anchorDot.setAttribute("visibility", "hidden");
        ghostLine.setAttribute("visibility", "hidden");
    }

    function getCoords(e) {
        const cell = parseInt(document.getElementById('cellSize').value);
        const rect = svgModel.getBoundingClientRect();
        return {
            x: Math.round((e.clientX - rect.left) / cell) * cell,
            y: Math.round((e.clientY - rect.top) / cell) * cell
        };
    }

    svgModel.addEventListener('pointerdown', (e) => {
        if (isGommeActive) {
            if (e.target.classList.contains('eraser-zone')) {
                const parentGroup = e.target.parentNode;
                if (parentGroup) {
                    svgModel.removeChild(parentGroup);
                    redoStack = [];
                }
            }
            return;
        }

        const c = getCoords(e);
        if (!lastPoint) {
            lastPoint = c;
            anchorDot.setAttribute("cx", c.x); anchorDot.setAttribute("cy", c.y);
            anchorDot.setAttribute("visibility", "visible");
        } else {
            if (lastPoint.x === c.x && lastPoint.y === c.y) return;
            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("class", "line-group");

            const hitZone = document.createElementNS("http://www.w3.org/2000/svg", "line");
            hitZone.setAttribute("x1", lastPoint.x); hitZone.setAttribute("y1", lastPoint.y);
            hitZone.setAttribute("x2", c.x); hitZone.setAttribute("y2", c.y);
            hitZone.setAttribute("stroke", "transparent");
            hitZone.setAttribute("stroke-width", "25");
            hitZone.setAttribute("class", "eraser-zone");
            hitZone.style.pointerEvents = "stroke";

            const visibleLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            visibleLine.setAttribute("x1", lastPoint.x); visibleLine.setAttribute("y1", lastPoint.y);
            visibleLine.setAttribute("x2", c.x); visibleLine.setAttribute("y2", c.y);
            visibleLine.setAttribute("stroke", "black");
            visibleLine.setAttribute("stroke-width", "3");
            visibleLine.setAttribute("stroke-linecap", "round");
            visibleLine.style.pointerEvents = "none";

            group.appendChild(hitZone);
            group.appendChild(visibleLine);
            svgModel.insertBefore(group, document.getElementById('help-layer'));
            
            lastPoint = null;
            anchorDot.setAttribute("visibility", "hidden");
            ghostLine.setAttribute("visibility", "hidden");
            redoStack = [];
        }
    });

    svgModel.addEventListener('pointermove', (e) => {
        if (isGommeActive) return;
        const c = getCoords(e);
        if (hoverDot) { hoverDot.setAttribute("cx", c.x); hoverDot.setAttribute("cy", c.y); }
        if (lastPoint && ghostLine) {
            ghostLine.setAttribute("x1", lastPoint.x); ghostLine.setAttribute("y1", lastPoint.y);
            ghostLine.setAttribute("x2", c.x); ghostLine.setAttribute("y2", c.y);
            ghostLine.setAttribute("visibility", "visible");
        }
    });

    svgModel.addEventListener('pointerleave', () => {
        if (hoverDot) hoverDot.setAttribute("cx", -20);
        if (ghostLine) ghostLine.setAttribute("visibility", "hidden");
    });

    function undoLastAction() {
        const lines = svgModel.querySelectorAll('.line-group');
        if (lines.length > 0) {
            const last = lines[lines.length - 1];
            redoStack.push(last.cloneNode(true));
            svgModel.removeChild(last);
        }
    }

    function redoLastAction() {
        if (redoStack.length > 0) svgModel.insertBefore(redoStack.pop(), document.getElementById('help-layer'));
    }

    function viderGrille() { document.getElementById('modal-confirm').style.display = 'flex'; }
    function fermerConfirm() { document.getElementById('modal-confirm').style.display = 'none'; }
    function validerVider() {
        svgModel.querySelectorAll('.line-group').forEach(l => svgModel.removeChild(l));
        lastPoint = null; redoStack = [];
        anchorDot.setAttribute("visibility", "hidden");
        ghostLine.setAttribute("visibility", "hidden");
        fermerConfirm();
    }

    async function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const container = document.getElementById('preview-container');
        if (hoverDot) hoverDot.setAttribute("visibility", "hidden");
        const canvas = await html2canvas(container, { scale: 3, backgroundColor: "#ffffff" });
        if (hoverDot) hoverDot.setAttribute("visibility", "visible");
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const margin = 10;
        const imgWidth = pdfWidth - (margin * 2);
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        [10, 105, 200].forEach(pos => pdf.addImage(imgData, 'PNG', margin, pos, imgWidth, imgHeight));
        pdf.save('exercice-geometrie.pdf');
    }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };
        const hexa = mapCouleurs[colPref] || '#06b6d4';
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';

        // AJOUT DE 'btn-retour-liste' ICI
        const idList = [
            'btn-retour-header', 
            'btn-aide', 
            'btn-retour-liste', // <--- Nouveau
            'btn-export-pdf', 
            'btn-fermer-aide', 
            'btn-undo', 
            'btn-redo', 
            'btn-gomme',
            'btn-vider',
            'btn-valider-vider'
        ];

        idList.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id === 'btn-gomme' && typeof isGommeActive !== 'undefined' && isGommeActive) {
                    el.style.backgroundColor = "#ef4444";
                    el.style.color = "#fff";
                } else {
                    el.style.backgroundColor = hexa;
                    el.style.color = contrast;
                }
            }
        });
        if(document.getElementById('titre-aide')) document.getElementById('titre-aide').style.color = hexa;
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerAide() { document.getElementById('modal-aide').style.display = 'none'; }
    document.getElementById('gridSize').onchange = initGrids;
    document.getElementById('cellSize').onchange = initGrids;
    window.onload = () => { initGrids(); appliquerTheme(); };
</script>
</body>
</html>