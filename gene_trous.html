<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Texte √† trous - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --accent-color: #06b6d4;
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border);
            border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700;
            width: 100%; color: var(--text-main); outline: none; }
        
        #text-editor { min-height: 150px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap; cursor: text; }
        #text-editor:empty:before { content: "Tapez votre texte ici..."; opacity: 0.3; }

        .word-gap { background-color: var(--accent-color); color: white !important; border-radius: 4px; padding: 0 4px; cursor: pointer; font-weight: 800; }

        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px;
            text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white;
            transition: all 0.2s ease; text-transform: uppercase; }

        .gap-input { border-bottom: 2px dashed var(--column-border); background: transparent; outline: none; text-align: center; font-weight: 800; color: var(--accent-color); }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px;
            border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="generateurs.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Texte √† trous</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="setup-zone" class="light-card space-y-4">
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Double-cliquez sur les mots pour les masquer</label>
            <div id="text-editor" contenteditable="true" class="input-field text-left"></div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Minutes</label><input type="number" id="timer-min" value="5" min="0" class="input-field text-center"></div>
            <div><label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Secondes</label><input type="number" id="timer-sec" value="0" min="0" max="59" class="input-field text-center"></div>
        </div>

        <button id="mainAddBtn" onclick="generateExercise()" class="btn-add">G√©n√©rer l'exercice</button>
    </div>

    <div id="game-zone" class="hidden space-y-6">
        <div id="timer-display" class="hidden text-center p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <span class="text-[10px] font-black uppercase opacity-50 tracking-widest">Temps restant</span>
            <div id="seconds-left" class="text-2xl font-black text-amber-500">0:00</div>
        </div>

        <div id="exercise-content" class="light-card leading-loose text-lg"></div>

        <div class="grid grid-cols-2 gap-4 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500 col-span-2">üìÑ √©dition PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide</h2>
        <div class="text-[11px] leading-relaxed space-y-2 opacity-80">
            <p>1. √âcrivez ou collez votre texte dans la zone principale.</p>
            <p>2. <strong>Double-cliquez</strong> sur les mots que vous souhaitez transformer en trous.</p>
            <p>3. Les mots s√©lectionn√©s appara√Ætront en couleur.</p>
            <p>4. Lancez le mode jeu ou g√©n√©rez un PDF.</p>
        </div>
        <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Fermer</button>
    </div>
</div>

<div id="modal-fin" class="modal-overlay">
    <div class="modal-content text-center">
        <div class="text-6xl mb-4">üîî</div>
        <h2 id="titre-fin" class="text-2xl font-black uppercase mb-2">Temps √©coul√© !</h2>
        <button onclick="fermerModal('modal-fin'); showCorrection();" class="btn-add">Voir les r√©sultats</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    let countdown;
    const editor = document.getElementById('text-editor');

    // Gestion du double-clic pour marquer les mots
    editor.addEventListener('dblclick', function(e) {
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const word = selection.toString().trim();

        if (word.length > 0) {
            const span = document.createElement('span');
            span.className = 'word-gap';
            span.textContent = word;
            range.deleteContents();
            range.insertNode(span);
            selection.removeAllRanges();
        }
    });

    function generateExercise() {
        if (!editor.innerHTML.includes('word-gap')) return alert("Double-cliquez sur au moins un mot !");
        
        const container = document.getElementById('exercise-content');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        
        tempDiv.querySelectorAll('.word-gap').forEach(span => {
            const word = span.textContent;
            const input = document.createElement('input');
            input.type = "text";
            input.className = "gap-input";
            input.dataset.answer = word;
            input.style.width = (word.length + 1) + "ch";
            input.oninput = function() {
                this.style.width = Math.max(this.value.length + 1, this.dataset.answer.length + 1) + 'ch';
            };
            span.parentNode.replaceChild(input, span);
        });

        container.innerHTML = tempDiv.innerHTML;
        startTimer();
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function startTimer() {
        const mins = parseInt(document.getElementById('timer-min').value) || 0;
        const secs = parseInt(document.getElementById('timer-sec').value) || 0;
        const total = (mins * 60) + secs;
        if (total <= 0) return;

        document.getElementById('timer-display').classList.remove('hidden');
        let timeLeft = total;
        const display = document.getElementById('seconds-left');
        
        countdown = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) { clearInterval(countdown); document.getElementById('modal-fin').style.display = 'flex'; }
        }, 1000);
    }

    function showCorrection() {
        clearInterval(countdown);
        document.querySelectorAll('.gap-input').forEach(input => {
            const answer = input.dataset.answer;
            if (input.value.trim().toLowerCase() === answer.toLowerCase()) {
                input.style.color = '#10b981';
            } else {
                input.value = answer;
                input.style.color = '#ef4444';
            }
            input.disabled = true;
        });
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const drawPage = (title, isCorrection) => {
            doc.setFont("helvetica", "bold"); doc.setFontSize(18); doc.text(title, 105, 20, { align: "center" });
            doc.setFontSize(11); doc.setFont("helvetica", "normal");
            
            let tempDiv = document.createElement('div');
            tempDiv.innerHTML = editor.innerHTML;
            
            if (!isCorrection) {
                tempDiv.querySelectorAll('.word-gap').forEach(s => s.textContent = "....................");
            }
            
            const content = tempDiv.innerText;
            const splitText = doc.splitTextToSize(content, 170);
            doc.text(splitText, 20, 40);
        };

        drawPage("Exercice : Texte √† trous", false);
        doc.addPage();
        drawPage("Correction", true);
        doc.save("exercice_texte_a_trous.pdf");
    }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        document.documentElement.style.setProperty('--accent-color', hexa);
        
        [document.getElementById('btn-retour-header'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-fermer-aide')].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
        if(document.getElementById('titre-aide')) document.getElementById('titre-aide').style.color = hexa;
        if(document.getElementById('titre-fin')) document.getElementById('titre-fin').style.color = hexa;
    }

    function retourReglages() { clearInterval(countdown); document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    
    window.onload = appliquerTheme;
</script>
</body>
</html>