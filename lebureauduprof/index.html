<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Bureau du Prof</title>
<style>
        :root {
            --bg-color: #eef2f5;
            --widget-bg: #ffffff;
            --primary-color: #4a90e2;
            --text-color: #333;
            --shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
            --border-radius: 18px;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #1a1a2e; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        #board { position: absolute; background-color: var(--bg-color); z-index: 0; transition: background 0.3s ease; overflow: hidden; }

        /* --- WIDGETS --- */
        .widget { position: absolute; background: var(--widget-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; flex-direction: column; z-index: 1; border: 2px solid transparent; height: auto; outline: none; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; }
        .widget:focus-within { border-color: var(--primary-color); box-shadow: 0 12px 30px rgba(74, 144, 226, 0.3); }
        .widget[data-type="homework"]:focus-within { border-color: #ff4757; }
        .widget[data-type="iframe"]:focus-within { border-color: #2bcbba; }
        .widget[data-transparent="true"] { border: none !important; box-shadow: none !important; background: transparent !important; }
        .widget[data-transparent="true"]:hover, .widget[data-transparent="true"]:focus-within { background: rgba(74, 144, 226, 0.05) !important; }
        .widget[data-transparent="true"] .editor-container, .widget[data-transparent="true"] .editor-content { border: none !important; background: transparent !important; }

        /* --- CONTR√îLES NATIFS DES WIDGETS --- */
        .widget-header { display: none !important; }
        .drag-handle, .widget-close-handle, .widget-pin-handle, .widget-rotate-handle, .widget-menu-handle, .widget-back-handle {
            position: absolute; width: 26px; height: 26px; background: #f8f9fa; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; transition: opacity 0.2s; border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); pointer-events: none;
        }
        .drag-handle          { left: -13px; top: 50%; transform: translateY(-50%); cursor: move; font-size: 14px; color: #666; }
        .widget-rotate-handle { right: -13px; top: 50%; transform: translateY(-50%); cursor: grab; font-size: 14px; color: #8E51FF; }
        .widget-rotate-handle:active { cursor: grabbing; }
        #rotation-indicator {
            position: fixed; background: rgba(30,30,30,0.82); color: #fff;
            font-size: 12px; font-family: 'Courier New', monospace; font-weight: 700;
            padding: 3px 9px; border-radius: 6px; pointer-events: none;
            z-index: 99999; display: none; white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transform: translate(14px, -50%);
        }
        #rotation-indicator .rot-reset-hint {
            font-size: 10px; color: #aaa; margin-left: 6px;
        }
        .widget-close-handle  { top: 5px; right: 5px; cursor: pointer; font-size: 14px; color: #ff5f56; }
        .widget-pin-handle    { top: -13px; left: calc(50% - 16px); transform: translateX(-50%); cursor: pointer; font-size: 13px; color: #f39c12; }
        .widget-back-handle   { top: -13px; left: calc(50% + 16px); transform: translateX(-50%); cursor: pointer; font-size: 13px; color: #888; }
        .widget-menu-handle   { bottom: -13px; left: 50%; transform: translateX(-50%); top: auto; cursor: pointer; font-size: 13px; color: #555; }
        .widget:focus-within .drag-handle,
        .widget:focus-within .widget-close-handle,
        .widget:focus-within .widget-pin-handle,
        .widget:focus-within .widget-back-handle,
        .widget:focus-within .widget-rotate-handle,
        .widget:focus-within .widget-menu-handle { opacity: 1; pointer-events: auto; }
        .shape-widget:focus-within .drag-handle,
        .shape-widget:focus-within .widget-close-handle,
        .shape-widget:focus-within .widget-pin-handle,
        .shape-widget:focus-within .widget-back-handle,
        .shape-widget:focus-within .widget-rotate-handle,
        .shape-widget:focus-within .widget-menu-handle { opacity: 1; pointer-events: auto; }
        /* En multi-s√©lection, forcer le masquage des poign√©es malgr√© focus-within */
        #board.multi-select .widget.selected .drag-handle,
        #board.multi-select .widget.selected .widget-close-handle,
        #board.multi-select .widget.selected .widget-pin-handle,
        #board.multi-select .widget.selected .widget-back-handle,
        #board.multi-select .widget.selected .widget-rotate-handle,
        #board.multi-select .widget.selected .widget-menu-handle,
        #board.multi-select .widget.selected:focus-within .drag-handle,
        #board.multi-select .widget.selected:focus-within .widget-close-handle,
        #board.multi-select .widget.selected:focus-within .widget-pin-handle,
        #board.multi-select .widget.selected:focus-within .widget-back-handle,
        #board.multi-select .widget.selected:focus-within .widget-rotate-handle,
        #board.multi-select .widget.selected:focus-within .widget-menu-handle,
        #board.multi-select .shape-widget.selected .drag-handle,
        #board.multi-select .shape-widget.selected .widget-close-handle,
        #board.multi-select .shape-widget.selected .widget-pin-handle,
        #board.multi-select .shape-widget.selected .widget-back-handle,
        #board.multi-select .shape-widget.selected .widget-rotate-handle,
        #board.multi-select .shape-widget.selected .widget-menu-handle,
        #board.multi-select .shape-widget.selected:focus-within .drag-handle,
        #board.multi-select .shape-widget.selected:focus-within .widget-close-handle,
        #board.multi-select .shape-widget.selected:focus-within .widget-pin-handle,
        #board.multi-select .shape-widget.selected:focus-within .widget-back-handle,
        #board.multi-select .shape-widget.selected:focus-within .widget-rotate-handle,
        #board.multi-select .shape-widget.selected:focus-within .widget-menu-handle { opacity: 0 !important; pointer-events: none !important; }
        .widget-close-handle:hover  { color: #ff5f56; background: white; }
        .drag-handle:hover          { color: var(--primary-color); background: white; }
        .widget-pin-handle:hover    { background: white; }
        .widget-back-handle:hover   { background: white; }
        .widget-rotate-handle:hover { color: #5a1fb8; background: white; }
        .widget-menu-handle:hover   { background: white; }
        .widget.pinned .widget-pin-handle { background: #FFD230; }
        .widget.pinned { border: 2px solid transparent !important; }
        .shape-widget.pinned .widget-pin-handle { background: #FFD230; }

        /* --- MENU CONTEXTUEL --- */
        .widget-ctx-menu {
            position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%); top: auto;
            background: #1F1F21; border: 1px solid #444; border-radius: 10px; padding: 5px 0;
            min-width: 170px; z-index: 200; box-shadow: 0 6px 20px rgba(0,0,0,0.35);
            display: none; flex-direction: column;
        }
        .widget-ctx-menu.open { display: flex; }
        .widget-ctx-menu button {
            background: none; border: none; color: #eee; padding: 7px 14px;
            text-align: left; cursor: pointer; font-size: 13px; display: flex;
            align-items: center; gap: 8px; white-space: nowrap; transition: background 0.12s;
        }
        .widget-ctx-menu button:hover { background: #333; }
        .widget-ctx-menu hr { border: none; border-top: 1px solid #444; margin: 4px 0; }

        /* Curseur crayon pour le mode insertion de texte */
        .cursor-pencil { cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' style='fill:black'><text y='20' font-size='20'>‚úèÔ∏è</text></svg>"), auto !important; }
        /* Curseur gomme */
        #draw-canvas.eraser-mode { cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><rect x='4' y='10' width='24' height='16' rx='3' fill='%23fff' stroke='%23aaa' stroke-width='2'/><rect x='4' y='10' width='12' height='16' rx='3' fill='%23ffcccc'/></svg>"), crosshair !important; }

        /* --- FORMES --- */
        .shape-widget {
            position: absolute; z-index: 1; outline: none;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            display: flex; flex-direction: column;
        }
        .shape-widget .drag-handle, .shape-widget .widget-close-handle,
        .shape-widget .widget-pin-handle, .shape-widget .widget-back-handle,
        .shape-widget .widget-rotate-handle, .shape-widget .widget-menu-handle { opacity: 0; pointer-events: none; }
        .shape-svg-wrap { display: flex; align-items: center; justify-content: center; padding: 16px; min-width: 80px; min-height: 80px; cursor: default; }
        .shape-svg-wrap svg { overflow: visible; display: block; pointer-events: none; }
        .shape-resize-handle {
            position: absolute; right: 0; bottom: 0; width: 18px; height: 18px;
            cursor: se-resize; opacity: 0; transition: opacity 0.2s;
            background: linear-gradient(135deg, transparent 50%, #4a90e2 50%);
            border-radius: 0 0 4px 0;
        }
        .shape-widget:focus-within .shape-resize-handle { opacity: 1; }
        .shape-widget[data-group-id]:focus-within .shape-resize-handle { opacity: 0 !important; pointer-events: none !important; }
        /* Bouton verrou proportions sur forme individuelle */
        .resize-lock-btn {
            position: absolute; right: 20px; bottom: 0;
            width: 20px; height: 18px; background: white; border: 1px solid #ccc;
            border-radius: 4px 0 0 0; cursor: pointer; opacity: 0; transition: opacity 0.2s;
            display: flex; align-items: center; justify-content: center; font-size: 11px;
            z-index: 101; user-select: none; pointer-events: none;
            box-shadow: -1px 0 3px rgba(0,0,0,0.1);
        }
        .shape-widget:focus-within .resize-lock-btn { opacity: 1; pointer-events: auto; }
        .shape-widget[data-group-id]:focus-within .resize-lock-btn { opacity: 0 !important; pointer-events: none !important; }
        .resize-lock-btn.locked { background: #4a90e2; color: white; border-color: #357abd; }
        /* Boutons sym√©trie sur forme individuelle */
        .flip-h-btn, .flip-v-btn {
            position: absolute; width: 20px; height: 18px; background: white; border: 1px solid #ccc;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
            display: flex; align-items: center; justify-content: center; font-size: 11px;
            z-index: 101; user-select: none; pointer-events: none;
            box-shadow: -1px 0 3px rgba(0,0,0,0.1);
        }
        .flip-h-btn { right: 60px; bottom: 0; border-radius: 4px 0 0 0; }
        .flip-v-btn { right: 40px; bottom: 0; border-radius: 0; }
        .shape-widget:focus-within .flip-h-btn,
        .shape-widget:focus-within .flip-v-btn { opacity: 1; pointer-events: auto; }
        .shape-widget[data-group-id]:focus-within .flip-h-btn,
        .shape-widget[data-group-id]:focus-within .flip-v-btn { opacity: 0 !important; pointer-events: none !important; }
        .flip-h-btn:hover, .flip-v-btn:hover, .resize-lock-btn:hover { background: #eef2f5; }
        /* Boutons sym√©trie dans l'overlay groupe */
        #sc-flip-h-btn, #sc-flip-v-btn {
            position: absolute; bottom: 14px;
            width: 24px; height: 24px; background: white; border: 1px solid #ccc;
            border-radius: 5px; cursor: pointer; pointer-events: auto;
            display: none; align-items: center; justify-content: center; font-size: 13px;
            z-index: 9992; user-select: none; box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        #sc-flip-h-btn { right: 44px; }
        #sc-flip-v-btn { right: 44px; bottom: 44px; }
        #sc-flip-h-btn:hover, #sc-flip-v-btn:hover, #sc-lock-btn:hover { background: #eef2f5; }
        /* Bouton verrou pour l'overlay groupe */
        #sc-lock-btn {
            position: absolute; right: 14px; bottom: 14px;
            width: 24px; height: 24px; background: white; border: 1px solid #ccc;
            border-radius: 5px; cursor: pointer; pointer-events: auto;
            display: none; align-items: center; justify-content: center; font-size: 13px;
            z-index: 9992; user-select: none; box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        #sc-lock-btn.locked { background: #4a90e2; color: white; border-color: #357abd; }

        /* --- S√âLECTION --- */
        .widget.selected, .widget.selected:focus-within {
            outline: 3px solid #4a90e2 !important;
            outline-offset: 6px;
            box-shadow: 0 0 0 6px rgba(74,144,226,0.25) !important;
        }
        .shape-widget.selected, .shape-widget.selected:focus-within {
            outline: 3px solid #4a90e2 !important;
            outline-offset: 6px;
            box-shadow: 0 0 0 6px rgba(74,144,226,0.25) !important;
        }
        /* Poign√©es visibles quand s√©lection UNIQUE uniquement */
		#board.single-select .widget.selected .drag-handle,
		#board.single-select .widget.selected .widget-close-handle,
		#board.single-select .widget.selected .widget-pin-handle,
		#board.single-select .widget.selected .widget-back-handle,
		#board.single-select .widget.selected .widget-rotate-handle,
		#board.single-select .widget.selected .widget-menu-handle,
		#board.single-select .shape-widget.selected .drag-handle,
		#board.single-select .shape-widget.selected .widget-close-handle,
		#board.single-select .shape-widget.selected .widget-pin-handle,
		#board.single-select .shape-widget.selected .widget-back-handle,
		#board.single-select .shape-widget.selected .widget-rotate-handle,
		#board.single-select .shape-widget.selected .widget-menu-handle { opacity: 1; pointer-events: auto; }

        /* Poign√©e resize + boutons sym√©trie/verrou visibles d√®s la s√©lection simple */
        .shape-widget.selected .shape-resize-handle { opacity: 1; }
        .shape-widget.selected .resize-lock-btn { opacity: 1; pointer-events: auto; }
        .shape-widget.selected .flip-h-btn      { opacity: 1; pointer-events: auto; }
        .shape-widget.selected .flip-v-btn      { opacity: 1; pointer-events: auto; }

        /* Masquer ces boutons en multi-s√©lection */
        #board.multi-select .shape-widget.selected .shape-resize-handle,
        #board.multi-select .shape-widget.selected .resize-lock-btn,
        #board.multi-select .shape-widget.selected .flip-h-btn,
        #board.multi-select .shape-widget.selected .flip-v-btn { opacity: 0 !important; pointer-events: none !important; }

        /* Masquer aussi pour les formes membres d'un groupe */
        .shape-widget[data-group-id].selected .shape-resize-handle,
        .shape-widget[data-group-id].selected .resize-lock-btn,
        .shape-widget[data-group-id].selected .flip-h-btn,
        .shape-widget[data-group-id].selected .flip-v-btn { opacity: 0 !important; pointer-events: none !important; }

        /* --- Sous-menu formes --- */
        #shape-toolbar {
            display: none; position: fixed; bottom: 80px; left: 30px;
            background: #1F1F21; border-radius: 14px; padding: 16px;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.4); z-index: 9998; border: 1px solid #3a3a3f;
            min-width: 300px;
        }
        #shape-toolbar.active { display: block; }
        .shape-toolbar-title { color: #666; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #2e2e2e; }
        .shape-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 7px; margin-bottom: 14px; }
        .shape-choice {
            width: 52px; height: 52px; background: #28282f; border: 1px solid #2e2e38;
            border-radius: 10px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: 0.15s; flex-direction: column; gap: 3px;
        }
        .shape-choice:hover { border-color: #4a90e2; background: #1a3550; }
        .shape-choice.active { border-color: #4a90e2; background: #1a3550; box-shadow: 0 0 0 2px rgba(74,144,226,0.3); }
        .shape-choice svg { pointer-events: none; }
        .shape-choice-label { color: #666; font-size: 9px; pointer-events: none; text-align: center; line-height: 1; }
        .shape-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; border-top: 1px solid #2e2e2e; padding-top: 12px; }
        .shape-controls label { color: #666; font-size: 11px; white-space: nowrap; }
        .shape-opacity-row { display: flex; align-items: center; gap: 8px; width: 100%; flex-wrap: wrap; margin-top: 8px; }
        .shape-opacity-row label { color: #666; font-size: 11px; }
        #shape-opacity-slider { flex: 1; min-width: 80px; cursor: pointer; }
        #shape-opacity-val { color: #aaa; font-size: 11px; min-width: 28px; }
        .shape-add-btn {
            margin-top: 12px; width: 100%; padding: 9px; background: #28282f;
            color: #aaa; border: 1px dashed #3a3a4a; border-radius: 10px; cursor: pointer;
            font-weight: 700; font-size: 12px; transition: background 0.15s;
        }
        .shape-add-btn:hover { background: #35353f; color: #e8e8f0; border-style: solid; border-color: #4a90e2; }
        .shape-toolbar-close {
            position: absolute; top: 12px; right: 12px; background: none; border: none;
            color: #555; cursor: pointer; font-size: 14px; padding: 3px 6px; border-radius: 6px; transition: .15s;
        }
        .shape-toolbar-close:hover { color: #ccc; background: #2e2e38; }

        /* --- OVERLAY DE S√âLECTION --- */
        #selection-controls {
            position: absolute; pointer-events: none; z-index: 9990; display: none;
            border: 2px dashed rgba(74,144,226,0.8); border-radius: 4px;
            box-shadow: 0 0 0 1px rgba(74,144,226,0.15);
        }
        #selection-controls .sc-btn {
            position: absolute; width: 32px; height: 32px; background: #f8f9fa; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; pointer-events: auto;
            font-size: 15px; user-select: none; z-index: 9991;
        }
        #selection-controls .sc-move   { left: -16px; top: 50%; transform: translateY(-50%); color: #666; cursor: move; }
        #selection-controls .sc-rotate { right: -16px; top: 50%; transform: translateY(-50%); color: #8E51FF; cursor: grab; }
        #selection-controls .sc-rotate:active { cursor: grabbing; }
        #selection-controls .sc-delete { top: 5px; right: 5px; color: #ff5f56; }
        #selection-controls .sc-menu   { top: 5px; left: 5px; color: #555; }
        #selection-controls .sc-merge   { bottom: -18px; left: 50%; transform: translateX(-50%); color: #2bcbba; display: none; white-space: nowrap; width: auto; padding: 0 10px; font-size: 11px; font-weight: 600; }
        #selection-controls .sc-ungroup { bottom: -18px; left: 50%; transform: translateX(-50%); color: #f39c12; display: none; white-space: nowrap; width: auto; padding: 0 10px; font-size: 11px; font-weight: 600; }
        #selection-controls .sc-resize  { right: -8px; bottom: -8px; width: 18px; height: 18px; cursor: se-resize; font-size: 11px; color: #f39c12; background: white; border-color: #f39c12; border-radius: 3px; }
        #selection-controls .sc-btn:hover { background: white; }
        #selection-controls .sc-move:hover   { transform: translateY(-50%) scale(1.1); }
        #selection-controls .sc-rotate:hover { transform: translateY(-50%) scale(1.1); }
        #selection-controls .sc-merge:hover   { background: #e0faf8; transform: translateX(-50%) scale(1.05); }
        #selection-controls .sc-ungroup:hover { background: #fff8e6; transform: translateX(-50%) scale(1.05); }
        /* Membres d'un groupe au repos : bordure ambr√©e discr√®te sur les widgets texte uniquement */
        .widget[data-group-id]              { border-color: rgba(243,156,18,0.35) !important; box-shadow: none !important; }
        .widget[data-group-id]:focus-within { border-color: rgba(243,156,18,0.5)  !important; box-shadow: none !important; }
        /* Membres s√©lectionn√©s (groupe actif) : bordure bleue nette */
        .widget.selected[data-group-id]        { outline: 3px solid #4a90e2 !important; outline-offset: 6px; box-shadow: 0 0 0 6px rgba(74,144,226,0.25) !important; }
        .shape-widget.selected[data-group-id]  { outline: 3px solid #4a90e2 !important; outline-offset: 6px; box-shadow: 0 0 0 6px rgba(74,144,226,0.25) !important; }
        #sc-ctx-menu {
            position: absolute; top: 38px; left: 5px; background: #1F1F21;
            border: 1px solid #444; border-radius: 10px; padding: 5px 0;
            min-width: 175px; z-index: 9995; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            display: none; flex-direction: column; pointer-events: auto;
        }
        #sc-ctx-menu.open { display: flex; }
        #sc-ctx-menu button {
            background: none; border: none; color: #eee; padding: 7px 14px;
            text-align: left; cursor: pointer; font-size: 13px; display: flex;
            align-items: center; gap: 8px; white-space: nowrap;
        }
        #sc-ctx-menu button:hover { background: #333; }
        #sc-ctx-menu hr { border: none; border-top: 1px solid #444; margin: 4px 0; }

        /* --- CONTENU --- */
		.widget[data-type="text"] .editor-container, .widget[data-type="homework"] .editor-container { border: none; }
		.widget[data-type="date"], .widget[data-type="time"] { min-width: unset; width: auto; }
		.widget[data-type="date"] .editor-container, .widget[data-type="time"] .editor-container { overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; resize: none; }
		.widget[data-type="date"] .editor-container { min-width: 150px; min-height: 180px; }
		.widget[data-type="time"] .editor-container { min-width: 120px; min-height: 80px; }
		.widget[data-type="time"] .editor-container { border: none; }
		.widget[data-type="date"] .editor-container::-webkit-resizer,
		.widget[data-type="time"] .editor-container::-webkit-resizer { background-color: transparent; background-image: none; }
		.editor-toolbar { display: flex; visibility: hidden; opacity: 0; gap: 4px; padding: 0px 35px; background: #f8f9fa; border-bottom: 1px solid #eee; flex-wrap: wrap; align-items: center; min-height: 36px; }
		.widget:focus-within .editor-toolbar { visibility: visible; opacity: 1; }
		.widget[data-type="iframe"] .editor-toolbar,
		.widget[data-type="youtube"] .editor-toolbar,
		.widget[data-type="pdf"] .editor-toolbar,
		.widget[data-type="deficalme"] .editor-toolbar,
		.widget[data-type="outilsprofs"] .editor-toolbar { visibility: visible; opacity: 1; }
		.widget-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
		.editor-container { display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; background: white; flex-grow: 1; overflow: hidden; resize: none; min-width: 180px; min-height: 70px; }
		.widget:hover .editor-container { resize: both; }
		.editor-container::-webkit-resizer { background-color: transparent; }
		.widget:hover .editor-container::-webkit-resizer { background-color: #ccc; background-image: linear-gradient(135deg, transparent 50%, #333 50%, #333 60%, transparent 60%, transparent 70%, #333 70%, #333 80%, transparent 80%); }
		.editor-toolbar button, .editor-toolbar select, .editor-toolbar input { padding: 2px 4px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 11px; height: 26px; box-sizing: border-box; }
		@font-face { font-family: 'KGPerfectPenmanship'; src: url('polices/KGPerfectPenmanship.ttf') format('truetype'); }
		@font-face { font-family: 'Andika'; src: url('polices/Andika.ttf') format('truetype'); }
		@font-face { font-family: 'OpenDyslexicLocal'; src: url('polices/OpenDyslexic-Regular.otf') format('opentype'); }
		@font-face { font-family: 'BelleAllureGS'; src: url('polices/BelleAllureGS-Gros.otf') format('opentype'); }
		.editor-content { padding: 10px; outline: none; overflow: auto; text-align: left; flex-grow: 1; }

		/* --- ANIMATIONS MODALES --- */
		@keyframes fadeInOverlay { from { opacity:0; } to { opacity:1; } }
		@keyframes slideUpModal  { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

		/* --- WIDGET M√âT√âO --- */
		.widget[data-type="meteo"] { min-width: unset; background: transparent !important; border: none !important; box-shadow: none !important; }
		.widget[data-type="meteo"] .editor-container { border: none; border-radius: 16px; overflow: hidden; resize: both; }
		.meteo-city-name { text-decoration: underline dotted; }

		/* --- TOOLBAR & MENUS --- */
		#toolbar-container { position: fixed; bottom: 65px; left: 30px; display: flex; flex-direction: column; align-items: flex-start; z-index: 9999; background: transparent; }
		#bg-submenu { display: none; position: fixed; right: 30px; bottom: 80px; background: #1F1F21; border-radius: 12px; padding: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.4); grid-template-columns: repeat(3, 1fr); gap: 10px; min-width: 200px; border: 1px solid #3a3a3f; z-index: 10001; }
		#bg-submenu.active { display: grid; }
		#bg-submenu-title { color:#aaa;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;grid-column:span 3; }
		#bg-submenu-import { background:#8e44ad;color:white;padding:5px 8px;font-size:11px;width:100%;margin-top:2px;border-radius:8px;border:none;cursor:pointer;grid-column:span 3; }
		@media (max-width: 600px) { #bg-submenu { right: 10px; bottom: 120px; min-width: 180px; grid-template-columns: repeat(2, 1fr); } }
		/* --- BOUTONS BARRE DU BAS --- */
		.tool-btn {
			background: #1F1F21; color: #ccc; border: 1px solid #3a3a4a;
			padding: 8px 10px; border-radius: 10px; cursor: pointer;
			font-size: 18px; display: flex; align-items: center; justify-content: center;
			transition: background .15s; box-sizing: border-box; white-space: nowrap; flex-shrink: 0;
		}
		.tool-btn:hover { background: #2e2e3a; color: #e8e8f0; }
		.tool-btn.active-tool { background: #1a3550; border-color: #4a90e2; color: #7ab8f5; }
		.undo-btn, .redo-btn {
			background: #1F1F21; color: #555; border: 1px solid #2e2e38;
			padding: 8px 10px; border-radius: 10px; cursor: not-allowed;
			font-size: 18px; display: flex; align-items: center; justify-content: center;
			box-sizing: border-box; flex-shrink: 0; transition: background .15s;
		}
		.undo-btn.enabled, .redo-btn.enabled { color: #ccc; cursor: pointer; }
		.undo-btn.enabled:hover, .redo-btn.enabled:hover { background: #2e2e3a; color: #e8e8f0; }
		.menu-btn { display: none; }
		#tools-menu { display: none; background: #1F1F21; border-radius: 14px; padding: 12px; box-shadow: var(--shadow); margin-bottom: 15px; gap: 8px; min-width: 220px; border: 1px solid #333; position: relative; max-height: 80vh; overflow-y: auto; overflow-x: hidden; grid-template-columns: repeat(3, 1fr); }
		#tools-menu.active { display: grid; }
		.widget-btn { background: #28282f; color: #ddd; border: none; padding: 14px 8px 10px; border-radius: 12px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 6px; width: 100%; transition: background .15s; line-height: 1.2; text-align: center; white-space: nowrap; }
		.widget-btn:hover { background: #35353f; }
		.widget-btn .ico { font-size: 26px; line-height: 1; }
		#main-tool-btn { background: #333; width: 100px; justify-content: center; }
		.exit-fs-btn { display: none; position: absolute; top: 10px; right: 10px; z-index: 99999; background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
		:fullscreen .exit-fs-btn { display: block; }
		.bg-thumb { width: 70px; height: 50px; border-radius: 6px; border: 2px solid #eee; cursor: pointer; background-size: cover; background-position: center; transition: 0.2s; }
		.bg-thumb:hover { transform: scale(1.05); border-color: var(--primary-color); }

		#font-size-input::-webkit-outer-spin-button,
		#font-size-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
		#font-size-input { -moz-appearance: textfield; appearance: textfield; }

        /* --- CANVAS --- */
        #draw-canvas { position: absolute; top: 0; left: 0; z-index: 12000; cursor: crosshair; touch-action: none; }
        #draw-canvas.inactive { pointer-events: none; cursor: default; z-index: 500; }
        #selection-rect { position: absolute; border: 2px dashed #4a90e2; background: rgba(74,144,226,0.08); pointer-events: none; z-index: 600; display: none; }

        /* --- CALENDRIER & HORLOGE --- */
        .calendar-page { width: 100%; height: 100%; display: flex; flex-direction: column; border: 1px solid #ced4da; border-radius: 8px; overflow: hidden; background: white; text-align: center; position: relative; padding-top: 15px; box-sizing: border-box; }
        .calendar-header { background: #D17B6B; height: 20%; min-height: 30px; border-bottom: 2px solid #D17B6B; margin-bottom: 5px; }
        .calendar-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 5px; }
        .calendar-day-name   { font-size: 0.95em; font-weight: 700; color: #333; text-transform: lowercase; }
        .calendar-day-number { font-size: 2.5em; font-weight: 800; color: #2c3e50; line-height: 1em; margin: 0.12em 0; }
        .calendar-month      { font-size: 1.25em; font-weight: 600; color: #333; }
        .clock-time { font-weight: 800; color: var(--primary-color); font-family: 'Courier New', monospace; display: flex; align-items: baseline; justify-content: center; width: 100%; gap: 4px; }
        .clock-seconds { font-size: 0.5em; color: #888; margin-left: 0.1em; }
        .icon-transparency { display: inline-block; width: 16px; height: 16px; border: 1px solid #333; background-color: #fff; background-image: linear-gradient(45deg,#ddd 25%,transparent 25%),linear-gradient(-45deg,#ddd 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ddd 75%),linear-gradient(-45deg,transparent 75%,#ddd 75%); background-size: 8px 8px; background-position: 0 0,0 4px,4px -4px,-4px 0px; vertical-align: middle; border-radius: 2px; }

        /* --- AGENDA --- */
        .agenda-container { display: flex; flex-direction: column; background: #fff; border-radius: 8px; border: 1px solid #eee; overflow: hidden; min-height: 200px; }
        .agenda-header-title { background: #2b7fff; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-family: 'Segoe UI', sans-serif; border-radius: 4px 4px 0 0; font-size: 1.6em; }
        .agenda-current-time { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }
        .agenda-list { padding: 10px; flex-grow: 1; }
        .agenda-item { display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px dashed #eee; position: relative; }
        .agenda-item:last-child { border-bottom: none; }
        .agenda-item.dragging { opacity: 0.5; background: #f0f7ff; border: 1px dashed var(--primary-color); }
        .agenda-time { font-weight: bold; color: #4a90e2; font-size: 1.6em; min-width: 45px; outline: none; cursor: text; }
        .agenda-text { outline: none; flex-grow: 1; font-size: 1.6em; color: #333; }
        .agenda-add-btn { background: #f8f9fa; border: none; border-top: 1px solid #eee; padding: 5px; cursor: pointer; color: #4a90e2; font-weight: bold; font-size: 1.2em; transition: background 0.2s; }
        .agenda-add-btn:hover { background: #eef2f5; color: #2c3e50; }
        .agenda-row-handle { cursor: grab; color: #ccc; padding: 0 5px; font-size: 0.75em; user-select: none; }
        .agenda-row-handle:active { cursor: grabbing; }
        .agenda-delete-row { cursor: pointer; color: #e74c3c; font-weight: bold; font-size: 1em; padding: 0 5px; opacity: 0; transition: opacity 0.2s; }
        .agenda-item:hover .agenda-delete-row { opacity: 1; }

        /* --- PANNEAU √âDITION FORME --- */
        #shape-edit-panel { display:none; position:fixed; background:#1F1F21; border-radius:14px; padding:14px 16px; box-shadow:0 -4px 30px rgba(0,0,0,0.4); z-index:10000; border:1px solid #3a3a3f; min-width:300px; }

        /* --- MODALES --- */
        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; border-radius:var(--border-radius); box-shadow:var(--shadow); text-align:center; max-width:400px; width:90%; }
        .modal-content button { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .modal-content .btn-cancel { border: 1px solid #ddd; background: #f8f9fa; color: var(--text-color); }
        .modal-content .btn-confirm { border: none; background: #ff4757; color: white; }

		/* Aide ‚Äî items de navigation */
		.help-nav {
		  display: flex; align-items: center; gap: 8px;
		  padding: 9px 18px; cursor: pointer; font-size: 13px;
		  color: #444; font-weight: 500; border-left: 3px solid transparent;
		  transition: all 0.15s; user-select: none;
		}
		.help-nav:hover { background: #e8edf5; color: #2B7FFF; }

		/* --- MODE PR√âSENTATION --- */
		body.presentation-mode #board {
			position: fixed !important;
			top: 0 !important; left: 0 !important;
			width: 100vw !important; height: 100vh !important;
			z-index: 1 !important;
		}
		body.presentation-mode #draw-canvas {
			position: fixed !important;
			top: 0 !important; left: 0 !important;
		}
		body.presentation-mode .widget .drag-handle,
		body.presentation-mode .widget .widget-close-handle,
		body.presentation-mode .widget .widget-pin-handle,
		body.presentation-mode .widget .widget-back-handle,
		body.presentation-mode .widget .widget-rotate-handle,
		body.presentation-mode .widget .widget-menu-handle,
		body.presentation-mode .widget .editor-toolbar,
		body.presentation-mode .widget .widget-ctx-menu,
		body.presentation-mode .shape-widget .drag-handle,
		body.presentation-mode .shape-widget .widget-close-handle,
		body.presentation-mode .shape-widget .widget-pin-handle,
		body.presentation-mode .shape-widget .widget-back-handle,
		body.presentation-mode .shape-widget .widget-rotate-handle,
		body.presentation-mode .shape-widget .widget-menu-handle,
		body.presentation-mode .shape-widget .shape-resize-handle,
		body.presentation-mode .shape-widget .resize-lock-btn,
		body.presentation-mode .shape-widget .flip-h-btn,
		body.presentation-mode .shape-widget .flip-v-btn { opacity: 0 !important; pointer-events: none !important; }
		body.presentation-mode .widget:focus-within,
		body.presentation-mode .shape-widget:focus-within {
			border-color: transparent !important;
			box-shadow: var(--shadow) !important;
			outline: none !important;
		}
		body.presentation-mode .widget,
		body.presentation-mode .shape-widget {
			pointer-events: none !important;
			cursor: default !important;
		}
		/* Garder les interactions internes des widgets (clics sur iframes, vid√©os, m√©t√©o...) */
		body.presentation-mode .widget .editor-container,
		body.presentation-mode .widget iframe,
		body.presentation-mode .widget .meteo-city {
			pointer-events: auto !important;
		}
		body.presentation-mode #selection-controls { display: none !important; }
		/* Bouton pr√©sentation en mode pr√©sentation : style "Quitter" discret */
		body.presentation-mode #presentation-btn {
			background: rgba(20,20,20,0.75) !important;
			border-color: rgba(255,255,255,0.2) !important;
			font-size: 13px !important;
			padding: 10px 16px !important;
			border-radius: 12px !important;
			opacity: 1 !important;
		}
		body.presentation-mode #presentation-btn:hover {
			background: rgba(50,50,50,0.95) !important;
		}

		/* POINTEUR LASER */
		#laser-pointer {
			position: fixed; pointer-events: none; z-index: 99999;
			width: 24px; height: 24px; border-radius: 50%;
			background: radial-gradient(circle, #fff 0%, #ff0000 35%, rgba(255,0,0,0.4) 65%, transparent 100%);
			box-shadow: 0 0 8px 4px rgba(255,0,0,0.5);
			transform: translate(-50%, -50%);
			display: none;
			transition: none;
		}
		#laser-pointer.active { display: block; }

		/* ‚ïê‚ïê‚ïê SC√àNES ‚ïê‚ïê‚ïê */
		#scenes-bar {
			display: flex; align-items: center; gap: 4px;
			pointer-events: auto; flex-wrap: nowrap; overflow-x: auto;
			max-width: 55vw; scrollbar-width: none;
		}
		#scenes-bar::-webkit-scrollbar { display: none; }
		.scene-tab {
			display: flex; align-items: center; gap: 5px;
			background: #cccccc; color: #333; border: 2px solid rgba(0,0,0,0.2);
			border-radius: 20px; padding: 5px 12px; font-size: 13px; font-weight: 600;
			cursor: pointer; white-space: nowrap; user-select: none;
			box-sizing: border-box; transition: background 0.15s, color 0.15s;
			max-width: 160px;
		}
		.scene-tab:hover { background: #bbbbbb; }
		.scene-tab.active {
			background: #2B7FFF; color: white;
			border-color: rgba(0,0,255,0.2);
		}
		.scene-tab-name {
			outline: none; cursor: pointer;
			max-width: 100px; overflow: hidden;
			text-overflow: ellipsis; white-space: nowrap;
		}
		.scene-tab-name:focus {
			border-bottom: 1px solid rgba(255,255,255,0.6);
			cursor: text;
		}
		.scene-tab-close {
			font-size: 14px; line-height: 1; opacity: 0.6;
			transition: opacity 0.15s; flex-shrink: 0;
		}
		.scene-tab-close:hover { opacity: 1; }
		.scene-tab.active .scene-tab-close { color: white; }
		#scene-add-btn {
			background: #eeeeee; color: #555; border: 2px solid rgba(0,0,0,0.3);
			border-radius: 20px; width: 34px; height: 34px;
			font-size: 20px; font-weight: 700; cursor: pointer;
			display: flex; align-items: center; justify-content: center;
			flex-shrink: 0; transition: background 0.15s;
			box-sizing: border-box; line-height: 1;
		}
		#scene-add-btn:hover { background: #ddd; }
		#scene-add-btn:disabled { opacity: 0.35; cursor: not-allowed; }

		/* === PANNEAU STICKERS === */
		#sticker-panel {
			display: none; position: fixed; bottom: 80px; left: 30px;
			background: #1F1F21; border-radius: 16px; padding: 14px 14px 10px;
			box-shadow: 0 -4px 30px rgba(0,0,0,0.5); z-index: 9998;
			border: 1px solid #3a3a3f; width: 400px;
		}
		#sticker-panel.active { display: block; }
		.sp-title { color: #888; font-size: 10px; font-weight: 700; text-transform: uppercase;
			letter-spacing: 1.2px; margin-bottom: 10px; padding-bottom: 8px;
			border-bottom: 1px solid #2e2e2e; display: flex; justify-content: space-between; align-items: center; }
		.sp-close { background: none; border: none; color: #555; cursor: pointer;
			font-size: 15px; line-height: 1; padding: 2px 5px; border-radius: 4px; }
		.sp-close:hover { color: #aaa; }
		.sp-tabs { display: flex; gap: 5px; margin-bottom: 9px; flex-wrap: wrap; }
		.sp-tab { background: #28282f; color: #aaa; border: 1px solid #3a3a3f;
			border-radius: 8px; padding: 4px 9px; font-size: 11px; cursor: pointer;
			transition: background 0.15s; white-space: nowrap; }
		.sp-tab:hover { background: #35353f; }
		.sp-tab.active { background: #1a3550; border-color: #4a90e2; color: #7ab8f5; }
		.sp-search { width: 100%; box-sizing: border-box; background: #28282f;
			border: 1px solid #3a3a3f; border-radius: 8px; color: #eee;
			padding: 6px 10px; font-size: 12px; margin-bottom: 9px; outline: none; }
		.sp-search:focus { border-color: #4a90e2; }
		.sp-empty { color: #555; font-size: 12px; text-align: center; padding: 20px 0; }
		/* Grille √©mojis anim√©s Noto */
		.sp-grid-anim { display: grid; grid-template-columns: repeat(7, 1fr);
			gap: 4px; max-height: 270px; overflow-y: auto; padding-right: 2px; }
		.sp-grid-anim::-webkit-scrollbar { width: 4px; }
		.sp-grid-anim::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
		.sp-anim-btn { background: #28282f; border: 1px solid #2e2e38;
			border-radius: 8px; cursor: pointer; padding: 2px;
			display: flex; align-items: center; justify-content: center;
			transition: all 0.12s; aspect-ratio: 1; }
		.sp-anim-btn:hover { background: #1a3550; border-color: #4a90e2; transform: scale(1.12); }
		.sp-anim-btn img { width: 42px; height: 42px; object-fit: contain; pointer-events: none; }
		/* Stickers : height fixe pour que le resize fonctionne */
		.widget[data-type="sticker"] { height: var(--sticker-h, 100px) !important; }

		/* Boutons bascule Anim√©s/Classiques */
		.sp-mode-btn { background:#28282f; color:#aaa; border:1px solid #3a3a3f;
			border-radius:8px; padding:5px 11px; font-size:12px; cursor:pointer;
			transition:background .15s; white-space:nowrap; flex-shrink:0; }
		.sp-mode-btn:hover  { background:#35353f; color:#eee; }
		.sp-mode-btn.active { background:#1a3550; border-color:#4a90e2; color:#7ab8f5; }

</style>
</head>
<body>

<div id="board">
    <div id="selection-controls">
        <div class="sc-btn sc-move"   id="sc-move-btn"   title="D√©placer">‚ú•</div>
        <div class="sc-btn sc-rotate" id="sc-rotate-btn" title="Faire pivoter">‚Üª</div>
        <div class="sc-btn sc-delete" id="sc-delete-btn" title="Supprimer">√ó</div>
        <div class="sc-btn sc-menu"   id="sc-menu-btn"   title="Menu">‚ò∞</div>
        <div class="sc-btn sc-resize"  id="sc-resize-btn"  title="Redimensionner le groupe">‚Üò</div>
        <div id="sc-lock-btn" title="Verrouiller les proportions (ou Shift)">üîì</div>
        <div id="sc-flip-h-btn" title="Sym√©trie horizontale">‚Üî</div>
        <div id="sc-flip-v-btn" title="Sym√©trie verticale">‚Üï</div>
        <div class="sc-btn sc-merge"   id="sc-merge-btn"   title="Grouper les widgets s√©lectionn√©s">‚äû Grouper</div>
        <div class="sc-btn sc-ungroup" id="sc-ungroup-btn" title="Dissocier le groupe">‚õìÔ∏è Dissocier</div>
        <div id="sc-ctx-menu"></div>
    </div>
</div>

<div id="toolbar-container">
    <div id="tools-menu">
        <button class="widget-btn" onclick="createWidget('youtube'); toggleMenu()"><span class="ico">üé¨</span>YouTube</button>
        <button class="widget-btn" onclick="createWidget('iframe'); toggleMenu()"><span class="ico">üíª</span>Fen√™tre Web</button>
		<button class="widget-btn" onclick="createWidget('outilsprofs'); toggleMenu()"><span class="ico"><img src="https://outilsprofs.fr/outilsprofs_icone.png" style="width:26px;height:26px;object-fit:contain;border-radius:6px;"></span>OutilsProfs</button>
		<button class="widget-btn" onclick="createWidget('agenda'); toggleMenu()"><span class="ico">üìå</span>Planning</button>
        <button class="widget-btn" onclick="createWidget('pdf'); toggleMenu()"><span class="ico">üìÑ</span>PDF</button>
		<button class="widget-btn" onclick="createWidget('deficalme'); toggleMenu()"><span class="ico">üßò</span>D√©fi Calme</button>
        <button class="widget-btn" onclick="createWidget('time'); toggleMenu()"><span class="ico">üïí</span>Heure</button>
        <button class="widget-btn" onclick="createWidget('date'); toggleMenu()"><span class="ico">üìÖ</span>Date</button>
        <button class="widget-btn" onclick="createWidget('meteo'); toggleMenu()"><span class="ico">‚õÖ</span>M√©t√©o</button>
        <button class="widget-btn" onclick="createWidget('homework'); toggleMenu()"><span class="ico">üìù</span>Devoirs</button>
        <button class="widget-btn" onclick="createWidget('text'); toggleMenu()"><span class="ico">üñäÔ∏è</span>Texte</button>


    </div>
	<div id="scenes-menu" style="display:none;position:fixed;bottom:80px;left:30px;background:#1F1F21;border-radius:14px;padding:14px 16px;box-shadow:0 -4px 30px rgba(0,0,0,0.4);z-index:9998;border:1px solid #3a3a3f;min-width:240px;">
        <div style="color:#666;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #2e2e2e;">üóÇÔ∏è Mes sc√®nes</div>
        <div id="scenes-menu-list" style="display:flex;flex-direction:column;gap:5px;margin-bottom:12px;"></div>
        <button id="scene-add-btn" onclick="addScene()" style="width:100%;padding:9px;background:#28282f;color:#aaa;border:1px dashed #3a3a4a;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px;transition:background .15s;" onmouseover="this.style.background='#35353f';this.style.color='#e8e8f0'" onmouseout="this.style.background='#28282f';this.style.color='#aaa'">Ôºã Nouvelle sc√®ne (copie)</button>
    </div>
    <!-- Sous-menu Formes -->
    <div id="shape-toolbar" style="position:relative;">
        <button class="shape-toolbar-close" onclick="toggleShapeToolbar()" title="Fermer">‚úñ</button>
        <div class="shape-toolbar-title">Choisir une forme</div>
        <div class="shape-grid" id="shape-grid"></div>
        <div class="shape-controls">
            <label>Contour :</label>
            <input type="color" id="shape-stroke-color" value="#2c3e50" title="Couleur du contour">
            <label>√âpaisseur :</label>
            <input type="range" id="shape-stroke-width" min="1" max="20" value="4" style="width:70px;cursor:pointer;">
            <span id="shape-stroke-width-val" style="color:#fff;font-size:11px;min-width:20px;">4</span>
            <label>Remplissage :</label>
            <input type="color" id="shape-fill-color" value="#4a90e2" title="Couleur de remplissage">
        </div>
        <div class="shape-opacity-row" style="margin-top:10px;">
            <label>Opacit√© remplissage :</label>
            <input type="range" id="shape-opacity-slider" min="0" max="100" value="60">
            <span id="shape-opacity-val">60%</span>
        </div>
        <button class="shape-add-btn" onclick="addShapeWidget()">Ôºã Ajouter la forme</button>
    </div>

    <!-- Panneau d'√©dition d'une forme existante -->
    <div id="shape-edit-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <span style="color:#aaa;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;">Modifier la forme</span>
            <button onclick="closeShapeEditPanel()" style="background:none;border:none;color:#666;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;">‚úñ</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;border-top:1px solid #333;padding-top:10px;">
            <label style="color:#aaa;font-size:11px;">Contour :</label>
            <input type="color" id="edit-stroke-color" value="#2c3e50" onchange="applyShapeEdit()">
            <label style="color:#aaa;font-size:11px;">√âpaisseur :</label>
            <input type="range" id="edit-stroke-width" min="1" max="20" value="4" style="width:70px;cursor:pointer;" oninput="document.getElementById('edit-stroke-width-val').textContent=this.value+'px';applyShapeEdit()">
            <span id="edit-stroke-width-val" style="color:#fff;font-size:11px;min-width:28px;">4px</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-top:8px;">
            <label style="color:#aaa;font-size:11px;">Remplissage :</label>
            <input type="color" id="edit-fill-color" value="#4a90e2" onchange="applyShapeEdit()">
            <label style="color:#aaa;font-size:11px;">Opacit√© :</label>
            <input type="range" id="edit-fill-opacity" min="0" max="100" value="60" style="width:70px;cursor:pointer;" oninput="document.getElementById('edit-fill-opacity-val').textContent=this.value+'%';applyShapeEdit()">
            <span id="edit-fill-opacity-val" style="color:#fff;font-size:11px;min-width:28px;">60%</span>
        </div>
    </div>

    <div id="draw-toolbar" style="display:none;position:fixed;bottom:80px;left:30px;background:#1F1F21;border-radius:12px;padding:12px 16px;box-shadow:0 -4px 20px rgba(0,0,0,0.3);z-index:9998;border:1px solid #444;min-width:420px;">
        <!-- S√©lection du mode dessin -->
        <div id="draw-mode-selector" style="display:flex;gap:6px;margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:10px;">
            <button id="draw-mode-free-btn" onclick="setDrawMode('free')" style="flex:1;padding:7px 8px;border-radius:8px;border:2px solid #4a90e2;background:#1a3550;color:#fff;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:5px;">
				‚úèÔ∏è Dessin libre
			</button>
			<button id="draw-mode-shape-btn" onclick="setDrawMode('shape')" style="flex:1;padding:7px 8px;border-radius:8px;border:2px solid #444;background:#2a2a2e;color:#aaa;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:5px;">
				üîµ Formes
			</button>
        </div>
        <!-- Contr√¥les communs -->
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
            <span style="color:#ccc;font-size:11px;">Couleur :</span>
            <input type="color" id="draw-color" value="#e84393" style="width:32px;height:28px;border:none;cursor:pointer;background:none;">
            <span style="color:#ccc;font-size:11px;">√âpaisseur :</span>
            <input type="range" id="draw-size" min="1" max="40" value="4" style="width:90px;cursor:pointer;">
            <span id="draw-size-label" style="color:#fff;font-size:12px;min-width:20px;">4</span>
            <!-- Options sp√©cifiques √† la reconnaissance de formes -->
            <div id="shape-recog-options" style="display:none;align-items:center;gap:8px;">
                <span style="color:#aaa;font-size:11px;">Remplissage :</span>
                <input type="color" id="shape-recog-fill" value="#4a90e2" style="width:28px;height:24px;border:none;cursor:pointer;background:none;">
                <span style="color:#aaa;font-size:11px;">Opacit√© :</span>
                <input type="range" id="shape-recog-opacity" min="0" max="100" value="30" style="width:70px;cursor:pointer;">
                <span id="shape-recog-opacity-val" style="color:#fff;font-size:11px;min-width:24px;">30%</span>
            </div>
            <button onclick="clearCanvas()" style="background:#ff4757;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">üóëÔ∏è Effacer</button>
            <button onclick="stopDrawing()" style="background:#6c757d;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">‚úñ Fermer</button>
        </div>
        <!-- Indicateur de mode formes -->
        <div id="shape-recog-hint" style="display:none;margin-top:8px;padding:5px 8px;background:#1a2e1a;border-radius:6px;border:1px solid #2d5a2d;">
            <span style="color:#7dba7d;font-size:11px;">üí° Dessinez un cercle, carr√©, rectangle ou triangle ‚Äî la forme sera reconnue √† la fin du trac√©</span>
        </div>
    </div>

    <div id="eraser-toolbar" style="display:none;position:fixed;bottom:80px;left:30px;background:#1F1F21;border-radius:12px;padding:12px 16px;box-shadow:0 -4px 20px rgba(0,0,0,0.3);z-index:9998;border:1px solid #444;">
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
            <span style="color:#ccc;font-size:12px;font-weight:600;">üßΩ Gomme</span>
            <span style="color:#ccc;font-size:11px;">Taille :</span>
            <input type="range" id="eraser-size" min="5" max="80" value="20" style="width:90px;cursor:pointer;" oninput="document.getElementById('eraser-size-label').textContent=this.value">
            <span id="eraser-size-label" style="color:#fff;font-size:12px;min-width:20px;">20</span>
            <button onclick="stopEraserMode()" style="background:#6c757d;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;">‚úñ Fermer</button>
        </div>
    </div>

    <div id="global-toolbar" style="position:fixed;bottom:80px;left:30px;right:30px;background:#1F1F21;border-radius:12px;display:none;padding:10px 15px;box-shadow:0 -4px 20px rgba(0,0,0,0.3);z-index:9998;border:1px solid #444;">
		<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
			<span style="background:#eee; color: #111; border-radius:12px; border:2px solid rgba(255,255,255,0.5);box-sizing:border-box;font-size:18px; font-weight: bold; ">&nbsp; Outils texte üñäÔ∏è &nbsp;</span>
			<div style="width:1px;height:20px;background:#444;"></div>
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="formatGlobal('bold')" style="cursor:pointer;" title="Gras"><b>G</b></button>
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="formatGlobal('italic')" style="cursor:pointer;" title="Italique"><i>I</i></button>
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="formatGlobal('underline')" style="cursor:pointer;" title="Soulign√©"><u>S</u></button>
			<span style="font-size:10px;color:#ccc;">Texte :</span>
			<input type="color" onmousedown="savedSelection=saveCurrentSelection()" onchange="applyTextColor(this.value)" style="cursor:pointer;" title="Couleur du texte">
			<span style="font-size:10px;color:#ccc;">Surligner :</span>
			<input type="color" onmousedown="savedSelection=saveCurrentSelection()" onchange="applyHighlightColor(this.value)" style="cursor:pointer;" title="Surligner" value="#ffff00">
			<span style="font-size:10px;color:#ccc;">Fond widget :</span>
			<input type="color" onchange="changeWidgetBgGlobal(this,this.value)" style="cursor:pointer;" title="Fond du cadre" value="#ffffff">
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="toggleTransparencyGlobal()" style="cursor:pointer;" title="Fond transparent"><span class="icon-transparency"></span></button>
				<span style="font-size:10px;color:#ccc;">Opacit√© fond :</span>
				<input type="range" id="widget-bg-opacity" min="0" max="100" value="100"
					onmousedown="savedSelection=saveCurrentSelection()"
					oninput="applyWidgetBgOpacity(this.value)"
					style="width:70px;cursor:pointer;">
				<span id="widget-bg-opacity-val" style="color:#fff;font-size:11px;min-width:28px;">100%</span>
			<select onmousedown="savedSelection=saveCurrentSelection()" onchange="formatFontFamilyGlobal(this.value)" style="width:140px; cursor:pointer;" ">
				<option value="Arial, sans-serif">Arial</option>
				<option value="'Segoe UI', sans-serif">Segoe UI</option>
				<option value="'Comic Sans MS', cursive">Comic Sans MS</option>
				<option value="Verdana, sans-serif">Verdana</option>
				<option value="'KGPerfectPenmanship', sans-serif">KGPerfectPenmanship</option>
				<option value="'Andika', sans-serif">Andika</option>
				<option value="'OpenDyslexicLocal', sans-serif">üß© OpenDyslexic</option>
				<option value="'BelleAllureGS', cursive">üìè Belle Allure GS</option>
			</select>
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="adjustFontSize(-2)" style="padding:2px 6px;font-size:14px;font-weight:bold;border:1px solid #555;background:#333;color:white;border-radius:4px;cursor:pointer;">‚àí</button>
			<input type="number" id="font-size-input" value="40" min="8" max="100"
				onmousedown="savedSelection=saveCurrentSelection()"
				onkeydown="if(event.key==='Enter'){applyFontSizeOnBlur(this);this.blur();}"
				onblur="applyFontSizeOnBlur(this)"
				style="width:40px;text-align:center;">
			<button onmousedown="savedSelection=saveCurrentSelection()" onclick="adjustFontSize(+2)" style="padding:2px 6px;font-size:14px;font-weight:bold;border:1px solid #555;background:#333;color:white;border-radius:4px;cursor:pointer;">+</button>
			<button onclick="closeGlobalToolbar()" style="margin-left:auto;background:#6c757d;color:white;padding:4px 8px;border-radius:4px; cursor:pointer;" ">‚úñ</button>
		</div>
	</div>

    <!-- Barre du bas -->
	<div id="bottom-bar" style="position:fixed;bottom:16px;left:0;right:0;z-index:9999;pointer-events:none;display:flex;flex-direction:column;gap:8px;padding:0 16px;">

		<!-- Ligne des sc√®nes -->
		<div style="display:flex;align-items:center;gap:6px;pointer-events:auto;align-self:flex-start;">

		</div>

		<!-- Ligne des outils -->
		<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;">
			<div style="display:flex;gap:10px;align-items:center;pointer-events:auto;flex-wrap:wrap;">
				<button id="main-tool-btn" onclick="toggleMenu()" style="background:#1F1F21;color:#e8e8f0;border:1px solid #3a3a4a;border-radius:12px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;line-height:1;transition:background .15s;box-sizing:border-box;" onmouseover="this.style.background='#2e2e3a'" onmouseout="this.style.background='#1F1F21'"><span style="font-size:20px;line-height:1;">üì¶</span>Widgets</button>
				<button id="scenes-btn" onclick="toggleScenesMenu()" style="background:#1F1F21;color:#e8e8f0;border:1px solid #3a3a4a;border-radius:12px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;line-height:1;transition:background .15s;box-sizing:border-box;" title="Sc√®nes" onmouseover="this.style.background='#2e2e3a'" onmouseout="this.style.background='#1F1F21'"><span style="font-size:20px;line-height:1;">üóÇÔ∏è</span>Sc√®nes</button>
				<button id="undo-btn" class="undo-btn" onclick="undoAction()" title="Annuler">‚Ü©</button>
				<button id="redo-btn" class="redo-btn" onclick="redoAction()" title="Refaire">‚Ü™</button>
				<button id="draw-btn" class="tool-btn" onclick="toggleDrawToolbar()" title="Dessiner">‚úèÔ∏è</button>
				<button id="shape-btn" class="tool-btn" onclick="toggleShapeToolbar()" title="Ajouter une forme">üî≤</button>
				<button id="sticker-btn" class="tool-btn" onclick="toggleStickerPanel()" title="Emojis anim√©s">üòÄ</button>
				<button id="eraser-btn" class="tool-btn" onclick="toggleEraserMode()" title="Gommer">üßΩ</button>
				<button id="laser-btn" class="tool-btn" onclick="toggleLaser()" title="Pointeur laser">üî¥</button>
			</div>
			<div style="display:flex;gap:10px;align-items:center;pointer-events:auto;flex-wrap:wrap;">
				<button class="tool-btn" onclick="toggleSubMenu(event)" title="Fond d'√©cran">üñºÔ∏è</button>
				<button class="tool-btn" onclick="exportConfig()" title="Sauvegarder">üíæ</button>
				<button class="tool-btn" onclick="document.getElementById('import-input').click()" title="Charger">üìÇ</button>
				<input type="file" id="import-input" style="display:none" accept=".json" onchange="importConfig(event)">
				<button class="tool-btn" onclick="clearBoard()" style="border-color:#3d2020;color:#ff6b6b;" title="Effacer tout">‚ùå</button>
				<button class="tool-btn" onclick="openHelpModal()" title="Aide">‚ùì</button>
			</div>
		</div>

	</div>

	<div id="bg-submenu">
		<div id="bg-submenu-title">üñºÔ∏è Fond d'√©cran</div>
		<div class="bg-thumb" style="background-color:#eef2f5;" onclick="applyBackground('none');saveBg('none');document.getElementById('bg-submenu').classList.remove('active')" title="D√©faut"></div>
		<div class="bg-thumb" style="background-color:#2f3542;" onclick="applyBackground('#2f3542');saveBg('#2f3542');document.getElementById('bg-submenu').classList.remove('active')" title="Ardoise"></div>
		<div class="bg-thumb" style="background-color:#104626;" onclick="applyBackground('#104626');saveBg('#104626');document.getElementById('bg-submenu').classList.remove('active')" title="Vert Tableau"></div>
		<div class="bg-thumb" style="background-color:#BAA09B;" onclick="applyBackground('#BAA09B');saveBg('#BAA09B');document.getElementById('bg-submenu').classList.remove('active')" title="Vieux rose"></div>
		<div class="bg-thumb" style="background-color:#EDD9D5;" onclick="applyBackground('#EDD9D5');saveBg('#EDD9D5');document.getElementById('bg-submenu').classList.remove('active')" title="Beige"></div>
		<div class="bg-thumb" style="background-color:#000000;" onclick="applyBackground('#000000');saveBg('#000000');document.getElementById('bg-submenu').classList.remove('active')" title="Noir"></div>
		<button id="bg-submenu-import" onclick="document.getElementById('bg-upload').click();document.getElementById('bg-submenu').classList.remove('active')">üì∑ Importer image</button>
	</div>

</div><!-- fin #toolbar-container -->

<!-- === PANNEAU STICKERS ANIM√âS NOTO === -->
<div id="sticker-panel">
	<div class="sp-title">
		<span>‚ú® Stickers Anim√©s</span>
		<button class="sp-close" onclick="toggleStickerPanel()" title="Fermer">‚úñ</button>
	</div>
	<!-- Bascule Anim√©s / Classiques -->
	<div style="display:flex;gap:6px;align-items:center;margin-bottom:10px;">
		<button id="sp-mode-animated" class="sp-mode-btn active" onclick="setStickerMode('animated')" title="√âmojis anim√©s Noto ‚Äî connexion internet requise">üåê Anim√©s</button>
		<button id="sp-mode-classic" class="sp-mode-btn" onclick="setStickerMode('classic')" title="√âmojis classiques ‚Äî fonctionne hors-ligne">üì¥ Classiques</button>
		<span id="sp-offline-badge" style="display:none;background:#ff4757;color:white;font-size:9px;font-weight:700;padding:2px 7px;border-radius:20px;white-space:nowrap;">HORS-LIGNE</span>
	</div>
	<!-- Section √©mojis anim√©s Noto -->
	<div id="sp-animated-section">
		<div class="sp-tabs" id="sp-tabs">
			<button class="sp-tab active" data-tab="üòä Visages & √©motions">üòä Visages</button>
			<button class="sp-tab" data-tab="üêæ Animaux & nature">üêæ Animaux</button>
			<button class="sp-tab" data-tab="üçï Nourriture">üçï Nourriture</button>
			<button class="sp-tab" data-tab="üöÄ Voyages">üöÄ Voyages</button>
			<button class="sp-tab" data-tab="üéâ Activit√©s">üéâ Activit√©s</button>
			<button class="sp-tab" data-tab="üí° Objets">üí° Objets</button>
			<button class="sp-tab" data-tab="üî£ Symboles">üî£ Symboles</button>
			<button class="sp-tab" data-tab="üè≥Ô∏è Drapeaux">üè≥Ô∏è Drapeaux</button>
			<button class="sp-tab" data-tab="üë• Personnes">üë• Personnes</button>
		</div>
	</div>
	<!-- Section √©mojis classiques (hors-ligne) -->
	<div id="sp-classic-section" style="display:none;">
		<div class="sp-tabs" id="sp-classic-tabs">
			<button class="sp-tab active" data-ctab="üòä Visages">üòä Visages</button>
			<button class="sp-tab" data-ctab="üêæ Animaux">üêæ Animaux</button>
			<button class="sp-tab" data-ctab="üçï Nourriture">üçï Nourrit.</button>
			<button class="sp-tab" data-ctab="üéâ F√™tes">üéâ F√™tes</button>
			<button class="sp-tab" data-ctab="üè´ √âcole">üè´ √âcole</button>
			<button class="sp-tab" data-ctab="üí° Objets">üí° Objets</button>
			<button class="sp-tab" data-ctab="üî£ Symboles">üî£ Symb.</button>
			<button class="sp-tab" data-ctab="üåç Nature">üåç Nature</button>
			<button class="sp-tab" data-ctab="üë§ Personnes">üë§ Pers.</button>
		</div>
	</div>
	<input type="text" class="sp-search" id="sp-search" placeholder="üîç Rechercher dans tous les √©mojis‚Ä¶" oninput="renderStickerPanel()">
	<div id="sp-content"></div>
</div>

<div id="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;color:#ff4757;">‚ö†Ô∏è Tout effacer ?</h3>
        <p style="color:#666;">Cette action videra votre bureau. C'est irr√©versible.</p>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
            <button class="btn-cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-confirm" onclick="confirmClearBoard()">Oui, vider tout</button>
        </div>
    </div>
</div>

<div id="help-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:20010;justify-content:center;align-items:center;padding:20px;">
<div style="background:#fff;border-radius:18px;width:100%;max-width:820px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.5);overflow:hidden;">

  <!-- EN-T√äTE -->
  <div style="background:linear-gradient(135deg,#2B7FFF 0%,#8E51FF 100%);color:white;padding:22px 28px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-shrink:0;">
    <div>
      <div style="font-size:1.4em;font-weight:800;">üìã Aide compl√®te ‚Äî Le Bureau du Prof</div>
      <div style="font-size:0.85em;opacity:0.85;margin-top:4px;">Cliquez sur une section dans le menu √† gauche pour naviguer.</div>
    </div>
    <button onclick="closeHelpModal()" style="background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:36px;height:36px;color:white;font-size:20px;cursor:pointer;flex-shrink:0;">√ó</button>
  </div>

  <!-- CORPS -->
  <div style="display:flex;flex:1;overflow:hidden;">

    <!-- SIDEBAR -->
    <nav id="help-sidebar" style="width:200px;flex-shrink:0;background:#f4f6f9;border-right:1px solid #e5e8ee;overflow-y:auto;padding:14px 0;">
      <div class="help-nav" data-s="h-intro"      onclick="helpShow(this)" style="border-left-color:#2B7FFF;background:#e8edf5;color:#2B7FFF;font-weight:700;">üè† Introduction</div>
      <div class="help-nav" data-s="h-widgets"    onclick="helpShow(this)">üì¶ Widgets</div>
      <div class="help-nav" data-s="h-selection"  onclick="helpShow(this)">üñ±Ô∏è S√©lection</div>
      <div class="help-nav" data-s="h-deplacement"onclick="helpShow(this)">‚ú• D√©placement</div>
      <div class="help-nav" data-s="h-rotation"   onclick="helpShow(this)">‚Üª Rotation</div>
      <div class="help-nav" data-s="h-groupes"    onclick="helpShow(this)">‚õìÔ∏è Groupes</div>
      <div style="height:1px;background:#e0e4ea;margin:8px 18px;"></div>
      <div class="help-nav" data-s="h-texte"      onclick="helpShow(this)">üñäÔ∏è Texte &amp; Format</div>
      <div class="help-nav" data-s="h-formes"     onclick="helpShow(this)">üî≤ Formes</div>
      <div class="help-nav" data-s="h-dessin"     onclick="helpShow(this)">‚úèÔ∏è Dessin libre</div>
      <div class="help-nav" data-s="h-gomme"      onclick="helpShow(this)">üßΩ Gomme</div>
      <div style="height:1px;background:#e0e4ea;margin:8px 18px;"></div>
      <div class="help-nav" data-s="h-fond"       onclick="helpShow(this)">üñºÔ∏è Fond d'√©cran</div>
      <div class="help-nav" data-s="h-sauvegarde" onclick="helpShow(this)">üíæ Sauvegarde</div>
      <div class="help-nav" data-s="h-undoredo"   onclick="helpShow(this)">‚Ü© Annuler / Refaire</div>
      <div class="help-nav" data-s="h-avance"     onclick="helpShow(this)">‚öôÔ∏è Options avanc√©es</div>
      <div style="height:1px;background:#e0e4ea;margin:8px 18px;"></div>
      <div class="help-nav" data-s="h-scenes"     onclick="helpShow(this)">üóÇÔ∏è Sc√®nes</div>
      <div class="help-nav" data-s="h-laser"      onclick="helpShow(this)">üî¥ Pointeur laser</div>
    </nav>

    <!-- CONTENU -->
    <div style="flex:1;overflow-y:auto;padding:28px 32px;font-family:'Segoe UI',system-ui,sans-serif;">

      <!-- INTRODUCTION -->
      <div id="h-intro" class="help-section">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üè† Bienvenue sur Le Bureau du Prof</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Le Bureau du Prof est un <strong>tableau de bord interactif</strong> con√ßu pour les enseignants. Il permet d'afficher simultan√©ment des widgets (heure, date, devoirs, agenda, vid√©os‚Ä¶), de dessiner librement, d'ajouter des formes g√©om√©triques et de tout sauvegarder.</p>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Le tableau respecte un <strong>format 16:9</strong> et s'adapte automatiquement √† la taille de votre √©cran ou vid√©oprojecteur.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">üó∫Ô∏è Organisation de l'interface</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:14px 16px;"><div style="font-size:13px;font-weight:700;color:#222;margin-bottom:6px;">‚¨áÔ∏è Barre du bas</div><p style="font-size:12.5px;color:#444;margin:0;">Acc√®s aux boutons <strong>WIDGETS</strong>, sc√®nes üóÇÔ∏è, dessin ‚úèÔ∏è, formes üî≤, gomme üßΩ, sauvegarde üíæ/üìÇ, effacement ‚ùå et aide ‚ùì.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:14px 16px;"><div style="font-size:13px;font-weight:700;color:#222;margin-bottom:6px;">üì¶ Menu WIDGETS</div><p style="font-size:12.5px;color:#444;margin:0;">S'ouvre au clic sur <strong>WIDGETS</strong>. Liste tous les types de widgets √† cr√©er + choix du fond.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:14px 16px;"><div style="font-size:13px;font-weight:700;color:#222;margin-bottom:6px;">üñäÔ∏è Barre de texte</div><p style="font-size:12.5px;color:#444;margin:0;">Appara√Æt automatiquement en cliquant dans un widget Texte ou Devoirs. Police, taille, couleur, gras, italique‚Ä¶</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:14px 16px;"><div style="font-size:13px;font-weight:700;color:#222;margin-bottom:6px;">üíæ Sauvegarde auto</div><p style="font-size:12.5px;color:#444;margin:0;">Tout est sauvegard√© dans le navigateur apr√®s chaque modification. Utilisez üíæ pour exporter en .json.</p></div>
        </div>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° <strong>D√©marrage :</strong> Cliquez sur <strong>WIDGETS</strong>, choisissez un type, puis glissez le widget en cliquant sur la poign√©e <strong>‚ú•</strong> qui appara√Æt sur sa gauche.</div>
        <div style="background:#1a1a2e;border-left:4px solid #8E51FF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#ccc;margin:10px 0;">üìΩÔ∏è <strong>Mode pr√©sentation :</strong> Cliquez sur le bouton <strong>üìΩÔ∏è</strong> en bas √† droite pour basculer en plein √©cran propre (sans interface). Le tableau est projet√© tel quel. Appuyez sur <strong>√âchap</strong> ou cliquez sur ¬´ Quitter la pr√©sentation ¬ª pour revenir.</div>
      </div>

      <!-- WIDGETS -->
      <div id="h-widgets" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üì¶ Les widgets disponibles</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Chaque widget est une fen√™tre flottante redimensionnable et d√©pla√ßable. Cliquez sur <strong>WIDGETS</strong> puis sur le type souhait√© pour l'ajouter au bureau.</p>
        <table style="width:100%;border-collapse:collapse;margin:10px 0 16px 0;font-size:13px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;color:#333;border-bottom:2px solid #dde2ea;">Widget</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;color:#333;border-bottom:2px solid #dde2ea;">Description</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;color:#333;border-bottom:2px solid #dde2ea;">Particularit√©</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#2B7FFF;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üñäÔ∏è Texte</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Zone de saisie libre avec mise en forme riche.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Barre de formatage globale automatique</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#3BB8DB;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üìù Devoirs</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Widget pr√©-rempli pour noter les devoirs par classe.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Contenu de d√©part modifiable</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#679638;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üìÖ Date</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Affiche le jour, num√©ro et mois en temps r√©el.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Police auto-adaptative √† la taille du widget</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#7CCF35;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üïí Heure</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Horloge num√©rique temps r√©el (h:min sec).</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Taille de police auto + fond transparent</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#8E51FF;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üìå Planning</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Agenda journalier avec lignes horaires.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Glisser-d√©poser des lignes, ajout/suppression</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#E7180B;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üé¨ YouTube</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Lecteur YouTube int√©gr√©.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Mode audio seul, plein √©cran</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#FFD230;color:#222;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üíª Fen√™tre Web</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Navigateur int√©gr√© pour tout site web.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Plein √©cran disponible</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#FF692A;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üéí OutilsProfs</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Ouvre directement ecolebernardet.github.io/outilsprofs.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Micro, cam√©ra autoris√©s</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#480eb3;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üßò D√©fi Calme</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Outil de gestion du calme en classe.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Plein √©cran disponible</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;"><span style="background:#E74C3C;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">üìÑ PDF</span></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Affiche un fichier PDF local.</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Fichier non sauvegard√© (r√©-ouvrir √† chaque session)</td></tr>
          <tr><td style="padding:8px 12px;"><span style="background:#00AACC;color:white;border-radius:5px;padding:2px 8px;font-size:11.5px;font-weight:700;">‚õÖ M√©t√©o</span></td><td style="padding:8px 12px;color:#444;">Affiche la m√©t√©o r√©elle de la ville de l'√©cole.</td><td style="padding:8px 12px;color:#444;">Via Open-Meteo (gratuit, sans cl√©). Clic sur le nom de la ville pour changer. Rafra√Æchi toutes les 10 min.</td></tr>
        </table>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">‚öôÔ∏è Contr√¥les communs √† tous les widgets</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Poign√©e</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Position</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Action</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚ú•</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Gauche (milieu)</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">D√©placer par glisser-d√©poser</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚Üª</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Droite (milieu)</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Faire pivoter (magn√©tisme 0¬∞/45¬∞/90¬∞‚Ä¶)</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">üìå</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Haut (centre)</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">√âpingler au premier plan (fond dor√© = √©pingl√©)</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">üîΩ</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Haut (droite du centre)</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Envoyer derri√®re tous les autres widgets</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚ò∞</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Bas (centre)</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Menu contextuel (dupliquer, modifier‚Ä¶)</td></tr>
          <tr><td style="padding:8px 12px;font-weight:700;color:#ff5f56;">√ó</td><td style="padding:8px 12px;color:#444;">Haut droite</td><td style="padding:8px 12px;color:#444;">Supprimer le widget</td></tr>
        </table>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:14px 0;">üí° <strong>Redimensionner :</strong> Survolez un widget pour faire appara√Ætre la poign√©e de redimensionnement (triangle gris, bas-droite de la zone de contenu).</div>
      </div>

      <!-- S√âLECTION -->
      <div id="h-selection" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üñ±Ô∏è S√©lectionner des widgets</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">Clic simple</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquer sur un widget le s√©lectionne (bordure bleue). Si le widget n'appartient √† aucun groupe, ses poign√©es natives apparaissent directement dessus.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">S√©lection multiple ‚Äî Ctrl + clic</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Maintenez <strong>Ctrl</strong> (ou ‚åò sur Mac) et cliquez sur plusieurs widgets. Recliquer sur un widget s√©lectionn√© le d√©s√©lectionne.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Rectangle de s√©lection</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez-glissez sur le <strong>fond du tableau</strong> (pas sur un widget) pour tracer un rectangle. Tous les widgets et traits √† l'int√©rieur sont s√©lectionn√©s.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Overlay de s√©lection multiple</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Quand plusieurs √©l√©ments sont s√©lectionn√©s, un cadre bleu pointill√© entoure l'ensemble :</p>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Bouton</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Action</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚ú•</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">D√©placer tout le groupe simultan√©ment</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚Üª</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Faire pivoter autour du centre de la s√©lection</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚Üò</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Redimensionner l'ensemble (+ Shift = proportionnel)</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;color:#ff5f56;">√ó</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Supprimer tous les √©l√©ments s√©lectionn√©s</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚ò∞</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Menu contextuel (dupliquer, premier plan‚Ä¶)</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚äû Grouper</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Cr√©er un groupe permanent (visible si ‚â• 2 √©l√©ments)</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚õìÔ∏è Dissocier</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Dissoudre un groupe existant</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚Üî / ‚Üï</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Sym√©trie horizontale / verticale</td></tr>
          <tr><td style="padding:8px 12px;font-weight:700;">üîì/üîí</td><td style="padding:8px 12px;color:#444;">Verrouiller/d√©verrouiller les proportions au redimensionnement</td></tr>
        </table>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° Double-clic sur ‚Üª (overlay multi-s√©lection) remet tous les √©l√©ments √† leur angle d'origine avant la rotation group√©e.</div>
      </div>

      <!-- D√âPLACEMENT -->
      <div id="h-deplacement" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚ú• D√©placer des widgets</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">D√©placer un widget seul</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez sur la poign√©e <strong>‚ú•</strong> √† gauche du widget (appara√Æt au survol ou √† la s√©lection), puis glissez. Rel√¢chez pour valider la position.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">D√©placer plusieurs widgets</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">S√©lectionnez plusieurs √©l√©ments (Ctrl+clic ou rectangle), puis utilisez la poign√©e ‚ú• de l'overlay bleu pour d√©placer tout le groupe d'un seul mouvement.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Ordre d'empilement (z-index)</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>üìå √âpingler</strong> ‚Äî place le widget en premier plan permanent. Son cadre devient dor√©.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>üîΩ Envoyer derri√®re</strong> ‚Äî place le widget tout derri√®re (utile pour les images de fond).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Tout clic sur un widget non √©pingl√© le remonte automatiquement au-dessus des autres.</li>
        </ul>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° <strong>Image de fond :</strong> Ajoutez une forme large ou un widget image, puis utilisez üîΩ pour l'envoyer derri√®re tous les autres √©l√©ments.</div>
      </div>

      <!-- ROTATION -->
      <div id="h-rotation" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚Üª Rotation des √©l√©ments</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">Rotation d'un widget seul</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez-glissez la poign√©e <strong>‚Üª</strong> √† droite du widget. L'angle s'affiche en temps r√©el dans une bulle flottante.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Magn√©tisme automatique</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">La rotation se "snap" automatiquement sur : <strong>0¬∞, 45¬∞, 90¬∞, 135¬∞, 180¬∞, 225¬∞, 270¬∞, 315¬∞</strong>. D√®s que vous approchez l'un de ces angles √† moins de 2¬∞, le widget s'y colle.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Remettre √† 0¬∞</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Double-cliquez sur la poign√©e <strong>‚Üª</strong> pour r√©initialiser instantan√©ment l'angle √† 0¬∞.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Rotation d'une s√©lection multiple</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">La rotation s'effectue autour du centre g√©om√©trique de la s√©lection. Tous les √©l√©ments (widgets + traits) pivotent ensemble.</p>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è Avec une s√©lection multiple, double-clic sur ‚Üª remet chaque widget √† son angle individuel d'avant la rotation group√©e (pas n√©cessairement 0¬∞).</div>
      </div>

      <!-- GROUPES -->
      <div id="h-groupes" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚õìÔ∏è Groupes de widgets</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Le groupement lie plusieurs √©l√©ments pour les d√©placer, redimensionner et faire pivoter ensemble comme un seul objet.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Cr√©er un groupe</div>
        <ol style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">S√©lectionnez au moins 2 √©l√©ments (Ctrl+clic ou rectangle).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Cliquez sur <strong>‚äû Grouper</strong> dans l'overlay bleu (ou via ‚ò∞).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Les membres du groupe sont li√©s (bordure ambr√©e sur les widgets texte).</li>
        </ol>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Interagir avec un groupe</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquer sur n'importe quel membre s√©lectionne <strong>tout le groupe</strong> d'un coup, affichant l'overlay multi-s√©lection complet.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Dissocier un groupe</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">S√©lectionnez un membre du groupe, puis cliquez sur <strong>‚õìÔ∏è Dissocier</strong> dans l'overlay ou dans ‚ò∞. Chaque √©l√©ment redevient ind√©pendant.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Groupes mixtes</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Un groupe peut contenir des widgets texte, des formes SVG <em>et</em> des traits de dessin libre. Tout se d√©place, pivote et redimensionne ensemble.</p>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° Pour ajouter un √©l√©ment √† un groupe existant, s√©lectionnez les membres du groupe + le nouvel √©l√©ment avec Ctrl+clic, puis regroupez. L'ancien groupe est absorb√© dans le nouveau.</div>
      </div>

      <!-- TEXTE -->
      <div id="h-texte" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üñäÔ∏è Texte &amp; Mise en forme</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Les widgets <strong>Texte</strong> et <strong>Devoirs</strong> sont des √©diteurs de texte enrichi. La <strong>barre de mise en forme globale</strong> s'affiche automatiquement en bas de l'√©cran d√®s qu'un de ces widgets est actif.</p>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin:10px 0 16px 0;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Outil</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Description</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">G / I / S</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Gras, Italique, Soulign√© sur le texte s√©lectionn√©</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">üé® Couleur texte</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Couleur du texte s√©lectionn√©</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">üñäÔ∏è Surligner</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Couleur de fond (surlignage) du texte s√©lectionn√©</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚¨ú Fond widget</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Couleur de fond de tout le widget</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚òë Transparence</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Rend le fond du widget enti√®rement transparent</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">üîÜ Opacit√© fond</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Slider 0‚Äì100% pour att√©nuer progressivement la couleur de fond</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">Police</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Arial, Segoe UI, Comic Sans, Verdana, KGPerfectPenmanship, Andika, üß© OpenDyslexic, üìè Belle Allure GS</td></tr>
          <tr><td style="padding:8px 12px;font-weight:700;">‚àí taille +</td><td style="padding:8px 12px;color:#444;">Diminue/augmente la taille de police de 2px. Saisie directe possible (Entr√©e pour valider).</td></tr>
        </table>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Polices sp√©ciales incluses</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">üß© OpenDyslexic</div><p style="font-size:12.5px;color:#444;margin:0;">Con√ßue pour faciliter la lecture des personnes dyslexiques.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">üìè Belle Allure GS</div><p style="font-size:12.5px;color:#444;margin:0;">Cursive adapt√©e √† l'√©cole primaire (√©criture li√©e).</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">‚úíÔ∏è KGPerfectPenmanship</div><p style="font-size:12.5px;color:#444;margin:0;">Style √©criture manuscrite soign√©e.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">üî° Andika</div><p style="font-size:12.5px;color:#444;margin:0;">Lisible, adapt√©e aux lecteurs d√©butants.</p></div>
        </div>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° <strong>S√©lectionnez avant de formater :</strong> S√©lectionnez le texte √† modifier AVANT de cliquer sur un bouton de la barre.</div>
      </div>

      <!-- FORMES -->
      <div id="h-formes" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üî≤ Formes g√©om√©triques</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:14px;">Cliquez sur le bouton <strong>üî≤</strong> en bas pour ouvrir le panneau des formes.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">‚≠ï Cercle / Ellipse</div><p style="font-size:12.5px;color:#444;margin:0;">Ellipse ronde ou ovale selon les dimensions.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">‚¨õ Carr√© / ‚ñ¨ Rectangle</div><p style="font-size:12.5px;color:#444;margin:0;">Formes rectangulaires √† dimensions libres.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">‚óá Losange / ‚ñ± Parall√©logramme</div><p style="font-size:12.5px;color:#444;margin:0;">Quadrilat√®res obliques.</p></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;"><div style="font-weight:700;font-size:13px;margin-bottom:4px;">‚Äî Ligne / ‚û°Ô∏è Fl√®che / ‚ñ≤ Triangle</div><p style="font-size:12.5px;color:#444;margin:0;">Trait, fl√®che directionnelle, triangle isoc√®le.</p></div>
        </div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Options de cr√©ation</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>Contour :</strong> couleur et √©paisseur (1 √† 20 px)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;"><strong>Remplissage :</strong> couleur + opacit√© (0 √† 100%)</li>
        </ul>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Modifier une forme existante</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;"><strong>Double-cliquez</strong> sur une forme pour ouvrir le panneau d'√©dition flottant. Changez contour, remplissage et opacit√© en temps r√©el.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Redimensionner</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Poign√©e bas-droite de la forme. Maintenez <strong>Shift</strong> ou activez üîí pour conserver le ratio largeur/hauteur.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Sym√©trie &amp; Duplication</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>‚Üî</strong> Sym√©trie horizontale (miroir gauche/droite)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>‚Üï</strong> Sym√©trie verticale (miroir haut/bas)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;"><strong>‚ò∞ ‚Üí ‚ßâ Dupliquer</strong> pour cloner la forme</li>
        </ul>
      </div>

      <!-- DESSIN -->
      <div id="h-dessin" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚úèÔ∏è Dessin libre &amp; Reconnaissance de formes</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez sur <strong>‚úèÔ∏è</strong> en bas pour activer le mode dessin. Une barre d'options appara√Æt.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Mode Dessin libre</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:8px;">Tracez √† main lev√©e avec la souris ou le stylet. Choisissez la <strong>couleur</strong> et l'<strong>√©paisseur</strong> (1 √† 40 px). Chaque trac√© est stock√© s√©par√©ment et peut √™tre s√©lectionn√©/d√©plac√©/supprim√© ind√©pendamment.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Mode Reconnaissance de formes üîµ</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:8px;">Basculez sur <strong>Formes</strong> dans la barre. Dessinez approximativement un cercle, carr√©, rectangle ou triangle : l'app d√©tecte automatiquement la forme et la remplace par une <strong>forme vectorielle nette</strong>.</p>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Options suppl√©mentaires : couleur et opacit√© du remplissage reconnu.</p>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0 14px 0;">üí° <strong>Conseil :</strong> Fermez votre trac√© (rejoignez le point de d√©part) pour d√©clencher la reconnaissance. Les formes non ferm√©es sont conserv√©es comme trac√© libre.</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Effacer / Quitter</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;"><strong>üóëÔ∏è Effacer</strong> ‚Äî supprime tous les traits du canvas</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;"><strong>‚úñ Fermer</strong> (ou recliquer ‚úèÔ∏è) ‚Äî quitte le mode dessin</li>
        </ul>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è En mode dessin, les widgets ne sont plus cliquables. Quittez le mode dessin pour interagir avec eux.</div>
      </div>

      <!-- GOMME -->
      <div id="h-gomme" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üßΩ Gomme</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez sur <strong>üßΩ</strong> en bas pour activer la gomme.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">Effacer des traits</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Passez la gomme sur les traits de dessin pour les effacer segment par segment. Les traits partiellement effac√©s sont d√©coup√©s proprement.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Effacer des formes SVG</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">La gomme s'applique aussi aux formes g√©om√©triques via un masque vectoriel. Si une forme est enti√®rement recouverte, elle est automatiquement supprim√©e.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">R√©gler la taille</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Curseur <strong>Taille</strong> (5 √† 80 px) dans la barre. Un aper√ßu circulaire s'affiche sous le curseur de la souris.</p>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">üí° Utilisez <strong>‚Ü© Annuler</strong> pour r√©tablir des traits effac√©s par erreur.</div>
      </div>

      <!-- FOND -->
      <div id="h-fond" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üñºÔ∏è Fond d'√©cran</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Menu <strong>WIDGETS</strong> ‚Üí bouton <strong>üñºÔ∏è Choisir fond ‚ùØ</strong>.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">Couleurs pr√©d√©finies</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#eef2f5;border:1px solid #ddd;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">D√©faut</div><p style="font-size:12px;color:#666;margin:0;">Gris clair neutre</p></div></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#2f3542;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">Ardoise</div><p style="font-size:12px;color:#666;margin:0;">Gris fonc√©</p></div></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#104626;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">Tableau vert</div><p style="font-size:12px;color:#666;margin:0;">Vert tableau classique</p></div></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#BAA09B;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">Vieux rose</div><p style="font-size:12px;color:#666;margin:0;">Tons chauds doux</p></div></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#EDD9D5;border:1px solid #ddd;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">Beige</div><p style="font-size:12px;color:#666;margin:0;">Chaleureux et reposant</p></div></div>
          <div style="background:#f8f9fb;border:1px solid #e5e8ee;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;"><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:#000;flex-shrink:0;"></span><div><div style="font-weight:700;font-size:13px;">Noir</div><p style="font-size:12px;color:#666;margin:0;">Fond enti√®rement noir</p></div></div>
        </div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Image personnalis√©e</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Bouton <strong>üì∑ Importer image</strong> ‚Üí s√©lectionnez une image depuis votre ordinateur. Elle est stock√©e en base64 dans le navigateur et recharg√©e automatiquement.</p>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è Les images tr√®s lourdes peuvent ralentir la sauvegarde locale. Privil√©giez des fichiers compress√©s (JPEG, WebP) de moins de 2 Mo.</div>
      </div>

      <!-- SAUVEGARDE -->
      <div id="h-sauvegarde" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üíæ Sauvegarde &amp; Chargement</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">Sauvegarde automatique</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Toute modification est enregistr√©e automatiquement dans le <strong>localStorage</strong> du navigateur. La prochaine ouverture restaure exactement l'√©tat pr√©c√©dent.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Exporter ‚Äî üíæ</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">T√©l√©charge un fichier <strong>.json</strong> contenant toutes les sc√®nes et leur contenu. Nomm√© automatiquement <code style="background:#f0f3f9;padding:1px 5px;border-radius:3px;font-size:12px;">lebureauduprof_export_AAAA-MM-JJ.json</code>.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Charger ‚Äî üìÇ</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">S√©lectionnez un fichier .json export√© pr√©c√©demment. Si le fichier contient plusieurs sc√®nes, elles sont toutes restaur√©es. Si c'est un fichier d'ancienne version (mono-sc√®ne), il est charg√© dans la sc√®ne active.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Ce qui est sauvegard√©</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Toutes les sc√®nes (nom, widgets, formes, dessins, fond)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Tous les widgets (type, position, taille, contenu, style)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Toutes les formes g√©om√©triques (type, couleurs, taille, rotation, flip)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Tous les traits de dessin libre</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Le fond d'√©cran de chaque sc√®ne (couleur ou image)</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Les groupes de widgets</li>
        </ul>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0 14px 0;">üí° <strong>Astuce :</strong> Exportez r√©guli√®rement un fichier .json comme sauvegarde externe en cas de suppression du cache du navigateur.</div>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è Les fichiers PDF ouverts via le widget PDF <em>ne sont pas</em> sauvegard√©s. Il faudra les r√©-ouvrir √† chaque session.</div>
      </div>

      <!-- ANNULER/REFAIRE -->
      <div id="h-undoredo" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚Ü© Annuler &amp; Refaire</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:14px;">Un historique de jusqu'√† <strong>60 √©tats</strong> est conserv√© pendant la session.</p>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Bouton</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Action</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Condition</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">‚Ü© Annuler</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Revient √† l'√©tat pr√©c√©dent</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Gris√© si aucune action √† annuler</td></tr>
          <tr><td style="padding:8px 12px;font-weight:700;">‚Ü™ Refaire</td><td style="padding:8px 12px;color:#444;">R√©tablit l'action annul√©e</td><td style="padding:8px 12px;color:#444;">Gris√© si rien √† refaire</td></tr>
        </table>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Ce qui est couvert</div>
        <ul style="padding-left:20px;margin-bottom:10px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Ajout / suppression de widgets ou de formes</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">D√©placement, rotation, redimensionnement</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Traits de dessin et effa√ßages</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Changements de fond</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Groupement / dissociation</li>
        </ul>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0 14px 0;">üí° Les modifications de texte (frappe clavier) sont enregistr√©es dans l'historique apr√®s 800 ms d'inactivit√©.</div>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è L'historique est local √† la sc√®ne active et est perdu si vous fermez ou rechargez la page. Exportez r√©guli√®rement avec üíæ.</div>
      </div>

      <!-- OPTIONS AVANC√âES -->
      <div id="h-avance" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">‚öôÔ∏è Options &amp; Fonctionnalit√©s avanc√©es</div>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:0 0 8px 0;">üóìÔ∏è Widget Planning ‚Äî d√©tail</div>
        <ul style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Cliquez sur une heure ou un texte pour l'√©diter directement.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Glissez les lignes via la poign√©e <strong>‚ãÆ‚ãÆ</strong> pour les r√©organiser.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Bouton <strong>+</strong> en bas pour ajouter une ligne.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Bouton <strong>√ó</strong> (au survol d'une ligne) pour supprimer.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">L'heure et la date courantes s'affichent en temps r√©el dans l'en-t√™te.</li>
        </ul>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">üé¨ Widget YouTube ‚Äî astuces</div>
        <ul style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;">Accepte les liens YouTube normaux, youtu.be et Shorts.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;"><strong>üîá Son seul</strong> : masque la vid√©o, id√©al pour une musique de fond discr√®te.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:3px;"><strong>üì∫ Vid√©o</strong> : r√©affiche la vid√©o.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Le bouton damier rend le fond du widget transparent.</li>
        </ul>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">üìê Redimensionnement adaptatif</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:14px;">Lorsque vous redimensionnez la fen√™tre du navigateur, tous les widgets et formes sont repositionn√©s et redimensionn√©s proportionnellement pour conserver le rendu 16:9.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">‚õ∂ Mode plein √©cran (widget)</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:14px;">Disponible sur YouTube, Fen√™tre Web, OutilsProfs, D√©fi Calme et PDF. Cliquez sur ‚õ∂ dans la barre du widget. Appuyez sur <strong>√âchap</strong> ou le bouton de sortie pour quitter.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">üìΩÔ∏è Mode pr√©sentation global</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:14px;">Le bouton <strong>üìΩÔ∏è</strong> en bas √† droite bascule l'interface en plein √©cran de projection : toute l'interface (boutons, menus, poign√©es) dispara√Æt et le tableau occupe tout l'√©cran. Id√©al pour la vid√©oprojection. Appuyez sur <strong>√âchap</strong> ou cliquez sur ¬´ Quitter la pr√©sentation ¬ª (en bas √† droite) pour revenir √† l'√©dition.</p>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:12px 16px;font-size:12.5px;color:#1a4d8f;margin:16px 0;">
          üí° <strong>Conseil p√©dagogique ‚Äî configuration type :</strong><br><br>
          ‚Ä¢ <strong>Date + Heure</strong> en haut ‚Üí affichage permanent<br>
          ‚Ä¢ <strong>Planning</strong> √† gauche ‚Üí d√©roul√© de la journ√©e<br>
          ‚Ä¢ <strong>Devoirs</strong> √† droite ‚Üí travaux √† noter<br>
          ‚Ä¢ <strong>YouTube</strong> en bas ‚Üí musique de travail<br><br>
          Sauvegardez cette configuration en .json et rechargez-la chaque matin en 2 secondes !
        </div>
      </div>

      <!-- SC√àNES -->
      <div id="h-scenes" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üóÇÔ∏è Sc√®nes</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Les sc√®nes permettent d'avoir plusieurs <strong>bureaux ind√©pendants</strong> que vous pouvez cr√©er, nommer et switcher en un clic. Chaque sc√®ne poss√®de ses propres widgets, formes, dessins et fond d'√©cran.</p>

        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Ouvrir le menu des sc√®nes</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Cliquez sur le bouton <strong>üóÇÔ∏è Sc√®nes</strong> dans la barre du bas (√† c√¥t√© de WIDGETS). Le nom de la sc√®ne active est affich√© directement sur le bouton.</p>

        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Actions disponibles dans le menu</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Action</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Comment</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">R√©sultat</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">Changer de sc√®ne</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Clic sur le nom d'une sc√®ne</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">La sc√®ne actuelle est sauvegard√©e, la nouvelle est charg√©e</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">Cr√©er une sc√®ne</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Bouton <strong>Ôºã Nouvelle sc√®ne</strong></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Copie de la sc√®ne actuelle, nomm√©e "Sc√®ne N"</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;font-weight:700;">Renommer</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Clic sur ‚úèÔ∏è √† droite de la sc√®ne</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Bo√Æte de dialogue pour saisir un nouveau nom</td></tr>
          <tr><td style="padding:8px 12px;font-weight:700;color:#ff5f56;">Supprimer</td><td style="padding:8px 12px;color:#444;">Clic sur √ó rouge √† droite de la sc√®ne</td><td style="padding:8px 12px;color:#444;">Confirmation demand√©e, puis sc√®ne supprim√©e d√©finitivement</td></tr>
        </table>

        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Comportement au changement de sc√®ne</div>
        <ul style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">La sc√®ne en cours est <strong>automatiquement sauvegard√©e</strong> avant de charger la suivante.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">L'historique annuler/refaire est <strong>r√©initialis√©</strong> √† chaque changement de sc√®ne.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Le fond d'√©cran change avec la sc√®ne.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Le bouton üóÇÔ∏è affiche toujours le nom de la sc√®ne active.</li>
        </ul>

        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Limites</div>
        <ul style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Maximum <strong>10 sc√®nes</strong> simultan√©es (le bouton Ôºã est gris√© au-del√†).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Il est impossible de supprimer la derni√®re sc√®ne restante.</li>
        </ul>

        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Export et import multi-sc√®nes</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Le bouton üíæ exporte <strong>toutes les sc√®nes</strong> dans un seul fichier .json. Le bouton üìÇ restaure toutes les sc√®nes si le fichier en contient plusieurs.</p>

        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:12px 16px;font-size:12.5px;color:#1a4d8f;margin:16px 0;">
          üí° <strong>Id√©es d'organisation :</strong><br><br>
          ‚Ä¢ <strong>Sc√®ne 1 ‚Äî Matin</strong> : accueil, date, planning de la journ√©e<br>
          ‚Ä¢ <strong>Sc√®ne 2 ‚Äî Maths</strong> : le√ßon du jour, exercices, timer<br>
          ‚Ä¢ <strong>Sc√®ne 3 ‚Äî Lecture</strong> : texte affich√©, questions, vocabulaire<br>
          ‚Ä¢ <strong>Sc√®ne 4 ‚Äî Fin de journ√©e</strong> : devoirs, r√©cap, YouTube<br><br>
          Basculez d'une sc√®ne √† l'autre en 1 clic sans rien perdre !
        </div>
        <div style="background:#fff8e6;border-left:4px solid #f39c12;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#7a5000;margin:10px 0;">‚ö†Ô∏è Les sc√®nes sont stock√©es dans le localStorage du navigateur. Si vous videz le cache ou changez de navigateur, exportez d'abord votre fichier .json pour ne rien perdre.</div>
      </div>

      <!-- POINTEUR LASER -->
      <div id="h-laser" class="help-section" style="display:none;">
        <div style="font-size:1.15em;font-weight:800;color:#1a1a2e;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid #e5e8ee;">üî¥ Pointeur laser</div>
        <p style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:10px;">Le pointeur laser remplace le curseur de la souris par un <strong>point rouge lumineux</strong>, id√©al pour attirer l'attention des √©l√®ves sur une zone pr√©cise du tableau projet√©.</p>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Activer / D√©sactiver</div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
          <tr><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">Action</th><th style="background:#f0f3f9;text-align:left;padding:8px 12px;font-weight:700;border-bottom:2px solid #dde2ea;">R√©sultat</th></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;">Clic sur <strong>üî¥</strong> dans la barre du bas</td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">Active le pointeur ‚Äî le curseur dispara√Æt, remplac√© par le point rouge lumineux</td></tr>
          <tr><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;">Reclic sur <strong>üî¥</strong></td><td style="padding:8px 12px;border-bottom:1px solid #eef0f3;color:#444;">D√©sactive le pointeur ‚Äî le curseur normal revient</td></tr>
          <tr><td style="padding:8px 12px;">Touche <strong>√âchap</strong></td><td style="padding:8px 12px;color:#444;">D√©sactive le pointeur en urgence</td></tr>
        </table>
        <div style="font-size:0.97em;font-weight:700;color:#2B7FFF;margin:18px 0 8px 0;">Comportement</div>
        <ul style="padding-left:20px;margin-bottom:14px;">
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Le point rouge s'affiche <strong>au-dessus de tout</strong> (widgets, dessins, formes).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Le bouton üî¥ prend un fond ros√© pour indiquer que le mode est actif.</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;margin-bottom:4px;">Le pointeur n'interf√®re pas avec les autres modes (dessin, gomme, s√©lection).</li>
          <li style="font-size:13.5px;color:#444;line-height:1.65;">Il fonctionne sur toute la surface de la page, y compris en dehors du tableau.</li>
        </ul>
        <div style="background:#eef7ff;border-left:4px solid #2B7FFF;border-radius:0 8px 8px 0;padding:10px 14px;font-size:12.5px;color:#1a4d8f;margin:10px 0;">
          üí° <strong>Astuce projection :</strong> Activez le pointeur laser juste avant de projeter votre √©cran. Les √©l√®ves verront uniquement le point rouge lumineux, sans le curseur syst√®me qui peut √™tre peu visible sur un vid√©oprojecteur.
        </div>
      </div>

    </div><!-- /contenu -->
  </div><!-- /corps -->

  <!-- PIED -->
  <div style="padding:14px 28px;border-top:1px solid #e5e8ee;display:flex;justify-content:flex-end;flex-shrink:0;background:#fafbfc;">
    <button onclick="closeHelpModal()" style="background:#2B7FFF;color:white;border:none;padding:9px 22px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;">Fermer</button>
  </div>

</div><!-- /modal -->
</div><!-- /overlay -->


<!-- TEMPLATES -->
<template id="template-text">
    <div class="editor-container">
        <div class="editor-content" contenteditable="true" oninput="saveBoard()" style="font-size:40px;"></div>
    </div>
</template>
<template id="template-homework">
    <div class="editor-container">
        <div class="editor-content" contenteditable="true" oninput="saveBoard()">
            <span style="color:#D4C9C7;font-size:25px;font-weight:bold;">‚úçüèª Devoirs √† noter </span><br>
            <p><span style="color:red;background-color:#F7E02A;font-size:38px;font-weight:bold;">Pour</span></p>
            <p><span style="color:#f7639f;font-size:35px;font-weight:bold;">&nbsp;&nbsp;üëâüèª CE2 =</span></p>
            <p><span style="color:#12a2e0;font-size:35px;font-weight:bold;">&nbsp;&nbsp;üëâüèΩ CM2 =</span></p>
            <p><span style="color:#D9C93B;font-size:35px;font-weight:bold;">&nbsp;&nbsp;üëâ TOUS =</span></p>
        </div>
    </div>
</template>
<template id="template-date">
    <div class="editor-container" style="width:220px;height:260px;overflow:hidden;">
        <div class="calendar-page" style="font-size:16px;">
            <div class="calendar-header"></div>
            <div class="calendar-body">
                <div class="calendar-day-name"></div>
                <div class="calendar-day-number"></div>
                <div class="calendar-month"></div>
            </div>
        </div>
    </div>
</template>
<template id="template-time">
    <div class="editor-container" style="width:200px;height:100px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:none;">
        <div class="clock-time" style="font-size:32px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:0 16px;box-sizing:border-box;">
            <span class="clock-hm">00:00</span><span class="clock-seconds">00</span>
        </div>
    </div>
</template>
<template id="template-iframe">
    <div class="editor-container" style="height:400px;width:550px;">
        <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
        <div class="editor-toolbar">
            <input type="text" placeholder="Collez l'URL ici..." style="flex-grow:1;" onchange="loadIframe(this)">
            <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂</button>
        </div>
        <iframe src="" style="flex-grow:1;border:none;background:white;" allow="microphone;camera;display-capture;autoplay"></iframe>
    </div>
</template>
<template id="template-outilsprofs">
    <div class="editor-container" style="height:500px;width:800px;">
        <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
        <div class="editor-toolbar" style="display:flex;justify-content:flex-end;">
            <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂ Plein √©cran</button>
        </div>
        <iframe src="https://ecolebernardet.github.io/outilsprofs" style="flex-grow:1;border:none;background:white;" allow="microphone;camera;display-capture;autoplay"></iframe>
    </div>
</template>
<template id="template-youtube">
    <div class="editor-container" style="height:350px;width:600px;">
        <div class="editor-toolbar">
            <input type="text" placeholder="Collez le lien YouTube ici..." style="flex-grow:1;" onchange="loadYoutube(this)">
            <button onclick="toggleYoutubeView(this,'none')" title="Mode Audio">üîá Son seul</button>
            <button onclick="toggleYoutubeView(this,'block')" title="Mode Vid√©o">üì∫ Vid√©o</button>
            <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂</button>
            <button onclick="toggleTransparency(this)" title="Fond transparent"><span class="icon-transparency"></span></button>
        </div>
        <iframe src="" style="flex-grow:1;border:none;background:#000;" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture;web-share" allowfullscreen></iframe>
    </div>
</template>
<template id="template-agenda">
    <div class="editor-container">
        <div class="agenda-container" style="font-size:16px;">
            <div class="agenda-header-title">
                <span class="agenda-current-date"></span>
                <span class="agenda-current-time"></span>
            </div>
            <div class="agenda-list">
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><span class="agenda-time" contenteditable="true">08:30</span><div class="agenda-text" contenteditable="true">Accueil / Appel / Rituels</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><span class="agenda-time" contenteditable="true">09:15</span><div class="agenda-text" contenteditable="true">Fran√ßais</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><span class="agenda-time" contenteditable="true">10:20</span><div class="agenda-text" contenteditable="true">R√©cr√©ation</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">10:45</div><div class="agenda-text" contenteditable="true">Math√©matiques</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">11:45</div><div class="agenda-text" contenteditable="true">Fin de la matin√©e</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">--:--</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">13:45</div><div class="agenda-text" contenteditable="true">Rituel / Quart d'heure lecture</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">14:00</div><div class="agenda-text" contenteditable="true">Mati√®re</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">15:20</div><div class="agenda-text" contenteditable="true">R√©cr√©ation</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">15:45</div><div class="agenda-text" contenteditable="true">Mati√®re</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
                <div class="agenda-item" draggable="true"><span class="agenda-row-handle">‚ãÆ‚ãÆ</span><div class="agenda-time" contenteditable="true">16:30</div><div class="agenda-text" contenteditable="true">Fin de la journ√©e</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span></div>
            </div>
            <button class="agenda-add-btn" onclick="addAgendaLine(this)" title="Ajouter une ligne">+</button>
        </div>
    </div>
</template>
<template id="template-deficalme">
    <div class="editor-container" style="height:500px;width:800px;">
        <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
        <div class="editor-toolbar" style="display:flex;justify-content:flex-end;">
            <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂ Plein √©cran</button>
        </div>
        <iframe src="https://ecolebernardet.github.io/lebureauduprof/deficalme.html" style="flex-grow:1;border:none;background:white;" allow="microphone;camera;display-capture;autoplay"></iframe>
    </div>
</template>
<template id="template-meteo">
    <div class="editor-container meteo-container" style="width:280px;height:200px;background:linear-gradient(135deg,#1a6fa8,#38b6e8);border-radius:16px;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:16px;box-sizing:border-box;color:white;overflow:hidden;">
        <div class="meteo-city" style="font-size:13px;font-weight:600;opacity:0.85;cursor:pointer;text-align:center;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:6px;width:100%;" title="Cliquer pour changer de ville">üìç <span class="meteo-city-name">Chargement...</span></div>
        <div class="meteo-icon" style="font-size:52px;line-height:1;margin:4px 0;">‚õÖ</div>
        <div class="meteo-temp" style="font-size:36px;font-weight:800;line-height:1;">--¬∞</div>
        <div class="meteo-desc" style="font-size:13px;opacity:0.9;text-align:center;">--</div>
        <div class="meteo-details" style="font-size:11px;opacity:0.75;display:flex;gap:12px;margin-top:2px;">
            <span class="meteo-wind">üí® --</span>
            <span class="meteo-humidity">üíß --</span>
        </div>
        <div class="meteo-updated" style="font-size:9px;opacity:0.5;margin-top:2px;">--</div>
    </div>
</template>
<template id="template-pdf">
    <div class="editor-container" style="height:500px;width:600px;">
        <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
        <div class="editor-toolbar" style="gap:8px;">
            <label style="cursor:pointer;background:#4a90e2;color:white;padding:3px 8px;border-radius:5px;font-size:11px;">
                üìÑ Ouvrir PDF
                <input type="file" accept=".pdf" style="display:none" onchange="loadPdfWidget(this)">
            </label>
            <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂ Plein √©cran</button>
        </div>
        <iframe src="" style="flex-grow:1;width:100%;border:none;background:white;"></iframe>
    </div>
</template>

<div id="rotation-indicator"><span id="rot-deg">0¬∞</span><span class="rot-reset-hint">double-clic ‚Üí 0¬∞</span></div>
<input type="file" id="bg-upload" style="display:none" accept="image/*" onchange="handleBgUpload(this)">

<script>
// =========================================================================
// VARIABLES GLOBALES
// =========================================================================
let board = document.getElementById('board');
let undoStack = [], redoStack = [];
const MAX_UNDO = 60;
let isInitialLoading = true;
let isRestoringState = false;
let _pendingSnapshotTimer = null;
let savedSelection = null;
let currentActiveWidget = null;
const RATIO = 16 / 9;
let _lastW = window.innerWidth;

// =========================================================================
// INIT
// =========================================================================
window.onload = () => {
    const savedBg = localStorage.getItem('boardBackground');
    if (savedBg) applyBackground(savedBg);
    applyBoardRatio(window.innerWidth);
    loadBoard();
    initShapeToolbar();
    setTimeout(() => {
        isInitialLoading = false;
        _lastW = window.innerWidth;
        initSelectionControls();
        initBoardSelection();
        const fontSizeInput = document.getElementById('font-size-input');
        if (fontSizeInput) {
            fontSizeInput.addEventListener('focus', () => {
                if (!currentActiveWidget) return;
                const sel = window.getSelection();
                if (sel.rangeCount > 0) savedSelection = sel.getRangeAt(0).cloneRange();
            });
        }
        const cur = buildBoardJSON();
        if (cur) undoStack.push(cur);
        updateUndoRedoBtns();
        scenesInit(); // ‚Üê ajout
    }, 1000);
    setInterval(updateClock, 1000);
    window.addEventListener('resize', handleWindowResize);
};

document.addEventListener('keydown', (e) => {
    // Supprimer les widgets s√©lectionn√©s avec Suppr ou Backspace
    // (sauf si on est en train de taper dans un champ de texte)
    if ((e.key === 'Delete' || e.key === 'Backspace') &&
        !e.target.closest('[contenteditable]') &&
        !e.target.closest('input') &&
        !e.target.closest('textarea') &&
        (selectedWidgets.length > 0 || selectedStrokes.length > 0)) {
        e.preventDefault();
        snapshotNow();
        selectedWidgets.forEach(w => { w.classList.remove('selected'); w.remove(); });
        selectedWidgets = [];
        strokes = strokes.filter(s => !selectedStrokes.includes(s));
        selectedStrokes = [];
        if (drawCtx) redrawStrokes();
        document.getElementById('selection-controls').style.display = 'none';
        saveBoard();
    }
});


// =========================================================================
// RATIO 16:9
// =========================================================================
function virtualH(w) { return w / RATIO; }

function applyBoardRatio(newW) {
    const vh = virtualH(newW);
    board.style.width    = newW + 'px';
    board.style.height   = vh + 'px';
    board.style.position = 'absolute';
    board.style.top      = Math.max(0, (window.innerHeight - vh) / 2) + 'px';
    board.style.left     = '0';
}

function scaleFontSizesBy(el, factor) {
    if (Math.abs(factor - 1) < 0.001) return;
    el.querySelectorAll('*').forEach(child => {
        if (!child.style?.fontSize) return;
        const m = child.style.fontSize.match(/^([\d.]+)px$/);
        if (m) child.style.fontSize = (parseFloat(m[1]) * factor) + 'px';
    });
    if (el.style?.fontSize) {
        const m = el.style.fontSize.match(/^([\d.]+)px$/);
        if (m) el.style.fontSize = (parseFloat(m[1]) * factor) + 'px';
    }
}

function scaleFontSizesFromRef(el, refW) { scaleFontSizesBy(el, window.innerWidth / refW); }

function getToolbarHeight(container) {
    const tb = container?.querySelector('.editor-toolbar');
    return tb ? tb.offsetHeight : 0;
}

function handleWindowResize() {
    const newW = window.innerWidth;
    const factor = newW / _lastW;
    applyBoardRatio(newW);
    const newVH = virtualH(newW);
    document.querySelectorAll('.widget').forEach(w => {
        const c = w.querySelector('.editor-container');
        if (c) {
            if (parseFloat(w.dataset.widthPercent) > 0)
                c.style.width = (parseFloat(w.dataset.widthPercent) / 100) * newW + 'px';
            if (parseFloat(w.dataset.contentHPercent) > 0)
                c.style.height = ((parseFloat(w.dataset.contentHPercent) / 100) * newVH) + getToolbarHeight(c) + 'px';
        }
        if (parseFloat(w.dataset.leftPercent) > 0) w.style.left = (parseFloat(w.dataset.leftPercent) / 100) * newW + 'px';
        if (parseFloat(w.dataset.topPercent)  > 0) w.style.top  = (parseFloat(w.dataset.topPercent)  / 100) * newVH + 'px';
        scaleFontSizesBy(w, factor);
    });
    document.querySelectorAll('.shape-widget').forEach(w => {
        const curW = newW, curVH = virtualH(curW);
        if (parseFloat(w.dataset.leftPercent) > 0) w.style.left = (parseFloat(w.dataset.leftPercent) / 100) * curW + 'px';
        if (parseFloat(w.dataset.topPercent)  > 0) w.style.top  = (parseFloat(w.dataset.topPercent)  / 100) * curVH + 'px';
        const svg = w.querySelector('svg');
        if (svg && parseFloat(w.dataset.wPercent) > 0) {
            const sw = (parseFloat(w.dataset.wPercent) / 100) * curW;
            const sh = (parseFloat(w.dataset.hPercent) / 100) * curVH;
            svg.setAttribute('width', sw);
            svg.setAttribute('height', sh);
        }
    });
    _lastW = newW;
    resizeCanvas();
}

// =========================================================================
// UNDO / REDO
// =========================================================================
function snapshotNow() {
    if (isInitialLoading || isRestoringState) return;
    clearTimeout(_pendingSnapshotTimer);
    const cur = buildBoardJSON();
    if (!cur) return;
    if (undoStack.length > 0 && undoStack[undoStack.length - 1] === cur) return;
    undoStack.push(cur);
    if (undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack = [];
    updateUndoRedoBtns();
}

function scheduleSaveSnapshot() {
    clearTimeout(_pendingSnapshotTimer);
    _pendingSnapshotTimer = setTimeout(() => {
        const cur = buildBoardJSON();
        if (!cur) return;
        if (undoStack.length > 0 && undoStack[undoStack.length - 1] === cur) return;
        undoStack.push(cur);
        if (undoStack.length > MAX_UNDO) undoStack.shift();
        redoStack = [];
        updateUndoRedoBtns();
    }, 800);
}

function undoAction() {
    if (undoStack.length <= 1) return;
    isRestoringState = true;
    clearTimeout(_pendingSnapshotTimer);
    redoStack.push(undoStack.pop());
    const snap = undoStack[undoStack.length - 1];
    document.querySelectorAll('.widget').forEach(w => w.remove());
    document.querySelectorAll('.shape-widget').forEach(w => w.remove());
    try {
        const p = JSON.parse(snap);
        strokes = p.strokes || [];
        if (p.background) { localStorage.setItem('boardBackground', p.background); applyBackground(p.background); }
    } catch(e) { strokes = []; }
    localStorage.setItem('profBoardConfig', snap);
    _lastW = window.innerWidth;
    restoreBoardFromJSON(snap);
    isRestoringState = false;
    updateUndoRedoBtns();
}

function redoAction() {
    if (redoStack.length === 0) return;
    isRestoringState = true;
    clearTimeout(_pendingSnapshotTimer);
    const snap = redoStack.pop();
    undoStack.push(snap);
    document.querySelectorAll('.widget').forEach(w => w.remove());
    document.querySelectorAll('.shape-widget').forEach(w => w.remove());
    try {
        const p = JSON.parse(snap);
        strokes = p.strokes || [];
        if (p.background) { localStorage.setItem('boardBackground', p.background); applyBackground(p.background); }
    } catch(e) { strokes = []; }
    localStorage.setItem('profBoardConfig', snap);
    _lastW = window.innerWidth;
    restoreBoardFromJSON(snap);
    isRestoringState = false;
    updateUndoRedoBtns();
}

function updateUndoRedoBtns() {
    const ub = document.getElementById('undo-btn'), rb = document.getElementById('redo-btn');
    const canU = undoStack.length > 1, canR = redoStack.length > 0;
    if (ub) { ub.classList.toggle('enabled', canU); }
    if (rb) { rb.classList.toggle('enabled', canR); }
}

// =========================================================================
// SAUVEGARDE / CHARGEMENT
// =========================================================================
function getInnerHTMLNormalized(widget) {
    const factor = 1920 / window.innerWidth;
    const clone = widget.cloneNode(true);
    clone.querySelectorAll('*').forEach(el => {
        if (!el.style?.fontSize) return;
        const m = el.style.fontSize.match(/^([\d.]+)px$/);
        if (m) el.style.fontSize = (parseFloat(m[1]) * factor) + 'px';
    });
    if (clone.style?.fontSize) {
        const m = clone.style.fontSize.match(/^([\d.]+)px$/);
        if (m) clone.style.fontSize = (parseFloat(m[1]) * factor) + 'px';
    }
    const agendaList = clone.querySelector('.agenda-list');
    const content    = clone.querySelector('.editor-content');
    return agendaList ? agendaList.innerHTML : (content ? content.innerHTML : null);
}

function getEditorStyleNormalized(widget, refWidth = 1920) {
    const editor = widget.querySelector('.editor-content');
    if (!editor) return null;
    const cs = window.getComputedStyle(editor);
    const curW = window.innerWidth || refWidth;
    const factor = refWidth / curW;
    const fontSizePx = parseFloat(cs.fontSize);
    return {
        fontFamily: cs.fontFamily || '',
        fontSizePx: Number.isFinite(fontSizePx) ? +(fontSizePx * factor).toFixed(2) : null,
        color: cs.color || ''
    };
}

function applyEditorStyleFromConfig(widget, style) {
    if (!style) return;
    const editor = widget.querySelector('.editor-content');
    if (!editor) return;
    if (style.fontFamily) editor.style.fontFamily = style.fontFamily;
    if (style.color) editor.style.color = style.color;
    if (style.fontSizePx) editor.style.fontSize = style.fontSizePx + 'px';
}

function buildBoardState() {
    const curW = window.innerWidth, curVH = virtualH(curW);
    const widgets = [];
    document.querySelectorAll('.widget').forEach(w => {
        const iframe = w.querySelector('iframe');
        const c = w.querySelector('.editor-container');
        const html = getInnerHTMLNormalized(w);
        const isTextLike = w.dataset.type === 'text' || w.dataset.type === 'homework';
        let wP = 0, hP = 0;
        if (c) { wP = (c.offsetWidth / curW) * 100; hP = ((c.offsetHeight - getToolbarHeight(c)) / curVH) * 100; }
        const lP = (w.offsetLeft / curW) * 100;
        const tP = (w.offsetTop  / curVH) * 100;
        Object.assign(w.dataset, { widthPercent: wP, contentHPercent: hP, leftPercent: lP, topPercent: tP });
        // Donn√©es propres aux stickers
        let stickerUrl = null, stickerEmoji = null, stickerSize = null;
        if (w.dataset.type === 'sticker') {
            const sImg = w.querySelector('img');
            const sEmoji = w.querySelector('[data-sticker-type="emoji"]');
            if (sImg) stickerUrl = sImg.src;
            if (sEmoji) stickerEmoji = sEmoji.textContent;
            stickerSize = { w: w.offsetWidth, h: w.offsetHeight };
        }
        widgets.push({
			type: w.dataset.type, topPercent: tP, leftPercent: lP, widthPercent: wP, contentHPercent: hP,
			html, content: html, iframeSrc: iframe?.src || null,
			transparent: w.dataset.transparent === "true",
			bgColor: w.dataset.bgColor || "#ffffff",
			bgOpacity: parseFloat(w.dataset.bgOpacity ?? 1),
			editorStyle: isTextLike ? getEditorStyleNormalized(w, 1920) : null,
			pinned: w.dataset.pinned === "true",
			background: w.dataset.background === "true",
			groupId: w.dataset.groupId || null,
			meteoCity: w.dataset.meteoCity || null,
			stickerUrl, stickerEmoji, stickerSize,
			transform: w.style.transform || null
		});
    });
    const shapes = [];
    document.querySelectorAll('.shape-widget').forEach(w => {
        const svg = w.querySelector('svg');
        if (!svg) return;
        const lP = (w.offsetLeft / curW) * 100;
        const tP = (w.offsetTop  / curVH) * 100;
        const wP = (parseFloat(svg.getAttribute('width') || 150) / curW) * 100;
        const hP = (parseFloat(svg.getAttribute('height') || 150) / curVH) * 100;
        w.dataset.leftPercent = lP; w.dataset.topPercent = tP;
        w.dataset.wPercent = wP; w.dataset.hPercent = hP;
        shapes.push({
            shapeType: w.dataset.shapeType, strokeColor: w.dataset.strokeColor,
            fillColor: w.dataset.fillColor, fillOpacity: w.dataset.fillOpacity,
            strokeWidth: parseInt(w.dataset.strokeWidth || 4),
            leftPercent: lP, topPercent: tP, wPercent: wP, hPercent: hP,
            transform: w.style.transform || '', pinned: w.dataset.pinned === "true",
            background: w.dataset.background === "true",
            groupId: w.dataset.groupId || null,
            flipX: parseFloat(w.dataset.flipX || 1),
            flipY: parseFloat(w.dataset.flipY || 1)
        });
    });
    return { widgets, shapes, refWidth: 1920, background: localStorage.getItem('boardBackground') || 'none', strokes: strokes || [] };
}

function buildBoardJSON() {
    try { return JSON.stringify(buildBoardState()); } catch(e) { return null; }
}

function saveBoard() {
    if (isInitialLoading || isRestoringState) return;
    const json = JSON.stringify(buildBoardState());
    localStorage.setItem('profBoardConfig', json);
    // Mettre √† jour la sc√®ne courante
    if (scenes && scenes.length > 0) {
        scenes[currentScene].config     = json;
        scenes[currentScene].background = localStorage.getItem('boardBackground') || 'none';
        saveScenesMeta();
    }
    scheduleSaveSnapshot();
}

function loadBoard() {
    const raw = localStorage.getItem('profBoardConfig');
    if (raw) {
        // localStorage contient une sauvegarde ‚Üí on la charge, fin de l'histoire
        restoreBoardFromJSON(raw);
    } else {
        // localStorage vide = premi√®re visite ‚Üí on charge le mod√®le distant
        fetch('https://outilsprofs.fr/lebureauduprof/sauvegardes/lebureauduprof_bienvenue.json')
            .then(r => r.json())
            .then(data => {
                const json = JSON.stringify(data);
                localStorage.setItem('profBoardConfig', json); // ‚Üê sauvegard√© en local d√®s la 1√®re fois
                if (data.background) {
                    applyBackground(data.background);
                    localStorage.setItem('boardBackground', data.background);
                }
                restoreBoardFromJSON(json);
            })
            .catch(err => {
                console.warn('Impossible de charger le mod√®le de bienvenue :', err);
            });
    }
}

function restoreBoardFromJSON(json) {
    const parsed = JSON.parse(json);
    const data = Array.isArray(parsed) ? parsed : (parsed.widgets || []);
    const refW = parsed.refWidth || 1920;
    // Restaurer les traits canvas si pr√©sents dans le snapshot
    if (parsed.strokes && parsed.strokes.length > 0) {
        strokes = parsed.strokes;
        if (!drawCanvas) {
            initCanvas();
            drawCanvas.classList.add('inactive');
        }
        setTimeout(() => redrawStrokes(), 100);
    }
    const curW = window.innerWidth, curVH = virtualH(curW);
    data.forEach(w => {
        // Restauration sp√©ciale des stickers (pas de template HTML)
        if (w.type === 'sticker') {
            const curWW = window.innerWidth, curVVH = virtualH(curWW);
            const lx = (w.leftPercent / 100) * curWW;
            const ty = (w.topPercent  / 100) * curVVH;
            const sw = document.createElement('div');
            sw.className = 'widget';
            sw.dataset.type = 'sticker';
            sw.dataset.transparent = 'true';
            sw.tabIndex = 0;
            const HANDLES = '<div class="drag-handle" title="D√©placer">‚ú•</div>'
                + '<div class="widget-rotate-handle" title="Faire pivoter">‚Üª</div>'
                + '<div class="widget-pin-handle" onclick="togglePin(this.closest(\'.widget\'))" title="√âpingler">üìå</div>'
                + '<div class="widget-back-handle" onclick="sendToBack(this.closest(\'.widget\'))" title="Envoyer derri√®re">üîΩ</div>'
                + '<div class="widget-close-handle" onclick="snapshotNow();this.closest(\'.widget\').remove();saveBoard();" title="Fermer">√ó</div>';
            if (w.stickerEmoji) {
                const sz = (w.stickerSize && w.stickerSize.w) ? w.stickerSize.w : 100;
                sw.style.cssText = `left:${lx}px;top:${ty}px;width:${sz}px;height:${sz}px;min-height:0!important;overflow:visible;flex-direction:row;flex-shrink:0;`;
                sw.style.setProperty('--sticker-h', sz + 'px');
                const econtent = document.createElement('div');
                econtent.dataset.stickerType = 'emoji';
                econtent.style.cssText = `position:absolute;top:0;left:0;width:${sz}px;height:${sz}px;display:flex;align-items:center;justify-content:center;font-size:${Math.round(sz*0.62)}px;line-height:1;user-select:none;pointer-events:none;`;
                econtent.textContent = w.stickerEmoji;
                sw.innerHTML = HANDLES;
                sw.appendChild(econtent);
            } else if (w.stickerUrl) {
                const szw = (w.stickerSize && w.stickerSize.w) ? w.stickerSize.w : 130;
                const szh = (w.stickerSize && w.stickerSize.h) ? w.stickerSize.h : 130;
                sw.style.cssText = `left:${lx}px;top:${ty}px;width:${szw}px;height:${szh}px;overflow:hidden;flex-direction:row;`;
                sw.style.setProperty('--sticker-h', szh + 'px');
                const simg = document.createElement('img');
                simg.src = w.stickerUrl;
                simg.alt = '';
                simg.draggable = false;
                simg.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;pointer-events:none;padding:6px;box-sizing:border-box;';
                sw.innerHTML = HANDLES;
                sw.appendChild(simg);
            } else {
                return; // sticker sans donn√©es valides, on ignore
            }
            if (w.transform) sw.style.transform = w.transform;
            if (w.pinned)    bringToFront(sw, true);
            if (w.background) { sw.style.zIndex = 1; sw.dataset.background = 'true'; }
            if (w.groupId)   sw.dataset.groupId = w.groupId;
            sw.addEventListener('mousedown', () => bringToFront(sw));
            board.appendChild(sw);
            makeDraggable(sw);
            makeDraggableRotate(sw);
            _addStickerResizeHandle(sw, 40);
            return; // widget sticker trait√©, on passe au suivant
        }
        const widget = createWidget(w.type, '100px', '100px', false);
        const c = widget.querySelector('.editor-container');
        const hP = w.contentHPercent !== undefined ? w.contentHPercent : w.heightPercent;
        Object.assign(widget.dataset, { widthPercent: w.widthPercent || 0, contentHPercent: hP || 0, leftPercent: w.leftPercent ?? 0, topPercent: w.topPercent ?? 0 });
        if (w.meteoCity) widget.dataset.meteoCity = w.meteoCity;
        if (c) {
            if (w.widthPercent > 0) c.style.width = (w.widthPercent / 100) * curW + 'px';
            if (hP > 0) c.style.height = ((hP / 100) * curVH) + getToolbarHeight(c) + 'px';
        }
        widget.style.left = (w.leftPercent / 100) * curW + 'px';
        widget.style.top  = (w.topPercent  / 100) * curVH + 'px';
        // Appliquer transparence et fond imm√©diatement pour √©viter le flash
        if (w.transparent) {
            applyTransparency(widget, true);
        } else if (w.bgColor) {
            widget.dataset.bgColor = w.bgColor;
            if (w.bgOpacity !== undefined && w.bgOpacity !== 1) {
                const rgb = hexToRgb(w.bgColor);
                if (rgb) {
                    const newBg = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${w.bgOpacity})`;
                    widget.style.background = newBg;
                    const c2 = widget.querySelector('.editor-container');
                    if (c2) c2.style.background = newBg;
                    widget.dataset.bgOpacity = w.bgOpacity;
                } else {
                    widget.style.background = w.bgColor;
                    const c2 = widget.querySelector('.editor-container');
                    if (c2) c2.style.background = w.bgColor;
                }
            } else {
                widget.style.background = w.bgColor;
                const c2 = widget.querySelector('.editor-container');
                if (c2) c2.style.background = w.bgColor;
                widget.dataset.bgOpacity = 1;
            }
        }
        if (w.background) { widget.style.zIndex = 1; widget.dataset.background = "true"; }
        else if (w.pinned) bringToFront(widget, true);
        if (w.groupId) widget.dataset.groupId = w.groupId;

        // Widgets texte/devoirs : d√©marrer en mode non-√©ditable (drag par d√©faut)
        if (w.type === 'text' || w.type === 'homework') {
            const ed = widget.querySelector('.editor-content');
            if (ed) {
                ed.contentEditable = 'false';
                ed.style.cursor = 'grab';
                ed.style.userSelect = 'none';
            }
            widget.style.cursor = 'grab';
        }

        setTimeout(() => {
            const editor = widget.querySelector('.editor-content');
            const agenda = widget.querySelector('.agenda-list');
            const htmlContent = w.html ?? w.content ?? null;
            if (htmlContent) {
                if (agenda) { agenda.innerHTML = htmlContent; agenda.querySelectorAll('.agenda-item').forEach(attachAgendaItemEvents); }
                else if (editor) { editor.innerHTML = htmlContent; }
            }
            const iframe = widget.querySelector('iframe');
            if (w.iframeSrc && iframe) iframe.src = w.iframeSrc;
            applyEditorStyleFromConfig(widget, w.editorStyle);
            scaleFontSizesFromRef(widget, refW);
        }, 50);
    });
    if (parsed.shapes) {
        parsed.shapes.forEach(s => {
            const curW2 = window.innerWidth, curVH2 = virtualH(curW2);
            const sw = (s.wPercent / 100) * curW2, sh = (s.hPercent / 100) * curVH2;
            const lx = (s.leftPercent / 100) * curW2, ty = (s.topPercent / 100) * curVH2;
            const w2 = createShapeWidget(s.shapeType, s.strokeColor, s.fillColor, s.fillOpacity, sw, sh, lx + 'px', ty + 'px', false, s.strokeWidth || 4);
            if (s.transform) w2.style.transform = s.transform;
            if (s.flipX !== undefined) w2.dataset.flipX = s.flipX;
            if (s.flipY !== undefined) w2.dataset.flipY = s.flipY;
            const fsx = parseFloat(s.flipX || 1), fsy = parseFloat(s.flipY || 1);
            if (fsx !== 1 || fsy !== 1) {
                const svg2 = w2.querySelector('svg');
                if (svg2) {
                    svg2.style.transformBox    = 'fill-box';
                    svg2.style.transformOrigin = 'center center';
                    svg2.style.transform       = `scale(${fsx}, ${fsy})`;
                }
            }
            if (s.background) { w2.style.zIndex = 1; w2.dataset.background = "true"; }
            else if (s.pinned) bringToFront(w2, true);
            if (s.groupId) w2.dataset.groupId = s.groupId;
            w2.dataset.leftPercent = s.leftPercent; w2.dataset.topPercent = s.topPercent;
            w2.dataset.wPercent = s.wPercent; w2.dataset.hPercent = s.hPercent;
        });
    }
}

function exportConfig() {
    saveCurrentSceneData();
    const exportData = {
        scenes:       scenes,
        currentScene: currentScene,
        // Compatibilit√© avec l'ancien format (sc√®ne active)
        ...JSON.parse(scenes[currentScene].config || '{}')
    };
    const a = document.createElement('a');
    a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
    a.download = `lebureauduprof_export_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click(); a.remove();
}

function importConfig(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // Format multi-sc√®nes
            if (data.scenes && Array.isArray(data.scenes)) {
                scenes       = data.scenes;
                currentScene = data.currentScene || 0;
                saveScenesMeta();
                loadScene(currentScene);
                renderScenesBar();
            } else {
                // Format ancienne version (mono-sc√®ne)
                snapshotNow();
                document.querySelectorAll('.widget').forEach(w => w.remove());
                document.querySelectorAll('.shape-widget').forEach(w => w.remove());
                applyBackground(data.background || 'none');
                saveBg(data.background || 'none');
                const json = JSON.stringify(data);
                localStorage.setItem('profBoardConfig', json);
                scenes[currentScene].config = json;
                saveScenesMeta();
                restoreBoardFromJSON(json);
            }
            event.target.value = '';
        } catch(err) { showAlert('‚ö†Ô∏è', 'Erreur d\'importation', err.message); }
    };
    reader.readAsText(file);
}

function clearBoard() { document.getElementById('modal-overlay').style.display = 'flex'; }
function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
function confirmClearBoard() {
    snapshotNow();
    document.querySelectorAll('.widget').forEach(w => w.remove());
    document.querySelectorAll('.shape-widget').forEach(w => w.remove());
    saveBoard(); closeModal();
}

function openHelpModal() {
  const o = document.getElementById('help-modal-overlay');
  o.style.display = 'flex';
  // S'assurer que l'intro est affich√©e √† l'ouverture
  helpShow(document.querySelector('.help-nav[data-s="h-intro"]'));
}

// =========================================================================
// MODE PR√âSENTATION
// =========================================================================
let _presentationActive = false;

function togglePresentationMode() {
    const btn = document.getElementById('presentation-btn');
    const UI_IDS = ['bottom-bar','toolbar-container','draw-toolbar','eraser-toolbar','global-toolbar','shape-toolbar','bg-submenu','scenes-menu','modal-overlay','help-modal-overlay','rotation-indicator'];

    _presentationActive = !_presentationActive;
    if (_presentationActive) {
        document.getElementById('tools-menu')?.classList.remove('active');
        document.getElementById('bg-submenu')?.classList.remove('active');
        document.getElementById('shape-toolbar')?.classList.remove('active');
        document.querySelectorAll('.widget.selected, .shape-widget.selected').forEach(w => w.classList.remove('selected'));
        document.getElementById('selection-controls') && (document.getElementById('selection-controls').style.display = 'none');
        document.activeElement?.blur();
        UI_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.dataset.ph = el.style.display || ''; el.style.display = 'none'; }
        });
        document.body.classList.add('presentation-mode');
        board.style.position = 'fixed';
        board.style.top = '0'; board.style.left = '0';
        board.style.width = '100vw'; board.style.height = '100vh';
        // Mettre le bouton DANS le board (qui couvre tout) pour qu'il soit visible
        if (btn) {
            board.appendChild(btn);
            btn.innerHTML = '‚õ∂ Quitter <span style="font-size:11px;opacity:0.65;margin-left:4px;">[√âchap]</span>';
            btn.style.cssText = 'position:absolute;bottom:20px;right:20px;z-index:99999;background:rgba(20,20,20,0.85);color:white;border:2px solid rgba(255,255,255,0.3);font-size:13px;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:0 4px 20px rgba(0,0,0,0.6);';
        }
        // Plein √©cran navigateur
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => {});
        }
    } else {
        document.body.classList.remove('presentation-mode');
        UI_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.dataset.ph !== undefined) { el.style.display = el.dataset.ph || ''; delete el.dataset.ph; }
        });
        if (btn) {
            // Remettre le bouton dans le body
            document.body.appendChild(btn);
            btn.innerHTML = 'üìΩÔ∏è';
            btn.style.cssText = 'position:fixed;bottom:80px;right:24px;z-index:100000;background:#1a1a2e;color:white;border:2px solid rgba(255,255,255,0.25);font-size:20px;padding:7px 12px;border-radius:20px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(0,0,0,0.5);';
        }
        applyBoardRatio(window.innerWidth);
        if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
    }
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && _presentationActive) togglePresentationMode();
});

// Sortie fullscreen via √âchap navigateur
document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        if (_presentationActive) togglePresentationMode();
        // Restaurer les dimensions apr√®s sortie plein √©cran
        if (_fsEl) {
            const el = _fsEl;
            const w  = _fsW, h = _fsH, ww = _fsWidgetW, wh = _fsWidgetH;
            _fsEl = null; _fsW = ''; _fsH = ''; _fsWidgetW = ''; _fsWidgetH = '';
            // D√©lai pour laisser le navigateur terminer la sortie fullscreen
            setTimeout(() => {
                el.style.width  = w;
                el.style.height = h;
                const widget = el.closest('.widget');
                if (widget) { widget.style.width = ww; widget.style.height = wh; }
            }, 50);
        }
    }
});

function helpShow(item) {
  document.querySelectorAll('.help-nav').forEach(i => {
    i.style.borderLeftColor = 'transparent';
    i.style.background = '';
    i.style.color = '#444';
    i.style.fontWeight = '500';
  });
  document.querySelectorAll('.help-section').forEach(s => s.style.display = 'none');
  item.style.borderLeftColor = '#2B7FFF';
  item.style.background = '#e8edf5';
  item.style.color = '#2B7FFF';
  item.style.fontWeight = '700';
  document.getElementById(item.dataset.s).style.display = 'block';
}

function closeHelpModal() { document.getElementById('help-modal-overlay').style.display = 'none'; }

// =========================================================================
// HORLOGE / DATE
// =========================================================================
function updateClock() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
    const timeStr = now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
    document.querySelectorAll('.agenda-current-date').forEach(el => el.textContent = dateStr);
    document.querySelectorAll('.agenda-current-time').forEach(el => el.textContent = timeStr);
    updateDateTime();
}
function updateDateTime() {
    const now = new Date();
    const days   = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
    const months = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    document.querySelectorAll('.calendar-day-name').forEach(el   => el.textContent = days[now.getDay()]);
    document.querySelectorAll('.calendar-day-number').forEach(el => el.textContent = now.getDate());
    document.querySelectorAll('.calendar-month').forEach(el      => el.textContent = months[now.getMonth()]);
    const hh = String(now.getHours()).padStart(2,'0'), mm = String(now.getMinutes()).padStart(2,'0'), ss = String(now.getSeconds()).padStart(2,'0');
    document.querySelectorAll('.clock-hm').forEach(el      => el.textContent = ` ${hh}:${mm} `);
    document.querySelectorAll('.clock-seconds').forEach(el => el.textContent = ss);
}

// =========================================================================
// WIDGETS
// =========================================================================
let widgetZCounter = 1000;
let pinnedZCounter = 10000;

function bringToFront(widget, pin = false) {
    if (pin) {
        pinnedZCounter++;
        widget.style.zIndex = pinnedZCounter;
        widget.dataset.pinned = "true";
        widget.classList.add('pinned');
    } else {
        if (widget.dataset.pinned === "true") return;
        if (widget.dataset.background === "true") return;
        widgetZCounter++;
        widget.style.zIndex = widgetZCounter;
    }
}

function togglePin(widget) {
    snapshotNow();
    if (widget.dataset.pinned === "true") {
        widget.dataset.pinned = "false";
        widget.classList.remove('pinned');
        widgetZCounter++;
        widget.style.zIndex = widgetZCounter;
    } else {
        widget.dataset.background = "false";
        bringToFront(widget, true);
    }
    saveBoard();
}

function sendToBack(widget) {
    snapshotNow();
    widget.style.zIndex = 1;
    widget.dataset.pinned = "false";
    widget.classList.remove('pinned');
    widget.dataset.background = "true";
    saveBoard();
}

function applyWidgetBgOpacity(value) {
    if (!currentActiveWidget) return;
    const c = currentActiveWidget.querySelector('.editor-container');
    if (!c) return;
    const opacity = parseInt(value) / 100;
    document.getElementById('widget-bg-opacity-val').textContent = value + '%';
    // R√©cup√©rer la couleur de fond actuelle et lui appliquer l'opacit√©
    const currentBg = currentActiveWidget.dataset.bgColor || '#ffffff';
    const rgb = hexToRgb(currentBg);
    if (!rgb) return;
    const newBg = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
    currentActiveWidget.style.background = newBg;
    c.style.background = newBg;
    currentActiveWidget.dataset.bgOpacity = opacity;
    saveBoard();
}

function hexToRgb(hex) {
    // G√©rer aussi les couleurs rgb() d√©j√† existantes
    const rgbMatch = hex.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (rgbMatch) return { r: parseInt(rgbMatch[1]), g: parseInt(rgbMatch[2]), b: parseInt(rgbMatch[3]) };
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

// =========================================================================
// MENU CONTEXTUEL
// =========================================================================
function closeCtxMenuAll() {
    document.querySelectorAll('.widget-ctx-menu.open').forEach(m => m.classList.remove('open'));
}

document.addEventListener('mousedown', (e) => {
    if (!e.target.closest('.widget-ctx-menu') && !e.target.closest('.widget-menu-handle')) closeCtxMenuAll();
    if (!e.target.closest('#shape-edit-panel') && !e.target.closest('.shape-widget')) closeShapeEditPanel();
    if (!e.target.closest('#sc-ctx-menu') && !e.target.closest('#sc-menu-btn')) {
        const m = document.getElementById('sc-ctx-menu');
        if (m) m.classList.remove('open');
    }
});

function toggleCtxMenu(btn) {
    const widget = btn.closest('.widget, .shape-widget');
    const menu   = widget.querySelector('.widget-ctx-menu');
    if (!menu) return;
    const wasOpen = menu.classList.contains('open');
    closeCtxMenuAll();
    if (wasOpen) return;
    buildCtxMenu(menu, widget);
    menu.classList.add('open');
}

function buildCtxMenu(menu, widget) {
    const isShape = widget.classList.contains('shape-widget');
    menu.innerHTML = '';

    addCtxBtn(menu, '‚ßâ Dupliquer', () => {
        closeCtxMenuAll();
        if (isShape) cloneShapeWidget(widget);
        else cloneWidget(widget);
    });

    if (isShape) {
        addCtxBtn(menu, 'üé® Modifier', () => {
            closeCtxMenuAll();
            openShapeEditPanel(widget);
        });
    }
}

function addCtxBtn(menu, label, fn) {
    const btn = document.createElement('button');
    btn.innerHTML = label;
    btn.addEventListener('mousedown', (e) => { e.stopPropagation(); });
    btn.addEventListener('click', fn);
    menu.appendChild(btn);
}

function findFreePosition() {
    const curW = window.innerWidth, curVH = virtualH(curW);
    const occupied = Array.from(document.querySelectorAll('.widget, .shape-widget')).map(w => ({
        left: w.offsetLeft, top: w.offsetTop, right: w.offsetLeft + w.offsetWidth, bottom: w.offsetTop + w.offsetHeight
    }));
    for (let y = 20; y < curVH - 200; y += 200) {
        for (let x = 20; x < curW - 320; x += 320) {
            const overlaps = occupied.some(r => x < r.right+20 && x+320 > r.left && y < r.bottom+20 && y+180 > r.top);
            if (!overlaps) return { x, y };
        }
    }
    const count = document.querySelectorAll('.widget, .shape-widget').length;
    return { x: (20 + count * 30) % (curW - 200), y: (20 + count * 30) % (curVH - 200) };
}

function createWidget(type, x = null, y = null, doSnapshot = true) {
    if (x === null || y === null) { const p = findFreePosition(); x = p.x + 'px'; y = p.y + 'px'; }
    if (doSnapshot && !isInitialLoading && !isRestoringState) snapshotNow();
    const widget = document.createElement('div');
    widget.className = 'widget';
    widget.dataset.type = type;
    widget.style.left = x; widget.style.top = y;
    widget.tabIndex = 0;
    widget.addEventListener('mousedown', (e) => {
        if (isDrawMode || isEraserMode) return;
        if (widget.dataset.background !== "true") bringToFront(widget);
    });
    widget.innerHTML = `
        <div class="drag-handle" title="D√©placer">‚ú•</div>
        <div class="widget-rotate-handle" title="Faire pivoter">‚Üª</div>
        <div class="widget-pin-handle" onclick="togglePin(this.closest('.widget, .shape-widget'))" title="√âpingler">üìå</div>
        <div class="widget-back-handle" onclick="sendToBack(this.closest('.widget, .shape-widget'))" title="Envoyer derri√®re">üîΩ</div>
        <div class="widget-menu-handle" onclick="toggleCtxMenu(this)" title="Menu">‚ò∞</div>
        <div class="widget-close-handle" onclick="snapshotNow();closeCtxMenuAll();this.closest('.widget').remove();saveBoard();" title="Fermer">√ó</div>
        <div class="widget-ctx-menu"></div>
        <div class="widget-content"></div>`;
    const contentZone = widget.querySelector('.widget-content');
    const tpl = document.getElementById(`template-${type}`);
    if (tpl && tpl.content) {
        contentZone.appendChild(tpl.content.cloneNode(true));
    } else {
        contentZone.innerHTML = `<div style="padding:10px;color:#b00;font-size:12px;">Type inconnu : <code>${type}</code></div>`;
    }
    board.appendChild(widget);
		widget.addEventListener('contextmenu', (e) => {
		e.preventDefault();
		e.stopPropagation();
		snapshotNow();
		widget.remove();
		saveBoard();
	});
    makeDraggable(widget);
    makeDraggableRotate(widget);
    if (type === 'agenda') { updateClock(); widget.querySelectorAll('.agenda-item').forEach(attachAgendaItemEvents); }
    const editor = widget.querySelector('.editor-content');
	if (type === 'text' || type === 'homework') {
		const editor = widget.querySelector('.editor-content');
		if (editor) {
			editor.contentEditable = 'false';
			editor.style.cursor = 'grab';
			editor.style.userSelect = 'none';
		}
		widget.style.cursor = 'grab';
		// Remettre grab quand on quitte l'√©dition (clic ailleurs)
		document.addEventListener('mousedown', function onOutsideClick(ev) {
			if (!widget.contains(ev.target)) {
				// Ne pas sortir du mode √©dition si on clique sur la toolbar de formatage
				if (ev.target.closest('#global-toolbar')) return;
				const ed = widget.querySelector('.editor-content');
				if (ed) {
					ed.contentEditable = 'false';
					ed.style.cursor = 'grab';
					ed.style.userSelect = 'none';
				}
				widget.style.cursor = 'grab';
			}
		});
	}
	if (type === 'time') {
		const container = widget.querySelector('.editor-container');
		const clockTime = widget.querySelector('.clock-time');
		if (container && clockTime) {
			const resizeObserver = new ResizeObserver(() => {
				// Adapter la taille de police √† la hauteur du conteneur
				const h = container.offsetHeight;
				const w = container.offsetWidth;
				// La taille de police = ~55% de la hauteur, limit√©e par la largeur
				const sizeByH = Math.floor(h * 0.55);
				const sizeByW = Math.floor(w * 0.28);
				const size = Math.max(12, Math.min(sizeByH, sizeByW));
				clockTime.style.fontSize = size + 'px';
				// Les secondes restent proportionnellement plus petites
				const sec = widget.querySelector('.clock-seconds');
				if (sec) sec.style.fontSize = Math.floor(size * 0.45) + 'px';
			});
			resizeObserver.observe(container);
			// Poign√©e custom pour √©viter le bug du resizer natif
			container.style.resize = 'none';
			const resizeHandle = document.createElement('div');
			resizeHandle.style.cssText = 'position:absolute;right:0;bottom:0;width:18px;height:18px;cursor:se-resize;background:linear-gradient(135deg,transparent 50%,#aaa 50%);border-radius:0 0 4px 0;opacity:0;transition:opacity 0.2s;z-index:10;';
			widget.appendChild(resizeHandle);
			// Bouton transparence
			const transpBtn = document.createElement('button');
			transpBtn.title = 'Fond transparent';
			transpBtn.style.cssText = 'position:absolute;top:4px;right:30px;background:rgba(255,255,255,0.8);border:1px solid #ddd;border-radius:4px;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;z-index:10;padding:0;';
			transpBtn.innerHTML = '<span class="icon-transparency"></span>';
			transpBtn.addEventListener('click', () => {
				snapshotNow();
				applyTransparency(widget, widget.dataset.transparent !== 'true');
				saveBoard();
			});
			widget.appendChild(transpBtn);
			widget.addEventListener('mouseenter', () => transpBtn.style.opacity = '1');
			widget.addEventListener('mouseleave', () => transpBtn.style.opacity = '0');
			widget.addEventListener('mouseenter', () => resizeHandle.style.opacity = '1');
			widget.addEventListener('mouseleave', () => resizeHandle.style.opacity = '0');

			resizeHandle.addEventListener('mousedown', (e) => {
				e.preventDefault(); e.stopPropagation();
				const startX = e.clientX, startY = e.clientY;
				const startW = container.offsetWidth, startH = container.offsetHeight;
				document.onmousemove = (ev) => {
					container.style.width  = Math.max(100, startW + ev.clientX - startX) + 'px';
					container.style.height = Math.max(60,  startH + ev.clientY - startY) + 'px';
				};
				document.onmouseup = () => { document.onmousemove = null; saveBoard(); };
			});
		}
	}
	if (type === 'date') {
		const container = widget.querySelector('.editor-container');
		const dayName   = widget.querySelector('.calendar-day-name');
		const dayNumber = widget.querySelector('.calendar-day-number');
		const month     = widget.querySelector('.calendar-month');
		const header    = widget.querySelector('.calendar-header');
		if (container) {
			const resizeObserver = new ResizeObserver(() => {
				const h = container.offsetHeight;
				const w = container.offsetWidth;
				// Header = 20% de la hauteur
				if (header) header.style.height = Math.floor(h * 0.20) + 'px';
				// Tailles de police proportionnelles
				const baseSize = Math.min(w, h) * 0.10;
				if (dayName)   dayName.style.fontSize   = Math.max(8,  Math.floor(baseSize * 0.75)) + 'px';
				if (dayNumber) dayNumber.style.fontSize = Math.max(16, Math.floor(baseSize * 2.2))  + 'px';
				if (month)     month.style.fontSize     = Math.max(8,  Math.floor(baseSize * 0.95)) + 'px';
			});
			resizeObserver.observe(container);
			// Poign√©e custom
			const resizeHandle = document.createElement('div');
			resizeHandle.style.cssText = 'position:absolute;right:0;bottom:0;width:18px;height:18px;cursor:se-resize;background:linear-gradient(135deg,transparent 50%,#aaa 50%);border-radius:0 0 4px 0;opacity:0;transition:opacity 0.2s;z-index:10;';
			widget.appendChild(resizeHandle);
			widget.addEventListener('mouseenter', () => resizeHandle.style.opacity = '1');
			widget.addEventListener('mouseleave', () => resizeHandle.style.opacity = '0');

			resizeHandle.addEventListener('mousedown', (e) => {
				e.preventDefault(); e.stopPropagation();
				const startX = e.clientX, startY = e.clientY;
				const startW = container.offsetWidth, startH = container.offsetHeight;
				document.onmousemove = (ev) => {
					container.style.width  = Math.max(150, startW + ev.clientX - startX) + 'px';
					container.style.height = Math.max(180, startH + ev.clientY - startY) + 'px';
				};
				document.onmouseup = () => { document.onmousemove = null; saveBoard(); };
			});

			// Bouton transparence
			const transpBtn = document.createElement('button');
			transpBtn.title = 'Fond transparent';
			transpBtn.style.cssText = 'position:absolute;top:4px;right:30px;background:rgba(255,255,255,0.8);border:1px solid #ddd;border-radius:4px;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;z-index:10;padding:0;';
			transpBtn.innerHTML = '<span class="icon-transparency"></span>';
			transpBtn.addEventListener('click', () => {
				snapshotNow();
				applyTransparency(widget, widget.dataset.transparent !== 'true');
				saveBoard();
			});
			widget.appendChild(transpBtn);
			widget.addEventListener('mouseenter', () => transpBtn.style.opacity = '1');
			widget.addEventListener('mouseleave', () => transpBtn.style.opacity = '0');
		}
	}
	if (type === 'meteo') {
		initMeteoWidget(widget);
	}
    if (editor) {
        editor.addEventListener('mouseup', () => { syncFontSize(widget); syncFontSizeGlobal(); });
		editor.addEventListener('keyup',   () => { syncFontSize(widget); syncFontSizeGlobal(); });
    }
    const REF_W = 1920, factor = window.innerWidth / REF_W;
    if (Math.abs(factor - 1) > 0.01) {
        scaleFontSizesBy(widget, factor);
        const c = widget.querySelector('.editor-container');
        if (c?.style.width)  c.style.width  = (parseFloat(c.style.width)  * factor) + 'px';
        if (c?.style.height) c.style.height = (parseFloat(c.style.height) * factor) + 'px';
    }
	if (!isInitialLoading && !isRestoringState) saveBoard();

	// Focus automatique sur l'√©diteur √† la cr√©ation
	if (!isInitialLoading && !isRestoringState) {
		const editor = widget.querySelector('.editor-content');
		if (editor) {
			setTimeout(() => {
				editor.focus();
				// Placer le curseur √† la fin du contenu existant
				const range = document.createRange();
				const sel = window.getSelection();
				range.selectNodeContents(editor);
				range.collapse(false);
				sel.removeAllRanges();
				sel.addRange(range);
			}, 50);
		}
	}

return widget;
}

// =========================================================================
// WIDGET M√âT√âO
// =========================================================================
// =========================================================================
// MODALES UTILITAIRES (rempla√ßant alert / confirm / prompt natifs)
// =========================================================================
function _createModalOverlay() {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeInOverlay 0.15s ease;';
    return overlay;
}
function _createModalBox(icon, title, subtitle) {
    const box = document.createElement('div');
    box.style.cssText = 'background:white;border-radius:18px;padding:28px 28px 24px;width:380px;max-width:92vw;box-shadow:0 24px 80px rgba(0,0,0,0.35);display:flex;flex-direction:column;gap:18px;font-family:inherit;animation:slideUpModal 0.18s ease;';
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:12px;';
    header.innerHTML = `<span style="font-size:30px;line-height:1;">${icon}</span><div><div style="font-size:16px;font-weight:700;color:#1a1a2e;">${title}</div>${subtitle ? `<div style="font-size:12px;color:#888;margin-top:3px;">${subtitle}</div>` : ''}</div>`;
    box.appendChild(header);
    return box;
}
function _modalBtn(label, primary, color) {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.style.cssText = `padding:9px 20px;border-radius:9px;border:${primary ? 'none' : '2px solid #e0e0e0'};background:${primary ? (color || 'linear-gradient(135deg,#2B7FFF,#8E51FF)') : 'white'};color:${primary ? 'white' : '#555'};font-size:14px;font-weight:700;cursor:pointer;transition:opacity 0.15s;`;
    btn.onmouseover = () => btn.style.opacity = '0.85';
    btn.onmouseout  = () => btn.style.opacity = '1';
    return btn;
}

/* showAlert(icon, title, message) ‚Üí Promise */
function showAlert(icon, title, message) {
    return new Promise(resolve => {
        const overlay = _createModalOverlay();
        const box = _createModalBox(icon, title);
        const msg = document.createElement('div');
        msg.style.cssText = 'font-size:14px;color:#444;line-height:1.5;';
        msg.textContent = message;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:flex-end;';
        const ok = _modalBtn('OK', true);
        row.appendChild(ok);
        box.appendChild(msg); box.appendChild(row);
        overlay.appendChild(box); document.body.appendChild(overlay);
        ok.focus();
        function close() { document.body.removeChild(overlay); resolve(); }
        ok.addEventListener('click', close);
        overlay.addEventListener('click', e => { if (e.target === overlay) close(); });
        document.addEventListener('keydown', function h(e) { if (e.key === 'Enter' || e.key === 'Escape') { document.removeEventListener('keydown', h); close(); }});
    });
}

/* showConfirm(icon, title, message, confirmLabel, danger) ‚Üí Promise<boolean> */
function showConfirm(icon, title, message, confirmLabel = 'Confirmer', danger = false) {
    return new Promise(resolve => {
        const overlay = _createModalOverlay();
        const box = _createModalBox(icon, title);
        const msg = document.createElement('div');
        msg.style.cssText = 'font-size:14px;color:#444;line-height:1.5;';
        msg.textContent = message;
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:10px;justify-content:flex-end;';
        const cancel = _modalBtn('Annuler', false);
        const ok     = _modalBtn(confirmLabel, true, danger ? '#ff4757' : null);
        row.appendChild(cancel); row.appendChild(ok);
        box.appendChild(msg); box.appendChild(row);
        overlay.appendChild(box); document.body.appendChild(overlay);
        ok.focus();
        function close(val) { document.body.removeChild(overlay); resolve(val); }
        ok.addEventListener('click', () => close(true));
        cancel.addEventListener('click', () => close(false));
        overlay.addEventListener('click', e => { if (e.target === overlay) close(false); });
        document.addEventListener('keydown', function h(e) {
            if (e.key === 'Enter') { document.removeEventListener('keydown', h); close(true); }
            if (e.key === 'Escape') { document.removeEventListener('keydown', h); close(false); }
        });
    });
}

/* showPromptModal(icon, title, subtitle, defaultValue, placeholder) ‚Üí Promise<string|null> */
function showPromptModal(icon, title, subtitle, defaultValue = '', placeholder = '') {
    return new Promise(resolve => {
        const overlay = _createModalOverlay();
        const box = _createModalBox(icon, title, subtitle);
        const input = document.createElement('input');
        input.type = 'text'; input.value = defaultValue; input.placeholder = placeholder;
        input.style.cssText = 'border:2px solid #e0e0e0;border-radius:10px;padding:10px 14px;font-size:15px;outline:none;transition:border 0.2s;width:100%;box-sizing:border-box;';
        input.onfocus = () => input.style.borderColor = '#2B7FFF';
        input.onblur  = () => input.style.borderColor = '#e0e0e0';
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:10px;justify-content:flex-end;';
        const cancel = _modalBtn('Annuler', false);
        const ok     = _modalBtn('Valider', true);
        row.appendChild(cancel); row.appendChild(ok);
        box.appendChild(input); box.appendChild(row);
        overlay.appendChild(box); document.body.appendChild(overlay);
        setTimeout(() => { input.focus(); input.select(); }, 50);
        function close(val) { document.body.removeChild(overlay); resolve(val); }
        ok.addEventListener('click', () => close(input.value.trim() || null));
        cancel.addEventListener('click', () => close(null));
        overlay.addEventListener('click', e => { if (e.target === overlay) close(null); });
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') close(input.value.trim() || null);
            if (e.key === 'Escape') close(null);
        });
    });
}

const WMO_CODES = {
    0:'Ciel d√©gag√©',1:'Principalement d√©gag√©',2:'Partiellement nuageux',3:'Couvert',
    45:'Brouillard',48:'Brouillard givrant',
    51:'Bruine l√©g√®re',53:'Bruine mod√©r√©e',55:'Bruine dense',
    61:'Pluie l√©g√®re',63:'Pluie mod√©r√©e',65:'Pluie forte',
    71:'Neige l√©g√®re',73:'Neige mod√©r√©e',75:'Neige forte',77:'Grains de neige',
    80:'Averses l√©g√®res',81:'Averses mod√©r√©es',82:'Averses violentes',
    85:'Averses de neige',86:'Averses de neige fortes',
    95:'Orage',96:'Orage avec gr√™le',99:'Orage violent avec gr√™le'
};
const WMO_ICONS = {
    0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',
    45:'üå´Ô∏è',48:'üå´Ô∏è',
    51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',
    61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',
    71:'‚ùÑÔ∏è',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',77:'üå®Ô∏è',
    80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',
    85:'üå®Ô∏è',86:'üå®Ô∏è',
    95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
};
const WMO_BG = {
    0:'linear-gradient(135deg,#f7971e,#ffd200)',
    1:'linear-gradient(135deg,#56ccf2,#2f80ed)',
    2:'linear-gradient(135deg,#4facfe,#6c8ce4)',
    3:'linear-gradient(135deg,#757f9a,#d7dde8)',
    45:'linear-gradient(135deg,#8e9eab,#c3cfe2)',48:'linear-gradient(135deg,#8e9eab,#c3cfe2)',
    61:'linear-gradient(135deg,#1a6fa8,#38b6e8)',63:'linear-gradient(135deg,#1a6fa8,#38b6e8)',65:'linear-gradient(135deg,#0f4c75,#1b6ca8)',
    71:'linear-gradient(135deg,#a8c0ff,#e0eafc)',73:'linear-gradient(135deg,#a8c0ff,#e0eafc)',75:'linear-gradient(135deg,#a8c0ff,#e0eafc)',
    80:'linear-gradient(135deg,#1a6fa8,#38b6e8)',81:'linear-gradient(135deg,#1a6fa8,#38b6e8)',82:'linear-gradient(135deg,#0f4c75,#1b6ca8)',
    95:'linear-gradient(135deg,#373b44,#4286f4)',96:'linear-gradient(135deg,#373b44,#4286f4)',99:'linear-gradient(135deg,#373b44,#4286f4)',
};

async function fetchMeteo(city) {
    // 1. G√©ocodage via Open-Meteo geocoding API
    const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=fr&format=json`);
    const geoData = await geoRes.json();
    if (!geoData.results?.length) throw new Error('Ville introuvable');
    const { latitude, longitude, name, country } = geoData.results[0];
    // 2. M√©t√©o actuelle
    const metRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weathercode,windspeed_10m,relativehumidity_2m&wind_speed_unit=kmh&timezone=auto`);
    const metData = await metRes.json();
    const c = metData.current;
    return { name, country, temp: Math.round(c.temperature_2m), code: c.weathercode, wind: Math.round(c.windspeed_10m), humidity: c.relativehumidity_2m };
}

function initMeteoWidget(widget) {
    const container = widget.querySelector('.meteo-container');
    const cityNameEl = widget.querySelector('.meteo-city-name');
    const iconEl     = widget.querySelector('.meteo-icon');
    const tempEl     = widget.querySelector('.meteo-temp');
    const descEl     = widget.querySelector('.meteo-desc');
    const windEl     = widget.querySelector('.meteo-wind');
    const humEl      = widget.querySelector('.meteo-humidity');
    const updEl      = widget.querySelector('.meteo-updated');

    // --- POIGN√âE DE REDIMENSIONNEMENT ---
    const resizeHandle = document.createElement('div');
    resizeHandle.style.cssText = 'position:absolute;right:0;bottom:0;width:20px;height:20px;cursor:se-resize;background:linear-gradient(135deg,transparent 50%,rgba(255,255,255,0.4) 50%);border-radius:0 0 14px 0;opacity:0;transition:opacity 0.2s;z-index:10;';
    widget.appendChild(resizeHandle);
    widget.addEventListener('mouseenter', () => resizeHandle.style.opacity = '1');
    widget.addEventListener('mouseleave', () => resizeHandle.style.opacity = '0');

    resizeHandle.addEventListener('mousedown', (e) => {
        e.preventDefault(); e.stopPropagation();
        const startX = e.clientX, startY = e.clientY;
        const startW = container.offsetWidth, startH = container.offsetHeight;
        document.onmousemove = (ev) => {
            const newW = Math.max(180, startW + ev.clientX - startX);
            const newH = Math.max(140, startH + ev.clientY - startY);
            container.style.width  = newW + 'px';
            container.style.height = newH + 'px';
            adaptMeteoFontSizes(container, newW, newH);
        };
        document.onmouseup = () => { document.onmousemove = null; saveBoard(); };
    });

    // Adapter les tailles de police au conteneur
    function adaptMeteoFontSizes(c, w, h) {
        const scale = Math.min(w / 280, h / 200);
        iconEl.style.fontSize     = Math.round(52 * scale) + 'px';
        tempEl.style.fontSize     = Math.round(36 * scale) + 'px';
        descEl.style.fontSize     = Math.round(13 * scale) + 'px';
        windEl.parentElement.style.fontSize = Math.round(11 * scale) + 'px';
        cityNameEl.style.fontSize = Math.round(13 * scale) + 'px';
        updEl.style.fontSize      = Math.round(9  * scale) + 'px';
    }

    // Observer les changements de taille
    new ResizeObserver(() => {
        adaptMeteoFontSizes(container, container.offsetWidth, container.offsetHeight);
    }).observe(container);

    // --- MODALE PERSONNALIS√âE ---

    let city = widget.dataset.meteoCity || '';

    function applyMeteo(data) {
        const code = data.code;
        cityNameEl.textContent = `${data.name}, ${data.country}`;
        iconEl.textContent  = WMO_ICONS[code] || 'üå°Ô∏è';
        tempEl.textContent  = `${data.temp}¬∞`;
        descEl.textContent  = WMO_CODES[code] || '';
        windEl.textContent  = `üí® ${data.wind} km/h`;
        humEl.textContent   = `üíß ${data.humidity}%`;
        updEl.textContent   = 'Mis √† jour ' + new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'});
        container.style.background = WMO_BG[code] || WMO_BG[2];
        const lightBg = [71,73,75,3];
        container.style.color = lightBg.includes(code) ? '#222' : 'white';
    }

    async function loadCity(c) {
        cityNameEl.textContent = 'Chargement...';
        iconEl.textContent = '‚è≥'; tempEl.textContent = ''; descEl.textContent = '';
        try {
            const data = await fetchMeteo(c);
            widget.dataset.meteoCity = c;
            applyMeteo(data);
            saveBoard();
        } catch(e) {
            cityNameEl.textContent = 'Ville introuvable';
            iconEl.textContent = '‚ùì'; tempEl.textContent = ''; descEl.textContent = '';
        }
    }

    widget.querySelector('.meteo-city').addEventListener('click', () => {
        showPromptModal('‚õÖ', 'Widget M√©t√©o', 'Entrez la ville de votre √©cole', widget.dataset.meteoCity || '', 'Ex : Paris, Lyon, Grenoble...')
            .then(newCity => { if (newCity) loadCity(newCity); });
    });

    function scheduleRefresh() {
        setTimeout(() => {
            if (widget.isConnected && widget.dataset.meteoCity) loadCity(widget.dataset.meteoCity).then(scheduleRefresh);
        }, 10 * 60 * 1000);
    }

    if (city) {
        loadCity(city).then(scheduleRefresh);
    } else {
        setTimeout(() => {
            showPromptModal('‚õÖ', 'Widget M√©t√©o', 'Entrez la ville de votre √©cole', '', 'Ex : Paris, Lyon, Grenoble...')
                .then(newCity => { if (newCity) loadCity(newCity).then(scheduleRefresh); });
        }, 200);
    }
}

function attachAgendaItemEvents(item) {
    item.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.addEventListener('mouseenter', () => item.draggable = false);
        el.addEventListener('mouseleave', () => item.draggable = true);
        el.addEventListener('input', saveBoard);
    });
    item.addEventListener('dragstart', handleRowDragStart);
    item.addEventListener('dragover',  handleRowDragOver);
    item.addEventListener('dragend',   handleRowDragEnd);
}

function syncFontSize(widget) {
    const toolbar = widget.querySelector('.editor-toolbar'); if (!toolbar) return;
    const sizeInput = toolbar.querySelector('input[type="number"]');
    if (!sizeInput) return;
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        const size = window.getComputedStyle(sel.anchorNode.parentElement).fontSize;
        if (size) sizeInput.value = parseInt(size);
    }
}

function makeDraggable(elmnt) {
    const handle = elmnt.querySelector('.drag-handle');
    if (handle) handle.onmousedown = (e) => {
        e.stopPropagation();
        startWidgetDrag(e, elmnt);
    };

    const isTextLike = elmnt.dataset.type === 'text' || elmnt.dataset.type === 'homework';

    if (isTextLike) {
        elmnt.addEventListener('mousedown', (e) => {
            if (isDrawMode || isEraserMode) return;
            if (e.target.closest('.drag-handle,.widget-close-handle,.widget-pin-handle,.widget-back-handle,.widget-rotate-handle,.widget-menu-handle,.widget-ctx-menu')) return;
            if (e.ctrlKey || e.metaKey) return;
            const container = elmnt.querySelector('.editor-container');
            if (container) {
                const rect = container.getBoundingClientRect();
                if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) return;
            }
            // Si le widget est d√©j√† en mode √©dition de texte, ne pas initier le glisser
            const editor = elmnt.querySelector('.editor-content');
            if (editor && editor.contentEditable === 'true') return;
            elmnt._dragPending = { x: e.clientX, y: e.clientY, e };
        });

        elmnt.addEventListener('dblclick', (e) => {
            if (e.target.closest('.drag-handle,.widget-close-handle,.widget-pin-handle,.widget-back-handle,.widget-rotate-handle,.widget-menu-handle,.widget-ctx-menu')) return;
            elmnt._dragPending = null;
            const editor = elmnt.querySelector('.editor-content');
            if (editor) {
                // Si d√©j√† en mode √©dition, laisser le navigateur g√©rer nativement (s√©lection de mot, etc.)
                if (editor.contentEditable === 'true') return;
                editor.contentEditable = 'true';
                editor.style.cursor = 'text';
                editor.style.userSelect = 'auto';
                elmnt.style.cursor = 'text';
                editor.focus();
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (range) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        });

        elmnt.addEventListener('mousemove', (e) => {
            if (!elmnt._dragPending) return;
            // Si le widget est en mode √©dition, annuler le glisser pour permettre la s√©lection de texte
            const editor = elmnt.querySelector('.editor-content');
            if (editor && editor.contentEditable === 'true') {
                elmnt._dragPending = null;
                return;
            }
            const dx = Math.abs(e.clientX - elmnt._dragPending.x);
            const dy = Math.abs(e.clientY - elmnt._dragPending.y);
            if (dx > 4 || dy > 4) {
                if (editor) {
                    editor.contentEditable = 'false';
                    editor.style.cursor = 'grab';
                    editor.style.userSelect = 'none';
                }
                startWidgetDrag(elmnt._dragPending.e, elmnt);
                elmnt._dragPending = null;
            }
        });

        elmnt.addEventListener('mouseup', () => {
            elmnt._dragPending = null;
        });

    } else {
        elmnt.addEventListener('mousedown', (e) => {
            if (isDrawMode || isEraserMode) return;
            if (e.target.closest('.drag-handle,.widget-close-handle,.widget-pin-handle,.widget-back-handle,.widget-rotate-handle,.widget-menu-handle,.widget-ctx-menu,.editor-toolbar,.agenda-time,.agenda-text,.agenda-add-btn,.agenda-row-handle,.agenda-delete-row,.meteo-city')) return;
            if (e.target.tagName === 'IFRAME' || e.target.tagName === 'EMBED') return;
            const container = elmnt.querySelector('.editor-container');
            if (container) {
                const rect = container.getBoundingClientRect();
                if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) return;
            }
            if (e.ctrlKey || e.metaKey) return;
            startWidgetDrag(e, elmnt);
        });
    }
}

function startWidgetDrag(e, elmnt) {
    e.preventDefault();
    elmnt.dataset.background = "false";
    bringToFront(elmnt);
    snapshotNow();
    clearSelection();

    // Bloquer les iframes pendant le drag
    const overlays = [];
    document.querySelectorAll('.widget iframe, .widget embed').forEach(el => {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:absolute;inset:0;z-index:9999;background:transparent;';
        el.parentElement.style.position = 'relative';
        el.parentElement.appendChild(overlay);
        overlays.push(overlay);
    });

    let px = e.clientX, py = e.clientY;
    document.onmousemove = (ev) => {
        elmnt.style.top  = (elmnt.offsetTop  + ev.clientY - py) + "px";
        elmnt.style.left = (elmnt.offsetLeft + ev.clientX - px) + "px";
        px = ev.clientX; py = ev.clientY;
    };
    document.onmouseup = () => {
        document.onmousemove = null;
        overlays.forEach(o => o.remove());
        const curW = window.innerWidth, curVH = virtualH(curW);
        elmnt.dataset.leftPercent = (elmnt.offsetLeft / curW) * 100;
        elmnt.dataset.topPercent  = (elmnt.offsetTop  / curVH) * 100;
        saveBoard();
    };
}

function makeDraggableRotate(elmnt) {
    const handle = elmnt.querySelector('.widget-rotate-handle'); if (!handle) return;

    handle.ondblclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        snapshotNow();
        elmnt.style.transform = '';
        hideRotationIndicator();
        saveBoard();
    };

    handle.onmousedown = (e) => {
        e.preventDefault(); e.stopPropagation();
        bringToFront(elmnt);
        snapshotNow();
        const rect = elmnt.getBoundingClientRect();
        const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
        const startAngle = Math.atan2(e.clientY - cy, e.clientX - cx);
        const startRot   = getCurrentRotation(elmnt);
        const indicator  = document.getElementById('rotation-indicator');
        document.onmousemove = (ev) => {
            const newRot = startRot + (Math.atan2(ev.clientY - cy, ev.clientX - cx) - startAngle) * 180 / Math.PI;
            const snapped = snapRotation(newRot);
            elmnt.style.transform = `rotate(${snapped}deg)`;
            if (indicator) {
                const deg = Math.round(((snapped % 360) + 360) % 360);
                document.getElementById('rot-deg').textContent = deg + '¬∞';
                indicator.style.display = 'block';
                indicator.style.left = ev.clientX + 'px';
                indicator.style.top  = ev.clientY + 'px';
                indicator.querySelector('.rot-reset-hint').style.display = (deg === 0) ? 'none' : 'inline';
            }
        };
        document.onmouseup = () => {
            document.onmousemove = null;
            hideRotationIndicator();
            saveBoard();
        };
    };
}

function snapRotation(deg) {
    const snaps = [0, 45, 90, 135, 180, 225, 270, 315, 360];
    const norm = ((deg % 360) + 360) % 360;
    for (const s of snaps) {
        const diff = Math.abs(norm - s);
        if (diff < 2) return s === 360 ? 0 : s;
    }
    return deg;
}

function hideRotationIndicator() {
    const ind = document.getElementById('rotation-indicator');
    if (ind) ind.style.display = 'none';
}

function cloneWidget(widget) {
    snapshotNow();
    const newWidget = createWidget(widget.dataset.type, (widget.offsetLeft + 30) + 'px', (widget.offsetTop + 30) + 'px', false);
    const sc = widget.querySelector('.editor-container'), dc = newWidget.querySelector('.editor-container');
    if (sc && dc) { dc.style.width = sc.style.width || sc.offsetWidth + 'px'; dc.style.height = sc.style.height || sc.offsetHeight + 'px'; }
    const se = widget.querySelector('.editor-content'), de = newWidget.querySelector('.editor-content');
    if (se && de) de.innerHTML = se.innerHTML;
    const sa = widget.querySelector('.agenda-list'), da = newWidget.querySelector('.agenda-list');
    if (sa && da) { da.innerHTML = sa.innerHTML; da.querySelectorAll('.agenda-item').forEach(attachAgendaItemEvents); }
    const si = widget.querySelector('iframe'), di = newWidget.querySelector('iframe');
    if (si && di) di.src = si.src;
    const rot = getCurrentRotation(widget);
    if (rot) newWidget.style.transform = `rotate(${rot}deg)`;
    if (widget.dataset.transparent === "true") applyTransparency(newWidget, true);
    else if (widget.dataset.bgColor) { newWidget.dataset.bgColor = widget.dataset.bgColor; newWidget.style.background = widget.dataset.bgColor; }
    saveBoard();
}

function getCurrentRotation(widget) {
    const m = widget.style.transform?.match(/rotate\(([-\d.]+)deg\)/);
    return m ? parseFloat(m[1]) : 0;
}

// =========================================================================
// FORMES G√âOM√âTRIQUES
// =========================================================================
const SHAPES = [
    { id: 'circle',        label: 'Cercle',         svg: (w,h,sw,f,o) => `<ellipse cx="${w/2}" cy="${h/2}" rx="${w/2-sw/2}" ry="${h/2-sw/2}" stroke="${sw}" stroke-width="${sw}" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'square',        label: 'Carr√©',           svg: (w,h,sw,f,o) => `<rect x="${sw/2}" y="${sw/2}" width="${w-sw}" height="${h-sw}" stroke="${sw}" stroke-width="${sw}" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'rectangle',     label: 'Rectangle',       svg: (w,h,sw,f,o) => `<rect x="${sw/2}" y="${sw/2}" width="${w-sw}" height="${h-sw}" stroke="${sw}" stroke-width="${sw}" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'diamond',       label: 'Losange',         svg: (w,h,sw,f,o) => `<polygon points="${w/2},${sw} ${w-sw},${h/2} ${w/2},${h-sw} ${sw},${h/2}" stroke="${sw}" stroke-width="${sw}" stroke-linejoin="round" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'parallelogram', label: 'Parall√©logramme', svg: (w,h,sw,f,o) => `<polygon points="${w*0.25},${sw} ${w-sw},${sw} ${w*0.75},${h-sw} ${sw},${h-sw}" stroke="${sw}" stroke-width="${sw}" stroke-linejoin="round" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'line',          label: 'Ligne',           svg: (w,h,sw,f,o) => `<line x1="${sw}" y1="${h/2}" x2="${w-sw}" y2="${h/2}" stroke="STROKECOLOR" stroke-width="${sw}" stroke-linecap="round"/>` },
    { id: 'arrow',         label: 'Fl√®che',          svg: (w,h,sw,f,o) => `<polygon points="${sw},${h*0.35} ${w*0.6},${h*0.35} ${w*0.6},${sw} ${w-sw},${h/2} ${w*0.6},${h-sw} ${w*0.6},${h*0.65} ${sw},${h*0.65}" stroke="${sw}" stroke-width="${sw}" stroke-linejoin="round" fill="${f}" fill-opacity="${o}"/>` },
    { id: 'triangle',      label: 'Triangle',        svg: (w,h,sw,f,o) => `<polygon points="${w/2},${sw} ${w-sw},${h-sw} ${sw},${h-sw}" stroke="${sw}" stroke-width="${sw}" stroke-linejoin="round" fill="${f}" fill-opacity="${o}"/>` },
];

let selectedShapeId = 'circle';

function buildShapeSVG(shapeId, w, h, strokeColor, fillColor, fillOpacity, strokeWidth) {
    const sw = strokeWidth || 4;
    const shape = SHAPES.find(s => s.id === shapeId);
    if (!shape) return '';
    let raw = shape.svg(w, h, sw, fillColor, fillOpacity);
    raw = raw.replace(/stroke="(\d+(?:\.\d+)?)"/g, `stroke="${strokeColor}"`);
    raw = raw.replace(/stroke="STROKECOLOR"/g, `stroke="${strokeColor}"`);
    return raw;
}

function initShapeToolbar() {
    const grid = document.getElementById('shape-grid');
    if (!grid) return;
    SHAPES.forEach(s => {
        const btn = document.createElement('div');
        btn.className = 'shape-choice' + (s.id === selectedShapeId ? ' active' : '');
        btn.dataset.id = s.id;
        btn.title = s.label;
        const previewSVG = `<svg width="28" height="28" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">${buildShapeSVG(s.id, 40, 40, '#ffffff', '#ffffff', 0.5)}</svg>`;
        btn.innerHTML = previewSVG + `<span class="shape-choice-label">${s.label}</span>`;
        btn.addEventListener('click', () => {
            document.querySelectorAll('.shape-choice').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedShapeId = s.id;
        });
        grid.appendChild(btn);
    });
    document.getElementById('shape-opacity-slider').addEventListener('input', function() {
        document.getElementById('shape-opacity-val').textContent = this.value + '%';
    });
    document.getElementById('shape-stroke-width').addEventListener('input', function() {
        document.getElementById('shape-stroke-width-val').textContent = this.value;
    });
}

let editingShapeWidget = null;

function openShapeEditPanel(widget) {
    editingShapeWidget = widget;
    const panel = document.getElementById('shape-edit-panel');
    document.getElementById('edit-stroke-color').value = widget.dataset.strokeColor || '#2c3e50';
    document.getElementById('edit-fill-color').value   = widget.dataset.fillColor   || '#4a90e2';
    const opPct = Math.round(parseFloat(widget.dataset.fillOpacity || 0.6) * 100);
    document.getElementById('edit-fill-opacity').value = opPct;
    document.getElementById('edit-fill-opacity-val').textContent = opPct + '%';
    const sw = parseInt(widget.dataset.strokeWidth || 4);
    document.getElementById('edit-stroke-width').value = sw;
    document.getElementById('edit-stroke-width-val').textContent = sw + 'px';
    const br = widget.getBoundingClientRect();
    panel.style.left = Math.min(br.right + 10, window.innerWidth - 320) + 'px';
    panel.style.top  = Math.max(10, br.top) + 'px';
    panel.style.display = 'block';
}

function closeShapeEditPanel() {
    const panel = document.getElementById('shape-edit-panel');
    if (panel) panel.style.display = 'none';
    editingShapeWidget = null;
}

function applyShapeEdit() {
    if (!editingShapeWidget) return;
    const sc = document.getElementById('edit-stroke-color').value;
    const fc = document.getElementById('edit-fill-color').value;
    const fo = parseFloat(document.getElementById('edit-fill-opacity').value) / 100;
    const sw = parseInt(document.getElementById('edit-stroke-width').value);
    const svg = editingShapeWidget.querySelector('svg');
    if (!svg) return;
    const w = parseFloat(svg.getAttribute('width'));
    const h = parseFloat(svg.getAttribute('height'));
    editingShapeWidget.dataset.strokeColor = sc;
    editingShapeWidget.dataset.fillColor   = fc;
    editingShapeWidget.dataset.fillOpacity = fo;
    editingShapeWidget.dataset.strokeWidth = sw;
    svg.innerHTML = buildShapeSVG(editingShapeWidget.dataset.shapeType, w, h, sc, fc, fo, sw);
    saveBoard();
}

function cloneShapeWidget(widget) {
    snapshotNow();
    const svg = widget.querySelector('svg');
    const sw = parseFloat(svg.getAttribute('width') || 150);
    const sh = parseFloat(svg.getAttribute('height') || 150);
    const newW = createShapeWidget(
        widget.dataset.shapeType, widget.dataset.strokeColor, widget.dataset.fillColor,
        parseFloat(widget.dataset.fillOpacity), sw, sh,
        (widget.offsetLeft + 30) + 'px', (widget.offsetTop + 30) + 'px', true,
        parseInt(widget.dataset.strokeWidth || 4)
    );
    const rot = getCurrentRotation(widget);
    if (rot) newW.style.transform = `rotate(${rot}deg)`;
}

function toggleShapeToolbar() {
    const tb = document.getElementById('shape-toolbar');
    const btn = document.getElementById('shape-btn');
    const isActive = tb.classList.toggle('active');
    btn.classList.toggle('active-tool', isActive);
    if (isActive) {
        stopDrawing();
        document.getElementById('global-toolbar').style.display = 'none';
        document.getElementById('tools-menu').classList.remove('active');
    }
}

function addShapeWidget() {
    const strokeColor = document.getElementById('shape-stroke-color').value;
    const fillColor   = document.getElementById('shape-fill-color').value;
    const fillOpacity = parseFloat(document.getElementById('shape-opacity-slider').value) / 100;
    const strokeWidth = parseInt(document.getElementById('shape-stroke-width').value);
    snapshotNow();
    const p = findFreePosition();
    const isLine = (selectedShapeId === 'line');
    const defaultW = isLine ? Math.min(window.innerWidth * 0.18, 280) : Math.min(window.innerWidth * 0.12, 180);
    const defaultH = isLine ? 20 : defaultW;
    createShapeWidget(selectedShapeId, strokeColor, fillColor, fillOpacity, defaultW, defaultH, p.x + 'px', p.y + 'px', true, strokeWidth);
    document.getElementById('shape-toolbar').classList.remove('active');
    document.getElementById('shape-btn').classList.remove('active-tool');
}

function createShapeWidget(shapeId, strokeColor, fillColor, fillOpacity, svgW, svgH, x, y, doSave = true, strokeWidth = 4) {
    const widget = document.createElement('div');
    widget.className = 'shape-widget';
    widget.dataset.shapeType   = shapeId;
    widget.dataset.strokeColor = strokeColor;
    widget.dataset.fillColor   = fillColor;
    widget.dataset.fillOpacity = fillOpacity;
    widget.dataset.strokeWidth = strokeWidth;
    widget.style.left = x; widget.style.top = y;
    widget.tabIndex = 0;
    widgetZCounter++;
    widget.style.zIndex = widgetZCounter;

    const svgContent = buildShapeSVG(shapeId, svgW, svgH, strokeColor, fillColor, fillOpacity, strokeWidth);

    widget.innerHTML = `
        <div class="drag-handle" title="D√©placer">‚ú•</div>
        <div class="widget-rotate-handle" title="Faire pivoter">‚Üª</div>
        <div class="widget-pin-handle" onclick="togglePin(this.closest('.widget, .shape-widget'))" title="√âpingler">üìå</div>
        <div class="widget-back-handle" onclick="sendToBack(this.closest('.widget, .shape-widget'))" title="Envoyer derri√®re">üîΩ</div>
        <div class="widget-menu-handle" onclick="toggleCtxMenu(this)" title="Menu">‚ò∞</div>
        <div class="widget-close-handle" onclick="snapshotNow();closeCtxMenuAll();this.closest('.shape-widget').remove();saveBoard();" title="Fermer">√ó</div>
        <div class="widget-ctx-menu"></div>
        <div class="shape-svg-wrap">
            <svg xmlns="http://www.w3.org/2000/svg" width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" style="overflow:visible;">${svgContent}</svg>
        </div>
        <div class="flip-h-btn" title="Sym√©trie horizontale">‚Üî</div>
        <div class="flip-v-btn" title="Sym√©trie verticale">‚Üï</div>
        <div class="resize-lock-btn" title="Verrouiller les proportions (ou Shift)">üîì</div>
        <div class="shape-resize-handle" title="Redimensionner"></div>
    `;

    board.appendChild(widget);
		widget.addEventListener('contextmenu', (e) => {
		e.preventDefault();
		e.stopPropagation();
		snapshotNow();
		widget.remove();
		saveBoard();
	});
    makeDraggable(widget);
    makeDraggableRotate(widget);
    makeShapeResizable(widget);

    widget.addEventListener('mousedown', (e) => {
        if (isDrawMode || isEraserMode) return;
        if (widget.dataset.background !== "true") bringToFront(widget);
    });
    widget.addEventListener('dblclick', (e) => {
        const ignore = '.drag-handle,.widget-close-handle,.widget-pin-handle,.widget-back-handle,.widget-rotate-handle,.widget-menu-handle,.widget-ctx-menu,.shape-resize-handle';
        if (!e.target.closest(ignore)) openShapeEditPanel(widget);
    });

    const curW = window.innerWidth, curVH = virtualH(curW);
    widget.dataset.leftPercent = (parseFloat(x) / curW) * 100;
    widget.dataset.topPercent  = (parseFloat(y) / curVH) * 100;
    widget.dataset.wPercent    = (svgW / curW) * 100;
    widget.dataset.hPercent    = (svgH / curVH) * 100;

    if (doSave && !isInitialLoading && !isRestoringState) saveBoard();
    return widget;
}

function makeShapeResizable(widget) {
    const handle  = widget.querySelector('.shape-resize-handle');
    const lockBtn = widget.querySelector('.resize-lock-btn');
    const flipH   = widget.querySelector('.flip-h-btn');
    const flipV   = widget.querySelector('.flip-v-btn');
    if (!handle) return;

    if (lockBtn) {
        lockBtn.addEventListener('mousedown', (e) => { e.preventDefault(); e.stopPropagation(); });
        lockBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const locked = lockBtn.classList.toggle('locked');
            lockBtn.textContent = locked ? 'üîí' : 'üîì';
        });
    }
    if (flipH) {
        flipH.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });
        flipH.addEventListener('click', e => { e.stopPropagation(); snapshotNow(); flipWidget(widget, 'h'); });
    }
    if (flipV) {
        flipV.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });
        flipV.addEventListener('click', e => { e.stopPropagation(); snapshotNow(); flipWidget(widget, 'v'); });
    }

    handle.addEventListener('mousedown', (e) => {
        e.preventDefault(); e.stopPropagation();
        snapshotNow();
        const svg = widget.querySelector('svg');
        const startX = e.clientX, startY = e.clientY;
        const startW = parseFloat(svg.getAttribute('width'));
        const startH = parseFloat(svg.getAttribute('height'));
        const ratio = startH / startW;
        const shapeId = widget.dataset.shapeType;
        const sc = widget.dataset.strokeColor, fc = widget.dataset.fillColor;
        const fo = widget.dataset.fillOpacity, sw = parseInt(widget.dataset.strokeWidth || 4);
        document.onmousemove = (ev) => {
            const proportional = ev.shiftKey || (lockBtn && lockBtn.classList.contains('locked'));
            const rawW = Math.max(40, startW + ev.clientX - startX);
            const rawH = Math.max(40, startH + ev.clientY - startY);
            let newW, newH;
            if (proportional) {
                newW = rawW;
                newH = Math.max(40, newW * ratio);
            } else {
                newW = rawW; newH = rawH;
            }
            svg.setAttribute('width', newW); svg.setAttribute('height', newH);
            svg.setAttribute('viewBox', `0 0 ${newW} ${newH}`);
            svg.innerHTML = buildShapeSVG(shapeId, newW, newH, sc, fc, fo, sw);
            const curW = window.innerWidth, curVH = virtualH(curW);
            widget.dataset.wPercent = (newW / curW) * 100;
            widget.dataset.hPercent = (newH / curVH) * 100;
        };
        document.onmouseup = () => { document.onmousemove = null; saveBoard(); };
    });
}

// Applique une sym√©trie √† un widget forme ou texte
// axis : 'h' (retournement gauche/droite) ou 'v' (retournement haut/bas)
function flipWidget(widget, axis) {
    // Extraire la rotation existante (rotation seule sur le widget)
    const rotMatch = (widget.style.transform || '').match(/rotate\(([-\d.]+)deg\)/);
    const rot = rotMatch ? parseFloat(rotMatch[1]) : 0;

    // Mettre √† jour les donn√©es de flip
    let sx = parseFloat(widget.dataset.flipX || 1);
    let sy = parseFloat(widget.dataset.flipY || 1);
    if (axis === 'h') sx = -sx;
    if (axis === 'v') sy = -sy;
    widget.dataset.flipX = sx;
    widget.dataset.flipY = sy;

    // Le widget ne porte QUE la rotation ‚Äî les boutons restent √† leur place
    widget.style.transform = rot !== 0 ? `rotate(${rot}deg)` : '';

    // Le flip est appliqu√© sur le SVG uniquement via CSS (transform-origin: center)
    const svg = widget.querySelector('svg');
    if (svg) {
        svg.style.transformBox    = 'fill-box';
        svg.style.transformOrigin = 'center center';
        svg.style.transform       = (sx !== 1 || sy !== 1) ? `scale(${sx}, ${sy})` : '';
        svg.removeAttribute('transform'); // nettoyer l'ancien attribut SVG si pr√©sent
    } else {
        // Widget texte : flip sur le container interne
        const container = widget.querySelector('.editor-container');
        if (container) {
            container.style.transformBox    = 'border-box';
            container.style.transformOrigin = 'center center';
            container.style.transform       = (sx !== 1 || sy !== 1) ? `scale(${sx}, ${sy})` : '';
        }
    }
    saveBoard();
}

// Applique une sym√©trie aux traits canvas s√©lectionn√©s
// axis : 'h' ou 'v' ‚Äî miroir autour du centre de leur bounding box
function flipStrokes(strokesList, axis) {
    if (!strokesList.length) return;
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    strokesList.forEach(s => s.points.forEach(p => {
        if (p.x < minX) minX = p.x; if (p.y < minY) minY = p.y;
        if (p.x > maxX) maxX = p.x; if (p.y > maxY) maxY = p.y;
    }));
    const cx = (minX + maxX) / 2, cy = (minY + maxY) / 2;
    strokesList.forEach(s => {
        s.points = s.points.map(p => ({
            x: axis === 'h' ? 2 * cx - p.x : p.x,
            y: axis === 'v' ? 2 * cy - p.y : p.y
        }));
    });
    if (drawCtx) redrawStrokes();
}

// =========================================================================
// PDF WIDGET
// =========================================================================
function loadPdfWidget(input) {
    const file = input.files[0]; if (!file) return;
    const url = URL.createObjectURL(file);
    const iframe = input.closest('.editor-container').querySelector('iframe');
    iframe.src = url;
}

// =========================================================================
// DESSIN LIBRE
// =========================================================================
let drawCanvas = null, drawCtx = null, isPainting = false, isDrawMode = false;
let strokes = [], currentStroke = null;

function initCanvas() {
    if (drawCanvas) return;
    drawCanvas = document.createElement('canvas');
    drawCanvas.id = 'draw-canvas';
    resizeCanvas();
    board.appendChild(drawCanvas);
    drawCtx = drawCanvas.getContext('2d');
    drawCanvas.addEventListener('mousedown',  startPaint);
    drawCanvas.addEventListener('mousemove',  paint);
    drawCanvas.addEventListener('mouseup',    endPaint);
    drawCanvas.addEventListener('mouseleave', endPaint);
    drawCanvas.addEventListener('touchstart', e => { e.preventDefault(); startPaint(e.touches[0]); }, { passive:false });
    drawCanvas.addEventListener('touchmove',  e => { e.preventDefault(); paint(e.touches[0]); }, { passive:false });
    drawCanvas.addEventListener('touchend',   endPaint);
    document.getElementById('draw-size').addEventListener('input', function() {
        document.getElementById('draw-size-label').textContent = this.value;
    });
    const opSlider = document.getElementById('shape-recog-opacity');
    if (opSlider) opSlider.addEventListener('input', function() {
        document.getElementById('shape-recog-opacity-val').textContent = this.value + '%';
    });
}

function resizeCanvas() {
    if (!drawCanvas) return;
    drawCanvas.width = board.offsetWidth; drawCanvas.height = board.offsetHeight;
    redrawStrokes();
}

function getPos(e) {
    const rect = drawCanvas.getBoundingClientRect();
    const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
}

function startPaint(e) {
    if (!isDrawMode || isEraserMode) return;
    isPainting = true;
    currentStroke = { points:[getPos(e)], color:document.getElementById('draw-color').value, size:parseInt(document.getElementById('draw-size').value) };
    if (currentDrawMode === 'shape') _lastStrokePoints = [...currentStroke.points];
    if (currentDrawMode === 'text') {
        // Annuler le timer de reconnaissance en cours
        clearTimeout(_hwRecogTimer);
    }
}

function paint(e) {
    if (!isPainting || !isDrawMode || isEraserMode || !currentStroke) return;
    currentStroke.points.push(getPos(e));
    if (currentDrawMode === 'shape') _lastStrokePoints = [...currentStroke.points];
    redrawStrokes(currentStroke);
}

function endPaint() {
    if (!isPainting || !currentStroke) return;
    isPainting = false;
    if (currentStroke.points.length > 1) {
        if (currentDrawMode === 'shape') {
            currentStroke = null;
            redrawStrokes();
            recognizeAndReplaceShape({ points: _lastStrokePoints, color: document.getElementById('draw-color').value, size: parseInt(document.getElementById('draw-size').value) });
            _lastStrokePoints = null;
            return;
        }
        strokes.push(currentStroke);
        const cur = buildBoardJSON();
        if (cur) {
            undoStack.push(cur);
            if (undoStack.length > MAX_UNDO) undoStack.shift();
            redoStack = [];
            updateUndoRedoBtns();
        }
        saveBoard();
    }
    currentStroke = null; redrawStrokes();
}

let _lastStrokePoints = null;

// =========================================================================
// RECONNAISSANCE D'√âCRITURE MANUSCRITE
// =========================================================================
let _hwRecogTimer = null;
let _hwPendingStrokes = []; // traits en attente de reconnaissance
let _hwRecognizedText = '';
let _hwBBox = null; // bounding box des traits manuscrits en cours

function scheduleHandwritingRecognition() {
    clearTimeout(_hwRecogTimer);
    _hwRecogTimer = setTimeout(() => {
        triggerHandwritingRecognition();
    }, 2000);
}

function cancelHandwritingRecognition() {
    clearTimeout(_hwRecogTimer);
    // Nettoyer le panneau preview si visible
    const preview = document.getElementById('handwriting-preview');
    if (preview) { preview.style.display = 'none'; preview._positioned = false; }
}

function triggerHandwritingRecognition() {
    // Collecter tous les traits textMode
    const hwStrokes = strokes.filter(s => s.textMode);
    if (hwStrokes.length === 0) return;

    // Calculer la bounding box globale
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    hwStrokes.forEach(s => s.points.forEach(p => {
        if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y;
        if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y;
    }));
    const pad = 20;
    minX = Math.max(0, minX-pad); minY = Math.max(0, minY-pad);
    maxX = Math.min(drawCanvas.width,  maxX+pad);
    maxY = Math.min(drawCanvas.height, maxY+pad);
    _hwBBox = { x: minX, y: minY, w: maxX-minX, h: maxY-minY };

    // Afficher le panneau avec √©tat de chargement
    showHandwritingPreview('', true, minX, minY, maxX-minX, maxY-minY);

    // OCR avec Tesseract.js (traitement local, pas d'API externe)
    callAnthropicOCR(null).then(text => {
        _hwRecognizedText = text && text.trim() ? text : '?';
        showHandwritingPreview(_hwRecognizedText, false, minX, minY, maxX-minX, maxY-minY);
    }).catch(err => {
        console.error('OCR error:', err);
        showHandwritingPreview('‚ö†Ô∏è ' + (err.message || 'Erreur'), false, minX, minY, maxX-minX, maxY-minY);
    });
}

// =========================================================================
// MYSCRIPT iink ‚Äî Reconnaissance d'√©criture manuscrite
// =========================================================================

function saveMyScriptKeys() {
    const appKey  = (document.getElementById('hw-appkey-input')?.value  || '').trim();
    const hmacKey = (document.getElementById('hw-hmackey-input')?.value || '').trim();
    localStorage.setItem('ms_app_key',  appKey);
    localStorage.setItem('ms_hmac_key', hmacKey);
    const status = document.getElementById('hw-apikey-status');
    if (status) {
        const ok = appKey.length > 8 && hmacKey.length > 8;
        status.textContent = ok ? '‚úì' : '‚óè';
        status.style.color  = ok ? '#4caf50' : '#888';
    }
}

function getMyScriptKeys() {
    return {
        appKey:  localStorage.getItem('ms_app_key')  || '',
        hmacKey: localStorage.getItem('ms_hmac_key') || ''
    };
}

// Remplir les champs au chargement
window.addEventListener('load', () => {
    const { appKey, hmacKey } = getMyScriptKeys();
    const ai = document.getElementById('hw-appkey-input');
    const hi = document.getElementById('hw-hmackey-input');
    if (ai && appKey)  { ai.value  = appKey; }
    if (hi && hmacKey) { hi.value = hmacKey; }
    if (appKey || hmacKey) saveMyScriptKeys();
});

// Calcul HMAC-SHA512 pour l'authentification MyScript
async function computeHmac(appKey, hmacKey, body) {
    const enc = new TextEncoder();
    const keyData = enc.encode(appKey + hmacKey);
    const msgData = enc.encode(body);
    const cryptoKey = await crypto.subtle.importKey(
        'raw', keyData, { name: 'HMAC', hash: 'SHA-512' }, false, ['sign']
    );
    const sig = await crypto.subtle.sign('HMAC', cryptoKey, msgData);
    return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, '0')).join('');
}

// Convertir nos strokes en format MyScript iink (JIIX)
function buildMyScriptStrokePayload() {
    const hwStrokes = strokes.filter(s => s.textMode);
    const minX = _hwBBox ? _hwBBox.x : 0;
    const minY = _hwBBox ? _hwBBox.y : 0;

    const strokeList = hwStrokes.map((s, idx) => {
        const xs = s.points.map(p => Math.round(p.x - minX));
        const ys = s.points.map(p => Math.round(p.y - minY));
        // Timestamps artificiels espac√©s de 20ms par point
        const ts = s.points.map((_, i) => idx * 1000 + i * 20);
        return { x: xs, y: ys, t: ts };
    });

    const w = _hwBBox ? Math.ceil(_hwBBox.w) : 800;
    const h = _hwBBox ? Math.ceil(_hwBBox.h) : 400;

    return {
        configuration: {
            lang: 'fr_FR',
            export: { 'image-resolution': 96 }
        },
        contentType: 'Text',
        conversionState: 'DIGITAL_EDIT',
        height: h,
        width: w,
        strokeGroups: [{ strokes: strokeList }]
    };
}

async function callAnthropicOCR(_unused) {
    // Lire les cl√©s depuis les champs EN PRIORIT√â, puis depuis localStorage
    const appKeyInput  = (document.getElementById('hw-appkey-input')?.value  || '').trim();
    const hmacKeyInput = (document.getElementById('hw-hmackey-input')?.value || '').trim();
    const appKey  = appKeyInput  || localStorage.getItem('ms_app_key')  || '';
    const hmacKey = hmacKeyInput || localStorage.getItem('ms_hmac_key') || '';

    if (!appKey || !hmacKey) {
        throw new Error('Cl√©s MyScript manquantes ‚Äî saisissez-les dans le panneau (mode ‚úçÔ∏è √âcriture)');
    }

    // Sauvegarder si pas encore fait
    if (appKey)  localStorage.setItem('ms_app_key',  appKey);
    if (hmacKey) localStorage.setItem('ms_hmac_key', hmacKey);

    const payload = buildMyScriptStrokePayload();
    const bodyStr = JSON.stringify(payload);
    const hmac = await computeHmac(appKey, hmacKey, bodyStr);

    const resp = await fetch('https://cloud.myscript.com/api/v4.0/iink/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json,application/vnd.myscript.jiix',
            'applicationKey': appKey,
            'hmac': hmac
        },
        body: bodyStr
    });

    if (!resp.ok) {
        const txt = await resp.text().catch(() => resp.status);
        throw new Error('MyScript API: ' + txt);
    }

    const result = await resp.json();
    const text = result?.label || result?.exports?.['text/plain'] || '';
    return text.trim() || '?';
}

function showHandwritingPreview(text, loading, bx, by, bw, bh) {
    const preview = document.getElementById('handwriting-preview');
    const textEl  = document.getElementById('handwriting-recognized-text');
    const loadEl  = document.getElementById('handwriting-loading');
    const convertBtn = document.getElementById('handwriting-convert-btn');

    if (loading) {
        textEl.textContent = '';
        loadEl.style.display = 'block';
        if (convertBtn) convertBtn.style.display = 'none';
    } else {
        textEl.textContent = text;
        loadEl.style.display = 'none';
        if (convertBtn) convertBtn.style.display = 'inline-block';
    }

    // Positionner le panneau au-dessus de la zone dessin√©e (seulement √† la 1√®re fois)
    if (preview.style.display === 'none' || !preview._positioned) {
        const boardRect = board.getBoundingClientRect();
        const panelX = boardRect.left + bx;
        const panelY = boardRect.top  + by;
        const maxLeft = window.innerWidth - 540;
        const maxTop  = window.innerHeight - 220;
        preview.style.left = Math.max(10, Math.min(panelX, maxLeft)) + 'px';
        preview.style.top  = Math.max(10, Math.min(panelY - 150, maxTop)) + 'px';
        preview._positioned = true;
    }
    preview.style.display = 'block';

    // Init drag si pas encore fait
    if (!preview._dragInited) {
        preview._dragInited = true;
        const header = document.getElementById('handwriting-preview-header');
        header.addEventListener('mousedown', (e) => {
            e.preventDefault();
            let ox = e.clientX - preview.offsetLeft;
            let oy = e.clientY - preview.offsetTop;
            const onMove = (ev) => {
                preview.style.left = Math.max(0, ev.clientX - ox) + 'px';
                preview.style.top  = Math.max(0, ev.clientY - oy) + 'px';
            };
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
    }
}

function convertHandwritingToWidget() {
    // Lire le texte potentiellement √©dit√© par l'utilisateur dans le panneau
    const editedEl = document.getElementById('handwriting-recognized-text');
    if (editedEl) _hwRecognizedText = editedEl.textContent.trim();
    if (!_hwRecognizedText || !_hwBBox) return;

    const preview = document.getElementById('handwriting-preview');
    if (preview) { preview.style.display = 'none'; preview._positioned = false; }

    // Cr√©er un widget texte √† l'emplacement du dessin
    snapshotNow();
    const widget = createWidget('text', _hwBBox.x + 'px', _hwBBox.y + 'px', false);
    const editor = widget.querySelector('.editor-content');
    if (editor) {
        editor.style.fontFamily = "'BelleAllureGS', cursive";
        editor.style.fontSize   = '52px';
        editor.innerHTML = `<span style="font-family:'BelleAllureGS', cursive;font-size:52px;">${_hwRecognizedText.replace(/\n/g, '<br>')}</span>`;
    }

    // Supprimer les traits manuscrits du canvas
    strokes = strokes.filter(s => !s.textMode);
    redrawStrokes();

    // Snapshot final avec le widget texte
    const cur = buildBoardJSON();
    if (cur) {
        undoStack.push(cur);
        if (undoStack.length > MAX_UNDO) undoStack.shift();
        redoStack = [];
        updateUndoRedoBtns();
        localStorage.setItem('profBoardConfig', cur);
    }

    _hwRecognizedText = '';
    _hwBBox = null;
}

function discardHandwriting() {
    const preview = document.getElementById('handwriting-preview');
    if (preview) { preview.style.display = 'none'; preview._positioned = false; }
    _hwRecognizedText = '';
    _hwBBox = null;
    // Garder les traits tels quels
}

function redrawStrokes(extra = null) {
    if (!drawCtx) return;
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    strokes.forEach(s => drawStroke(s));
    if (extra) drawStroke(extra);
    selectedStrokes.forEach(s => drawStroke(s, true));
}

function drawStroke(stroke, highlight = false) {
    if (!stroke.points || stroke.points.length < 2) return;
    drawCtx.save();
    drawCtx.beginPath(); drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round';
    drawCtx.strokeStyle = highlight ? '#4a90e2' : stroke.color;
    drawCtx.lineWidth   = highlight ? stroke.size + 6 : stroke.size;
    if (highlight) drawCtx.globalAlpha = 0.5;
    drawCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
    stroke.points.forEach(p => drawCtx.lineTo(p.x, p.y));
    drawCtx.stroke(); drawCtx.restore();
    if (highlight) {
        drawCtx.save(); drawCtx.beginPath(); drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round';
        drawCtx.strokeStyle = stroke.color; drawCtx.lineWidth = stroke.size;
        drawCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
        stroke.points.forEach(p => drawCtx.lineTo(p.x, p.y));
        drawCtx.stroke(); drawCtx.restore();
    }
}

// =========================================================================
// MODES DESSIN
// =========================================================================
let currentDrawMode = 'free'; // 'free' | 'shape' | 'text'

function setDrawMode(mode) {
    currentDrawMode = mode;
    ['free','shape'].forEach(m => {
        const btn = document.getElementById('draw-mode-'+m+'-btn');
        if (!btn) return;
        if (m === mode) {
            btn.style.borderColor = '#4a90e2'; btn.style.background = '#1a3550'; btn.style.color = '#fff';
        } else {
            btn.style.borderColor = '#444'; btn.style.background = '#2a2a2e'; btn.style.color = '#aaa';
        }
    });
    const shapeOpts = document.getElementById('shape-recog-options');
    const shapeHint = document.getElementById('shape-recog-hint');
    if (mode === 'shape') {
        if (shapeOpts) shapeOpts.style.display = 'flex';
        if (shapeHint) shapeHint.style.display = 'block';
    } else {
        if (shapeOpts) shapeOpts.style.display = 'none';
        if (shapeHint) shapeHint.style.display = 'none';
    }
}

function toggleDrawToolbar() {
    const tb = document.getElementById('draw-toolbar');
    if (tb.style.display === 'flex') { stopDrawing(); return; }
    stopEraserMode();
    document.getElementById('shape-toolbar').classList.remove('active');
    document.getElementById('shape-btn').classList.remove('active-tool');
    tb.style.display = 'flex';
    initCanvas(); enableDrawing();
    setDrawMode('free'); // always start in free mode
}
function enableDrawing() {
    isDrawMode = true; drawCanvas.classList.remove('inactive');
    document.getElementById('draw-btn').classList.add('active-tool');
    document.getElementById('draw-btn').textContent = '‚úèÔ∏è';
    clearSelection();
}
function stopDrawing() {
    isDrawMode = false;
    if (drawCanvas) drawCanvas.classList.add('inactive');
    document.getElementById('draw-toolbar').style.display = 'none';
    document.getElementById('draw-btn').classList.remove('active-tool');
    document.getElementById('draw-btn').textContent = '‚úèÔ∏è';
    cancelHandwritingRecognition();
}
function clearCanvas() {
    snapshotNow();
    strokes = []; selectedStrokes = []; redrawStrokes();
}

// =========================================================================
// RECONNAISSANCE DE FORMES
// =========================================================================

function recognizeAndReplaceShape(stroke) {
    if (!stroke || stroke.points.length < 4) return false;
    const pts = stroke.points;

    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    pts.forEach(p => {
        if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y;
        if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y;
    });
    const w = maxX - minX, h = maxY - minY;
    if (w < 10 && h < 10) return false;

    const strokeColor = document.getElementById('draw-color').value;
    const strokeWidth = parseInt(document.getElementById('draw-size').value);
    const fillColor   = document.getElementById('shape-recog-fill').value;
    const fillOpacity = parseInt(document.getElementById('shape-recog-opacity').value) / 100;

    const firstPt = pts[0], lastPt = pts[pts.length-1];
    const closeDist = Math.hypot(firstPt.x-lastPt.x, firstPt.y-lastPt.y);
    const diagLen   = Math.hypot(w, h);
    const isClosed  = closeDist < diagLen * 0.35;

    if (!isClosed) {
        strokes.push({ ...stroke, recognized: false });
        const cur = buildBoardJSON();
        if (cur) { undoStack.push(cur); if (undoStack.length > MAX_UNDO) undoStack.shift(); redoStack=[]; updateUndoRedoBtns(); }
        saveBoard(); redrawStrokes();
        return false;
    }

    const cx = (minX+maxX)/2, cy = (minY+maxY)/2;
    const radii  = pts.map(p => Math.hypot(p.x-cx, p.y-cy));
    const avgR   = radii.reduce((a,b)=>a+b,0)/radii.length;
    const stdDev = Math.sqrt(radii.reduce((a,v)=>a+(v-avgR)**2,0)/radii.length);
    const cv     = stdDev / avgR; // coefficient de variation ‚Äî faible = cercle
    const aspect = Math.min(w,h) / Math.max(w,h);

    // ‚îÄ‚îÄ Crit√®res am√©lior√©s ‚îÄ‚îÄ
    // Cercle : cv tr√®s faible ET aspect proche de 1
    // On exige cv < 0.12 (√©tait 0.20) pour √©viter les faux positifs
    const isCircle = cv < 0.12 && aspect > 0.75;

    // Triangle : simplification agressive
    const isTriangle = !isCircle && isLikelyTriangle(pts);

    let shapeId;
    if (isCircle) {
        shapeId = 'circle';
    } else if (isTriangle) {
        shapeId = 'triangle';
    } else {
        // Carr√© vs rectangle : bas√© sur l'aspect ratio uniquement
        shapeId = aspect > 0.85 ? 'square' : 'rectangle';
    }

    let svgW = w, svgH = h;
    if (shapeId === 'circle') {
        const side = Math.max(w, h);
        svgW = side; svgH = side;
    }

    createShapeWidget(shapeId, strokeColor, fillColor, fillOpacity, svgW, svgH, minX + 'px', minY + 'px', false, strokeWidth);

    const snapCur = buildBoardJSON();
    if (snapCur) {
        undoStack.push(snapCur);
        if (undoStack.length > MAX_UNDO) undoStack.shift();
        redoStack = [];
        updateUndoRedoBtns();
        localStorage.setItem('profBoardConfig', snapCur);
    }
    redrawStrokes();
    return true;
}

function isLikelyTriangle(pts) {
    // Simplify and count corners ‚Äî triangle = 3 corners
    const epsilon = Math.hypot(
        Math.max(...pts.map(p=>p.x)) - Math.min(...pts.map(p=>p.x)),
        Math.max(...pts.map(p=>p.y)) - Math.min(...pts.map(p=>p.y))
    ) * 0.10;
    const simplified = rdpSimplify(pts, epsilon);
    return simplified.length >= 3 && simplified.length <= 5;
}

function rdpSimplify(pts, epsilon) {
    if (pts.length < 3) return pts;
    let maxDist = 0, maxIdx = 0;
    const first = pts[0], last = pts[pts.length-1];
    for (let i=1; i<pts.length-1; i++) {
        const d = perpendicularDist(pts[i], first, last);
        if (d > maxDist) { maxDist = d; maxIdx = i; }
    }
    if (maxDist > epsilon) {
        const left = rdpSimplify(pts.slice(0, maxIdx+1), epsilon);
        const right = rdpSimplify(pts.slice(maxIdx), epsilon);
        return [...left.slice(0,-1), ...right];
    }
    return [first, last];
}

function perpendicularDist(pt, lineA, lineB) {
    const dx = lineB.x - lineA.x, dy = lineB.y - lineA.y;
    const len = Math.hypot(dx, dy);
    if (len === 0) return Math.hypot(pt.x - lineA.x, pt.y - lineA.y);
    return Math.abs(dy*pt.x - dx*pt.y + lineB.x*lineA.y - lineB.y*lineA.x) / len;
}



// =========================================================================
// GOMME
// =========================================================================
let isEraserMode = false, isErasing = false;

function toggleEraserMode() {
    if (isEraserMode) { stopEraserMode(); return; }
    stopDrawing();
    document.getElementById('shape-toolbar').classList.remove('active');
    document.getElementById('shape-btn').classList.remove('active-tool');
    document.getElementById('global-toolbar').style.display = 'none';
    isEraserMode = true;
    initCanvas();
    drawCanvas.classList.remove('inactive');
    drawCanvas.classList.add('eraser-mode');
    document.getElementById('eraser-btn').classList.add('active-tool');
    document.getElementById('eraser-btn').textContent = 'üßΩ en cours‚Ä¶';
    document.getElementById('eraser-toolbar').style.display = 'flex';
    drawCanvas.addEventListener('mousedown',  startErase);
    drawCanvas.addEventListener('mousemove',  onEraserMouseMove);
    drawCanvas.addEventListener('mouseup',    endErase);
    drawCanvas.addEventListener('mouseleave', onEraserLeave);
    drawCanvas.addEventListener('touchstart', eTouchStart, { passive: false });
    drawCanvas.addEventListener('touchmove',  eTouchMove,  { passive: false });
    drawCanvas.addEventListener('touchend',   endErase);
    clearSelection();
}

function stopEraserMode() {
    if (!isEraserMode) return;
    isEraserMode = false; isErasing = false;
    if (drawCanvas) {
        drawCanvas.classList.add('inactive');
        drawCanvas.classList.remove('eraser-mode');
        drawCanvas.removeEventListener('mousedown',  startErase);
        drawCanvas.removeEventListener('mousemove',  onEraserMouseMove);
        drawCanvas.removeEventListener('mouseup',    endErase);
        drawCanvas.removeEventListener('mouseleave', onEraserLeave);
        drawCanvas.removeEventListener('touchstart', eTouchStart);
        drawCanvas.removeEventListener('touchmove',  eTouchMove);
        drawCanvas.removeEventListener('touchend',   endErase);
        redrawStrokes();
    }
    document.getElementById('eraser-btn').classList.remove('active-tool');
    document.getElementById('eraser-btn').textContent = 'üßΩ';
    document.getElementById('eraser-toolbar').style.display = 'none';
}

function eTouchStart(e) { e.preventDefault(); snapshotNow(); isErasing = true; eraseAt(getPos(e.touches[0])); }
function eTouchMove(e)  { e.preventDefault(); if (isErasing) eraseAt(getPos(e.touches[0])); }

function onEraserMouseMove(e) {
    const pos = getPos(e);
    const r = parseInt(document.getElementById('eraser-size').value);
    if (isErasing) eraseAt(pos);
    else drawEraserPreview(pos, r);
}
function onEraserLeave() { endErase(); redrawStrokes(); }
function startErase(e) { if (!isEraserMode) return; snapshotNow(); isErasing = true; eraseAt(getPos(e)); }
function endErase() { if (!isErasing) return; isErasing = false; saveBoard(); }

// =========================================================================
// D√âTECTION FORME SVG ENTI√àREMENT GOMM√âE
// =========================================================================
function isShapeFullyErased(widget) {
    const svg = widget.querySelector('svg');
    if (!svg) return false;
    if (!svg.querySelector('mask.eraser-mask')) return false;
    const svgW = parseFloat(svg.getAttribute('width')) || 100;
    const svgH = parseFloat(svg.getAttribute('height')) || 100;
    const tmpCanvas = document.createElement('canvas');
    const scale = Math.min(1, 200 / Math.max(svgW, svgH));
    tmpCanvas.width  = Math.ceil(svgW * scale);
    tmpCanvas.height = Math.ceil(svgH * scale);
    const tmpCtx = tmpCanvas.getContext('2d');
    const svgClone = svg.cloneNode(true);
    svgClone.setAttribute('width',  tmpCanvas.width);
    svgClone.setAttribute('height', tmpCanvas.height);
    svgClone.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
    const svgStr = new XMLSerializer().serializeToString(svgClone);
    const blob = new Blob([svgStr], { type: 'image/svg+xml' });
    const url  = URL.createObjectURL(blob);
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            tmpCtx.clearRect(0, 0, tmpCanvas.width, tmpCanvas.height);
            tmpCtx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);
            const data = tmpCtx.getImageData(0, 0, tmpCanvas.width, tmpCanvas.height).data;
            for (let i = 3; i < data.length; i += 4) {
                if (data[i] > 5) { resolve(false); return; }
            }
            resolve(true);
        };
        img.onerror = () => { URL.revokeObjectURL(url); resolve(false); };
        img.src = url;
    });
}

async function removeFullyErasedShapes() {
    const shapeWidgets = [...document.querySelectorAll('.shape-widget')];
    const toRemove = [];
    for (const widget of shapeWidgets) {
        const erased = await isShapeFullyErased(widget);
        if (erased) toRemove.push(widget);
    }
    if (toRemove.length > 0) {
        toRemove.forEach(w => w.remove());
        saveBoard();
    }
}

function eraseAt(pos) {
    const r = parseInt(document.getElementById('eraser-size').value);
    const NS = 'http://www.w3.org/2000/svg';
    const newStrokes = [];
    strokes.forEach(stroke => {
        const pts = stroke.points;
        let current = [];
        for (let i = 0; i < pts.length; i++) {
            if (Math.hypot(pts[i].x - pos.x, pts[i].y - pos.y) <= r) {
                if (current.length >= 2) newStrokes.push({ ...stroke, points: current });
                current = [];
            } else { current.push(pts[i]); }
        }
        if (current.length >= 2) newStrokes.push({ ...stroke, points: current });
    });
    strokes = newStrokes;
    let shapesModified = false;
    document.querySelectorAll('.shape-widget').forEach(widget => {
        const svg = widget.querySelector('svg');
        if (!svg) return;
        const bRect = board.getBoundingClientRect();
        const svg2R = svg.getBoundingClientRect();
        const svgX = pos.x - (svg2R.left - bRect.left);
        const svgY = pos.y - (svg2R.top  - bRect.top);
        if (svgX < -r || svgY < -r || svgX > svg2R.width + r || svgY > svg2R.height + r) return;
        let mask = svg.querySelector('mask.eraser-mask');
        if (!mask) {
            const defs = document.createElementNS(NS, 'defs');
            mask = document.createElementNS(NS, 'mask');
            mask.setAttribute('class', 'eraser-mask');
            mask.setAttribute('id', 'em-' + Math.random().toString(36).slice(2));
            const bg = document.createElementNS(NS, 'rect');
            bg.setAttribute('x', '-500'); bg.setAttribute('y', '-500');
            bg.setAttribute('width', '9999'); bg.setAttribute('height', '9999');
            bg.setAttribute('fill', 'white');
            mask.appendChild(bg); defs.appendChild(mask);
            svg.insertBefore(defs, svg.firstChild);
            const g = document.createElementNS(NS, 'g');
            g.setAttribute('mask', 'url(#' + mask.id + ')');
            const toMove = [...svg.childNodes].filter(n => n !== defs);
            toMove.forEach(n => g.appendChild(n));
            svg.appendChild(g);
        }
        const circle = document.createElementNS(NS, 'circle');
        circle.setAttribute('cx', svgX); circle.setAttribute('cy', svgY);
        circle.setAttribute('r', r); circle.setAttribute('fill', 'black');
        mask.appendChild(circle);
        shapesModified = true;
    });
    drawEraserPreview(pos, r);
    if (shapesModified) {
        clearTimeout(eraseAt._checkTimer);
        eraseAt._checkTimer = setTimeout(() => {
            removeFullyErasedShapes();
        }, 150);
    }
}

function drawEraserPreview(pos, r) {
    if (!drawCtx) return;
    redrawStrokes();
    drawCtx.save();
    drawCtx.beginPath();
    drawCtx.arc(pos.x, pos.y, r, 0, Math.PI * 2);
    drawCtx.strokeStyle = 'rgba(60,60,60,0.7)';
    drawCtx.lineWidth = 1.5;
    drawCtx.setLineDash([4, 3]);
    drawCtx.stroke();
    drawCtx.beginPath();
    drawCtx.arc(pos.x, pos.y, 2, 0, Math.PI * 2);
    drawCtx.fillStyle = 'rgba(60,60,60,0.5)';
    drawCtx.fill();
    drawCtx.restore();
}

// =========================================================================
// S√âLECTION
// =========================================================================
let selectedWidgets = [], selectedStrokes = [];
let selectionRect = null;
let isSelectingRect = false, selectStartX = 0, selectStartY = 0;
let mouseDownClientX = 0, mouseDownClientY = 0;
let moveStartX = 0, moveStartY = 0;
let widgetMoveOrigins = [], strokeMoveOrigins = [];
let rotateCenterX = 0, rotateCenterY = 0, rotateStartAngle = 0;
let rotateOrigWidgetTransforms = [], rotateOrigStrokePoints = [];

function initSelectionRect() {
    if (selectionRect) return;
    selectionRect = document.createElement('div');
    selectionRect.id = 'selection-rect';
    board.appendChild(selectionRect);
}

function initBoardSelection() {
    initSelectionRect();
    board.addEventListener('mousedown', onBoardMouseDown);
}

function onBoardMouseDown(e) {
    if (_presentationActive) return;
    if (isDrawMode || isEraserMode) return;
    if (e.target.closest('#selection-controls')) return;
    if (e.target.closest('#toolbar-container')) return;
    if (e.target.closest('.widget-ctx-menu')) return;
    if (e.target.closest('#shape-edit-panel')) return;

    // Fermer le menu widgets si ouvert
    document.getElementById('tools-menu')?.classList.remove('active');

    mouseDownClientX = e.clientX;
    mouseDownClientY = e.clientY;

    const widget = e.target.closest('.widget, .shape-widget');

    if (widget) {
        const gid = widget.dataset.groupId;
        // Membres DOM du groupe (widgets + shape-widgets)
        const domMembers = gid
            ? [...document.querySelectorAll(`.widget[data-group-id="${gid}"], .shape-widget[data-group-id="${gid}"]`)]
            : [widget];
        // Membres traits canvas du groupe
        const strokeMembers = gid ? strokes.filter(s => s.groupId === gid) : [];

        if (e.ctrlKey || e.metaKey) {
            const allDomSelected    = domMembers.every(m => selectedWidgets.includes(m));
            const allStrokeSel      = strokeMembers.every(s => selectedStrokes.includes(s));
            const allAlreadySelected = allDomSelected && allStrokeSel;
            if (allAlreadySelected) {
                domMembers.forEach(m => { selectedWidgets = selectedWidgets.filter(w => w !== m); m.classList.remove('selected'); });
                selectedStrokes = selectedStrokes.filter(s => !strokeMembers.includes(s));
            } else {
                domMembers.forEach(m => { if (!selectedWidgets.includes(m)) { selectedWidgets.push(m); m.classList.add('selected'); } });
                strokeMembers.forEach(s => { if (!selectedStrokes.includes(s)) selectedStrokes.push(s); });
            }
        } else {
            const allDomSelected    = domMembers.every(m => selectedWidgets.includes(m));
            const allStrokeSel      = strokeMembers.every(s => selectedStrokes.includes(s));
            const allAlreadySelected = allDomSelected && allStrokeSel
                && selectedWidgets.length === domMembers.length
                && selectedStrokes.length === strokeMembers.length;
            if (!allAlreadySelected) {
                clearSelection();
                domMembers.forEach(m => { selectedWidgets.push(m); m.classList.add('selected'); });
                strokeMembers.forEach(s => selectedStrokes.push(s));
            }
        }
        if (drawCtx) redrawStrokes();
        updateSelectionOverlay();
        return;
    }

    const pos = getBoardPos(e);

    const hitStroke = findStrokeAt(pos.x, pos.y);
	if (hitStroke) {
		const gid = hitStroke.groupId;
		const groupStrokes  = gid ? strokes.filter(s => s.groupId === gid) : [hitStroke];
		const groupWidgets  = gid
			? [...document.querySelectorAll(`.widget[data-group-id="${gid}"], .shape-widget[data-group-id="${gid}"]`)]
			: [];

		if (e.ctrlKey || e.metaKey) {
			const allInSel = groupStrokes.every(s => selectedStrokes.includes(s))
						  && groupWidgets.every(w => selectedWidgets.includes(w));
			if (allInSel) {
				selectedStrokes = selectedStrokes.filter(s => !groupStrokes.includes(s));
				groupWidgets.forEach(w => { selectedWidgets = selectedWidgets.filter(x => x !== w); w.classList.remove('selected'); });
			} else {
				groupStrokes.forEach(s => { if (!selectedStrokes.includes(s)) selectedStrokes.push(s); });
				groupWidgets.forEach(w => { if (!selectedWidgets.includes(w)) { selectedWidgets.push(w); w.classList.add('selected'); } });
			}
			if (drawCtx) redrawStrokes();
			updateSelectionOverlay();
			return;
		}

		// S√©lection exclusive
		const allInSel = groupStrokes.every(s => selectedStrokes.includes(s))
					  && groupWidgets.every(w => selectedWidgets.includes(w))
					  && selectedStrokes.length === groupStrokes.length
					  && selectedWidgets.length === groupWidgets.length;
		if (!allInSel) {
			clearSelection();
			groupStrokes.forEach(s => selectedStrokes.push(s));
			groupWidgets.forEach(w => { selectedWidgets.push(w); w.classList.add('selected'); });
		}
		if (drawCtx) redrawStrokes();
		updateSelectionOverlay();

		// --- DRAG DIRECT sur le trait (sans poign√©e) ---
		snapshotNow();
		const dragStart = { x: pos.x, y: pos.y };
		widgetMoveOrigins = selectedWidgets.map(w => ({ widget: w, origLeft: w.offsetLeft, origTop: w.offsetTop }));
		strokeMoveOrigins = selectedStrokes.map(s => ({ stroke: s, origPoints: s.points.map(p => ({...p})) }));
		let hasMoved = false;

		const onStrokeDragMove = (ev) => {
			const p = getBoardPos(ev);
			const dx = p.x - dragStart.x, dy = p.y - dragStart.y;
			if (!hasMoved && Math.hypot(dx, dy) < 4) return;
			hasMoved = true;
			if (drawCanvas) drawCanvas.style.zIndex = 13000;
			widgetMoveOrigins.forEach(({ widget, origLeft, origTop }) => {
				widget.style.left = (origLeft + dx) + 'px';
				widget.style.top  = (origTop  + dy) + 'px';
			});
			strokeMoveOrigins.forEach(({ stroke, origPoints }) => {
				stroke.points = origPoints.map(p2 => ({ x: p2.x + dx, y: p2.y + dy }));
			});
			if (drawCtx) redrawStrokes();
			updateSelectionOverlay();
		};

		const onStrokeDragEnd = () => {
			document.removeEventListener('mousemove', onStrokeDragMove);
			document.removeEventListener('mouseup', onStrokeDragEnd);
			if (drawCanvas) drawCanvas.style.zIndex = '';
			if (hasMoved) {
				const curW = window.innerWidth, curVH = virtualH(curW);
				selectedWidgets.forEach(w => {
					w.dataset.leftPercent = (w.offsetLeft / curW) * 100;
					w.dataset.topPercent  = (w.offsetTop  / curVH) * 100;
				});
				saveBoard();
			}
			updateSelectionOverlay();
		};

		document.addEventListener('mousemove', onStrokeDragMove);
		document.addEventListener('mouseup', onStrokeDragEnd);
		return;
	}

    clearSelection();
    isSelectingRect = true;
    selectStartX = pos.x;
    selectStartY = pos.y;
    selectionRect.style.cssText = `display:block;left:${pos.x}px;top:${pos.y}px;width:0;height:0;`;

    const onMove = (ev) => {
        if (!isSelectingRect) return;
        const p = getBoardPos(ev);
        const x = Math.min(p.x, selectStartX), y = Math.min(p.y, selectStartY);
        Object.assign(selectionRect.style, {
            left: x+'px', top: y+'px',
            width: Math.abs(p.x - selectStartX)+'px',
            height: Math.abs(p.y - selectStartY)+'px'
        });
    };

    const onUp = (ev) => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (!isSelectingRect) return;
        isSelectingRect = false;

        const dx = Math.abs(ev.clientX - mouseDownClientX);
        const dy = Math.abs(ev.clientY - mouseDownClientY);

        if (dx < 5 && dy < 5) {
            clearSelection();
            return;
        }

        const pos2 = getBoardPos(ev);
        const rx = Math.min(pos2.x, selectStartX), ry = Math.min(pos2.y, selectStartY);
        const rw = Math.abs(pos2.x - selectStartX), rh = Math.abs(pos2.y - selectStartY);
        const br = board.getBoundingClientRect();

        document.querySelectorAll('.widget, .shape-widget').forEach(w => {
            const r = w.getBoundingClientRect();
            const wl = r.left - br.left, wt = r.top - br.top;
            if (wl < rx+rw && wl+r.width > rx && wt < ry+rh && wt+r.height > ry) {
                selectedWidgets.push(w);
                w.classList.add('selected');
            }
        });

        if (strokes) {
            strokes.forEach(s => {
                if (s.points.some(p => p.x >= rx && p.x <= rx+rw && p.y >= ry && p.y <= ry+rh))
                    selectedStrokes.push(s);
            });
        }

        if (drawCtx) redrawStrokes();
        updateSelectionOverlay();
        if (selectionRect) selectionRect.style.display = 'none';
    };

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
}

function clearSelection() {
    selectedWidgets.forEach(w => w.classList.remove('selected'));
    selectedWidgets = []; selectedStrokes = [];
    if (drawCtx) redrawStrokes();
    document.getElementById('selection-controls').style.display = 'none';
    if (selectionRect) selectionRect.style.display = 'none';
    board.classList.remove('single-select');
    board.classList.remove('multi-select');
}

// =========================================================================
// GROUPEMENT DE WIDGETS
// =========================================================================
let groupCounter = 0;

function mergeWidgets() {
    const totalItems = selectedWidgets.length + selectedStrokes.length;
    if (totalItems < 2) return;
    snapshotNow();
    groupCounter++;
    const groupId = 'grp-' + Date.now() + '-' + groupCounter;
    selectedWidgets.forEach(w => {
        const existingGroup = w.dataset.groupId;
        if (existingGroup && existingGroup !== groupId) {
            document.querySelectorAll(`.widget[data-group-id="${existingGroup}"], .shape-widget[data-group-id="${existingGroup}"]`).forEach(m => {
                m.dataset.groupId = groupId;
            });
            strokes.filter(s => s.groupId === existingGroup).forEach(s => { s.groupId = groupId; });
        }
        w.dataset.groupId = groupId;
    });
    selectedStrokes.forEach(s => {
        const existingGroup = s.groupId;
        if (existingGroup && existingGroup !== groupId) {
            document.querySelectorAll(`.widget[data-group-id="${existingGroup}"], .shape-widget[data-group-id="${existingGroup}"]`).forEach(m => {
                m.dataset.groupId = groupId;
            });
            strokes.filter(st => st.groupId === existingGroup).forEach(st => { st.groupId = groupId; });
        }
        s.groupId = groupId;
    });
    updateSelectionOverlay();
    saveBoard();
}

function ungroupWidgets() {
    if (selectedWidgets.length === 0 && selectedStrokes.length === 0) return;
    snapshotNow();
    const groupIds = new Set([
        ...selectedWidgets.map(w => w.dataset.groupId),
        ...selectedStrokes.map(s => s.groupId)
    ].filter(Boolean));
    groupIds.forEach(gid => {
        document.querySelectorAll(`.widget[data-group-id="${gid}"], .shape-widget[data-group-id="${gid}"]`).forEach(w => {
            delete w.dataset.groupId;
        });
        strokes.filter(s => s.groupId === gid).forEach(s => { delete s.groupId; });
    });
    clearSelection();
    saveBoard();
}

function initSelectionControls() {
    document.getElementById('sc-move-btn').onmousedown = (e) => {
		e.preventDefault(); e.stopPropagation();
		snapshotNow();
		const pos = getBoardPos(e);
		moveStartX = pos.x; moveStartY = pos.y;
		widgetMoveOrigins = selectedWidgets.map(w => ({ widget: w, origLeft: w.offsetLeft, origTop: w.offsetTop }));
		strokeMoveOrigins = selectedStrokes.map(s => ({ stroke: s, origPoints: s.points.map(p => ({...p})) }));

		// Bloquer les iframes pendant le drag
		const overlays = [];
		document.querySelectorAll('.widget iframe, .widget embed').forEach(el => {
			const overlay = document.createElement('div');
			overlay.style.cssText = 'position:absolute;inset:0;z-index:9999;background:transparent;';
			el.parentElement.style.position = 'relative';
			el.parentElement.appendChild(overlay);
			overlays.push(overlay);
		});

		const onMoveEnd_patched = () => {
			document.removeEventListener('mousemove', onMoveMove);
			document.removeEventListener('mouseup', onMoveEnd_patched);
			overlays.forEach(o => o.remove());
			const curW = window.innerWidth, curVH = virtualH(curW);
			selectedWidgets.forEach(w => {
				w.dataset.leftPercent = (w.offsetLeft / curW) * 100;
				w.dataset.topPercent  = (w.offsetTop  / curVH) * 100;
			});
			saveBoard(); updateSelectionOverlay();
		};

		document.addEventListener('mousemove', onMoveMove);
		document.addEventListener('mouseup', onMoveEnd_patched);
	};
    document.getElementById('sc-rotate-btn').ondblclick = (e) => {
        e.preventDefault(); e.stopPropagation();
        snapshotNow();
        selectedWidgets.forEach(w => {
            if (w.dataset.preRotLeft !== undefined) {
                w.style.left      = w.dataset.preRotLeft;
                w.style.top       = w.dataset.preRotTop;
                w.style.transform = w.dataset.preRotTransform || '';
                delete w.dataset.preRotLeft;
                delete w.dataset.preRotTop;
                delete w.dataset.preRotTransform;
            } else {
                w.style.transform = '';
            }
        });
        hideRotationIndicator();
        saveBoard(); updateSelectionOverlay();
    };
    document.getElementById('sc-rotate-btn').onmousedown = (e) => {
        e.preventDefault(); e.stopPropagation();
        snapshotNow();
        selectedWidgets.forEach(w => {
            if (w.dataset.preRotLeft === undefined) {
                w.dataset.preRotLeft      = w.style.left;
                w.dataset.preRotTop       = w.style.top;
                w.dataset.preRotTransform = w.style.transform || '';
            }
        });
        const center = getSelectionCenter();
        rotateCenterX = center.x; rotateCenterY = center.y;
        const br = board.getBoundingClientRect();
        rotateStartAngle = Math.atan2(e.clientY - br.top - rotateCenterY, e.clientX - br.left - rotateCenterX);
        rotateOrigWidgetTransforms = selectedWidgets.map(w => ({ widget: w, origLeft: w.offsetLeft, origTop: w.offsetTop, origRot: getCurrentRotation(w) }));
        rotateOrigStrokePoints = selectedStrokes.map(s => ({ stroke: s, origPoints: s.points.map(p => ({...p})) }));
        const indicator = document.getElementById('rotation-indicator');
        const onMove = (ev) => {
            const br2 = board.getBoundingClientRect();
            const angle = Math.atan2(ev.clientY - br2.top - rotateCenterY, ev.clientX - br2.left - rotateCenterX);
            const delta = (angle - rotateStartAngle) * 180 / Math.PI;
            rotateOrigWidgetTransforms.forEach(({ widget, origLeft, origTop, origRot }) => {
                const cx2 = origLeft + widget.offsetWidth/2  - rotateCenterX;
                const cy2 = origTop  + widget.offsetHeight/2 - rotateCenterY;
                const rad = delta * Math.PI / 180;
                widget.style.left      = (rotateCenterX + cx2*Math.cos(rad) - cy2*Math.sin(rad) - widget.offsetWidth/2)  + 'px';
                widget.style.top       = (rotateCenterY + cx2*Math.sin(rad) + cy2*Math.cos(rad) - widget.offsetHeight/2) + 'px';
                widget.style.transform = `rotate(${snapRotation(origRot + delta)}deg)`;
            });
            rotateOrigStrokePoints.forEach(({ stroke, origPoints }) => {
                const rad = delta * Math.PI / 180;
                stroke.points = origPoints.map(p => ({
                    x: rotateCenterX + (p.x-rotateCenterX)*Math.cos(rad) - (p.y-rotateCenterY)*Math.sin(rad),
                    y: rotateCenterY + (p.x-rotateCenterX)*Math.sin(rad) + (p.y-rotateCenterY)*Math.cos(rad)
                }));
            });
            if (indicator && rotateOrigWidgetTransforms.length > 0) {
                const deg = Math.round(((snapRotation(rotateOrigWidgetTransforms[0].origRot + delta) % 360) + 360) % 360);
                document.getElementById('rot-deg').textContent = deg + '¬∞';
                indicator.style.display = 'block';
                indicator.style.left = ev.clientX + 'px';
                indicator.style.top  = ev.clientY + 'px';
                indicator.querySelector('.rot-reset-hint').style.display = deg === 0 ? 'none' : 'inline';
            }
            if (drawCtx) redrawStrokes(); updateSelectionOverlay();
        };
        const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            hideRotationIndicator();
            saveBoard(); updateSelectionOverlay();
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
    document.getElementById('sc-delete-btn').onclick = (e) => {
        e.stopPropagation();
        snapshotNow();
        selectedWidgets.forEach(w => { w.classList.remove('selected'); w.remove(); });
        selectedWidgets = [];
        strokes = strokes.filter(s => !selectedStrokes.includes(s));
        selectedStrokes = [];
        if (drawCtx) redrawStrokes();
        document.getElementById('selection-controls').style.display = 'none';
        saveBoard();
    };
    document.getElementById('sc-menu-btn').onclick = (e) => {
        e.stopPropagation();
        const menu = document.getElementById('sc-ctx-menu');
        const isOpen = menu.classList.contains('open');
        menu.classList.toggle('open', !isOpen);
        if (!isOpen) buildScCtxMenu(menu);
    };
    // Bouton verrou de l'overlay groupe
    const scLockBtn = document.getElementById('sc-lock-btn');
    if (scLockBtn) {
        scLockBtn.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });
        scLockBtn.addEventListener('click', e => {
            e.stopPropagation();
            const locked = scLockBtn.classList.toggle('locked');
            scLockBtn.textContent = locked ? 'üîí' : 'üîì';
        });
    }
    // Boutons sym√©trie de l'overlay groupe
    const scFlipH = document.getElementById('sc-flip-h-btn');
    const scFlipV = document.getElementById('sc-flip-v-btn');
    if (scFlipH) {
        scFlipH.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });
        scFlipH.addEventListener('click', e => {
            e.stopPropagation(); snapshotNow();
            selectedWidgets.forEach(w => flipWidget(w, 'h'));
            flipStrokes(selectedStrokes, 'h');
            saveBoard();
        });
    }
    if (scFlipV) {
        scFlipV.addEventListener('mousedown', e => { e.preventDefault(); e.stopPropagation(); });
        scFlipV.addEventListener('click', e => {
            e.stopPropagation(); snapshotNow();
            selectedWidgets.forEach(w => flipWidget(w, 'v'));
            flipStrokes(selectedStrokes, 'v');
            saveBoard();
        });
    }

    document.getElementById('sc-resize-btn').onmousedown = (e) => {
        e.preventDefault(); e.stopPropagation();
        const totalSel = selectedWidgets.length + selectedStrokes.length;
        if (totalSel < 1) return;
        snapshotNow();
        const br = board.getBoundingClientRect();
        let bMinX=Infinity, bMinY=Infinity, bMaxX=-Infinity, bMaxY=-Infinity;
        selectedWidgets.forEach(w => {
            const r = w.getBoundingClientRect();
            const l = r.left - br.left, t = r.top - br.top;
            const rr = r.right - br.left, rb = r.bottom - br.top;
            if (l  < bMinX) bMinX = l;  if (t  < bMinY) bMinY = t;
            if (rr > bMaxX) bMaxX = rr; if (rb > bMaxY) bMaxY = rb;
        });
        selectedStrokes.forEach(s => s.points.forEach(p => {
            if (p.x < bMinX) bMinX = p.x; if (p.y < bMinY) bMinY = p.y;
            if (p.x > bMaxX) bMaxX = p.x; if (p.y > bMaxY) bMaxY = p.y;
        }));
        const origBoxW = bMaxX - bMinX, origBoxH = bMaxY - bMinY;
        if (origBoxW < 1 || origBoxH < 1) return;
        const boxRatio = origBoxH / origBoxW;
        const startClientX = e.clientX, startClientY = e.clientY;
        const widgetOrigins = selectedWidgets.map(w => {
            const r = w.getBoundingClientRect();
            const wL = r.left  - br.left, wT = r.top    - br.top;
            const c = w.querySelector('.editor-container');
            const svg = w.querySelector('svg');
            return {
                widget: w,
                relL: (wL - bMinX) / origBoxW,
                relT: (wT - bMinY) / origBoxH,
                container: c,
                origCW: c   ? c.offsetWidth  : 0,
                origCH: c   ? c.offsetHeight : 0,
                svg: svg,
                origSW: svg ? parseFloat(svg.getAttribute('width')  || svg.getBoundingClientRect().width)  : 0,
                origSH: svg ? parseFloat(svg.getAttribute('height') || svg.getBoundingClientRect().height) : 0,
            };
        });
        const strokeOrigins = selectedStrokes.map(s => ({
            stroke: s,
            origPoints: s.points.map(p => ({ x: p.x, y: p.y }))
        }));
        const onMove = (ev) => {
            const proportional = ev.shiftKey || (scLockBtn && scLockBtn.classList.contains('locked'));
            const newBoxW = Math.max(20, origBoxW + ev.clientX - startClientX);
            const newBoxH = proportional ? Math.max(20, newBoxW * boxRatio)
                                         : Math.max(20, origBoxH + ev.clientY - startClientY);
            const scaleX = newBoxW / origBoxW, scaleY = newBoxH / origBoxH;
            widgetOrigins.forEach(({ widget, relL, relT, container, origCW, origCH, svg, origSW, origSH }) => {
                widget.style.left = (bMinX + relL * newBoxW) + 'px';
                widget.style.top  = (bMinY + relT * newBoxH) + 'px';
                if (container && origCW > 0) {
                    container.style.width  = (origCW * scaleX) + 'px';
                    container.style.height = (origCH * scaleY) + 'px';
                }
                if (svg && origSW > 0) {
                    const newSW = origSW * scaleX, newSH = origSH * scaleY;
                    svg.setAttribute('width', newSW); svg.setAttribute('height', newSH);
                    widget.style.width = newSW + 'px'; widget.style.height = newSH + 'px';
                }
            });
            strokeOrigins.forEach(({ stroke, origPoints }) => {
                stroke.points = origPoints.map(p => ({
                    x: bMinX + (p.x - bMinX) * scaleX,
                    y: bMinY + (p.y - bMinY) * scaleY
                }));
            });
            if (drawCtx) redrawStrokes();
            updateSelectionOverlay();
        };
        const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            const curW = window.innerWidth, curVH = virtualH(curW);
            selectedWidgets.forEach(w => {
                w.dataset.leftPercent = (w.offsetLeft / curW) * 100;
                w.dataset.topPercent  = (w.offsetTop  / curVH) * 100;
                const c = w.querySelector('.editor-container');
                if (c) {
                    w.dataset.widthPercent    = (c.offsetWidth  / curW) * 100;
                    w.dataset.contentHPercent = (c.offsetHeight / curVH) * 100;
                }
            });
            saveBoard();
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
    };
    document.getElementById('sc-merge-btn').onclick = (e) => {
        e.stopPropagation();
        mergeWidgets();
    };
    document.getElementById('sc-ungroup-btn').onclick = (e) => {
        e.stopPropagation();
        const groupIds = new Set([
            ...selectedWidgets.map(w => w.dataset.groupId),
            ...selectedStrokes.map(s => s.groupId)
        ].filter(Boolean));
        if (groupIds.size === 0) return;
        snapshotNow();
        groupIds.forEach(gid => {
            document.querySelectorAll(`.widget[data-group-id="${gid}"], .shape-widget[data-group-id="${gid}"]`).forEach(w => {
                delete w.dataset.groupId;
            });
            strokes.filter(s => s.groupId === gid).forEach(s => { delete s.groupId; });
        });
        clearSelection();
        saveBoard();
    };
}

function buildScCtxMenu(menu) {
    menu.innerHTML = '';
    const addBtn = (label, fn) => {
        const b = document.createElement('button');
        b.innerHTML = label;
        b.onmousedown = ev => ev.stopPropagation();
        b.onclick = () => { menu.classList.remove('open'); fn(); };
        menu.appendChild(b);
    };
    const addSep = () => menu.appendChild(document.createElement('hr'));

    addBtn('‚¨ÜÔ∏è Premier plan', () => {
        snapshotNow();
        selectedWidgets.forEach(w => { pinnedZCounter++; w.style.zIndex = pinnedZCounter; });
        saveBoard();
    });
    addBtn('‚¨áÔ∏è Envoyer derri√®re', () => {
        snapshotNow();
        selectedWidgets.forEach(w => { w.style.zIndex = 1; w.dataset.background = "true"; w.dataset.pinned = "false"; w.classList.remove('pinned'); });
        saveBoard();
    });
    addSep();
    addBtn('‚ßâ Dupliquer', () => {
        snapshotNow();
        const toClone = [...selectedWidgets];
        clearSelection();
        toClone.forEach(w => {
            if (w.classList.contains('shape-widget')) cloneShapeWidget(w);
            else cloneWidget(w);
        });
    });
    const hasGroup = selectedWidgets.some(w => w.dataset.groupId);
    if (hasGroup) {
        const groupIds = new Set(selectedWidgets.map(w => w.dataset.groupId).filter(Boolean));
        addSep();
        addBtn('‚õìÔ∏è‚Äçüí• Dissocier le groupe', () => {
            snapshotNow();
            groupIds.forEach(gid => {
                document.querySelectorAll(`.widget[data-group-id="${gid}"], .shape-widget[data-group-id="${gid}"]`).forEach(w => {
                    delete w.dataset.groupId;
                });
            });
            clearSelection();
            saveBoard();
        });
    }
}

function onMoveMove(e) {
    const pos = getBoardPos(e);
    const dx = pos.x - moveStartX, dy = pos.y - moveStartY;
    widgetMoveOrigins.forEach(({ widget, origLeft, origTop }) => {
        widget.style.left = (origLeft + dx) + 'px'; widget.style.top = (origTop + dy) + 'px';
    });
    strokeMoveOrigins.forEach(({ stroke, origPoints }) => {
        stroke.points = origPoints.map(p => ({ x: p.x + dx, y: p.y + dy }));
    });
    if (drawCtx) redrawStrokes(); updateSelectionOverlay();
}

function onMoveEnd() {
    document.removeEventListener('mousemove', onMoveMove);
    document.removeEventListener('mouseup',   onMoveEnd);
    const curW = window.innerWidth, curVH = virtualH(curW);
    selectedWidgets.forEach(w => {
        w.dataset.leftPercent = (w.offsetLeft / curW) * 100;
        w.dataset.topPercent  = (w.offsetTop  / curVH) * 100;
    });
    saveBoard(); updateSelectionOverlay();
}

function getSelectionCenter() {
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    const br = board.getBoundingClientRect();
    selectedWidgets.forEach(w => {
        const r = w.getBoundingClientRect();
        minX=Math.min(minX,r.left-br.left); minY=Math.min(minY,r.top-br.top);
        maxX=Math.max(maxX,r.right-br.left); maxY=Math.max(maxY,r.bottom-br.top);
    });
    selectedStrokes.forEach(s => s.points.forEach(p => {
        minX=Math.min(minX,p.x); minY=Math.min(minY,p.y); maxX=Math.max(maxX,p.x); maxY=Math.max(maxY,p.y);
    }));
    return { x:(minX+maxX)/2, y:(minY+maxY)/2 };
}

function updateSelectionOverlay() {
    const has = selectedWidgets.length > 0 || selectedStrokes.length > 0;
    const ctrl = document.getElementById('selection-controls');
    if (!has) {
        ctrl.style.display = 'none';
        board.classList.remove('single-select');
        return;
    }
    // Widget seul SANS groupe ‚Üí poign√©es natives bleues, pas d'overlay
    if (selectedWidgets.length === 1 && selectedStrokes.length === 0 && !selectedWidgets[0].dataset.groupId) {
        board.classList.add('single-select');
        board.classList.remove('multi-select');
        ctrl.style.display = 'none';
        return;
    }

    board.classList.remove('single-select');
    board.classList.add('multi-select');

    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    const br = board.getBoundingClientRect();
    selectedWidgets.forEach(w => {
        const r = w.getBoundingClientRect();
        minX=Math.min(minX,r.left-br.left); minY=Math.min(minY,r.top-br.top);
        maxX=Math.max(maxX,r.right-br.left); maxY=Math.max(maxY,r.bottom-br.top);
    });
    selectedStrokes.forEach(s => {
        const pad = (s.size||4)/2;
        s.points.forEach(p => {
            minX=Math.min(minX,p.x-pad); minY=Math.min(minY,p.y-pad);
            maxX=Math.max(maxX,p.x+pad); maxY=Math.max(maxY,p.y+pad);
        });
    });
    ctrl.style.display = 'block';
    ctrl.style.left   = minX + 'px'; ctrl.style.top    = minY + 'px';
    ctrl.style.width  = (maxX - minX) + 'px'; ctrl.style.height = (maxY - minY) + 'px';

    const resizeBtnO  = document.getElementById('sc-resize-btn');
    const scLockBtnO  = document.getElementById('sc-lock-btn');
    const scFlipHO    = document.getElementById('sc-flip-h-btn');
    const scFlipVO    = document.getElementById('sc-flip-v-btn');
    const mergeBtn    = document.getElementById('sc-merge-btn');
    const ungroupBtn  = document.getElementById('sc-ungroup-btn');
    if (resizeBtnO)  resizeBtnO.style.display  = '';
    if (scLockBtnO)  scLockBtnO.style.display  = 'flex';
    if (scFlipHO)    scFlipHO.style.display    = 'flex';
    if (scFlipVO)    scFlipVO.style.display    = 'flex';

    if (mergeBtn && ungroupBtn) {
        const totalSel  = selectedWidgets.length + selectedStrokes.length;
        const multi     = totalSel >= 2;
        const allGroupIds = [
            ...selectedWidgets.map(w => w.dataset.groupId),
            ...selectedStrokes.map(s => s.groupId)
        ].filter(Boolean);
        const groupIdSet   = new Set(allGroupIds);
        const allSameGroup = groupIdSet.size === 1 && allGroupIds.length === totalSel;

        if (allSameGroup) {
            mergeBtn.style.display   = 'none';
            ungroupBtn.style.display = 'flex';
        } else if (multi) {
            mergeBtn.style.display   = 'flex';
            ungroupBtn.style.display = 'none';
        } else {
            mergeBtn.style.display   = 'none';
            ungroupBtn.style.display = 'none';
        }
    }
}

function getBoardPos(e) {
    const r = board.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function findStrokeAt(x, y) {
    for (let i = strokes.length - 1; i >= 0; i--) {
        const s = strokes[i], tol = s.size / 2 + 5;
        for (let j = 1; j < s.points.length; j++) {
            if (distToSegment(x, y, s.points[j-1], s.points[j]) <= tol) return s;
        }
    }
    return null;
}

function distToSegment(px, py, a, b) {
    const dx = b.x-a.x, dy = b.y-a.y, lenSq = dx*dx + dy*dy;
    if (lenSq === 0) return Math.hypot(px-a.x, py-a.y);
    const t = Math.max(0, Math.min(1, ((px-a.x)*dx + (py-a.y)*dy) / lenSq));
    return Math.hypot(px - (a.x + t*dx), py - (a.y + t*dy));
}

// =========================================================================
// FORMATAGE TEXTE
// =========================================================================
function format(cmd, val=null) { document.execCommand(cmd, false, val); saveBoard(); }

function formatFontSize(size) {
    const sel = window.getSelection(); if (!sel || sel.rangeCount===0) return;
    document.execCommand("fontSize", false, "7");
    Array.from(document.getElementsByTagName("font")).forEach(f => {
        if (f.size === "7") { f.removeAttribute("size"); f.style.fontSize = size + "px"; }
    });
    saveBoard();
}

function formatFontFamily(font) {
    document.execCommand('fontName', false, font);
    const sel = window.getSelection();
    if (sel.anchorNode) sel.anchorNode.parentElement.style.fontFamily = font;
    saveBoard();
}

function changeWidgetBg(input, color) {
    const widget = input.closest('.widget');
    snapshotNow();
    applyTransparency(widget, false); widget.style.background = color; widget.dataset.bgColor = color; saveBoard();
}

function toggleTransparency(btn) {
    const widget = btn.closest('.widget');
    snapshotNow();
    applyTransparency(widget, widget.dataset.transparent !== "true"); saveBoard();
}

function applyTransparency(widget, isT) {
    const c = widget.querySelector('.editor-container');
    widget.dataset.transparent = isT;
    if (isT) {
        widget.style.background = 'transparent';
        widget.style.boxShadow  = 'none';
        widget.style.border     = 'none';
        if (c) c.style.background = 'transparent';
        widget.dataset.bgOpacity = 0;
        // Mettre le slider √† 0
        const slider = document.getElementById('widget-bg-opacity');
        const label  = document.getElementById('widget-bg-opacity-val');
        if (slider) slider.value = 0;
        if (label)  label.textContent = '0%';
    } else {
        const bg = widget.dataset.bgColor || '#ffffff';
        widget.style.background = '';
        widget.style.boxShadow  = '';
        widget.style.border     = '';
        if (c) c.style.background = bg;
        widget.dataset.bgOpacity = 1;
        const slider = document.getElementById('widget-bg-opacity');
        const label  = document.getElementById('widget-bg-opacity-val');
        if (slider) slider.value = 100;
        if (label)  label.textContent = '100%';
    }
}

// =========================================================================
// PLEIN √âCRAN, YOUTUBE, IFRAME
// =========================================================================
let _fsEl = null, _fsW = '', _fsH = '', _fsWidgetW = '', _fsWidgetH = '';
function toggleFullScreen(el) {
    if (!document.fullscreenElement) {
        _fsEl = el;
        _fsW  = el.style.width;
        _fsH  = el.style.height;
        const widget = el.closest('.widget');
        if (widget) { _fsWidgetW = widget.style.width; _fsWidgetH = widget.style.height; }
        el.requestFullscreen().catch(err => console.log(err));
    } else {
        document.exitFullscreen();
    }
}
function loadIframe(input) {
    const iframe = input.closest('.editor-container').querySelector('iframe');
    let url = input.value.trim();
    if (url && !url.startsWith('http')) url = 'https://' + url;
    iframe.src = url; saveBoard();
}
function loadYoutube(input) {
    const iframe = input.closest('.editor-container').querySelector('iframe');
    let url = input.value.trim();
    const match = url.match(/(?:v=|youtu\.be\/|shorts\/)([a-zA-Z0-9_-]{11})/);
    iframe.src = match ? `https://www.youtube.com/embed/${match[1]}?autoplay=1` : url;
    saveBoard();
}
function toggleYoutubeView(btn, display) {
    const c = btn.closest('.editor-container');
    c.querySelector('iframe').style.display = display;
    c.style.height = display === 'none' ? '50px' : '';
    saveBoard();
}

// =========================================================================
// AGENDA
// =========================================================================
let dragSrcRow = null;
function handleRowDragStart(e) { dragSrcRow = this; this.classList.add('dragging'); }
function handleRowDragOver(e) {
    e.preventDefault(); if (!dragSrcRow || dragSrcRow===this) return;
    const list = this.parentNode, items = [...list.querySelectorAll('.agenda-item')];
    list.insertBefore(dragSrcRow, items.indexOf(dragSrcRow) < items.indexOf(this) ? this.nextSibling : this);
}
function handleRowDragEnd() { this.classList.remove('dragging'); dragSrcRow=null; saveBoard(); }
function addAgendaLine(btn) {
    snapshotNow();
    const list = btn.closest('.agenda-container').querySelector('.agenda-list');
    const item = document.createElement('div');
    item.className = 'agenda-item'; item.draggable = true;
    item.innerHTML = `<span class="agenda-row-handle">‚ãÆ‚ãÆ</span><span class="agenda-time" contenteditable="true">--:--</span><div class="agenda-text" contenteditable="true">Nouvelle ligne</div><span class="agenda-delete-row" onclick="deleteAgendaLine(this)" title="Supprimer">√ó</span>`;
    list.appendChild(item); attachAgendaItemEvents(item); saveBoard();
}
function deleteAgendaLine(btn) { snapshotNow(); btn.closest('.agenda-item').remove(); saveBoard(); }

// =========================================================================
// FOND
// =========================================================================
function applyBackground(value) {
    if (!value || value==='none') { board.style.background=''; board.style.backgroundColor='#eef2f5'; }
    else if (value.startsWith('#') || value.startsWith('rgb')) { board.style.background=''; board.style.backgroundColor=value; }
    else board.style.background = value;
}
function saveBg(value) { snapshotNow(); localStorage.setItem('boardBackground', value); }
function handleBgUpload(input) {
    const file = input.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => { const v = `url(${e.target.result})`; applyBackground(v); saveBg(v); };
    reader.readAsDataURL(file);
}
function toggleSubMenu(event) { event.stopPropagation(); document.getElementById('bg-submenu').classList.toggle('active'); }

// =========================================================================
// MENU
// =========================================================================
function toggleMenu() {
    document.getElementById('tools-menu').classList.toggle('active');
    document.getElementById('bg-submenu').classList.remove('active');
    document.getElementById('shape-toolbar').classList.remove('active');
    document.getElementById('shape-btn').classList.remove('active-tool');
    // Fermer le panneau stickers si ouvert
    const sp = document.getElementById('sticker-panel');
    if (sp && sp.classList.contains('active')) {
        sp.classList.remove('active');
        const sb = document.getElementById('sticker-btn');
        if (sb) sb.classList.remove('active-tool');
    }
}
document.addEventListener('click', (e) => {
    const widget = e.target.closest('.widget');
    const isTextLike = widget && (widget.dataset.type === 'text' || widget.dataset.type === 'homework');
    if (isTextLike) {
        currentActiveWidget = widget;
        document.getElementById('global-toolbar').style.display = 'flex';
        syncFontSizeGlobal();
        // Synchroniser le slider d'opacit√©
        const opacity = parseFloat(widget.dataset.bgOpacity ?? 1);
        const slider = document.getElementById('widget-bg-opacity');
        const label  = document.getElementById('widget-bg-opacity-val');
        if (slider) { slider.value = Math.round(opacity * 100); }
        if (label)  { label.textContent = Math.round(opacity * 100) + '%'; }
        return;
    }
    if (!e.target.closest('#global-toolbar') && !e.target.closest('#toolbar-toggle-btn') && !isTextLike) {
        if (currentActiveWidget) {
            currentActiveWidget = null;
            document.getElementById('global-toolbar').style.display = 'none';
        }
    }
});

// =========================================================================
// BARRE TEXTE GLOBALE
// =========================================================================
let isTextPlacementMode = false;

function toggleGlobalToolbar() {
    const tb = document.getElementById('global-toolbar');
    const boardEl = document.getElementById('board');
    if (tb.style.display === 'none' || tb.style.display === '') {
        tb.style.display = 'block';
        isTextPlacementMode = true;
        boardEl.classList.add('cursor-pencil');
        if (typeof stopDrawing === "function") stopDrawing();
    } else {
        closeGlobalToolbar();
    }
}

function closeGlobalToolbar() {
    document.getElementById('global-toolbar').style.display = 'none';
    document.getElementById('board').classList.remove('cursor-pencil');
    isTextPlacementMode = false;
}

document.getElementById('board').addEventListener('click', function(e) {
    if (isTextPlacementMode && e.target.id === 'board') {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        const widget = createWidget('text');
        widget.style.left = x + 'px'; widget.style.top = y + 'px';
        const editableArea = widget.querySelector('.editor-content');
        if (editableArea) setTimeout(() => editableArea.focus(), 10);
        isTextPlacementMode = false;
        this.classList.remove('cursor-pencil');
        saveBoard();
    } else if (e.target.id === 'board') {
        const tb = document.getElementById('global-toolbar');
        if (tb.style.display === 'block') closeGlobalToolbar();
    }
});

function formatGlobal(cmd, val=null) {
    if (!currentActiveWidget) return;
    if (savedSelection) { const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(savedSelection); savedSelection=null; }
    document.execCommand(cmd, false, val); saveBoard();
}

function formatFontSizeGlobal(size) {
    if (!currentActiveWidget) return;
    const editor = currentActiveWidget.querySelector('.editor-content');
    if (!editor) return;

    if (savedSelection) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
    }

    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0 || sel.isCollapsed) return;

    // ‚îÄ‚îÄ Approche : appliquer fontSize sur TOUS les √©l√©ments de l'√©diteur
    // qui sont (au moins partiellement) dans la s√©lection
    const range = sel.getRangeAt(0);

    // Cas simple : toute la s√©lection est dans un seul n≈ìud texte
    // ‚Üí on le wrappe dans un span
    if (range.commonAncestorContainer.nodeType === 3) {
        const span = document.createElement('span');
        span.style.fontSize = size + 'px';
        range.surroundContents(span);
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.removeAllRanges();
        sel.addRange(newRange);
        savedSelection = newRange.cloneRange();
        saveBoard();
        return;
    }

    // Cas g√©n√©ral : s√©lection multi-√©l√©ments
    // On applique directement fontSize sur tous les descendants de l'anc√™tre commun
    // qui intersectent la s√©lection
    const ancestor = range.commonAncestorContainer;
    const allElements = ancestor.querySelectorAll ? 
        [...ancestor.querySelectorAll('*')] : [];
    
    // Aussi traiter l'anc√™tre lui-m√™me si c'est un √©l√©ment
    if (ancestor.nodeType === 1) allElements.unshift(ancestor);

    allElements.forEach(el => {
        if (range.intersectsNode(el)) {
            el.style.fontSize = size + 'px';
        }
    });

    // Traiter les n≈ìuds texte nus directement dans l'anc√™tre
    [...ancestor.childNodes].forEach(node => {
        if (node.nodeType === 3 && node.textContent.trim() && range.intersectsNode(node)) {
            const span = document.createElement('span');
            span.style.fontSize = size + 'px';
            node.parentNode.insertBefore(span, node);
            span.appendChild(node);
        }
    });

    // Maintenir la s√©lection
    try {
        const newRange = document.createRange();
        newRange.setStart(range.startContainer, range.startOffset);
        newRange.setEnd(range.endContainer, range.endOffset);
        sel.removeAllRanges();
        sel.addRange(newRange);
        savedSelection = newRange.cloneRange();
    } catch(e) {}

    saveBoard();
}

function adjustFontSize(delta) {
    if (!currentActiveWidget) return;
    const inp = document.getElementById('font-size-input');
    const currentSize = parseInt(inp.value) || 40;
    const newSize = Math.max(8, Math.min(100, currentSize + delta));
    inp.value = newSize;
    formatFontSizeGlobal(newSize);
}

function saveCurrentSelection() {
    const sel = window.getSelection();
    return (sel && sel.rangeCount>0) ? sel.getRangeAt(0).cloneRange() : null;
}

function formatFontFamilyGlobal(font) {
    if (!currentActiveWidget) return;
    document.execCommand('fontName', false, font);
    const sel = window.getSelection();
    if (sel.anchorNode) sel.anchorNode.parentElement.style.fontFamily = font;
    saveBoard();
}

function changeWidgetBgGlobal(input, color) {
    if (!currentActiveWidget) return;
    const c = currentActiveWidget.querySelector('.editor-container'); if (!c) return;
    snapshotNow();
    applyTransparency(currentActiveWidget, false); c.style.background=color; currentActiveWidget.dataset.bgColor=color; saveBoard();
}

function toggleTransparencyGlobal() {
    if (!currentActiveWidget) return;
    snapshotNow();
    applyTransparency(currentActiveWidget, currentActiveWidget.dataset.transparent!=="true"); saveBoard();
}

function applyTextColor(color) {
    if (!currentActiveWidget) return;
    if (savedSelection) { const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(savedSelection); savedSelection=null; }
    document.execCommand('foreColor', false, color); saveBoard();
}

function applyHighlightColor(color) {
    if (!currentActiveWidget) return;
    if (savedSelection) { const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(savedSelection); savedSelection=null; }
    document.execCommand('backColor', false, color); saveBoard();
}

function syncFontSizeGlobal() {
    const inp = document.getElementById('font-size-input');
    if (!inp) return;
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;
    const node = sel.anchorNode;
    if (!node) return;
    const el = node.nodeType === 3 ? node.parentElement : node;
    if (!el) return;
    const size = parseInt(window.getComputedStyle(el).fontSize);
    if (!isNaN(size)) inp.value = size;
}

function applyFontSizeOnBlur(input) {
    const size = parseInt(input.value);
    if (isNaN(size) || size < 8) { input.value = 8; return; }
    if (size > 100) { input.value = 100; return; }
    // savedSelection est d√©j√† restaur√© dans formatFontSizeGlobal
    formatFontSizeGlobal(size);
}

document.addEventListener('click', (e) => {
    const widget = e.target.closest('.widget');
    const isTextOrHomework = widget && (widget.dataset.type==='text' || widget.dataset.type==='homework');
    if (isTextOrHomework) { currentActiveWidget=widget; document.getElementById('global-toolbar').style.display='flex'; syncFontSizeGlobal(); return; }
    if (!e.target.closest('#global-toolbar') && !e.target.closest('#toolbar-toggle-btn') && !isTextOrHomework) {
        if (currentActiveWidget) { currentActiveWidget=null; document.getElementById('global-toolbar').style.display='none'; }
    }
});

	// =========================================================================
	// POINTEUR LASER
	// =========================================================================
	let isLaserMode = false;
	const laserDot = document.getElementById('laser-pointer') || (() => {
		const d = document.createElement('div');
		d.id = 'laser-pointer';
		document.body.appendChild(d);
		return d;
	})();

	function toggleLaser() {
		isLaserMode = !isLaserMode;
		const btn = document.getElementById('laser-btn');
		if (isLaserMode) {
			btn.classList.add('active-tool');
			document.body.style.cursor = 'none';
			laserDot.classList.add('active');
			// Couvrir les iframes avec un overlay pour que le laser reste visible dessus
			document.querySelectorAll('.widget iframe, .widget embed').forEach(el => {
				const overlay = document.createElement('div');
				overlay.className = 'laser-iframe-overlay';
				overlay.style.cssText = 'position:absolute;inset:0;z-index:9999;cursor:none;background:transparent;';
				// Double-clic sur l'overlay : d√©sactiver le laser et entrer dans le widget
				overlay.addEventListener('dblclick', (e) => {
					toggleLaser();
				});
				// Afficher une petite info-bulle au survol
				overlay.title = 'Double-clic pour entrer dans ce widget';
				el.parentElement.style.position = 'relative';
				el.parentElement.appendChild(overlay);
			});
		} else {
			btn.classList.remove('active-tool');
			document.body.style.cursor = '';
			laserDot.classList.remove('active');
			document.querySelectorAll('.laser-iframe-overlay').forEach(el => el.remove());
		}
	}

	document.addEventListener('mousemove', (e) => {
		if (!isLaserMode) return;
		laserDot.style.left = e.clientX + 'px';
		laserDot.style.top  = e.clientY + 'px';
	});

	// D√©sactiver avec √âchap
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && isLaserMode) toggleLaser();
	});

	// =========================================================================
	// SC√àNES
	// =========================================================================
	const MAX_SCENES = 10;
	let scenes        = [];   // [{ id, name, config, background }]
	let currentScene  = 0;    // index de la sc√®ne active

	function scenesInit() {
		const saved = localStorage.getItem('profScenes');
		if (saved) {
			try {
				const parsed = JSON.parse(saved);
				scenes       = parsed.scenes       || [];
				currentScene = parsed.currentScene || 0;
				if (currentScene >= scenes.length) currentScene = 0;
			} catch(e) { scenes = []; }
		}
		// Migration : si pas de sc√®nes mais un bureau existant ‚Üí sc√®ne 1 = bureau actuel
		if (scenes.length === 0) {
			const existing = localStorage.getItem('profBoardConfig');
			const bg       = localStorage.getItem('boardBackground') || 'none';
			scenes.push({ id: Date.now(), name: 'Sc√®ne 1', config: existing || null, background: bg });
			currentScene = 0;
			saveScenesMeta();
		}
		renderScenesBar();
	}

	function saveScenesMeta() {
		localStorage.setItem('profScenes', JSON.stringify({ scenes, currentScene }));
	}

	function saveCurrentSceneData() {
		if (scenes.length === 0) return;
		scenes[currentScene].config     = buildBoardJSON();
		scenes[currentScene].background = localStorage.getItem('boardBackground') || 'none';
		saveScenesMeta();
	}

	function switchScene(index) {
		if (index === currentScene) return;
		saveCurrentSceneData();
		currentScene = index;
		loadScene(index);
		renderScenesBar();
		saveScenesMeta();
	}

	function loadScene(index) {
		const scene = scenes[index];
		// Vider le bureau
		document.querySelectorAll('.widget').forEach(w => w.remove());
		document.querySelectorAll('.shape-widget').forEach(w => w.remove());
		strokes = []; if (drawCtx) redrawStrokes();
		clearSelection();
		undoStack = []; redoStack = []; updateUndoRedoBtns();
		// Appliquer le fond
		const bg = scene.background || 'none';
		applyBackground(bg);
		localStorage.setItem('boardBackground', bg);
		// Charger le contenu
		if (scene.config) {
			localStorage.setItem('profBoardConfig', scene.config);
			_lastW = window.innerWidth;
			restoreBoardFromJSON(scene.config);
			// R√©initialiser l'historique avec cet √©tat
			setTimeout(() => {
				const cur = buildBoardJSON();
				if (cur) { undoStack = [cur]; updateUndoRedoBtns(); }
			}, 600);
		} else {
			localStorage.removeItem('profBoardConfig');
		}
	}

	function addScene() {
		if (scenes.length >= MAX_SCENES) return;
		saveCurrentSceneData();
		const newName   = 'Sc√®ne ' + (scenes.length + 1);
		// Copie de la sc√®ne actuelle
		const newConfig = scenes[currentScene]?.config || null;
		const newBg     = scenes[currentScene]?.background || 'none';
		scenes.push({ id: Date.now(), name: newName, config: newConfig, background: newBg });
		currentScene = scenes.length - 1;
		loadScene(currentScene);
		renderScenesBar();
		saveScenesMeta();
		// Focus sur le nom pour le renommer tout de suite
		setTimeout(() => {
			const tabs = document.querySelectorAll('.scene-tab');
			const lastTab = tabs[tabs.length - 1];
			if (lastTab) {
				const nameEl = lastTab.querySelector('.scene-tab-name');
				if (nameEl) { nameEl.focus(); selectAllText(nameEl); }
			}
		}, 100);
	}

	async function deleteScene(index, e) {
		e.stopPropagation();
		if (scenes.length <= 1) return;
		const ok = await showConfirm('üóÇÔ∏è', 'Supprimer la sc√®ne', `Voulez-vous vraiment supprimer "${scenes[index].name}" ?`, 'Supprimer', true);
		if (!ok) return;
		scenes.splice(index, 1);
		if (currentScene >= scenes.length) currentScene = scenes.length - 1;
		else if (currentScene > index) currentScene--;
		loadScene(currentScene);
		renderScenesBar();
		saveScenesMeta();
	}

	function renameScene(index, newName) {
		const name = newName.trim() || ('Sc√®ne ' + (index + 1));
		scenes[index].name = name;
		saveScenesMeta();
	}

	function renderScenesBar() {
		const list   = document.getElementById('scenes-menu-list');
		const addBtn = document.getElementById('scene-add-btn');
		if (!list) return;
		list.innerHTML = '';

		scenes.forEach((scene, i) => {
			const row = document.createElement('div');
			row.style.cssText = 'display:flex;align-items:center;gap:5px;';

			// Bouton principal
			const btn = document.createElement('button');
			const isActive = i === currentScene;
			btn.style.cssText = `
				flex:1;text-align:left;padding:8px 12px;border-radius:10px;
				border:1px solid ${isActive ? '#4a90e2' : '#2e2e38'};
				cursor:pointer;font-size:12px;font-weight:700;transition:background 0.15s;
				background:${isActive ? '#1a3550' : '#28282f'};
				color:${isActive ? '#7ab8f5' : '#aaa'};
				overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
			`;
			btn.textContent = (isActive ? '‚ñ∂ ' : '') + scene.name;
			btn.title = scene.name;
			btn.addEventListener('click', () => { switchScene(i); toggleScenesMenu(); });
			row.appendChild(btn);

			// Bouton renommer ‚úèÔ∏è
			const editBtn = document.createElement('button');
			editBtn.textContent = '‚úèÔ∏è';
			editBtn.title = 'Renommer';
			editBtn.style.cssText = 'background:#28282f;color:#aaa;border:1px solid #2e2e38;border-radius:8px;width:28px;height:28px;cursor:pointer;font-size:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s;';
			editBtn.onmouseover = () => editBtn.style.background = '#35353f';
			editBtn.onmouseout  = () => editBtn.style.background = '#28282f';
			editBtn.addEventListener('click', async (e) => {
				e.stopPropagation();
				const newName = await showPromptModal('‚úèÔ∏è', 'Renommer la sc√®ne', null, scene.name, 'Nom de la sc√®ne...');
				if (newName !== null) { renameScene(i, newName); renderScenesBar(); }
			});
			row.appendChild(editBtn);

			// Bouton supprimer √ó
			if (scenes.length > 1) {
				const del = document.createElement('button');
				del.textContent = '√ó';
				del.title = 'Supprimer';
				del.style.cssText = 'background:#2a1a1a;color:#ff6b6b;border:1px solid #3d2020;border-radius:8px;width:28px;height:28px;cursor:pointer;font-size:15px;font-weight:700;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s;';
				del.onmouseover = () => del.style.background = '#3d1a1a';
				del.onmouseout  = () => del.style.background = '#2a1a1a';
				del.addEventListener('click', (e) => deleteScene(i, e));
				row.appendChild(del);
			}

			list.appendChild(row);
		});

		if (addBtn) {
			addBtn.disabled = scenes.length >= MAX_SCENES;
			addBtn.style.opacity = scenes.length >= MAX_SCENES ? '0.4' : '1';
			addBtn.style.cursor  = scenes.length >= MAX_SCENES ? 'not-allowed' : 'pointer';
		}

		const scenesBtn = document.getElementById('scenes-btn');
		if (scenesBtn) {
			scenesBtn.textContent = `üóÇÔ∏è ${scenes[currentScene]?.name || 'Sc√®nes'}`;
		}
	}
	
	function toggleScenesMenu() {
		const menu = document.getElementById('scenes-menu');
		const isOpen = menu.style.display === 'block';
		// Fermer les autres menus ouverts
		document.getElementById('tools-menu').classList.remove('active');
		document.getElementById('bg-submenu').classList.remove('active');
		document.getElementById('shape-toolbar').classList.remove('active');
		menu.style.display = isOpen ? 'none' : 'block';
	}

	// Fermer le menu sc√®nes au clic ext√©rieur
	document.addEventListener('click', (e) => {
		if (!e.target.closest('#scenes-menu') && !e.target.closest('#scenes-btn')) {
			const menu = document.getElementById('scenes-menu');
			if (menu) menu.style.display = 'none';
		}
	});

	function selectAllText(el) {
		const range = document.createRange();
		range.selectNodeContents(el);
		const sel = window.getSelection();
		sel.removeAllRanges(); sel.addRange(range);
	}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PANNEAU STICKERS ANIM√âS ‚Äî Google Noto Emoji Animation
//  Source : https://googlefonts.github.io/noto-emoji-animation/
//  CDN    : https://fonts.gstatic.com/s/e/notoemoji/latest/{codepoint}/512.webp
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âMOJIS CLASSIQUES ‚Äî int√©gr√©s en dur, fonctionne hors-ligne
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLASSIC_DATA = {
  "üòä Visages": ["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","ü§£","üòÇ","üôÇ","üôÉ","ü´†","üòâ","üòä","üòá","ü•∞","üòç","ü§©","üòò","üòó","üòö","üòô","ü•≤","üòã","üòõ","üòú","ü§™","üòù","ü§ë","ü§ó","ü§≠","ü´¢","ü´£","ü§´","ü§î","ü´°","ü§ê","ü§®","üòê","üòë","üò∂","ü´•","üòè","üòí","üôÑ","üò¨","ü§•","ü´®","üòå","üòî","üò™","ü§§","üò¥","üò∑","ü§í","ü§ï","ü§¢","ü§Æ","ü§ß","ü•µ","ü•∂","ü•¥","üòµ","ü§Ø","ü§†","ü•≥","ü•∏","üòé","ü§ì","üßê","üòï","ü´§","üòü","üôÅ","‚òπÔ∏è","üòÆ","üòØ","üò≤","üò≥","ü•∫","ü•π","üò¶","üòß","üò®","üò∞","üò•","üò¢","üò≠","üò±","üòñ","üò£","üòû","üòì","üò©","üò´","ü•±","üò§","üò°","ü§¨","üòà","üëø","üíÄ","‚ò†Ô∏è","üí©","ü§°","üëπ","üë∫","üëª","üëΩ","üëæ","ü§ñ","üò∫","üò∏","üòπ","üòª","üòº","üòΩ","üôÄ","üòø","üòæ","üôà","üôâ","üôä"],
  "üêæ Animaux": ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","üêî","üêß","üê¶","üê§","ü¶Ü","ü¶Ö","ü¶â","ü¶á","üê∫","üê¥","ü¶Ñ","üêù","ü¶ã","üêå","üêû","üêú","üê¢","üêç","ü¶é","ü¶ï","ü¶ñ","üêô","ü¶ë","ü¶û","ü¶Ä","üê°","üê†","üêü","üê¨","üê≥","üêã","ü¶à","ü¶≠","üêä","üêÖ","üêÜ","ü¶ì","ü¶ç","üêò","ü¶õ","ü¶è","üê™","üê´","ü¶í","ü¶ò","üêÉ","üêÑ","üêé","üêñ","üêë","ü¶ô","üêê","ü¶å","üêï","üê©","üêà","ü™∂","üêì","ü¶É","ü¶ö","ü¶ú","ü¶¢","üïäÔ∏è","üêá","ü¶î","üåµ","üå≤","üå≥","üå¥","üå±","üåø","‚òòÔ∏è","üçÄ","üçÑ","üåæ","üíê","üå∑","üåπ","üå∫","üå∏","üåº","üåª","üåû","üåù","üåô","‚≠ê","‚ú®","‚ö°","üåà","‚ùÑÔ∏è","üî•","üíß","üåä","üå™Ô∏è","ü™ê"],
  "üçï Nourriture": ["üçè","üçé","üçê","üçä","üçã","üçå","üçâ","üçá","üçì","ü´ê","üçí","üçë","ü•≠","üçç","ü••","ü•ù","üçÖ","üçÜ","ü•ë","ü•¶","ü•í","üå∂Ô∏è","üåΩ","ü•ï","ü•î","üç†","ü•ê","üçû","ü•ñ","üßÄ","ü•ö","üç≥","ü•û","üßá","ü•ì","üçó","üçñ","üå≠","üçî","üçü","üçï","üåÆ","üåØ","ü•ó","üç≤","üçõ","üç£","üç±","ü•ü","üçô","üçö","üçò","üç•","üéÇ","üç∞","üßÅ","üç≠","üç¨","üç´","üçø","üç©","üç™","üå∞","ü•ú","üçØ","üßÉ","ü•§","üßã","‚òï","üçµ","üç∫","üçª","ü•Ç","üç∑","üç∏","üçπ","üßä"],
  "üéâ F√™tes": ["üéâ","üéä","üéà","üéÅ","üéÄ","üéóÔ∏è","üéñÔ∏è","üèÜ","ü•á","ü•à","ü•â","üèÖ","üé†","üé°","üé¢","üé™","ü§π","üé≠","üé®","üé¨","üé§","üéß","üéº","üéπ","ü•Å","üé∑","üé∫","üé∏","üéª","üé≤","üéØ","üé±","üé≥","‚õ≥","üé£","ü§ø","üéΩ","üéø","üõ∑","ü•å","ü™É","üèπ","üéÆ","üïπÔ∏è","üé∞","üß©","‚ôüÔ∏è","ü™Ñ","üé©","ü™Ö","ü™©","ü™Ü","üéë","üéê","üéè","üßß","üéé","üéã","üéÜ","üéá","üß®"],
  "üè´ √âcole": ["üìö","üìñ","üìù","‚úèÔ∏è","üñäÔ∏è","üñãÔ∏è","üñåÔ∏è","üìê","üìè","üóÇÔ∏è","üìÅ","üìÇ","üìä","üìà","üìâ","üóíÔ∏è","üìã","üìå","üìç","üìé","üñáÔ∏è","‚úÇÔ∏è","üîí","üîì","üîë","üóùÔ∏è","üîß","ü™õ","üî©","‚öôÔ∏è","üßÆ","üí°","üî¶","üî¨","üî≠","üì°","üß™","üß´","üß¨","üíâ","üíä","ü©π","ü©∫","‚è∞","‚è±Ô∏è","‚è≤Ô∏è","‚åõ","‚è≥","üìÖ","üìÜ","üóìÔ∏è","üåê","üó∫Ô∏è","üß≠","üíª","üñ•Ô∏è","‚å®Ô∏è","üñ±Ô∏è","üì±","üì∑","üìπ","üé•","üíæ","üìÄ","üîã","üîä","üì¢","üì£","üîî","üè´","üöó","üöå","‚úàÔ∏è","üöÄ","üéí","üëì","üï∂Ô∏è","ü•Ω","üíº","üëú","üëù","üéì","üì°"],
  "üí° Objets": ["üíª","üñ•Ô∏è","üñ®Ô∏è","‚å®Ô∏è","üñ±Ô∏è","üíæ","üíø","üìÄ","üì±","‚òéÔ∏è","üìû","üì∫","üì∑","üì∏","üìπ","üé•","üìΩÔ∏è","üîã","üí°","üî¶","üïØÔ∏è","üíµ","üí¥","üí∂","üí∑","üí∏","üí≥","ü™ô","üíé","‚öñÔ∏è","üß≤","ü™Ñ","üé©","üß¢","üëë","üíç","üíÑ","üëì","üï∂Ô∏è","ü•Ω","üåÇ","‚òÇÔ∏è","üßµ","üß∂","ü™¢","üß∏","ü™Ü","üéÄ","üéÅ","üîë","üóùÔ∏è","üîß","ü™õ","üî©","‚öôÔ∏è","ü™ú","üß∞","üî¨","üî≠","üì°","üß™","üíä","ü©π","ü©∫","‚è∞","üó∫Ô∏è","üß≠","üéí","üëú","üíº","üìö","üìñ","üìù","‚úèÔ∏è","üñäÔ∏è","üìê","üìè","ü™§","üß≤","‚öóÔ∏è","üßØ"],
  "üî£ Symboles": ["‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","ü©∑","ü©µ","ü©∂","‚ù§Ô∏è‚Äçüî•","‚ù§Ô∏è‚Äçü©π","üíî","üíï","üíû","üíì","üíó","üíñ","üíò","üíù","‚úÖ","‚òëÔ∏è","‚ùé","‚ùå","‚≠ï","üõë","‚õî","üìõ","üö´","üíØ","‚ö†Ô∏è","‚ò¢Ô∏è","‚ò£Ô∏è","üîû","üìµ","üîï","üîá","üîä","üì¢","üì£","üîî","‚ñ∂Ô∏è","‚è©","‚è≠Ô∏è","‚óÄÔ∏è","‚è™","‚èÆÔ∏è","üîº","üîΩ","‚è∏Ô∏è","‚èπÔ∏è","‚è∫Ô∏è","üé¶","üì∂","üîÖ","üîÜ","‚ûï","‚ûñ","‚úñÔ∏è","‚ûó","‚ôæÔ∏è","‚ôªÔ∏è","üî¥","üü†","üü°","üü¢","üîµ","üü£","üü§","‚ö´","‚ö™","üü•","üüß","üü®","üü©","üü¶","üü™","üü´","‚¨õ","‚¨ú","üî∂","üî∑","üî∏","üîπ","üî∫","üîª","üí†","üîò","‚¨ÜÔ∏è","‚ÜóÔ∏è","‚û°Ô∏è","‚ÜòÔ∏è","‚¨áÔ∏è","‚ÜôÔ∏è","‚¨ÖÔ∏è","‚ÜñÔ∏è","‚ÜïÔ∏è","‚ÜîÔ∏è","‚Ü©Ô∏è","‚Ü™Ô∏è","‚§¥Ô∏è","‚§µÔ∏è","üîÉ","üîÑ","üîô","üîö","üîõ","üîú","üîù","‚ú®","üí´","‚ö°","üí•","üî•","üåü"],
  "üåç Nature": ["üåç","üåé","üåè","üåê","üó∫Ô∏è","üß≠","üåã","üóª","üèîÔ∏è","‚õ∞Ô∏è","üèïÔ∏è","üèñÔ∏è","üèúÔ∏è","üèùÔ∏è","üèûÔ∏è","üåÉ","üèôÔ∏è","üåÑ","üåÖ","üåÜ","üåá","üåâ","üåå","üéá","üéÜ","üå†","üåä","üå¨Ô∏è","üåÄ","üåà","üåÇ","‚òÇÔ∏è","‚òî","‚õ±Ô∏è","‚ö°","‚ùÑÔ∏è","üå®Ô∏è","‚òÉÔ∏è","‚õÑ","üî•","üíß","üåµ","üå¥","üå≤","üå≥","üå±","üåø","‚òòÔ∏è","üåæ","üçÇ","üçÅ","üå∫","üå∏","üåº","üåª","üåπ","üå∑","ü™∑","üíê","üçÑ","üåû","üåù","üåõ","üåú","üåö","üåï","üåî","üåì","üåí","üåë","üåô","üåü","‚≠ê","üí´","‚ú®","ü™ê","‚òÑÔ∏è","üå§Ô∏è","‚õÖ","üå•Ô∏è","üå¶Ô∏è","üåßÔ∏è","üå©Ô∏è","üå™Ô∏è","üå´Ô∏è","ü™∏","ü™®","ü™µ"],
  "üë§ Personnes": ["üë∂","üßí","üë¶","üëß","üßë","üë±","üë®","üßî","üë©","üßì","üë¥","üëµ","üôç","üôé","üôÖ","üôÜ","üíÅ","üôã","üßè","üôá","ü§¶","ü§∑","üíÜ","üíá","üö∂","üßç","üßé","üèÉ","üíÉ","üï∫","üëØ","üõÄ","üßñ","üõå","üë´","üë¨","üë≠","üíë","üíè","üë™","üëÆ","üïµÔ∏è","üíÇ","ü•∑","üë∑","ü§¥","üë∏","üë≥","üë≤","üßï","ü§µ","üë∞","ü§∞","ü§±","üéÖ","ü§∂","üßô","üßù","üßõ","üßü","üßû","üßú","üßö","üßå","üëº","üëç","üëé","üëã","ü§ö","üñêÔ∏è","‚úã","üññ","ü§ô","üëà","üëâ","üëÜ","üëá","‚òùÔ∏è","‚úä","üëä","ü§õ","ü§ú","üëè","üôå","ü§≤","ü´∂","ü§ù","üôè","‚úçÔ∏è","üíÖ","üí™","ü´µ","ü´∞","ü´±","ü´≤"]
};

let spCurrentClassicTab = Object.keys(CLASSIC_DATA)[0];
let spMode = 'animated'; // 'animated' | 'classic'

function checkStickerConnectivity() {
  var probe = new Image();
  probe.onload = function() {
    var b = document.getElementById('sp-offline-badge');
    if (b) b.style.display = 'none';
  };
  probe.onerror = function() {
    var b = document.getElementById('sp-offline-badge');
    if (b) b.style.display = 'inline-block';
    if (spMode === 'animated') setStickerMode('classic', true);
  };
  probe.src = NOTO_CDN + '/1f600/512.webp?_t=' + Date.now();
}

function setStickerMode(mode, auto) {
  auto = auto || false;
  spMode = mode;
  var animSection  = document.getElementById('sp-animated-section');
  var classSection = document.getElementById('sp-classic-section');
  var btnAnim  = document.getElementById('sp-mode-animated');
  var btnClass = document.getElementById('sp-mode-classic');
  var search   = document.getElementById('sp-search');
  if (mode === 'animated') {
    if (animSection)  animSection.style.display  = '';
    if (classSection) classSection.style.display = 'none';
    if (btnAnim)  btnAnim.classList.add('active');
    if (btnClass) btnClass.classList.remove('active');
    if (search) search.placeholder = 'üîç Rechercher dans les √©mojis anim√©s‚Ä¶';
  } else {
    if (animSection)  animSection.style.display  = 'none';
    if (classSection) classSection.style.display = '';
    if (btnAnim)  btnAnim.classList.remove('active');
    if (btnClass) btnClass.classList.add('active');
    if (search) search.placeholder = 'üîç Rechercher dans les √©mojis classiques‚Ä¶';
    if (!auto) {
      spCurrentClassicTab = Object.keys(CLASSIC_DATA)[0];
      document.querySelectorAll('#sp-classic-tabs .sp-tab')
        .forEach(function(b, i) { b.classList.toggle('active', i === 0); });
    }
  }
  if (search) search.value = '';
  renderStickerPanel();
}

document.addEventListener('DOMContentLoaded', function() {
  var ctabs = document.getElementById('sp-classic-tabs');
  if (!ctabs) return;
  ctabs.addEventListener('click', function(e) {
    var btn = e.target.closest('[data-ctab]');
    if (!btn) return;
    document.querySelectorAll('#sp-classic-tabs .sp-tab')
      .forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    spCurrentClassicTab = btn.dataset.ctab;
    var s = document.getElementById('sp-search');
    if (s) s.value = '';
    renderStickerPanel();
  });
});

const NOTO_CDN = 'https://fonts.gstatic.com/s/e/notoemoji/latest';

const NOTO_DATA = {
  "\ud83d\ude0a Visages & \u00e9motions": [{"c": "1f600", "n": "smile"}, {"c": "1f603", "n": "smile with big eyes"}, {"c": "1f604", "n": "grin"}, {"c": "1f601", "n": "grinning"}, {"c": "1f606", "n": "laughing"}, {"c": "1f605", "n": "grin sweat"}, {"c": "1f602", "n": "joy"}, {"c": "1f923", "n": "rofl"}, {"c": "1f62d", "n": "loudly crying"}, {"c": "1f609", "n": "wink"}, {"c": "1f617", "n": "kissing"}, {"c": "1f619", "n": "kissing smiling eyes"}, {"c": "1f61a", "n": "kissing closed eyes"}, {"c": "1f618", "n": "kissing heart"}, {"c": "1f970", "n": "heart face"}, {"c": "1f60d", "n": "heart eyes"}, {"c": "1f929", "n": "star struck"}, {"c": "1f973", "n": "partying face"}, {"c": "1fae0", "n": "melting"}, {"c": "1f643", "n": "upside down face"}, {"c": "1f642", "n": "slightly happy"}, {"c": "1f972", "n": "happy cry"}, {"c": "1f979", "n": "holding back tears"}, {"c": "1f60a", "n": "blush"}, {"c": "263a_fe0f", "n": "warm smile"}, {"c": "1f60c", "n": "relieved"}, {"c": "1f642_200d_2195_fe0f", "n": "head nod"}, {"c": "1f642_200d_2194_fe0f", "n": "head shake"}, {"c": "1f60f", "n": "smirk"}, {"c": "1f924", "n": "drool"}, {"c": "1f60b", "n": "yum"}, {"c": "1f61b", "n": "stuck out tongue"}, {"c": "1f61d", "n": "squinting tongue"}, {"c": "1f61c", "n": "winky tongue"}, {"c": "1f92a", "n": "zany face"}, {"c": "1f974", "n": "woozy"}, {"c": "1f614", "n": "pensive"}, {"c": "1f97a", "n": "pleading"}, {"c": "1f62c", "n": "grimacing"}, {"c": "1f611", "n": "expressionless"}, {"c": "1f610", "n": "neutral face"}, {"c": "1f636", "n": "mouth none"}, {"c": "1f636_200d_1f32b_fe0f", "n": "face in clouds"}, {"c": "1fae5", "n": "dotted line face"}, {"c": "1f910", "n": "zipper face"}, {"c": "1fae1", "n": "salute"}, {"c": "1f914", "n": "thinking face"}, {"c": "1f92b", "n": "shushing face"}, {"c": "1fae2", "n": "hand over mouth"}, {"c": "1f92d", "n": "chuckling"}, {"c": "1f971", "n": "yawn"}, {"c": "1f917", "n": "hug face"}, {"c": "1fae3", "n": "peeking"}, {"c": "1f631", "n": "screaming"}, {"c": "1f928", "n": "raised eyebrow"}, {"c": "1f9d0", "n": "monocle"}, {"c": "1f612", "n": "unamused"}, {"c": "1f644", "n": "rolling eyes"}, {"c": "1f62e_200d_1f4a8", "n": "exhale"}, {"c": "1f624", "n": "triumph"}, {"c": "1f620", "n": "angry"}, {"c": "1f621", "n": "rage"}, {"c": "1f92c", "n": "cursing"}, {"c": "1f61e", "n": "sad"}, {"c": "1f613", "n": "sweat"}, {"c": "1f61f", "n": "worried"}, {"c": "1f625", "n": "concerned"}, {"c": "1f622", "n": "cry"}, {"c": "2639_fe0f", "n": "big frown"}, {"c": "1f641", "n": "frown"}, {"c": "1fae4", "n": "diagonal mouth"}, {"c": "1f615", "n": "slightly frowning"}, {"c": "1f630", "n": "anxious with sweat"}, {"c": "1f628", "n": "scared"}, {"c": "1f627", "n": "anguished"}, {"c": "1f626", "n": "gasp"}, {"c": "1f62e", "n": "mouth open"}, {"c": "1f62f", "n": "surprised"}, {"c": "1f632", "n": "astonished"}, {"c": "1f633", "n": "flushed"}, {"c": "1f92f", "n": "exploding head"}, {"c": "1f616", "n": "confounded"}, {"c": "1f623", "n": "persevering"}, {"c": "1f629", "n": "weary"}, {"c": "1f62b", "n": "distraught"}, {"c": "1f635", "n": "x eyes"}, {"c": "1f635_200d_1f4ab", "n": "dizzy face"}, {"c": "1fae8", "n": "shaking face"}, {"c": "1f976", "n": "cold face"}, {"c": "1f975", "n": "hot face"}, {"c": "1f922", "n": "nauseated"}, {"c": "1f92e", "n": "vomit"}, {"c": "1fae9", "n": "tired"}, {"c": "1f634", "n": "sleep"}, {"c": "1f62a", "n": "sleepy"}, {"c": "1f927", "n": "sneeze"}, {"c": "1f912", "n": "thermometer face"}, {"c": "1f915", "n": "bandage face"}, {"c": "1f637", "n": "mask"}, {"c": "1f925", "n": "liar"}, {"c": "1f607", "n": "halo"}, {"c": "1f920", "n": "cowboy"}, {"c": "1f911", "n": "money face"}, {"c": "1f913", "n": "nerd face"}, {"c": "1f60e", "n": "sunglasses face"}, {"c": "1f978", "n": "disguise"}, {"c": "1f921", "n": "clown"}, {"c": "1f4a9", "n": "poop"}, {"c": "1f608", "n": "imp smile"}, {"c": "1f47f", "n": "imp frown"}, {"c": "1f47b", "n": "ghost"}, {"c": "1f480", "n": "skull"}, {"c": "2603_fe0f", "n": "snowman with snow"}, {"c": "26c4", "n": "snowman"}, {"c": "1f383", "n": "jack o lantern"}, {"c": "1f916", "n": "robot"}, {"c": "1f47d", "n": "alien"}, {"c": "1f47e", "n": "alien monster"}, {"c": "1f31e", "n": "sun with face"}, {"c": "1f31b", "n": "moon face"}, {"c": "1f31c", "n": "moon face last"}, {"c": "1f63a", "n": "smiley cat"}, {"c": "1f638", "n": "smile cat"}, {"c": "1f639", "n": "joy cat"}, {"c": "1f63b", "n": "heart eyes cat"}, {"c": "1f63c", "n": "smirk cat"}, {"c": "1f63d", "n": "kissing cat"}, {"c": "1f640", "n": "scream cat"}, {"c": "1f63f", "n": "crying cat"}, {"c": "1f63e", "n": "pouting cat"}, {"c": "1f648", "n": "see no evil"}, {"c": "1f649", "n": "hear no evil"}, {"c": "1f64a", "n": "speak no evil"}, {"c": "1f31f", "n": "glowing star"}, {"c": "2728", "n": "sparkles"}, {"c": "26a1", "n": "lightning"}, {"c": "1f4a5", "n": "collision"}, {"c": "1f525", "n": "fire"}, {"c": "1f4af", "n": "100"}, {"c": "1f389", "n": "party popper"}, {"c": "1f38a", "n": "confetti ball"}, {"c": "2764_fe0f", "n": "red heart"}, {"c": "1f9e1", "n": "orange heart"}, {"c": "1f49b", "n": "yellow heart"}, {"c": "1f49a", "n": "green heart"}, {"c": "1fa75", "n": "light blue heart"}, {"c": "1f499", "n": "blue heart"}, {"c": "1f49c", "n": "purple heart"}, {"c": "1f90e", "n": "brown heart"}, {"c": "1f5a4", "n": "black heart"}, {"c": "1fa76", "n": "grey heart"}, {"c": "1f90d", "n": "white heart"}, {"c": "1fa77", "n": "pink heart"}, {"c": "1f498", "n": "cupid"}, {"c": "1f49d", "n": "gift heart"}, {"c": "1f496", "n": "sparkling heart"}, {"c": "1f497", "n": "heart grow"}, {"c": "1f493", "n": "beating heart"}, {"c": "1f49e", "n": "revolving hearts"}, {"c": "1f495", "n": "two hearts"}, {"c": "1f48c", "n": "love letter"}, {"c": "1f49f", "n": "heart box"}, {"c": "2763_fe0f", "n": "heart exclamation"}, {"c": "2764_fe0f_200d_1fa79", "n": "bandaged heart"}, {"c": "1f494", "n": "broken heart"}, {"c": "2764_fe0f_200d_1f525", "n": "fire heart"}, {"c": "1f48b", "n": "kiss"}, {"c": "1f463", "n": "footprints"}, {"c": "1fac6", "n": "fingerprint"}, {"c": "1fac0", "n": "anatomical heart"}, {"c": "1fa78", "n": "blood"}, {"c": "1f9a0", "n": "microbe"}, {"c": "1f440", "n": "eyes"}, {"c": "1f441_fe0f", "n": "eye"}, {"c": "1fae6", "n": "biting lip"}, {"c": "1f443", "n": "nose"}, {"c": "1f4aa", "n": "muscle"}, {"c": "1f44f", "n": "clap"}, {"c": "1f44d", "n": "thumbs up"}, {"c": "1f44e", "n": "thumbs down"}, {"c": "1faf6", "n": "heart hands"}, {"c": "1f64c", "n": "raising hands"}, {"c": "1f450", "n": "open hands"}, {"c": "1f932", "n": "palms up"}, {"c": "1f91c", "n": "fist right"}, {"c": "1f91b", "n": "fist left"}, {"c": "270a", "n": "raised fist"}, {"c": "1f44a", "n": "fist"}, {"c": "1faf3", "n": "palm down"}, {"c": "1faf4", "n": "palm up"}, {"c": "1faf1", "n": "hand right"}, {"c": "1faf2", "n": "hand left"}, {"c": "1faf8", "n": "push right"}, {"c": "1faf7", "n": "push left"}, {"c": "1f44b", "n": "wave"}, {"c": "1f91a", "n": "back hand"}, {"c": "1f590_fe0f", "n": "palm"}, {"c": "270b", "n": "raised hand"}, {"c": "1f596", "n": "vulcan"}, {"c": "1f91f", "n": "love you"}, {"c": "1f918", "n": "metal"}, {"c": "270c_fe0f", "n": "victory"}, {"c": "1f91e", "n": "crossed fingers"}, {"c": "1faf0", "n": "finger heart"}, {"c": "1f919", "n": "call me"}, {"c": "1f90c", "n": "pinched fingers"}, {"c": "1f90f", "n": "pinch"}, {"c": "1f44c", "n": "ok"}, {"c": "1faf5", "n": "pointing"}, {"c": "1f449", "n": "point right"}, {"c": "1f448", "n": "point left"}, {"c": "261d_fe0f", "n": "index finger"}, {"c": "1f446", "n": "point up"}, {"c": "1f447", "n": "point down"}, {"c": "1f595", "n": "middle finger"}, {"c": "270d_fe0f", "n": "writing hand"}, {"c": "1f933", "n": "selfie"}, {"c": "1f64f", "n": "pray"}, {"c": "1f485", "n": "nail care"}, {"c": "1f91d", "n": "handshake"}],
  "\ud83d\udc65 Personnes": [{"c": "1f483", "n": "dancer"}],
  "\ud83d\udc3e Animaux & nature": [{"c": "1f490", "n": "bouquet"}, {"c": "1f339", "n": "rose"}, {"c": "1f940", "n": "wilted flower"}, {"c": "1f342", "n": "fallen leaf"}, {"c": "1f331", "n": "plant"}, {"c": "1f343", "n": "leaves"}, {"c": "1f340", "n": "four leaf clover"}, {"c": "1fabe", "n": "leafless tree"}, {"c": "2744_fe0f", "n": "snowflake"}, {"c": "1f30b", "n": "volcano"}, {"c": "1f305", "n": "sunrise"}, {"c": "1f304", "n": "sunrise mountains"}, {"c": "1f308", "n": "rainbow"}, {"c": "1fae7", "n": "bubbles"}, {"c": "1f30a", "n": "ocean"}, {"c": "1f32c_fe0f", "n": "wind"}, {"c": "1f32a_fe0f", "n": "tornado"}, {"c": "1f4a7", "n": "droplet"}, {"c": "1f327_fe0f", "n": "rain"}, {"c": "1f329_fe0f", "n": "lightning cloud"}, {"c": "1f30d", "n": "globe europe"}, {"c": "1f30e", "n": "globe americas"}, {"c": "1f30f", "n": "globe asia"}, {"c": "2604_fe0f", "n": "comet"}, {"c": "1f42e", "n": "cow"}, {"c": "1f984", "n": "unicorn"}, {"c": "1f98e", "n": "lizard"}, {"c": "1f409", "n": "dragon"}, {"c": "1f996", "n": "t rex"}, {"c": "1f995", "n": "dinosaur"}, {"c": "1f422", "n": "turtle"}, {"c": "1f40a", "n": "crocodile"}, {"c": "1f40d", "n": "snake"}, {"c": "1f438", "n": "frog"}, {"c": "1f407", "n": "rabbit"}, {"c": "1f400", "n": "rat"}, {"c": "1f429", "n": "poodle"}, {"c": "1f415", "n": "dog"}, {"c": "1f416", "n": "pig"}, {"c": "1f40e", "n": "horse"}, {"c": "1facf", "n": "donkey"}, {"c": "1f402", "n": "ox"}, {"c": "1f410", "n": "goat"}, {"c": "1f998", "n": "kangaroo"}, {"c": "1f405", "n": "tiger"}, {"c": "1f412", "n": "monkey"}, {"c": "1f98d", "n": "gorilla"}, {"c": "1f9a7", "n": "orangutan"}, {"c": "1f43f_fe0f", "n": "chipmunk"}, {"c": "1f9a6", "n": "otter"}, {"c": "1f987", "n": "bat"}, {"c": "1f426", "n": "bird"}, {"c": "1f426_200d_2b1b", "n": "black bird"}, {"c": "1f413", "n": "rooster"}, {"c": "1f423", "n": "hatching chick"}, {"c": "1f424", "n": "baby chick"}, {"c": "1f425", "n": "hatched chick"}, {"c": "1f985", "n": "eagle"}, {"c": "1f989", "n": "owl"}, {"c": "1f54a_fe0f", "n": "dove"}, {"c": "1fabf", "n": "goose"}, {"c": "1f99a", "n": "peacock"}, {"c": "1f426_200d_1f525", "n": "phoenix"}, {"c": "1f9ad", "n": "seal"}, {"c": "1f988", "n": "shark"}, {"c": "1f42c", "n": "dolphin"}, {"c": "1f433", "n": "whale"}, {"c": "1f41f", "n": "fish"}, {"c": "1f421", "n": "blowfish"}, {"c": "1f99e", "n": "lobster"}, {"c": "1f980", "n": "crab"}, {"c": "1f419", "n": "octopus"}, {"c": "1fabc", "n": "jellyfish"}, {"c": "1f982", "n": "scorpion"}, {"c": "1f577_fe0f", "n": "spider"}, {"c": "1f40c", "n": "snail"}, {"c": "1f41c", "n": "ant"}, {"c": "1f99f", "n": "mosquito"}, {"c": "1fab3", "n": "cockroach"}, {"c": "1fab0", "n": "fly"}, {"c": "1f41d", "n": "bee"}, {"c": "1f41e", "n": "ladybug"}, {"c": "1f98b", "n": "butterfly"}, {"c": "1f41b", "n": "bug"}, {"c": "1fab1", "n": "worm"}, {"c": "1f43e", "n": "paw prints"}],
  "\ud83c\udf55 Nourriture": [{"c": "1f345", "n": "tomato"}, {"c": "1fadc", "n": "root vegetable"}, {"c": "1f373", "n": "cooking"}, {"c": "1f32f", "n": "burrito"}, {"c": "1f35d", "n": "spaghetti"}, {"c": "1f35c", "n": "steaming bowl"}, {"c": "1f37f", "n": "popcorn"}, {"c": "2615", "n": "hot beverage"}, {"c": "1f37b", "n": "beer mugs"}, {"c": "1f942", "n": "clinking glasses"}, {"c": "1f37e", "n": "champagne"}, {"c": "1f377", "n": "wine glass"}, {"c": "1fad7", "n": "pour"}, {"c": "1f379", "n": "tropical drink"}],
  "\ud83d\ude80 Voyages": [{"c": "1f6a7", "n": "construction"}, {"c": "1f6a8", "n": "police light"}, {"c": "1f6b2", "n": "bicycle"}, {"c": "1f697", "n": "car"}, {"c": "1f3ce_fe0f", "n": "racing car"}, {"c": "1f695", "n": "taxi"}, {"c": "1f68c", "n": "bus"}, {"c": "26f5", "n": "sailboat"}, {"c": "1f6f6", "n": "canoe"}, {"c": "1f6f8", "n": "flying saucer"}, {"c": "1f680", "n": "rocket"}, {"c": "1f6eb", "n": "airplane departure"}, {"c": "1f6ec", "n": "airplane arrival"}, {"c": "1f3a2", "n": "roller coaster"}, {"c": "1f3a1", "n": "ferris wheel"}, {"c": "1f3d5_fe0f", "n": "camping"}],
  "\ud83c\udf89 Activit\u00e9s": [{"c": "1f388", "n": "balloon"}, {"c": "1f382", "n": "birthday cake"}, {"c": "1f381", "n": "gift"}, {"c": "1f386", "n": "fireworks"}, {"c": "1fa85", "n": "pinata"}, {"c": "1faa9", "n": "disco ball"}, {"c": "1f947", "n": "gold medal"}, {"c": "1f948", "n": "silver medal"}, {"c": "1f949", "n": "bronze medal"}, {"c": "1f3c6", "n": "trophy"}, {"c": "26bd", "n": "soccer"}, {"c": "26be", "n": "baseball"}, {"c": "1f94e", "n": "softball"}, {"c": "1f3be", "n": "tennis"}, {"c": "1f3f8", "n": "badminton"}, {"c": "1f94d", "n": "lacrosse"}, {"c": "1f3cf", "n": "cricket"}, {"c": "1f3d1", "n": "field hockey"}, {"c": "1f3d2", "n": "ice hockey"}, {"c": "26f8_fe0f", "n": "ice skate"}, {"c": "1f6fc", "n": "roller skates"}, {"c": "1fa70", "n": "ballet shoes"}, {"c": "1f6f9", "n": "skateboard"}, {"c": "26f3", "n": "golf"}, {"c": "1f3af", "n": "target"}, {"c": "1f94f", "n": "flying disc"}, {"c": "1fa83", "n": "boomerang"}, {"c": "1fa81", "n": "kite"}, {"c": "1f3a3", "n": "fishing"}, {"c": "1f94b", "n": "martial arts"}, {"c": "1f3b1", "n": "8 ball"}, {"c": "1f3d3", "n": "ping pong"}, {"c": "1f3b3", "n": "bowling"}, {"c": "1f3b2", "n": "die"}, {"c": "1f3b0", "n": "slot machine"}, {"c": "1fa84", "n": "wand"}, {"c": "1f4f8", "n": "camera flash"}, {"c": "1fadf", "n": "splatter"}, {"c": "1f3b7", "n": "saxophone"}, {"c": "1f3ba", "n": "trumpet"}, {"c": "1f3bb", "n": "violin"}, {"c": "1fa89", "n": "harp"}, {"c": "1f941", "n": "drum"}, {"c": "1fa87", "n": "maracas"}, {"c": "1f3ac", "n": "clapper"}],
  "\ud83d\udca1 Objets": [{"c": "1f50b", "n": "battery"}, {"c": "1faab", "n": "battery low"}, {"c": "1fa99", "n": "coin"}, {"c": "1f4b8", "n": "money wings"}, {"c": "1f48e", "n": "gem"}, {"c": "2696_fe0f", "n": "balance scale"}, {"c": "1f4a1", "n": "light bulb"}, {"c": "1f393", "n": "graduation cap"}, {"c": "1f48d", "n": "ring"}, {"c": "1faad", "n": "fan"}, {"c": "2602_fe0f", "n": "umbrella"}, {"c": "1fa8f", "n": "shovel"}, {"c": "2699_fe0f", "n": "gear"}, {"c": "26d3_fe0f_200d_1f4a5", "n": "broken chain"}, {"c": "270f_fe0f", "n": "pencil"}, {"c": "23f0", "n": "alarm clock"}, {"c": "1f6ce_fe0f", "n": "bellhop"}, {"c": "1f514", "n": "bell"}, {"c": "1f52e", "n": "crystal ball"}, {"c": "1f4a3", "n": "bomb"}, {"c": "1faa4", "n": "mousetrap"}, {"c": "1f512", "n": "locked"}],
  "\ud83d\udd23 Symboles": [{"c": "2648", "n": "aries"}, {"c": "2649", "n": "taurus"}, {"c": "264a", "n": "gemini"}, {"c": "264b", "n": "cancer"}, {"c": "264c", "n": "leo"}, {"c": "264d", "n": "virgo"}, {"c": "264e", "n": "libra"}, {"c": "264f", "n": "scorpio"}, {"c": "2650", "n": "sagittarius"}, {"c": "2651", "n": "capricorn"}, {"c": "2652", "n": "aquarius"}, {"c": "2653", "n": "pisces"}, {"c": "26ce", "n": "ophiuchus"}, {"c": "2757", "n": "exclamation"}, {"c": "2753", "n": "question"}, {"c": "2049_fe0f", "n": "interrobang"}, {"c": "203c_fe0f", "n": "double exclamation"}, {"c": "274c", "n": "cross"}, {"c": "1f198", "n": "sos"}, {"c": "1f4f4", "n": "phone off"}, {"c": "2622_fe0f", "n": "radioactive"}, {"c": "2623_fe0f", "n": "biohazard"}, {"c": "26a0_fe0f", "n": "warning"}, {"c": "2705", "n": "check"}, {"c": "1f195", "n": "new"}, {"c": "1f193", "n": "free"}, {"c": "1f199", "n": "up"}, {"c": "1f192", "n": "cool"}, {"c": "1f6ae", "n": "litter"}, {"c": "262e_fe0f", "n": "peace"}, {"c": "262f_fe0f", "n": "yin yang"}, {"c": "267e_fe0f", "n": "infinity"}, {"c": "1f3b6", "n": "musical notes"}, {"c": "2795", "n": "plus"}],
  "\ud83c\udff3\ufe0f Drapeaux": [{"c": "1f3c1", "n": "chequered flag"}, {"c": "1f6a9", "n": "triangular flag"}, {"c": "1f3f4", "n": "black flag"}, {"c": "1f3f3_fe0f", "n": "white flag"}],
};
// Total: 442 emojis, 9 cat√©gories

let spCurrentTab = Object.keys(NOTO_DATA)[0];

// Init des onglets
document.getElementById('sp-tabs').addEventListener('click', (e) => {
	const btn = e.target.closest('.sp-tab');
	if (!btn) return;
	document.querySelectorAll('.sp-tab').forEach(b => b.classList.remove('active'));
	btn.classList.add('active');
	spCurrentTab = btn.dataset.tab;
	document.getElementById('sp-search').value = '';
	renderStickerPanel();
});

function toggleStickerPanel() {
	const panel = document.getElementById('sticker-panel');
	const btn   = document.getElementById('sticker-btn');
	const open  = panel.classList.toggle('active');
	if (btn) btn.classList.toggle('active-tool', open);
	if (open) {
		document.getElementById('tools-menu').classList.remove('active');
		document.getElementById('shape-toolbar').classList.remove('active');
		document.getElementById('bg-submenu').classList.remove('active');
		const sm = document.getElementById('scenes-menu');
		if (sm) sm.style.display = 'none';
		checkStickerConnectivity();
		renderStickerPanel();
	}
}

function renderStickerPanel() {
	const container = document.getElementById('sp-content');
	if (!container) return;
	const filter = (document.getElementById('sp-search') || {value:''}).value.trim().toLowerCase();

	if (spMode === 'classic') {
		// ‚îÄ‚îÄ √âmojis classiques Unicode (hors-ligne) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const allItems = CLASSIC_DATA[spCurrentClassicTab] || [];
		const items = filter
			? Object.values(CLASSIC_DATA).flat().filter(emoji => {
				const notoAll = Object.values(NOTO_DATA).flat();
				const cp = [...emoji].map(c => c.codePointAt(0).toString(16))
				           .join('_').replace(/_fe0f/gi, '');
				const match = notoAll.find(n => {
					const nc = n.c.replace(/_fe0f/gi, '');
					return nc === cp
						|| nc.startsWith(cp.split('_')[0])
						|| cp.startsWith(nc.split('_')[0]);
				});
				return match ? match.n.toLowerCase().includes(filter) : false;
			  })
			: allItems;
		if (!items.length) {
			container.innerHTML = '<div class="sp-empty">Aucun r√©sultat</div>';
			return;
		}
		const grid = document.createElement('div');
		grid.className = 'sp-grid-anim';
		items.forEach(emoji => {
			const btn = document.createElement('div');
			btn.className = 'sp-anim-btn';
			btn.title = emoji;
			btn.style.fontSize = '28px';
			btn.style.lineHeight = '1';
			btn.textContent = emoji;
			btn.addEventListener('click', () => insertStickerEmoji(emoji));
			grid.appendChild(btn);
		});
		container.innerHTML = '';
		if (filter) {
			const hint = document.createElement('div');
			hint.style.cssText = 'color:#555;font-size:10px;text-align:center;padding:0 0 8px;font-style:italic;';
			hint.textContent = items.length + ' r√©sultat(s) dans toutes les cat√©gories';
			container.appendChild(hint);
		}
		container.appendChild(grid);

	} else {
		// ‚îÄ‚îÄ √âmojis anim√©s Noto (CDN WebP) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
		const tab      = spCurrentTab;
		const allItems = NOTO_DATA[tab] || [];
		const items = filter
			? Object.values(NOTO_DATA).flat().filter(i => i.n.toLowerCase().includes(filter))
			: allItems;
		if (!items.length) {
			container.innerHTML = '<div class="sp-empty">Aucun r√©sultat</div>';
			return;
		}
		const grid = document.createElement('div');
		grid.className = 'sp-grid-anim';
		items.forEach(item => {
			const webpUrl = NOTO_CDN + '/' + item.c + '/512.webp';
			const btn = document.createElement('div');
			btn.className = 'sp-anim-btn';
			btn.title = item.n;
			const img = document.createElement('img');
			img.src = webpUrl;
			img.alt = item.n;
			img.loading = 'lazy';
			img.onerror = () => { btn.style.display = 'none'; };
			btn.appendChild(img);
			btn.addEventListener('click', () => insertStickerImage(webpUrl, item.n));
			grid.appendChild(btn);
		});
		container.innerHTML = '';
		if (filter) {
			const hint = document.createElement('div');
			hint.style.cssText = 'color:#555;font-size:10px;text-align:center;padding:0 0 8px;font-style:italic;';
			hint.textContent = items.length + ' r√©sultat(s) dans toutes les cat√©gories';
			container.appendChild(hint);
		}
		container.appendChild(grid);
	}
}

function _addStickerResizeHandle(w, minSize) {
	const handle = document.createElement('div');
	handle.title = 'Redimensionner';
	handle.style.cssText = `
		position:absolute; right:0; bottom:0; width:18px; height:18px;
		cursor:se-resize; z-index:200; border-radius:0 0 6px 0;
		background:linear-gradient(135deg, transparent 50%, #4a90e2 50%);
		opacity:0; transition:opacity 0.2s; pointer-events:auto;
	`;
	w.appendChild(handle);

	// Afficher/masquer au survol ou focus
	w.addEventListener('mouseenter', () => handle.style.opacity = '1');
	w.addEventListener('mouseleave', () => { if (!w.matches(':focus-within')) handle.style.opacity = '0'; });
	w.addEventListener('focusin',    () => handle.style.opacity = '1');
	w.addEventListener('focusout',   () => { if (!w.matches(':hover')) handle.style.opacity = '0'; });

	handle.addEventListener('mousedown', (e) => {
		e.preventDefault();
		e.stopPropagation();
		snapshotNow();
		const startX = e.clientX, startY = e.clientY;
		const startW = w.offsetWidth,  startH = w.offsetHeight;

		// Maintenir les proportions carr√©es (Shift ou par d√©faut pour stickers)
		const onMove = (ev) => {
			const dx = ev.clientX - startX;
			const dy = ev.clientY - startY;
			const delta = Math.max(dx, dy);
			const newSize = Math.max(minSize, startW + delta);
			w.style.width  = newSize + 'px';
			w.style.height = newSize + 'px';
			w.style.setProperty('--sticker-h', newSize + 'px');
			// Pour les √©mojis : mettre √† jour font-size ET dimensions du content
			const content = w.querySelector('[data-sticker-type="emoji"]');
			if (content) {
				content.style.width    = newSize + 'px';
				content.style.height   = newSize + 'px';
				content.style.fontSize = Math.round(newSize * 0.62) + 'px';
			}
		};
		const onUp = () => {
			document.removeEventListener('mousemove', onMove);
			document.removeEventListener('mouseup', onUp);
			saveBoard();
		};
		document.addEventListener('mousemove', onMove);
		document.addEventListener('mouseup', onUp);
	});
}

function insertStickerEmoji(emoji) {
	snapshotNow();
	const pos = findFreePosition();
	const w = document.createElement('div');
	w.className = 'widget';
	w.dataset.type = 'sticker';
	w.dataset.transparent = 'true';
	// min-height:0 et height explicite pour contrer le height:auto du CSS global
	w.style.cssText = `left:${pos.x}px; top:${pos.y}px; width:100px; height:100px; min-height:0 !important; overflow:visible; flex-direction:row; flex-shrink:0;`;
	w.style.setProperty('--sticker-h', '100px');
	w.tabIndex = 0;

	const content = document.createElement('div');
	content.dataset.stickerType = 'emoji';
	// position absolute, taille 100%x100% du widget, font-size proportionnelle
	content.style.cssText = 'position:absolute; top:0; left:0; width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:62px; line-height:1; user-select:none; pointer-events:none;';
	content.textContent = emoji;

	w.innerHTML = `
		<div class="drag-handle" title="D√©placer">‚ú•</div>
		<div class="widget-rotate-handle" title="Faire pivoter">‚Üª</div>
		<div class="widget-pin-handle" onclick="togglePin(this.closest('.widget'))" title="√âpingler">üìå</div>
		<div class="widget-back-handle" onclick="sendToBack(this.closest('.widget'))" title="Envoyer derri√®re">üîΩ</div>
		<div class="widget-close-handle" onclick="snapshotNow();this.closest('.widget').remove();saveBoard();" title="Fermer">√ó</div>
	`;
	w.appendChild(content);
	w.addEventListener('mousedown', () => bringToFront(w));
	board.appendChild(w);
	makeDraggable(w);
	makeDraggableRotate(w);
	_addStickerResizeHandle(w, 40);
	saveBoard();
}

function insertStickerImage(url, name) {
	snapshotNow();
	const pos = findFreePosition();
	const w = document.createElement('div');
	w.className = 'widget';
	w.dataset.type = 'sticker';
	w.dataset.transparent = 'true';
	// Forcer height explicite et overflow hidden pour que le redimensionnement fonctionne
	w.style.cssText = `left:${pos.x}px; top:${pos.y}px; width:130px; height:130px; overflow:hidden; flex-direction:row;`;
	w.style.setProperty('--sticker-h', '130px');
	w.tabIndex = 0;

	// L'image occupe tout l'espace du widget directement, sans widget-content qui flex-grow
	const img = document.createElement('img');
	img.src = url;
	img.alt = name;
	img.draggable = false;
	img.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; pointer-events:none; padding:6px; box-sizing:border-box;';

	w.innerHTML = `
		<div class="drag-handle" title="D√©placer">‚ú•</div>
		<div class="widget-rotate-handle" title="Faire pivoter">‚Üª</div>
		<div class="widget-pin-handle" onclick="togglePin(this.closest('.widget'))" title="√âpingler">üìå</div>
		<div class="widget-back-handle" onclick="sendToBack(this.closest('.widget'))" title="Envoyer derri√®re">üîΩ</div>
		<div class="widget-close-handle" onclick="snapshotNow();this.closest('.widget').remove();saveBoard();" title="Fermer">√ó</div>
	`;
	w.appendChild(img);
	w.addEventListener('mousedown', () => bringToFront(w));
	board.appendChild(w);
	makeDraggable(w);
	makeDraggableRotate(w);
	_addStickerResizeHandle(w, 40);
	saveBoard();
}

// Fermer au clic ext√©rieur
document.addEventListener('click', (e) => {
	const sp = document.getElementById('sticker-panel');
	if (sp && sp.classList.contains('active') &&
		!e.target.closest('#sticker-panel') &&
		!e.target.closest('#sticker-btn')) {
		sp.classList.remove('active');
		const sb = document.getElementById('sticker-btn');
		if (sb) sb.classList.remove('active-tool');
	}
});

</script>
<div id="laser-pointer"></div>
<button id="presentation-btn" onclick="togglePresentationMode()" title="Mode pr√©sentation" style="position:fixed;bottom:80px;right:24px;z-index:100000;background:#1a1a2e;color:white;border:2px solid rgba(255,255,255,0.25);font-size:20px;padding:7px 12px;border-radius:20px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(0,0,0,0.5);">üìΩÔ∏è</button>
</body>
</html>
