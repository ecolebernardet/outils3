<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Liens - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ============ CSS CUSTOM PROPERTIES ============ */
        :root {
            --bg-page: #121212;
            --text-page: #ffffff;
            --column-bg: #1e1e1e;
            --column-border: rgba(255, 255, 255, 0.1);
            --header-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --input-bg: #2a2a2a;
            --input-text: #ffffff;
            --item-bg: #2a2a2a;
            --item-text-url: #a1a1aa;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --modal-overlay: rgba(0, 0, 0, 0.85);
        }

        body.light-mode {
            --bg-page: #eeeeee;
            --text-page: #111827;
            --column-bg: #ffffff;
            --column-border: #ddd;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --input-bg: #f3f4f6;
            --input-text: #111827;
            --item-bg: #f3f4f6;
            --item-text-url: #71717a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.6);
        }

        /* ============ GLOBAL STYLES ============ */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-page);
            color: var(--text-page);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
        }

        /* ============ HEADER ============ */
        header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%;
            margin-bottom: 0;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ============ BUTTONS (Header & Generic) ============ */
        #btn-retour,
        #btn-aide {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        #btn-retour:active,
        #btn-aide:active {
            transform: scale(0.95);
        }

        /* ============ TABS NAVIGATION ============ */
        .tabs-container {
            background: var(--bg-page);
            display: flex;
            gap: 8px;
            padding: 10px 15px;
			justify-content: center;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: sticky;
            top: 60px;
            z-index: 99;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex-shrink: 0;
            padding: 10px 18px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            background: var(--header-bg);
            color: var(--item-text-url);
            border: 1px solid var(--column-border);
            cursor: grab;
            transition: all 0.3s ease;
            white-space: nowrap;
            touch-action: none;
        }

        .tab-btn:active:not(.dragging) {
            transform: scale(0.95);
        }

        .tab-btn.sortable-ghost {
			opacity: 0.4;
			transform: scale(0.9);
		}

        .tab-btn.active {
			font-weight: 900;
			color: white;
			border: 1px solid currentColor;
			box-shadow: none;
			transform: none;
		}

        /* ============ MAIN LAYOUT ============ */
        .main-wrapper {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 15px 20px 10px 20px;
        }
		
        #categoriesContainer {
			display: grid;
			grid-template-columns: 1fr;
			gap: 5px;
			width: 100%;
		}

		/* Pinterest layout sur grand √©cran */
		@media (min-width: 1024px) {
			.main-wrapper {
				padding: 20px 40px;
			}

			#categoriesContainer {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 20px;
				grid-auto-flow: dense;
			}
		}

		@media (min-width: 1400px) {
			#categoriesContainer {
				grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
				gap: 25px;
			}
		}

        /* ============ CARDS & COLUMNS ============ */
        .column {
            background: var(--card-bg);
            border: 1px solid var(--column-border);
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            box-shadow: var(--shadow-custom);
            break-inside: avoid;
            margin-bottom: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .column:hover {
			box-shadow: var(--shadow-custom);
		}

        .column-header {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            padding: 15px;
            border-bottom: 2px solid;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            background: var(--card-bg);
        }

        .column-header:active {
            transform: scale(0.98);
        }

        .column-header-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .column-toggle-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .column-toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .links-list {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 12px 15px;
        }

        .links-list.collapsed {
            max-height: 0;
            padding: 0 15px;
        }

        /* ============ HANDLE (Drag Handle) ============ */
        .dots-handle {
            display: grid;
            grid-template-columns: repeat(3, 2.5px);
            grid-template-rows: repeat(3, 2.5px);
            gap: 2.2px;
            opacity: 0.3;
            cursor: grab;
            flex-shrink: 0;
            padding: 10px;
            margin: -10px;
            transition: opacity 0.2s;
        }

        .dots-handle:hover {
            opacity: 0.6;
        }

        .dots-handle span {
            width: 2.5px;
            height: 2.5px;
            background-color: currentColor;
            border-radius: 50%;
        }

        /* ============ LINK ITEMS ============ */
        .link-item {
            background: var(--item-bg);
            border-radius: 0.75rem;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            border: 1px solid var(--column-border);
            touch-action: none;
            gap: 8px;
            transition: all 0.2s;
        }

        .link-item:hover {
            background: var(--card-bg);
            border-color: currentColor;
        }

        .link-item:last-child {
            margin-bottom: 0;
        }

        .link-favicon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 14px;
            overflow: hidden;
        }

        .link-favicon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .link-info {
            flex: 1;
            cursor: pointer;
            min-width: 0;
            padding: 0;
        }

        .link-name {
            font-weight: 800;
            font-size: 11px;
            text-transform: uppercase;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .link-url {
            font-size: 9px;
            color: var(--item-text-url);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .btn-action {
            color: #6b7280;
            opacity: 0.8;
            cursor: pointer;
            padding: 4px;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .btn-action:active {
            opacity: 1;
        }

        /* ============ FORM INPUTS ============ */
        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.75rem;
            padding: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            color: var(--input-text);
            outline: none;
        }

        /* ============ CATEGORY BUTTONS ============ */
        .cat-btn {
            flex: 1;
            padding: 10px 4px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            background: var(--input-bg);
            color: var(--item-text-url);
            border: 1px solid var(--column-border);
            transition: all 0.2s;
            cursor: pointer;
        }

        .cat-btn.active {
            background: #4b5563 !important;
            color: white !important;
            border-color: transparent !important;
        }

        /* ============ BUTTONS (Primary Actions) ============ */
        .btn-add,
        .nav-btn,
        #btn-fermer-aide,
        #alerte-cancel,
        #alerte-confirm {
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            border-radius: 50px;
            color: white;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        /* ============ NAVIGATION BUTTONS ============ */
        .bottom-nav {
            width: 100%;
            max-width: 600px;
            margin: 20px auto 0;
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            border-radius: 50px;
            font-size: 9px;
            padding: 12px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        /* ============ MODALS ============ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #modal-aide,
        #modal-alerte {
            z-index: 1100;
        }

        #form-container-modal {
            z-index: 900;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
            position: relative;
            box-shadow: var(--shadow-custom);
        }

        .modal-content h2 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        #btn-fermer-aide,
        #alerte-cancel,
        #alerte-confirm {
            border-radius: 0.75rem;
            font-size: 10px;
            tracking-widest: true;
            padding: 12px;
        }

        #alerte-cancel {
            background: rgba(115, 115, 115, 0.2);
        }

        /* ============ FLOATING ACTION BUTTON ============ */
        .fab-add {
            position: fixed;
            bottom: 60px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.6);
            color: white;
        }

        .fab-add:hover {
            transform: scale(1.1);
        }

        .fab-add:active {
            transform: scale(0.9);
        }

        /* ============ ANIMATIONS ============ */
        @keyframes blink-point {
            0% {
                transform: scale(0.9);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(0.9);
                opacity: 0.5;
            }
        }

        .mini-pastille {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #f97316;
            border-radius: 50%;
            margin-left: 4px;
            margin-right: 2px;
            box-shadow: 0 0 5px #f97316;
            animation: blink-point 1.5s infinite;
        }
		
		/* ================ Animation sp√©cifique pour l'ic√¥ne MathMaster ================== */
		.animate-math-icon {
			animation: rotate-3d-icon 4s linear infinite;
			display: inline-block;
			transform-style: preserve-3d;
		}

		@keyframes rotate-3d-icon {
			0% { 
				transform: rotateY(0deg) scale(1);
				filter: drop-shadow(0 5px 10px rgba(244, 63, 94, 0.2));
			}
			50% { 
				transform: rotateY(180deg) scale(1.2);
				filter: drop-shadow(0 8px 20px rgba(244, 63, 94, 0.5));
			}
			100% { 
				transform: rotateY(360deg) scale(1);
				filter: drop-shadow(0 5px 10px rgba(244, 63, 94, 0.2));
			}
		}

		/* Animation des particules math√©matiques */
		.math-particle {
			position: absolute;
			pointer-events: none;
			font-size: 12px;
			font-weight: bold;
			color: #f43f5e;
			opacity: 0;
			z-index: 10;
		}

		/* On d√©clenche l'animation des particules au hover de la tuile */
		.group:hover .p1 { animation: math-fly 1s ease-out forwards; }
		.group:hover .p2 { animation: math-fly 1s ease-out 0.1s forwards; }
		.group:hover .p3 { animation: math-fly 1s ease-out 0.2s forwards; }
		.group:hover .p4 { animation: math-fly 1s ease-out 0.3s forwards; }

		@keyframes math-fly {
			0% { transform: translate(0, 0) scale(0.5); opacity: 0; }
			20% { opacity: 1; }
			100% { 
				transform: translate(var(--tw-x), var(--tw-y)) rotate(var(--tw-r)) scale(1.2); 
				opacity: 0; 
			}
		}

		/* Variables de direction pour chaque particule */
		.p1 { --tw-x: -30px; --tw-y: -30px; --tw-r: 45deg; }
		.p2 { --tw-x: 30px; --tw-y: -35px; --tw-r: -30deg; }
		.p3 { --tw-x: -25px; --tw-y: 30px; --tw-r: 15deg; }
		.p4 { --tw-x: 35px; --tw-y: 25px; --tw-r: -45deg; }

    </style>
</head>
<body class="pb-10">

<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<!-- ============ MODAL: Form ============ -->
<div id="form-container-modal" class="modal-overlay" onclick="fermerFormulaire()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="form-title">Nouveau Lien</h2>
        <input type="text" id="linkName" class="input-field" placeholder="Nom du lien..." autocomplete="off">
        <input type="text" id="linkUrl" class="input-field" placeholder="URL (ex: google.fr)" autocomplete="off">
        <div class="flex gap-2 mb-6">
            <button class="cat-btn active" data-value="√âcole">√âcole</button>
            <button class="cat-btn" data-value="Institutionnel">Inst.</button>
            <button class="cat-btn" data-value="Ressources">Ress.</button>
            <button class="cat-btn" data-value="Autres">Autres</button>
        </div>
        <div class="flex gap-2">
            <button onclick="fermerFormulaire()" class="flex-1 py-3 rounded-xl bg-neutral-500/10 text-[10px] font-black uppercase">Annuler</button>
            <button id="mainAddBtn" onclick="addLink()" class="flex-[2] btn-add">Ajouter</button>
        </div>
    </div>
</div>

<!-- ============ MODAL: Help ============ -->
<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide">üí° Mes Liens</h2>
        <div class="text-[11px] leading-relaxed space-y-4 opacity-90">
            <div>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-50">Organisation</p>
                <ul class="space-y-1">
                    <li>‚Ä¢ <b>Ajouter :</b> Utilisez le bouton <span class="font-bold">+</span> en bas √† droite.</li>
                    <li>‚Ä¢ <b>R√©organiser cat√©gories :</b> Maintenez et glissez les onglets en haut.</li>
                    <li>‚Ä¢ <b>Plier/D√©plier :</b> Cliquez sur l'en-t√™te ou la fl√®che d'une cat√©gorie.</li>
                    <li>‚Ä¢ <b>R√©organiser liens :</b> Maintenez les <span class="opacity-50 text-xs">‚†ø</span> pour d√©placer un lien.</li>
                    <li>‚Ä¢ <b>Actions :</b> Cliquez sur ‚úèÔ∏è pour modifier ou üóëÔ∏è pour supprimer.</li>
                </ul>
            </div>
            <div>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-50">Navigation</p>
                <p>Les onglets en haut indiquent quelle cat√©gorie est ouverte. Cliquez dessus pour plier/d√©plier.</p>
            </div>
            <div>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-50">Sauvegarde</p>
                <p>Vos liens et l'ordre des cat√©gories sont stock√©s sur cet appareil. Pensez √† <b>Exporter</b> r√©guli√®rement votre liste pour ne pas la perdre en cas de changement de navigateur.</p>
            </div>
            <div class="bg-neutral-500/5 p-3 rounded-lg border border-neutral-500/10">
                <p><strong>Alerte <span class="mini-pastille"></span> :</strong></p>
                <p class="mt-1">Si cette pastille clignote sur l'export, vos derni√®res modifications n'ont pas encore √©t√© sauvegard√©es dans un fichier .txt.</p>
            </div>
        </div>
        <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">J'ai compris</button>
    </div>
</div>

<!-- ============ MODAL: Alert ============ -->
<div id="modal-alerte" class="modal-overlay">
    <div class="modal-content">
        <h2 id="alerte-titre">Alerte</h2>
        <div id="alerte-texte" class="text-[11px] leading-relaxed opacity-80 mb-6 text-center"></div>
        <div class="flex gap-3">
            <button id="alerte-cancel" onclick="fermerModal('modal-alerte')" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Annuler</button>
            <button id="alerte-confirm" class="flex-1 py-3 text-white rounded-xl text-[10px] font-black uppercase tracking-widest">Confirmer</button>
        </div>
    </div>
</div>

<!-- ============ HEADER ============ -->
<header>
    <a href="index.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Mes Liens</h1>
    <button id="btn-aide" onclick="ouvrirAide()">üí°</button>
</header>

<!-- ============ TABS NAVIGATION ============ -->
<div class="tabs-container" id="tabsContainer"></div>

<!-- ============ MAIN CONTENT ============ -->
<div class="main-wrapper">
	<div class="main-wrapper">
    <div class="mb-4">
		<h3 class="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 mb-3 ml-1">Du m√™me auteur :</h3>
		<a href="https://outilsprofs.fr/mathmaster" target="_blank" 
		   class="link-item !p-4 border-rose-500/30 bg-rose-500/5 hover:bg-rose-500/10 hover:border-rose-500/60 group !mb-0 transition-all relative overflow-visible">
			
			<div class="link-favicon !w-10 !h-10 !bg-transparent !text-2xl shadow-none relative flex items-center justify-center">
				<span class="math-particle p1">+</span>
				<span class="math-particle p2">‚àí</span>
				<span class="math-particle p3">√ó</span>
				<span class="math-particle p4">√∑</span>
				
				<span class="animate-math-icon">üßÆ</span>
			</div>

			<div class="link-info ml-3">
				<span class="link-name !text-[13px] font-bold text-rose-500">MathMaster</span>
				<span class="link-url !text-[10px] opacity-70">Plateforme de calcul mental</span>
			</div>
			
			<div class="link-actions">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-rose-500/40 group-hover:text-rose-500 group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 7l5 5m0 0l-5 5m5-5H6" />
				</svg>
			</div>
		</a>
	</div>

    <div class="h-[1px] bg-white/10 dark:bg-black/5 w-full mb-8"></div>

    <div id="categoriesContainer"></div>

    <!-- ============ FOOTER NAVIGATION ============ -->
    <footer class="bottom-nav">
        <div class="flex gap-2">
            <label for="importFile" class="nav-btn bg-black text-white cursor-pointer text-center flex-1">üëá importer .txt üëá</label>
            <input type="file" id="importFile" class="hidden" accept=".txt" onchange="importLinks(event)">
            <button id="btn-export" onclick="exportLinks()" class="nav-btn bg-black text-white flex-1 relative overflow-visible">
                üëÜ exporter .txt üëÜ
                <span id="badge-export" class="hidden absolute -top-1 -right-1 w-3.5 h-3.5 bg-orange-500 rounded-full border-2 border-white animate-pulse"></span>
            </button>
        </div>
        <button onclick="resetLinks()" class="nav-btn bg-red-500 text-white shadow-lg">‚ö†Ô∏è effacer tous les liens</button>
    </footer>
</div>

<!-- ============ FLOATING ACTION BUTTON ============ -->
<button id="fab-plus" onclick="ouvrirFormulaire()" class="fab-add">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
    </svg>
</button>

<script>
    // ============ CONFIGURATION & STATE ============
    const CATEGORIES = ["√âcole", "Institutionnel", "Ressources", "Autres"];
    
    const COLOR_MAP = {
        'red': '#ef4444',
        'orange': '#f97316',
        'amber': '#f59e0b',
        'yellow': '#eab308',
        'lime': '#84cc16',
        'green': '#22c55e',
        'emerald': '#10b981',
        'teal': '#14b8a6',
        'cyan': '#06b6d4',
        'sky': '#0ea5e9',
        'blue': '#3b82f6',
        'indigo': '#6366f1',
        'violet': '#8b5cf6',
        'purple': '#a855f7',
        'fuchsia': '#d946ef',
        'pink': '#ec4899',
        'rose': '#f43f5e',
        'gray': '#6b7280'
    };

    const CATEGORY_CONFIG = {
        '√âcole': { text: 'text-rose-500', border: 'border-rose-500', emoji: 'üè´' },
        'Institutionnel': { text: 'text-purple-500', border: 'border-purple-500', emoji: 'üßëüèª‚Äçüíº' },
        'Ressources': { text: 'text-blue-500', border: 'border-blue-500', emoji: 'üß∞' },
        'Autres': { text: 'text-emerald-500', border: 'border-emerald-500', emoji: 'üåç' }
    };

    // Application State
    let catOrder = JSON.parse(localStorage.getItem('eduCatOrder')) || CATEGORIES;
    let links = JSON.parse(localStorage.getItem('eduLinksList')) || [];
    let currentSelectedCat = "√âcole";
    let expandedCategories = JSON.parse(localStorage.getItem('expandedCategories')) || ["√âcole"];
    let editingLinkId = null;

    // ============ DOM SELECTORS (Cached) ============
    const DOM = {
        // Modals
        formModal: document.getElementById('form-container-modal'),
        formTitle: document.getElementById('form-title'),
        alertModal: document.getElementById('modal-alerte'),
        helpModal: document.getElementById('modal-aide'),

        // Form Inputs
        linkName: document.getElementById('linkName'),
        linkUrl: document.getElementById('linkUrl'),
        mainAddBtn: document.getElementById('mainAddBtn'),

        // Buttons
        btn_retour: document.getElementById('btn-retour'),
        btn_aide: document.getElementById('btn-aide'),
        btn_fermerAide: document.getElementById('btn-fermer-aide'),
        btn_export: document.getElementById('btn-export'),
        badge_export: document.getElementById('badge-export'),
        fab_plus: document.getElementById('fab-plus'),

        // Alerts
        alertTitle: document.getElementById('alerte-titre'),
        alertText: document.getElementById('alerte-texte'),
        alertConfirm: document.getElementById('alerte-confirm'),

        // Containers
        tabsContainer: document.getElementById('tabsContainer'),
        categoriesContainer: document.getElementById('categoriesContainer')
    };

    // ============ UTILITIES ============
    function getThemeColor() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colorName = themePrefs.liens || 'emerald';
        return COLOR_MAP[colorName];
    }

    function isDarkText(colorName) {
        const darkColors = ['yellow', 'lime', 'amber', 'cyan'];
        return darkColors.includes(colorName);
    }

    function getTextColor(colorName) {
        return isDarkText(colorName) ? '#000' : '#fff';
    }

    function formatUrl(urlInput) {
        urlInput = urlInput.trim().replace(/\s/g, '');
        return /^(http|https):\/\//i.test(urlInput) ? urlInput : 'https://' + urlInput;
    }

    function getFaviconUrl(urlString) {
		try {
			const url = new URL(urlString);
			
			// Si le domaine est ton site, on renvoie directement ton ic√¥ne GitHub
			if (url.hostname === 'outilsprofs.fr' || url.hostname === 'www.outilsprofs.fr') {
				return 'https://ecolebernardet.github.io/outilsprofs/outilsprofs_icone.png';
			}
			
			// Pour les autres sites, on continue d'utiliser Google
			return `https://www.google.com/s2/favicons?sz=64&domain=${url.hostname}`;
		} catch (e) {
			return null;
		}
	}

    // ============ STORAGE & PERSISTENCE ============
    function updateExportBadge(needsExport) {
        if (needsExport) {
            DOM.badge_export.classList.remove('hidden');
            localStorage.setItem('needsExport_liens', 'true');
            DOM.btn_export.style.border = '2px solid #f97316';
        } else {
            DOM.badge_export.classList.add('hidden');
            localStorage.removeItem('needsExport_liens');
            localStorage.setItem('last_export_liens', Date.now());
            DOM.btn_export.style.border = 'none';
        }
    }

    function checkBadgeStatus() {
        const lastExport = localStorage.getItem('last_export_liens');
        const needsExport = localStorage.getItem('needsExport_liens') === 'true';
        
        if (needsExport) {
            updateExportBadge(true);
            return;
        }

        const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
        if (lastExport && Date.now() - parseInt(lastExport) > SEVEN_DAYS_MS) {
            updateExportBadge(true);
        } else if (!lastExport) {
            localStorage.setItem('last_export_liens', Date.now());
        }
    }

    // ============ MODAL MANAGEMENT ============
    function fermerFormulaire() {
        DOM.formModal.style.display = 'none';
        if (editingLinkId) {
            editingLinkId = null;
            DOM.linkName.value = '';
            DOM.linkUrl.value = '';
            DOM.mainAddBtn.innerText = "Ajouter";
        }
    }

    function fermerModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function ouvrirFormulaire() {
        DOM.formModal.style.display = 'flex';
        DOM.formTitle.innerText = editingLinkId ? "Modifier le lien" : "Nouveau Lien";
        updateCategoryButtons();
    }

    function ouvrirAide() {
        applyTheme();
        DOM.helpModal.style.display = 'flex';
    }

    // ============ ACCORDION MANAGEMENT ============
    function toggleCategory(cat) {
        const index = expandedCategories.indexOf(cat);
        if (index > -1) {
            expandedCategories.splice(index, 1);
        } else {
            expandedCategories.push(cat);
        }
        localStorage.setItem('expandedCategories', JSON.stringify(expandedCategories));
        updateTabButtons();
        render();
    }

    function renderTabs() {
        DOM.tabsContainer.innerHTML = '';
        
        catOrder.forEach(cat => {
            const btn = document.createElement('button');
            // On retire draggable=true, SortableJS s'en occupe
            btn.className = `tab-btn ${expandedCategories.includes(cat) ? 'active' : ''}`;
            btn.setAttribute('data-category', cat);
            btn.innerHTML = `${CATEGORY_CONFIG[cat].emoji} ${cat}`;
            
            const isExpanded = expandedCategories.includes(cat);
            btn.style.color = isExpanded ? 'white' : '';
            btn.style.background = isExpanded ? getThemeColor() : '';
            btn.style.borderColor = isExpanded ? getThemeColor() : '';
            
            btn.addEventListener('click', () => {
                toggleCategory(cat);
            });
            
            DOM.tabsContainer.appendChild(btn);
        });

        // Initialisation de Sortable pour les onglets
        new Sortable(DOM.tabsContainer, {
            animation: 150,
            ghostClass: 'opacity-50',
            // On √©vite le d√©clenchement accidentel lors du clic/scroll
            delay: 100,
            delayOnTouchOnly: true,
            onEnd: () => {
                const newOrder = Array.from(DOM.tabsContainer.querySelectorAll('.tab-btn'))
                                     .map(b => b.getAttribute('data-category'));
                catOrder = newOrder;
                localStorage.setItem('eduCatOrder', JSON.stringify(catOrder));
                updateExportBadge(true);
                // On rafra√Æchit le rendu pour aligner les colonnes avec le nouvel ordre
                render(); 
            }
        });
    }

    function updateTabButtons() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const cat = btn.getAttribute('data-category');
            const isExpanded = expandedCategories.includes(cat);
            
            if (isExpanded) {
                btn.classList.add('active');
                btn.style.color = 'white';
                btn.style.background = getThemeColor();
                btn.style.borderColor = getThemeColor();
            } else {
                btn.classList.remove('active');
                btn.style.color = '';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        });
    }

    // ============ CATEGORY BUTTONS ============
    function updateCategoryButtons() {
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-value') === currentSelectedCat);
        });
    }

    function initCategoryButtonListeners() {
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.onclick = () => {
                currentSelectedCat = btn.getAttribute('data-value');
                updateCategoryButtons();
            };
        });
    }

    // ============ LINK MANAGEMENT ============
    function addLink() {
        const name = DOM.linkName.value.trim();
        const url = formatUrl(DOM.linkUrl.value);

        if (!name || !DOM.linkUrl.value.trim()) {
            return;
        }

        if (editingLinkId) {
            const index = links.findIndex(l => l.id === editingLinkId);
            if (index !== -1) {
                links[index] = { ...links[index], name, url, cat: currentSelectedCat };
            }
            editingLinkId = null;
            DOM.mainAddBtn.innerText = "Ajouter";
        } else {
            links.push({ id: Date.now(), name, url, cat: currentSelectedCat });
        }

        localStorage.setItem('eduLinksList', JSON.stringify(links));
        DOM.linkName.value = '';
        DOM.linkUrl.value = '';
        updateExportBadge(true);
        fermerFormulaire();
        render();
    }

    function editLink(id) {
        const link = links.find(l => l.id === id);
        if (!link) return;

        DOM.linkName.value = link.name;
        DOM.linkUrl.value = link.url;
        currentSelectedCat = link.cat;
        editingLinkId = id;
        DOM.mainAddBtn.innerText = "Mettre √† jour";
        
        updateCategoryButtons();
        ouvrirFormulaire();
    }

    function deleteLink(id) {
        afficherMessage("Suppression", "Voulez-vous supprimer ce lien ?", () => {
            links = links.filter(l => l.id !== id);
            localStorage.setItem('eduLinksList', JSON.stringify(links));
            updateExportBadge(true);
            render();
        });
    }

    // ============ IMPORT/EXPORT ============
    function exportLinks() {
        if (links.length === 0) return;

        const dataStr = JSON.stringify(links);
        const nomFichier = `outilsprofs_liens_${new Date().toISOString().split('T')[0]}.txt`;

        if (window.Android && typeof window.Android.exportTxt === "function") {
            window.Android.exportTxt(dataStr, nomFichier);
        } else {
            const blob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomFichier;
            a.click();
            URL.revokeObjectURL(url);
        }

        updateExportBadge(false);
    }

    function importLinks(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    links = imported;
                    localStorage.setItem('eduLinksList', JSON.stringify(links));
                    updateExportBadge(false);
                    render();
                }
            } catch (err) {
                console.error('Import error:', err);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    function resetLinks() {
        afficherMessage("R√©initialisation", "Effacer TOUS vos liens ?", () => {
            links = [];
            localStorage.removeItem('eduLinksList');
            updateExportBadge(true);
            render();
        });
    }

    // ============ ALERTS ============
    function afficherMessage(titre, texte, callback) {
        DOM.alertTitle.innerText = titre;
        DOM.alertText.innerText = texte;
        
        const themeColor = getThemeColor();
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const isDark = isDarkText(themePrefs.liens || 'emerald');
        
        DOM.alertConfirm.style.backgroundColor = themeColor;
        DOM.alertConfirm.style.color = isDark ? '#000' : '#fff';
        DOM.alertModal.style.display = 'flex';
        
        DOM.alertConfirm.onclick = () => {
            DOM.alertModal.style.display = 'none';
            callback();
        };
    }

    // ============ RENDERING ============
    function render() {
        DOM.categoriesContainer.innerHTML = '';

        catOrder.forEach(cat => {
            const catLinks = links.filter(l => l.cat === cat);
            const conf = CATEGORY_CONFIG[cat];
            const isExpanded = expandedCategories.includes(cat);
            const count = catLinks.length;
            
            // 1. Cr√©ation de l'aper√ßu des favicons (max 4 pour rester discret)
            const iconsPreview = catLinks.slice(0, 4).map(link => {
                const fav = getFaviconUrl(link.url);
                return fav ? `<img src="${fav}" style="width:12px; height:12px; border-radius:2px; margin-right:2px; opacity:0.8; object-fit:contain;">` : '';
            }).join('');

            const col = document.createElement('div');
            col.className = 'column';
            col.setAttribute('data-cat', cat);

            const linksHtml = count === 0
                ? '<p class="text-[10px] opacity-30 italic py-2 text-center">Vide</p>'
                : catLinks.map(link => createLinkItemHtml(link, conf)).join('');

            const header = document.createElement('div');
            header.className = `column-header ${conf.text} ${conf.border}`;
            
            // 2. Badge de compteur avec aper√ßu d'ic√¥nes √† gauche
            const badgeHtml = count > 0 
                ? `<div style="display: flex; align-items: center; margin-left: auto; gap: 8px;">
                    <div style="display: flex; align-items: center; opacity: 0.6;">${iconsPreview}</div>
                    <span class="px-2 py-0.5 rounded-full bg-current" 
                          style="font-size: 9px; font-weight: 900; display: inline-flex; align-items: center; justify-content: center; min-width: 18px; background-color: currentColor; --tw-bg-opacity: 0.2;">
                        <span style="filter: brightness(0) invert(1); color: black !important;">${count}</span>
                    </span>
                   </div>` 
                : '';

            const headerContent = document.createElement('div');
            headerContent.className = 'column-header-content';
            headerContent.style.display = 'flex';
            headerContent.style.alignItems = 'center';
            headerContent.style.flex = '1';
            headerContent.innerHTML = `
                <span>${conf.emoji}</span> 
                <span class="ml-1">${cat}</span>
                ${badgeHtml}
            `;
            
            const arrow = document.createElement('div');
            arrow.className = `column-toggle-arrow ${isExpanded ? '' : 'collapsed'}`;
            arrow.innerHTML = '‚ñº';
            
            header.appendChild(headerContent);
            header.appendChild(arrow);
            
            header.onclick = (e) => {
                e.preventDefault();
                toggleCategory(cat);
            };

            const linksList = document.createElement('div');
            linksList.className = `links-list ${isExpanded ? '' : 'collapsed'}`;
            linksList.setAttribute('data-cat', cat);
            linksList.innerHTML = linksHtml;

            col.appendChild(header);
            col.appendChild(linksList);

            DOM.categoriesContainer.appendChild(col);
        });

        initSortables();
    }

    function createLinkItemHtml(link, conf) {
        const faviconUrl = getFaviconUrl(link.url);
        const faviconHtml = faviconUrl 
            ? `<img src="${faviconUrl}" alt="${link.name}" onerror="this.style.display='none'">`
            : 'üîó';
        
        return `
            <div class="link-item" data-id="${link.id}">
                <div class="dots-handle handle-link"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                <div class="link-favicon">${faviconHtml}</div>
                <div class="link-info" onclick="window.open('${link.url}', '_blank')">
                    <span class="link-name ${conf.text}">${link.name}</span>
                    <span class="link-url">${link.url}</span>
                </div>
                <div class="link-actions">
                    <div class="btn-action" onclick="event.stopPropagation(); editLink(${link.id})">‚úèÔ∏è</div>
                    <div class="btn-action" onclick="event.stopPropagation(); deleteLink(${link.id})">üóëÔ∏è</div>
                </div>
            </div>
        `;
    }

    // ============ DRAG & DROP ============
    function initSortables() {
        // Link sorting within categories
        document.querySelectorAll('.links-list').forEach(listEl => {
            new Sortable(listEl, {
                group: 'sharedLinks',
                handle: '.handle-link',
                animation: 150,
                delay: 200,
                delayOnTouchOnly: true,
                touchStartThreshold: 3,
                onEnd: () => {
                    const newLinks = [];
                    document.querySelectorAll('.column').forEach(col => {
                        const catName = col.getAttribute('data-cat');
                        col.querySelectorAll('.link-item').forEach(item => {
                            const id = parseInt(item.getAttribute('data-id'));
                            const link = links.find(l => l.id === id);
                            if (link) {
                                newLinks.push({ ...link, cat: catName });
                            }
                        });
                    });
                    links = newLinks;
                    localStorage.setItem('eduLinksList', JSON.stringify(links));
                    updateExportBadge(true);
                    render();
                }
            });
        });
    }

    // ============ THEMING ============
    function applyTheme() {
        const themeColor = getThemeColor();
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const isDark = isDarkText(themePrefs.liens || 'emerald');
        const textColor = isDark ? '#000' : '#fff';

        const elementsToStyle = [
            DOM.mainAddBtn,
            DOM.btn_retour,
            DOM.btn_aide,
            DOM.btn_fermerAide,
            DOM.fab_plus
        ];

        elementsToStyle.forEach(el => {
            if (el) {
                el.style.backgroundColor = themeColor;
                el.style.color = textColor;
            }
        });

        const titleAide = document.getElementById('titre-aide');
        if (titleAide) {
            titleAide.style.color = themeColor;
        }

        updateTabButtons();
    }

    // ============ INITIALIZATION ============
    window.addEventListener('load', () => {
        applyTheme();
        initCategoryButtonListeners();
        renderTabs();
        render();
        checkBadgeStatus();
    });
</script>
</body>
</html>