<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sonom√®tre - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-page); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            transition: background 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 800px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 25px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        /* Jauge Sonom√®tre */
        .gauge-container {
            width: 100%;
            height: 40px;
            background: var(--input-bg);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--column-border);
            position: relative;
        }

        .gauge-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            transition: width 0.1s ease-out;
        }

        .gauge-marker {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background: var(--text-main);
            opacity: 0.3;
        }

        .btn-action { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; color: white; }
        .btn-action:active { transform: scale(0.95); }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Volume de la Classe</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux outils
        </a>
    </div>

    <div class="light-card text-center">
        <label class="block text-[9px] font-black uppercase opacity-50 mb-6 tracking-widest">Niveau sonore en temps r√©el</label>
        
        <div class="gauge-container mb-6">
            <div id="gauge-bar" class="gauge-fill"></div>
            <div class="gauge-marker" style="left: 25%"></div>
            <div class="gauge-marker" style="left: 50%"></div>
            <div class="gauge-marker" style="left: 75%"></div>
        </div>

        <div id="status-text" class="text-2xl font-black uppercase mb-8 tracking-tighter">Micro d√©sactiv√©</div>

        <div class="grid grid-cols-1 gap-3">
            <button id="btn-start" onclick="toggleMic()" class="btn-action bg-emerald-500">D√©marrer la mesure</button>
            <div class="flex items-center justify-center gap-4 mt-4">
                <span class="text-[9px] font-black uppercase opacity-50">Sensibilit√©</span>
                <input type="range" id="sensitivity" min="1" max="10" value="5" class="accent-cyan-500">
            </div>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center">üí° Sonom√®tre de classe</h2>
        <div class="text-[11px] leading-relaxed space-y-4 opacity-90">
            <p>Cet outil permet de visualiser le niveau sonore de la classe pour encourager l'autonomie et le calme.</p>
            <ul class="list-disc pl-4 space-y-2">
                <li><b>Vert :</b> Niveau id√©al (travail individuel/calme).</li>
                <li><b>Jaune :</b> Murmures autoris√©s.</li>
                <li><b>Rouge :</b> Trop de bruit !</li>
            </ul>
            <p class="italic text-[10px]">Note : Vous devez autoriser l'acc√®s au microphone pour utiliser cette page.</p>
        </div>
        <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-white">Fermer</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };

    let audioContext;
    let analyser;
    let microphone;
    let javascriptNode;
    let isRecording = false;

    function toggleMic() {
        if (!isRecording) {
            startMic();
        } else {
            stopMic();
        }
    }

    async function startMic() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = function() {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                let values = 0;

                for (let i = 0; i < array.length; i++) {
                    values += array[i];
                }

                const average = values / array.length;
                updateGauge(average);
            };

            isRecording = true;
            document.getElementById('btn-start').innerText = "Arr√™ter la mesure";
            document.getElementById('btn-start').classList.replace('bg-emerald-500', 'bg-rose-500');
        } catch (err) {
            alert("Erreur d'acc√®s au micro : " + err);
        }
    }

    function stopMic() {
        if (audioContext) audioContext.close();
        isRecording = false;
        document.getElementById('btn-start').innerText = "D√©marrer la mesure";
        document.getElementById('btn-start').classList.replace('bg-rose-500', 'bg-emerald-500');
        document.getElementById('gauge-bar').style.width = "0%";
        document.getElementById('status-text').innerText = "Micro d√©sactiv√©";
    }

    function updateGauge(value) {
        const sensitivity = document.getElementById('sensitivity').value;
        // Calcul du pourcentage bas√© sur la sensibilit√©
        let percent = (value * (sensitivity / 5)) * 2;
        percent = Math.min(Math.max(percent, 0), 100);

        const gauge = document.getElementById('gauge-bar');
        const status = document.getElementById('status-text');
        
        gauge.style.width = percent + "%";

        if (percent < 30) {
            status.innerText = "Parfait ü§´";
            status.style.color = "#22c55e";
        } else if (percent < 70) {
            status.innerText = "C'est bien üó£Ô∏è";
            status.style.color = "#eab308";
        } else {
            status.innerText = "Trop de bruit ! üì¢";
            status.style.color = "#ef4444";
        }
    }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        
        [
            document.getElementById('btn-retour-header'), 
            document.getElementById('btn-retour-liste'), 
            document.getElementById('btn-aide'),
            document.getElementById('btn-fermer-aide')
        ].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onload = appliquerTheme;
</script>
</body>
</html>