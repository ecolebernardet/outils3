<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>D√©fi Calme - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.1); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }

        body.light-mode {
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #ddd; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; width: 100%;
            position: sticky; top: 0; z-index: 100;
        }

        .ui-btn-round { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.2; }
        header h1 { font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; text-align: center; }

        .main-wrapper { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px 15px; }

        #container-retour-liste { margin-bottom: 1rem; text-align: left; }
        #btn-retour-liste {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .gauge-container {
            background: var(--card-bg); border-radius: 1.5rem; padding: 10px 30px 40px 30px; border: 1px solid var(--column-border); text-align: center;
        }

        /* Reveal Box Format Paysage et Grand √©cran */
        .reveal-box {
            position: relative;
            width: 90vw; 
            aspect-ratio: 16 / 9;
            max-width: 900px; 
            margin: 20px auto 10px auto;
            background: #000;
            border-radius: 1.5rem;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--column-border);
        }

        #hidden-image {
            width: 100%; height: 100%;
            object-fit: cover;
            filter: blur(30px) brightness(0.4);
            transition: filter 0.3s linear;
        }

        #btn-start {
            width: 100%; max-width: 400px; padding: 16px; border-radius: 12px; font-weight: 900; 
            text-transform: uppercase; cursor: pointer; border: none; margin: 20px auto; display: block;
        }

        .mic-monitor-bg { width: 100px; height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; margin: 5px auto; }
        #mic-bar { height: 100%; background: var(--theme-color); width: 0%; transition: width 0.1s; }

        .modal-overlay { 
            display: none; position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); 
            align-items: center; justify-content: center; padding: 20px; 
        }
        .modal-content { 
            background: var(--card-bg); width: 100%; max-width: 450px;
            border-radius: 1.5rem; border: 1px solid var(--column-border); 
            padding: 30px; position: relative; color: var(--text-page);
        }

        @media (max-width: 640px) {
            .gauge-container { padding: 20px 20px 40px 20px; }
        }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour" class="ui-btn-round">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1 id="pageTitle">D√©fi Calme</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux outils
        </a>
    </div>

    <div class="gauge-container">
        <div class="mt-2">
            <span class="text-[9px] font-black uppercase opacity-40">Niveau Micro</span>
            <div class="mic-monitor-bg">
                <div id="mic-bar"></div>
            </div>
        </div>

        <div class="reveal-box">
            <img id="hidden-image" src="https://picsum.photos/900/500?nature,animals" alt="Surprise">
            <div id="msg-start" class="absolute inset-0 flex items-center justify-center text-center p-6 text-sm font-bold opacity-30">
                Restez silencieux pour<br>r√©v√©ler l'image...
            </div>
        </div>

        <div class="max-w-xs mx-auto mt-6">
            <div class="flex justify-between items-end mb-2">
                <span id="status-text" class="text-[10px] font-black uppercase opacity-60">En attente...</span>
                <span id="percent-text" class="text-xl font-black">0%</span>
            </div>
            <div class="w-full bg-black/10 dark:bg-white/5 h-4 rounded-full overflow-hidden">
                <div id="progress-fill" class="h-full transition-all duration-300" style="width: 0%; background-color: var(--theme-color);"></div>
            </div>
        </div>

        <button id="btn-start" onclick="toggleDefi()">D√©marrer le d√©fi</button>
        <button id="btn-reset" onclick="nouveauDefi()" class="hidden w-full max-w-400px padding-16 border-radius-12 font-weight-900 text-transform-uppercase cursor-pointer border-none margin-20-auto display-block" style="width: 100%; max-width: 400px; padding: 16px; border-radius: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; border: none; margin: 20px auto;">Nouveau d√©fi</button>

        <div class="flex flex-col gap-4 mt-8 py-4 bg-black/5 dark:bg-white/5 rounded-xl">
            <div class="flex justify-center items-center gap-4">
                <span class="text-[10px] font-black uppercase opacity-60">Dur√©e (sec) :</span>
                <input type="number" id="duree-defi" value="10" min="1" max="1000" class="bg-transparent font-bold text-xs outline-none border-b border-current w-12 text-center">
            </div>
            <div class="px-8">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-black uppercase opacity-60">Sensibilit√© du micro</span>
                    <span id="sensibilite-val" class="text-[10px] font-bold">50</span>
                </div>
                <input type="range" id="sensibilite-slider" min="1" max="100" value="50" class="w-full h-1.5 bg-black/20 rounded-lg appearance-none cursor-pointer accent-[var(--theme-color)]" oninput="document.getElementById('sensibilite-val').textContent = this.value">
            </div>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4" style="color: var(--theme-color)">üí° Le D√©fi Calme</h2>
        <div class="text-[12px] leading-relaxed space-y-4 opacity-90">
            <p>‚Ä¢ <b>Objectif :</b> L'image devient de plus en plus nette si le silence est respect√©.</p>
            <p>‚Ä¢ <b>Progression :</b> Plus il y a de calme, plus l'image se r√©v√®le.</p>
            <p>‚Ä¢ <b>Sanction :</b> Si le bruit d√©passe la limite, l'image redevient floue.</p>
            <p>‚Ä¢ <b>Succ√®s :</b> Atteignez 100% pour voir l'image parfaitement !</p>
        </div>
        <button onclick="fermerModal('modal-aide')" id="btn-fermer-aide" class="mt-8 w-full py-4 rounded-xl text-[11px] font-black uppercase tracking-widest text-white shadow-lg">J'ai compris</button>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };
    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue') ? '#000' : '#fff';
    
    document.querySelectorAll('#btn-start, #btn-retour, #btn-retour-liste, #btn-aide, #btn-fermer-aide').forEach(el => {
        if(el) { el.style.backgroundColor = themeColor; el.style.color = contrast; }
    });
    document.documentElement.style.setProperty('--theme-color', themeColor);

    let audioContext, analyser, javascriptNode, stream, isPlaying = false, progress = 0;

    async function toggleDefi() {
        if (!isPlaying) {
            const success = await startMic();
            if (success) {
                isPlaying = true;
                document.getElementById('btn-start').textContent = "Pause";
                document.getElementById('msg-start').style.display = 'none';
            }
        } else {
            stopMic();
            isPlaying = false;
            document.getElementById('btn-start').textContent = "Reprendre";
            document.getElementById('status-text').textContent = "En pause";
        }
    }

    async function startMic() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
            source.connect(analyser); analyser.connect(javascriptNode); javascriptNode.connect(audioContext.destination);
            javascriptNode.onaudioprocess = () => {
                let array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                let volume = array.reduce((a, b) => a + b) / array.length;
                document.getElementById('mic-bar').style.width = `${Math.min(volume * 3, 100)}%`;
                updateGame(volume);
            };
            return true;
        } catch (err) { return false; }
    }

    function stopMic() {
        if (javascriptNode) javascriptNode.disconnect();
        if (stream) stream.getTracks().forEach(t => t.stop());
    }

    function updateGame(volume) {
        // On convertit la sensibilit√© (1-100) en seuil de volume (plus c'est sensible, plus le seuil est bas)
        // Un volume capt√© est souvent entre 0 et 50. Ici on mappe 100 de sensibilit√© √† un seuil tr√®s bas (5).
        const sensibilite = parseInt(document.getElementById('sensibilite-slider').value);
        const threshold = 60 - (sensibilite * 0.55); 
        
        const dureeSaisie = parseInt(document.getElementById('duree-defi').value) || 10;
        const img = document.getElementById('hidden-image'), fill = document.getElementById('progress-fill'), status = document.getElementById('status-text');
        
        const increment = 100 / (dureeSaisie * 60);

        if (volume < threshold) {
            if (progress < 100) progress += increment; 
            status.textContent = "Chut... √ßa s'√©claircit !";
            status.style.color = "inherit";
        } else {
            if (progress > 0) progress -= (increment * 4); // Sanction l√©g√®rement augment√©e pour le challenge
            status.textContent = "Trop de bruit !";
            status.style.color = "#ef4444";
        }

        const blurValue = 30 - (progress * 0.3);
        const brightnessValue = 0.4 + (progress * 0.006);
        img.style.filter = `blur(${Math.max(0, blurValue)}px) brightness(${brightnessValue})`;
        
        fill.style.width = `${progress}%`;
        document.getElementById('percent-text').textContent = `${Math.floor(progress)}%`;
        
        if (progress >= 100) {
            status.textContent = "Bravo !"; 
            img.style.filter = "blur(0px) brightness(1)";
            stopMic(); 
            isPlaying = false;
            document.getElementById('btn-start').style.display = 'none';
            const btnReset = document.getElementById('btn-reset');
            btnReset.classList.remove('hidden');
            btnReset.style.backgroundColor = themeColor;
            btnReset.style.color = contrast;
        }
    }

	function nouveauDefi() {
        progress = 0;
        isPlaying = false;
        
        // R√©initialisation de l'affichage
        const img = document.getElementById('hidden-image');
        img.style.filter = "blur(30px) brightness(0.4)";
        // On ajoute un param√®tre al√©atoire √† l'URL pour forcer le chargement d'une nouvelle image
        img.src = `https://picsum.photos/900/500?nature,animals&sig=${Math.random()}`;
        
        document.getElementById('progress-fill').style.width = "0%";
        document.getElementById('percent-text').textContent = "0%";
        document.getElementById('status-text').textContent = "Pr√™t ?";
        document.getElementById('status-text').style.color = "inherit";
        
        // Gestion des boutons
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-start').textContent = "D√©marrer le d√©fi";
        document.getElementById('btn-reset').classList.add('hidden');
        document.getElementById('msg-start').style.display = 'flex';
    }
	
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>