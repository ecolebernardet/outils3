<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√âdition - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap');
        
        :root { --bg-color: #f1f5f9; --card-bg: #ffffff; --text-main: #1e293b; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        .header-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .edition-card { background: var(--card-bg); border-radius: 24px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .edition-card:active { transform: scale(0.96); }
        .card-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }

        .btn-header-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-box { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        
        /* Bouton retour aux outils sp√©cifique (sous le header) */
		#container-retour-liste {
    max-width: 500px; /* Align√© sur ton wrapper mobile */
    margin: 0 auto 20px auto;
    padding: 0 15px;
    display: flex;
    justify-content: flex-start;
}
#btn-retour-liste {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(128, 128, 128, 0.1); /* Couleur de fond par d√©faut */
    transition: all 0.2s ease;
    text-decoration: none;
}

#btn-retour-liste:active {
    transform: scale(0.95);
}

        .btn-sub-action { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; padding: 8px 16px; border-radius: 50px; transition: all 0.2s; }
    </style>
</head>
<body class="pb-10">

    <header class="header-glass sticky top-0 z-50 px-4 py-3">
    <div class="max-w-2xl mx-auto flex items-center justify-between">
        <a href="index.html" id="btn-retour" class="btn-header-round bg-neutral-800 text-white shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="pageTitle" class="text-[16px] font-black uppercase tracking-[0.2em] text-slate-800">√âdition</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="btn-header-round shadow-lg text-lg" style="line-height: 1;">
            <span>üí°</span>
        </button>
    </div>
</header>

    <main class="max-w-2xl mx-auto px-4 mt-4">
        
        <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux outils
        </a>
    </div>

<div class="max-w-2xl mx-auto px-4 mb-6">
    <div class="flex items-center gap-4">
        <span class="text-[11px] font-black uppercase tracking-widest text-slate-400">Mode de tri</span>
        
        <div class="flex bg-slate-200/50 p-1 rounded-full">
            <button id="tri-prenom" onclick="changerTri('prenom')" class="btn-sub-action px-4 py-2 rounded-full transition-all">
                Pr√©nom
            </button>
            <button id="tri-nom" onclick="changerTri('nom')" class="btn-sub-action px-4 py-2 rounded-full transition-all">
                Nom
            </button>
        </div>
    </div>
</div>

        <div class="space-y-4">
            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererPDF()">
                <div class="card-accent bg-blue-500"></div>
                <div class="icon-box bg-blue-50 text-blue-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Liste de classe</h2>
                    <p class="text-[11px] text-slate-400">PDF complet (Identit√©s & Niveaux)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererEmargement()">
                <div class="card-accent bg-emerald-500"></div>
                <div class="icon-box bg-emerald-50 text-emerald-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Feuille de pointage</h2>
                    <p class="text-[11px] text-slate-400">Grille de 15 colonnes vierges</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererEtiquettes()">
                <div class="card-accent bg-amber-500"></div>
                <div class="icon-box bg-amber-50 text-amber-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Grandes √âtiquettes</h2>
                    <p class="text-[11px] text-slate-400">8 par page (Casiers)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererPetitesEtiquettes()">
                <div class="card-accent bg-rose-500"></div>
                <div class="icon-box bg-rose-50 text-rose-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h16M4 18h16" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Petites √âtiquettes</h2>
                    <p class="text-[11px] text-slate-400">27 par page (Cahiers)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererSuiviIndividuel()">
                <div class="card-accent bg-purple-500"></div>
                <div class="icon-box bg-purple-50 text-purple-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Fiches de suivi</h2>
                    <p class="text-[11px] text-slate-400">Fiches individuelles A5 paysage</p>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-aide" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-6" onclick="fermerAide(event)">
    <div class="bg-white rounded-[32px] w-full max-w-sm overflow-hidden shadow-2xl animate-in zoom-in duration-300">
        <div class="p-8">
            <h3 id="aide-titre" class="text-2xl font-black mb-4 uppercase italic tracking-tight text-center">Module √©dition</h3>
            
            <div class="space-y-4 text-slate-500 text-[13px] leading-relaxed">
                <p class="font-semibold text-slate-800">Comment g√©n√©rer vos documents ?</p>
                
                <ul class="space-y-3">
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>Choisissez votre mode de tri (**Pr√©nom** ou **Nom**) avant de g√©n√©rer le document.</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>Le tri par **Nom** affichera automatiquement le nom en majuscules suivi du pr√©nom.</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>S√©lectionnez un type de document : le PDF sera g√©n√©r√© avec les √©l√®ves enregistr√©s.</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>Sur mobile, le fichier s'enregistre directement dans vos t√©l√©chargements.</span>
                    </li>
                </ul>

                <p class="bg-slate-50 p-3 rounded-xl italic">
                    Astuce : Assurez-vous d'avoir bien renseign√© votre nom dans la page "Ma classe" pour qu'il apparaisse sur les documents.
                </p>
            </div>

            <button onclick="document.getElementById('modal-aide').style.display='none'" id="btn-fermer-aide" class="w-full mt-8 py-4 rounded-2xl font-black uppercase tracking-widest text-xs text-white active:scale-95 shadow-lg">
                J'ai compris
            </button>
        </div>
    </div>
</div>

<script>
    // 1. Donn√©es et Configuration
    const mapCouleurs = {
        'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6',
        'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e',
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b',
        'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e',
        'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4',
        'sky': '#0ea5e9', 'slate': '#64748b'
    };

    const eleves = JSON.parse(localStorage.getItem('maListeEleves')) || [];
    const ordreNiveaux = ["TPS", "PS", "MS", "GS", "CP", "CE1", "CE2", "CM1", "CM2"];
    let modeTriActuel = 'prenom'; 

    // Fonction de tri ET de formatage du nom
    function trierEtFormater(liste) {
        let resultat = liste.map(el => {
            const parts = el.identite.trim().split(" ");
            const prenom = parts[0];
            const nom = parts.slice(1).join(" ");
            
            // On cr√©e une propri√©t√© temporaire pour l'affichage selon le mode
            let identiteAffichee = (modeTriActuel === 'nom') 
                ? `${nom.toUpperCase()} ${prenom}` 
                : `${prenom} ${nom}`;
            
            return { ...el, identiteAffichee, prenom, nom };
        });

        return resultat.sort((a, b) => {
            if (modeTriActuel === 'nom') {
                return a.nom.localeCompare(b.nom) || a.prenom.localeCompare(b.prenom);
            } else {
                return a.prenom.localeCompare(b.prenom) || a.nom.localeCompare(b.nom);
            }
        });
    }

    function changerTri(mode) {
        modeTriActuel = mode;
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.outils || 'blue';
        const hexa = mapCouleurs[colPref] || '#3b82f6';
        const btnP = document.getElementById('tri-prenom');
        const btnN = document.getElementById('tri-nom');

        if(mode === 'prenom') {
            btnP.style.backgroundColor = hexa; btnP.style.color = '#fff';
            btnN.style.backgroundColor = 'transparent'; btnN.style.color = '#64748b';
        } else {
            btnN.style.backgroundColor = hexa; btnN.style.color = '#fff';
            btnP.style.backgroundColor = 'transparent'; btnP.style.color = '#64748b';
        }
    }

    window.onload = () => {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.outils || 'blue'; 
        const hexa = mapCouleurs[colPref] || '#3b82f6';
        const isDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref);
        const contrast = isDarkText ? '#000' : '#fff';
        changerTri('prenom'); 
        const ids = ['btn-retour', 'btn-aide', 'btn-retour-liste', 'btn-fermer-aide'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
        if(document.getElementById('aide-titre')) document.getElementById('aide-titre').style.color = hexa;
    };

    function finaliserExportPDF(doc, nomFichier) {
        try {
            if (window.Android && typeof window.Android.savePdfFromBase64 === "function") {
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                window.Android.savePdfFromBase64(pdfBase64, nomFichier);
            } else { doc.save(nomFichier); }
        } catch (e) { doc.save(nomFichier); }
    }

    function genererEmargement() {
    // V√©rification de la liste (utilisation de customConfirm comme dans ton snippet)
    if (!eleves || eleves.length === 0) { 
        if (typeof customConfirm === 'function') {
            customConfirm("La liste est vide !", () => {}, [{text: 'D‚Äôaccord', value: 'ok', type: 'primary'}]); 
        } else {
            alert("La liste est vide !");
        }
        return; 
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
    const maintenant = new Date();
    const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
    
    // Groupement par niveau
    const groupes = {};
    eleves.forEach(el => { if (!groupes[el.niveau]) groupes[el.niveau] = []; groupes[el.niveau].push(el); });
    
    // Tri des niveaux selon l'ordre d√©fini
    const niveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));
    const texteNiveaux = niveauxPresents.join(" / ");
    
    doc.setFontSize(16); 
    doc.text(`Feuille de pointage ${texteNiveaux} - ${nomEnseignantBrut}`, 105, 15, { align: "center" });

    let finalBody = []; 
    let compteurGlobal = 1;

    niveauxPresents.forEach(niv => {
        // Ligne de titre du niveau
        finalBody.push([{ content: niv, colSpan: 17, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' } }]);
        
        // Tri des √©l√®ves du groupe selon le mode choisi (nom ou prenom)
        groupes[niv].sort((a, b) => {
            const ptsA = a.identite.trim().split(" "), ptsB = b.identite.trim().split(" ");
            const pA = ptsA[0], nA = ptsA.slice(1).join(" ");
            const pB = ptsB[0], nB = ptsB.slice(1).join(" ");
            // Attention : on utilise modeTriActuel pour correspondre au bouton
            return modeTriActuel === 'nom' ? nA.localeCompare(nB) : pA.localeCompare(pB);
        }).forEach((el) => {
            const pts = el.identite.trim().split(" ");
            const prenom = pts[0];
            const nom = pts.slice(1).join(" ");
            // Formatage de l'affichage : NOM Pr√©nom ou Pr√©nom Nom
            const idAffiche = modeTriActuel === 'nom' ? `${nom.toUpperCase()} ${prenom}` : `${prenom} ${nom}`;
            
            finalBody.push([compteurGlobal++, idAffiche, ...Array(15).fill('')]);
        });
    });

    // G√©n√©ration du tableau
    doc.autoTable({ 
        head: [[...Array(17).fill('')]], 
        body: finalBody, 
        startY: 25, 
        theme: 'grid', 
        alternateRowStyles: { fillColor: [245, 245, 245] }, 
        headStyles: { fillColor: [255, 255, 255], lineWidth: 0.1, lineColor: [0, 0, 0], minCellHeight: 16 }, 
        styles: { fontSize: 7, cellPadding: 1.5, lineColor: [0, 0, 0], textColor: [0, 0, 0] }, 
        columnStyles: { 
            0: { cellWidth: 7, halign: 'center' }, 
            1: { cellWidth: 'auto' },
            // Colonnes de pointage (8mm chacune)
            ...Object.fromEntries([...Array(15)].map((_, i) => [i + 2, { cellWidth: 8 }]))
        }, 
        didParseCell: function (data) { 
            if (data.section === 'head' && (data.column.index === 0 || data.column.index === 1)) { 
                data.cell.styles.lineWidth = 0; 
            } 
            if (data.section === 'body' && data.cell.raw && data.cell.raw.colSpan === 17) { 
                data.cell.styles.fillColor = [160, 160, 160]; 
            } 
        } 
    });

    const nomNettoye = nomEnseignantBrut.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
    const nomFinalEmarg = `outilsprofs_liste_pointage_${nomNettoye}_${dateFormattee}.pdf`;
    finaliserExportPDF(doc, nomFinalEmarg);
}

    function genererPDF() {
        if (!eleves || eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
        const maintenant = new Date(); const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
        const groupes = {}; eleves.forEach(el => { if (!groupes[el.niveau]) groupes[el.niveau] = []; groupes[el.niveau].push(el); });
        const niveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));
        doc.setFontSize(18); doc.text(`Liste de la classe de ${nomEnseignantBrut}`, 105, 15, { align: "center" });
        let finalBody = []; let compteurGlobal = 1;
        niveauxPresents.forEach(niv => {
            finalBody.push([{ content: niv, colSpan: 5, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold' } }]);
            trierEtFormater(groupes[niv]).forEach(el => {
                finalBody.push([compteurGlobal++, el.identiteAffichee, el.dateNaissance || '-', el.sexe.toUpperCase(), el.niveau]);
            });
        });
        doc.autoTable({ body: finalBody, startY: 30, theme: 'grid', styles: { fontSize: 9 } });
        const nomNettoye = nomEnseignantBrut.toLowerCase().replace(/\s+/g, '_');
        finaliserExportPDF(doc, `outilsprofs_liste_classe_${nomNettoye}_${dateFormattee}.pdf`);
    }

    function genererEtiquettes() {
    if (!eleves || eleves.length === 0) return;
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF();
    const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
    const maintenant = new Date(); 
    const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
    const nomNettoye = nomEnseignantBrut.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
    
    let col = 0, row = 0;
    
    // On utilise trierEtFormater pour appliquer le choix de l'utilisateur
    trierEtFormater(eleves).forEach((el, index) => {
        if (index > 0 && index % 8 === 0) { doc.addPage(); col = 0; row = 0; }
        
        const x = 10 + (col * 95); 
        const y = 10 + (row * 70);
        
        doc.setDrawColor(200); 
        doc.roundedRect(x, y, 85, 60, 3, 3, 'S');

        // Adaptabilit√© de l'affichage sur l'√©tiquette selon le mode de tri
        if (modeTriActuel === 'nom') {
            // Mode NOM : Nom en gros, Pr√©nom en dessous
            doc.setFontSize(22); 
            doc.text(el.nom.toUpperCase(), x + 42.5, y + 25, { align: 'center' });
            doc.setFontSize(16); 
            doc.text(el.prenom, x + 42.5, y + 37, { align: 'center' });
        } else {
            // Mode Pr√©nom : Pr√©nom en gros, Nom en dessous
            doc.setFontSize(22); 
            doc.text(el.prenom, x + 42.5, y + 25, { align: 'center' });
            doc.setFontSize(12); 
            doc.text(el.nom.toUpperCase(), x + 42.5, y + 35, { align: 'center' });
        }

        col++; 
        if (col === 2) { col = 0; row++; }
    });

    finaliserExportPDF(doc, `outilsprofs_etiquettes_${nomNettoye}_${dateFormattee}.pdf`);
}

    function genererPetitesEtiquettes() {
    if (!eleves || eleves.length === 0) return;
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF('p', 'mm', 'a4');
    const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
    const maintenant = new Date(); 
    const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
    const nomNettoye = nomEnseignantBrut.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
    
    let col = 0, row = 0;
    
    // Application du tri et du formatage choisi
    trierEtFormater(eleves).forEach((el, index) => {
        if (index > 0 && index % 27 === 0) { doc.addPage(); col = 0; row = 0; }
        
        const x = 10 + (col * 65); 
        const y = 12 + (row * 31);
        
        doc.setDrawColor(220); 
        doc.rect(x, y, 60, 28, 'S');
        
        doc.setFont("helvetica", "bold"); 
        doc.setFontSize(10); 
        // Utilise l'identit√© format√©e (NOM Pr√©nom ou Pr√©nom Nom)
        doc.text(el.identiteAffichee, x + 30, y + 14, { align: 'center' });
        
        col++; 
        if (col === 3) { col = 0; row++; }
    });

    finaliserExportPDF(doc, `outilsprofs_petitesetiquettes_${nomNettoye}_${dateFormattee}.pdf`);
}

    function genererSuiviIndividuel() {
    if (eleves.length === 0) { 
        customConfirm("La liste est vide !", () => {}, [{text: 'D‚Äôaccord', value: 'ok', type: 'primary'}]); 
        return; 
    }
    
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF('l', 'mm', 'a4');
    const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
    const maintenant = new Date(); 
    const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
    const nomNettoye = nomEnseignantBrut.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');

    // On utilise trierEtFormater pour respecter le choix de l'utilisateur (modeTriActuel)
    trierEtFormater(eleves).forEach((el, index) => {
        if (index > 0 && index % 2 === 0) doc.addPage('l');
        
        const position = index % 2, offsetX = position * 148.5;
        
        // En-t√™te gris clair
        doc.setFillColor(248, 248, 248); 
        doc.rect(offsetX + 10, 10, 128.5, 20, 'F');
        
        doc.setFontSize(8); 
        doc.setTextColor(120); 
        doc.text(`Suivi P√©dagogique - Classe de ${nomEnseignantBrut}`, offsetX + 15, 18);
        doc.text(`Ann√©e Scolaire 2025-2026`, offsetX + 15, 24);
        
        // Identit√© (NOM Pr√©nom ou Pr√©nom Nom selon le tri)
        doc.setFontSize(16); 
        doc.setTextColor(0); 
        doc.setFont("helvetica", "bold"); 
        doc.text(el.identiteAffichee, offsetX + 74.25, 45, { align: "center" });
        
        // Informations compl√©mentaires
        doc.setFontSize(10); 
        doc.setFont("helvetica", "normal");
        const infoNiveau = `Niveau : ${el.niveau}`, infoNaissance = el.dateNaissance ? ` - N√©(e) le : ${el.dateNaissance}` : "";
        doc.text(infoNiveau + infoNaissance, offsetX + 74.25, 52, { align: "center" });
        
        // Ligne de s√©paration sous l'identit√©
        doc.setDrawColor(200); 
        doc.line(offsetX + 30, 58, offsetX + 118, 58);
        
        // Section Observations
        doc.setFontSize(9); 
        doc.setTextColor(150); 
        doc.setFont("helvetica", "italic"); 
        doc.text("OBSERVATIONS / NOTES :", offsetX + 15, 68);
        
        // Cadre principal
        doc.setDrawColor(230); 
        doc.roundedRect(offsetX + 10, 72, 128.5, 120, 2, 2, 'S');
        
        // Lignes de notes
        doc.setDrawColor(240); 
        for (let i = 0; i < 10; i++) { 
            doc.line(offsetX + 15, 85 + (i * 11), offsetX + 133.5, 85 + (i * 11)); 
        }
        
        // Ligne de d√©coupe centrale (uniquement sur la colonne de gauche)
        if (position === 0) { 
            doc.setDrawColor(220); 
            doc.setLineDashPattern([2, 2], 0); 
            doc.line(148.5, 5, 148.5, 205); 
            doc.setLineDashPattern([], 0); 
        }
    });

    const nomFinalSuivi = `outilsprofs_fiches_suivi_classe_${nomNettoye}_${dateFormattee}.pdf`;
    finaliserExportPDF(doc, nomFinalSuivi);
}
    
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerAide(e) { if(e.target.id === 'modal-aide' || e.target.id === 'btn-fermer-aide') document.getElementById('modal-aide').style.display = 'none'; }
</script>
</body>
</html>