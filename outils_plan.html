<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plan de Classe Final - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.1); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }

        body.light-mode {
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #ddd; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 100;
        }

        #btn-retour, #btn-aide { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .classroom-area {
            position: relative;
            width: 100vw;
            height: calc(100vh - 140px);
            background-image: radial-gradient(var(--column-border) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            touch-action: none;
        }

        .desk {
            position: absolute;
            width: 75px;
            height: 55px;
            background: #5d4037;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: transform 0.2s ease-out;
        }

        .desk::before {
            content: '';
            position: absolute;
            bottom: -10px;
            width: 30px;
            height: 6px;
            background: #2e7d32;
            border-radius: 2px;
        }

        .toolbar {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--header-bg);
            width: 96%;
            max-width: 550px;
            padding: 6px;
            border-radius: 18px;
            border: 1px solid var(--column-border);
            display: flex;
            justify-content: space-around;
            gap: 2px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 200;
        }

        .btn-tool { flex: 1; height: 40px; border-radius: 10px; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: rgba(128,128,128,0.1); }
        .btn-tool:active { transform: scale(0.9); }
        .btn-tool:disabled { opacity: 0.2; pointer-events: none; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--card-bg); width: 100%; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 20px; }
    </style>
</head>
<body>

<header>
    <a href="outils.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1 class="font-black uppercase tracking-widest text-[10px]">Plan de Classe</h1>
    <button id="btn-aide" onclick="ouvrirAide()">ðŸ’¡</button>
</header>

<div class="classroom-area" id="canvas"></div>

<div class="toolbar">
    <button class="btn-tool" id="btn-mode" onclick="toggleLock()">ðŸ”“</button>
    <button class="btn-tool" id="btn-undo" onclick="undo()">â†¶</button>
    <button class="btn-tool" id="btn-redo" onclick="redo()">â†·</button>
    <button class="btn-tool" id="btn-shuffle" onclick="shuffleNames()" style="background: var(--theme-color); color: var(--contrast-color);">ðŸ”€</button>
    <button class="btn-tool" onclick="ouvrirConfig()">ðŸ‘¥</button>
    <button class="btn-tool" onclick="exporterPlan()">ðŸ’¾</button>
    <button class="btn-tool" onclick="importerPlan()">ðŸ“‚</button>
</div>

<div id="modal-config" class="modal-overlay">
    <div class="modal-content">
        <h2 class="font-black uppercase mb-2 text-sm text-center">Liste des Ã©lÃ¨ves</h2>
        <textarea id="liste-input" class="w-full h-40 bg-black/20 border border-[var(--column-border)] p-3 rounded-xl text-white outline-none font-bold text-xs" placeholder="Un nom par ligne..."></textarea>
        <div class="flex gap-2 mt-4">
            <button onclick="fermerConfig()" class="flex-1 py-3 rounded-xl font-black uppercase text-[10px] bg-white/5">Fermer</button>
            <button onclick="saveAndReload()" class="flex-[2] py-3 rounded-xl font-black uppercase text-[10px]" style="background: var(--theme-color); color: var(--contrast-color);">Appliquer</button>
        </div>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const mapCouleurs = { red:'#ef4444', orange:'#f97316', amber:'#f59e0b', yellow:'#eab308', lime:'#84cc16', green:'#22c55e', emerald:'#10b981', teal:'#14b8a6', cyan:'#06b6d4', sky:'#0ea5e9', blue:'#3b82f6', indigo:'#6366f1', violet:'#8b5cf6', purple:'#a855f7', fuchsia:'#d946ef', pink:'#ec4899', rose:'#f43f5e' };
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const contrast = ['yellow','amber','cyan','lime'].includes(themePrefs.outils) ? '#000' : '#fff';
    document.documentElement.style.setProperty('--theme-color', themeColor);
    document.documentElement.style.setProperty('--contrast-color', contrast);
    document.getElementById('btn-retour').style.backgroundColor = themeColor;
    document.getElementById('btn-retour').style.color = contrast;

    let isLocked = false;
    let studentData = JSON.parse(localStorage.getItem('plan_gynzy_v3')) || [];
    let historyStack = [];
    let redoStack = [];

    function pushHistory() {
        historyStack.push(JSON.stringify(studentData));
        if (historyStack.length > 30) historyStack.shift();
        redoStack = []; 
        updateUndoButtons();
    }

    function undo() {
        if (historyStack.length === 0) return;
        redoStack.push(JSON.stringify(studentData));
        studentData = JSON.parse(historyStack.pop());
        sync();
    }

    function redo() {
        if (redoStack.length === 0) return;
        historyStack.push(JSON.stringify(studentData));
        studentData = JSON.parse(redoStack.pop());
        sync();
    }

    function sync() {
        localStorage.setItem('plan_gynzy_v3', JSON.stringify(studentData));
        initClassroom();
        updateUndoButtons();
    }

    function updateUndoButtons() {
        document.getElementById('btn-undo').disabled = historyStack.length === 0;
        document.getElementById('btn-redo').disabled = redoStack.length === 0;
    }

    function initClassroom() {
        const canvas = document.getElementById('canvas');
        canvas.innerHTML = '';
        studentData.forEach((student, index) => {
            const el = document.createElement('div');
            el.className = 'desk';
            el.textContent = student.name;
            const x = student.x || 20, y = student.y || 20, r = student.r || 0;
            el.style.transform = `translate(${x}px, ${y}px) rotate(${r}deg)`;
            el.setAttribute('data-x', x); el.setAttribute('data-y', y); el.setAttribute('data-r', r);
            
            el.addEventListener('dblclick', function() {
                if(isLocked) return;
                pushHistory();
                let curR = (parseInt(this.dataset.r) + 45) % 360;
                this.dataset.r = curR;
                this.style.transform = `translate(${this.dataset.x}px, ${this.dataset.y}px) rotate(${curR}deg)`;
                savePositionsSilent();
            });
            canvas.appendChild(el);
        });
        setupDrag();
        updateUndoButtons();
    }

    function setupDrag() {
        interact('.desk').draggable({
            onstart: () => { if(!isLocked) pushHistory(); },
            listeners: {
                move(event) {
                    if(isLocked) return;
                    let { x, y, r } = event.target.dataset;
                    x = (parseFloat(x) || 0) + event.dx;
                    y = (parseFloat(y) || 0) + event.dy;
                    event.target.style.transform = `translate(${x}px, ${y}px) rotate(${r}deg)`;
                    Object.assign(event.target.dataset, { x, y });
                },
                end: savePositionsSilent
            }
        });
    }

    function savePositionsSilent() {
        const desks = document.querySelectorAll('.desk');
        studentData = Array.from(desks).map(d => ({
            name: d.textContent,
            x: parseFloat(d.dataset.x),
            y: parseFloat(d.dataset.y),
            r: parseInt(d.dataset.r) || 0
        }));
        localStorage.setItem('plan_gynzy_v3', JSON.stringify(studentData));
    }

    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('btn-mode');
        btn.textContent = isLocked ? 'ðŸ”’' : 'ðŸ”“';
        btn.style.background = isLocked ? themeColor : 'rgba(128,128,128,0.2)';
        btn.style.color = isLocked ? contrast : 'white';
    }

    function shuffleNames() {
        pushHistory();
        const desks = document.querySelectorAll('.desk');
        let names = Array.from(desks).map(d => d.textContent);
        for (let i = names.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [names[i], names[j]] = [names[j], names[i]];
        }
        desks.forEach((d, i) => {
            d.style.transition = 'transform 0.4s';
            d.textContent = names[i];
            setTimeout(() => d.style.transition = '', 500);
        });
        savePositionsSilent();
    }

    function saveAndReload() {
        const names = document.getElementById('liste-input').value.split('\n').map(n => n.trim()).filter(n => n !== "");
        if (names.length === 0) return;
        pushHistory();
        studentData = names.map((name, i) => {
            const ex = studentData[i] || {};
            return { name: name, x: ex.x || 20, y: ex.y || 20 + (i*5), r: ex.r || 0 };
        });
        sync(); fermerConfig();
    }

    function exporterPlan() {
        const blob = new Blob([JSON.stringify(studentData, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'plan_classe.json'; a.click();
    }

    function importerPlan() {
        const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json';
        inp.onchange = e => {
            const f = e.target.files[0]; const r = new FileReader();
            r.onload = ev => { 
                try {
                    pushHistory();
                    studentData = JSON.parse(ev.target.result); 
                    sync();
                } catch(e) { alert("Fichier invalide"); }
            };
            r.readAsText(f);
        };
        inp.click();
    }

    function ouvrirConfig() { document.getElementById('modal-config').style.display = 'flex'; document.getElementById('liste-input').value = studentData.map(s => s.name).join('\n'); }
    function fermerConfig() { document.getElementById('modal-config').style.display = 'none'; }
    function ouvrirAide() { alert("â€¢ DÃ©placer : Glisser\nâ€¢ Pivoter : Double-tap\nâ€¢ Annuler : â†¶\nâ€¢ Verrouiller (ðŸ”’) pour mÃ©langer les noms sans bouger les tables."); }

    initClassroom();
</script>
</body>
</html>