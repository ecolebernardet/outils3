<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structure École - Double Niveau Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root {
            --bg-page: #121212; --text-page: #ffffff; --column-bg: #1e1e1e; 
            --column-border: rgba(255, 255, 255, 0.1); --card-bg: #1e1e1e; 
            --input-bg: #2a2a2a; --input-text: #ffffff; --item-bg: #2a2a2a;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); font-size: 11px; }
        .main-wrapper { width: 100%; max-width: 950px; margin: 0 auto; padding: 10px; }
        .light-card { background: var(--card-bg); border-radius: 1rem; padding: 15px; border: 1px solid var(--column-border); margin-bottom: 15px; }
        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 640px) { .results-grid { grid-template-columns: 1fr; } }
        .column-prop { background: var(--column-bg); border-radius: 1rem; padding: 15px; border: 1px solid var(--column-border); }
        .label-text { font-size: 9px; font-weight: 900; text-transform: uppercase; margin-bottom: 2px; display: block; opacity: 0.6; }
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.4rem; padding: 5px 8px; font-size: 11px; width: 100%; color: var(--input-text); outline: none; margin-bottom: 5px; }
        .btn-main { width: 100%; padding: 10px; border-radius: 30px; font-weight: 800; font-size: 10px; text-transform: uppercase; color: white; background-color: #10b981; border: none; cursor: pointer; }
        .result-item { background: var(--item-bg); border-radius: 0.5rem; padding: 8px 10px; margin-bottom: 6px; border: 1px solid var(--column-border); }
        .grid-inputs { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .badge-dn { font-size: 8px; background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        .stat-bar { font-size: 9px; opacity: 0.7; margin-bottom: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="light-card">
        <h2 class="label-text mb-2" style="color: #10b981;">Configuration Strictement Double Niveau Max</h2>
        <div class="grid-inputs mb-2">
            <div><span class="label-text">CP</span><input type="number" id="cp" class="input-field" value="33"></div>
            <div><span class="label-text">CE1</span><input type="number" id="ce1" class="input-field" value="37"></div>
            <div><span class="label-text">CE2</span><input type="number" id="ce2" class="input-field" value="41"></div>
            <div><span class="label-text">CM1</span><input type="number" id="cm1" class="input-field" value="29"></div>
            <div><span class="label-text">CM2</span><input type="number" id="cm2" class="input-field" value="29"></div>
            <div><span class="label-text">Classes</span><input type="number" id="nbClasses" class="input-field" value="7"></div>
        </div>
        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-2">
            <div><span class="label-text">Ecart Effectif Max (Standard : 6)</span><input type="number" id="maxDiff" class="input-field" value="6"></div>
            <div><span class="label-text">Allègement DN</span><input type="number" id="allege" class="input-field" value="3"></div>
        </div>
        <button onclick="genererRepartitions()" class="btn-main mt-3">Calculer la Structure</button>
    </div>
    <div id="resultsContainer" class="results-grid"></div>
</div>

<script>
    const NIVEAUX = ['CP', 'CE1', 'CE2', 'CM1', 'CM2'];

    function genererRepartitions() {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        const levels = NIVEAUX.map((nom, i) => ({ nom, id: i, count: parseInt(document.getElementById(nom.toLowerCase()).value) || 0 }));
        const config = {
            nbClasses: parseInt(document.getElementById('nbClasses').value) || 1,
            maxEcartNiveaux: 2,
            maxDiffEffectif: parseInt(document.getElementById('maxDiff').value) || 6,
            allege: parseInt(document.getElementById('allege').value) || 3,
            minNiveau: 6
        };

        [1, 2].forEach(p => {
            let structure = calculerStructure(levels, config, p);
            structure.sort((a, b) => (a.minId ?? 9) - (b.minId ?? 9));
            afficherProposition(structure, p, container);
        });
    }

    function calculerStructure(baseLevels, config, seed) {
        let stock = baseLevels.map(n => ({...n}));
        let classes = Array.from({length: config.nbClasses}, () => ({ levels: {}, total: 0, minId: null, maxId: null }));
        
        const totalEleves = stock.reduce((s, n) => s + n.count, 0);
        const cibleMoy = totalEleves / config.nbClasses;

        let classOrder = Array.from({length: config.nbClasses}, (_, i) => i);
        if (seed === 2) classOrder.reverse();

        stock.forEach(lvl => {
            let aPlacer = lvl.count;
            for (let i of classOrder) {
                if (aPlacer <= 0) break;
                let c = classes[i];
                
                // --- CONTRAINTE TRIPLE NIVEAU ---
                let niveauxExistants = Object.keys(c.levels);
                let estDejaDouble = niveauxExistants.length >= 2;
                let dejaPresent = niveauxExistants.includes(lvl.nom);
                if (estDejaDouble && !dejaPresent) continue; // On ne peut pas ajouter un 3ème niveau

                let cibleLocale = (niveauxExistants.length > 0 && !dejaPresent) ? (cibleMoy - config.allege) : (cibleMoy + 1);

                if (c.total >= cibleLocale) continue;
                if (c.minId !== null && (Math.abs(lvl.id - c.minId) > config.maxEcartNiveaux || Math.abs(lvl.id - c.maxId) > config.maxEcartNiveaux)) continue;

                let qte = Math.min(aPlacer, Math.ceil(cibleLocale - c.total));
                if (qte < config.minNiveau && qte < aPlacer && c.total > 0) continue;

                if (qte > 0) {
                    c.levels[lvl.nom] = (c.levels[lvl.nom] || 0) + qte;
                    c.total += qte;
                    aPlacer -= qte;
                    if (c.minId === null || lvl.id < c.minId) c.minId = lvl.id;
                    if (c.maxId === null || lvl.id > c.maxId) c.maxId = lvl.id;
                }
            }
            // Placement forcé des restes (respect strict écart 2 et pas de triple)
            if (aPlacer > 0) {
                let compatibles = classes.filter(c => {
                    let nivs = Object.keys(c.levels);
                    let peutAccueillir = nivs.includes(lvl.nom) || nivs.length < 2;
                    let ecartOk = c.minId === null || (Math.abs(lvl.id - c.minId) <= config.maxEcartNiveaux && Math.abs(lvl.id - c.maxId) <= config.maxEcartNiveaux);
                    return peutAccueillir && ecartOk;
                }).sort((a,b) => a.total - b.total);

                let cS = compatibles[0] || classes.sort((a,b) => a.total - b.total)[0];
                cS.levels[lvl.nom] = (cS.levels[lvl.nom] || 0) + aPlacer;
                cS.total += aPlacer;
                if (cS.minId === null || lvl.id < cS.minId) cS.minId = lvl.id;
                if (cS.maxId === null || lvl.id > cS.maxId) cS.maxId = lvl.id;
                aPlacer = 0;
            }
        });

        // EQUILIBRAGE (Idem version précédente mais avec verrou Triple Niveau)
        for (let t = 0; t < 60; t++) {
            classes.sort((a, b) => b.total - a.total);
            let gros = classes[0];
            let petit = classes[classes.length-1];
            if (gros.total - petit.total <= config.maxDiffEffectif) break;

            for (let [nivNom, qte] of Object.entries(gros.levels)) {
                let id = NIVEAUX.indexOf(nivNom);
                let pNivs = Object.keys(petit.levels);
                let compatible = (pNivs.includes(nivNom) || pNivs.length < 2) && 
                                 (petit.minId === null || (Math.abs(id - petit.minId) <= config.maxEcartNiveaux && Math.abs(id - petit.maxId) <= config.maxEcartNiveaux));
                if (compatible && qte > 1) {
                    gros.levels[nivNom]--; gros.total--;
                    petit.levels[nivNom] = (petit.levels[nivNom] || 0) + 1; petit.total++;
                    if (gros.levels[nivNom] === 0) delete gros.levels[nivNom];
                    let rG = Object.keys(gros.levels).map(n => NIVEAUX.indexOf(n));
                    gros.minId = rG.length ? Math.min(...rG) : null; gros.maxId = rG.length ? Math.max(...rG) : null;
                    let rP = Object.keys(petit.levels).map(n => NIVEAUX.indexOf(n));
                    petit.minId = rP.length ? Math.min(...rP) : null; petit.maxId = rP.length ? Math.max(...rP) : null;
                    break;
                }
            }
        }
        return classes;
    }

    function afficherProposition(structure, num, container) {
        const propDiv = document.createElement('div');
        propDiv.className = 'column-prop shadow-xl';
        const effs = structure.map(c => c.total);
        propDiv.innerHTML = `<div class="label-text border-b border-emerald-500 pb-2 mb-2 text-emerald-500 text-center">Option ${num}</div>
                             <div class="stat-bar">Écart: ${Math.max(...effs) - Math.min(...effs)} (Max: ${Math.max(...effs)} / Min: ${Math.min(...effs)})</div>`;
        
        structure.forEach((c) => {
            const nivsKeys = Object.keys(c.levels);
            const details = NIVEAUX.filter(n => c.levels[n]).map(n => `<b>${c.levels[n]}</b> ${n}`).join(' + ');
            propDiv.innerHTML += `
                <div class="result-item">
                    <div class="flex justify-between items-center text-[9px] font-black uppercase">
                        <span class="text-gray-400">CLASSE ${nivsKeys.join('-')} ${nivsKeys.length>1 ? '<span class="badge-dn">DOUBLE</span>' : ''}</span>
                        <span class="text-emerald-400">${c.total} ELEVES</span>
                    </div>
                    <div class="text-[10px] opacity-90 mt-1">${details}</div>
                </div>`;
        });
        container.appendChild(propDiv);
    }
</script>
</body>
</html>